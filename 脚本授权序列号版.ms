-- ========================================
-- è„šæœ¬æ—¶é—´+ç¡¬ä»¶æˆæƒæ·»åŠ ç³»ç»Ÿ - å®æ—¶ç‰ˆ v2.7
-- ä¿®å¤ï¼šä½¿ç”¨ .NET å¯¹è¯æ¡†å®ç°çœŸæ­£çš„å¤šæ–‡ä»¶é€‰æ‹©
-- æ–°å¢ï¼šæ”¯æŒæ–‡ä»¶æ‹–æ‹½åˆ°åˆ—è¡¨
-- ä¼˜åŒ–ï¼šUI å¸ƒå±€è°ƒæ•´
-- ========================================

global g_AuthListURL = "https://raw.githubusercontent.com/2779913057-beep/crispy-spork/main/æˆæƒåˆ—è¡¨.txt"

-- ========================================
-- å·¥å…·å‡½æ•° (æ ¸å¿ƒé€»è¾‘ä¿æŒä¸å˜)
-- ========================================

fn getExpireDateByMonths months =
(
    local now = (dotNetClass "System.DateTime").Now
    now.AddMonths months
)

fn formatDateTime dt =
(
    try (dt.ToString "yyyy-MM-dd HH:mm:ss") catch ("æ—¶é—´æ ¼å¼é”™è¯¯")
)

fn encodeToBase64 s =
(
    try
    (
        local c = dotnetclass "System.Convert"
        local b = (dotnetclass "System.Text.Encoding").UTF8.GetBytes s
        c.ToBase64String b
    )
    catch ("")
)

fn readFileContent f =
(
    try
    (
        local fh = openFile f
        local t = ""
        if fh != undefined then
        (
            while not eof fh do t += readLine fh + "\n"
            close fh
            t
        )
    )
    catch (undefined)
)

fn saveFileContent f content =
(
    try
    (
        local io = dotnetclass "System.IO.File"
        local enc = dotnetclass "System.Text.Encoding"
        io.WriteAllText f content enc.UTF8
        true
    )
    catch (false)
)

-- ========================================
-- è·å–ç¡¬ç›˜åºåˆ—å·
-- ========================================
fn GetHardDiskSerial =
(
    local result = #()
    local tempFile = (GetDir #temp) + "\\disk_serial_" + (random 100000 999999) as string + ".txt"
    local psCommand = "powershell -NoProfile -ExecutionPolicy Bypass -Command \"Get-CimInstance -ClassName Win32_PhysicalMedia -ErrorAction SilentlyContinue | ForEach-Object {$_.SerialNumber}\" > \"" + tempFile + "\" 2>nul"
    
    HiddenDOSCommand psCommand
    
    local timeout = 30
    while timeout > 0 and not (doesFileExist tempFile) do (sleep 0.1; timeout -= 1)
    
    if doesFileExist tempFile then
    (
        try (
            local fs = openFile tempFile
            if fs != undefined then (
                while not eof fs do (
                    local line = trimLeft (trimRight (readLine fs))
                    if line != "" and line != " " do append result line
                )
                close fs
            )
        ) catch()
        try(deleteFile tempFile) catch()
    )
    
    if result.count > 0 then result[1] else ""
)

-- ========================================
-- å®æ—¶è·å–GitHubå†…å®¹
-- ========================================
fn GetGitHubContentRealtime url =
(
    local randNum = random 100000000 999999999
    local cacheBypassURL = url + "?t=" + (randNum as string)
    
    try
    (
        local webClient = dotNetObject "System.Net.WebClient"
        webClient.Encoding = (dotNetClass "System.Text.Encoding").UTF8
        webClient.Headers.Add "User-Agent" "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
        webClient.Headers.Add "Cache-Control" "no-cache, no-store, must-revalidate"
        webClient.Headers.Add "Pragma" "no-cache"
        
        local content = webClient.DownloadString cacheBypassURL
        webClient.Dispose()
        
        return content
    )
    catch err
    (
        return undefined
    )
)

-- ========================================
-- ç”Ÿæˆæˆæƒè„šæœ¬
-- ========================================
fn generateAuthWrapperCN fileName base64Code expireDateTime authURL =
(
    local expStr = formatDateTime expireDateTime
    local encodedURL = encodeToBase64 authURL

    local t = ""
    t += "-- ========================================\n"
    t += "-- æˆæƒè„šæœ¬: " + fileName + "\n"
    t += "-- æœ‰æ•ˆæœŸè‡³: " + expStr + "\n"
    t += "-- ========================================\n\n"

    t += "fn GetHardDiskSerial =\n"
    t += "(\n"
    t += "    local result = #()\n"
    t += "    local tempFile = (GetDir #temp) + \"\\\\disk_serial_\" + (random 100000 999999) as string + \".txt\"\n"
    t += "    local psCommand = \"powershell -NoProfile -ExecutionPolicy Bypass -Command \\\"Get-CimInstance -ClassName Win32_PhysicalMedia -ErrorAction SilentlyContinue | ForEach-Object {$_.SerialNumber}\\\" > \\\"\" + tempFile + \"\\\" 2>nul\"\n"
    t += "    HiddenDOSCommand psCommand\n"
    t += "    local timeout = 30\n"
    t += "    while timeout > 0 and not (doesFileExist tempFile) do (sleep 0.1; timeout -= 1)\n"
    t += "    if doesFileExist tempFile then\n"
    t += "    (\n"
    t += "        try (\n"
    t += "            local fs = openFile tempFile\n"
    t += "            if fs != undefined then (\n"
    t += "                while not eof fs do (\n"
    t += "                    local line = trimLeft (trimRight (readLine fs))\n"
    t += "                    if line != \"\" and line != \" \" do append result line\n"
    t += "                )\n"
    t += "                close fs\n"
    t += "            )\n"
    t += "        ) catch()\n"
    t += "        try(deleteFile tempFile) catch()\n"
    t += "    )\n"
    t += "    if result.count > 0 then result[1] else \"\"\n"
    t += ")\n\n"

    t += "fn DecodeAuthURL =\n"
    t += "(\n"
    t += "    try\n"
    t += "    (\n"
    t += "        local encoded = \"" + encodedURL + "\"\n"
    t += "        local bytes = (dotNetClass \"System.Convert\").FromBase64String encoded\n"
    t += "        (dotNetClass \"System.Text.Encoding\").UTF8.GetString bytes\n"
    t += "    )\n"
    t += "    catch (undefined)\n"
    t += ")\n\n"

    t += "fn GetAuthorizationList =\n"
    t += "(\n"
    t += "    local baseURL = DecodeAuthURL()\n"
    t += "    if baseURL == undefined then return undefined\n"
    t += "    local randNum = random 100000000 999999999\n"
    t += "    local url = baseURL + \"?t=\" + (randNum as string)\n"
    t += "    try\n"
    t += "    (\n"
    t += "        local webClient = dotNetObject \"System.Net.WebClient\"\n"
    t += "        webClient.Encoding = (dotNetClass \"System.Text.Encoding\").UTF8\n"
    t += "        webClient.Headers.Add \"User-Agent\" \"Mozilla/5.0\"\n"
    t += "        webClient.Headers.Add \"Cache-Control\" \"no-cache\"\n"
    t += "        webClient.Headers.Add \"Pragma\" \"no-cache\"\n"
    t += "        local content = webClient.DownloadString url\n"
    t += "        webClient.Dispose()\n"
    t += "        return content\n"
    t += "    )\n"
    t += "    catch (return undefined)\n"
    t += ")\n\n"

    t += "fn VerifyHardDiskAuth =\n"
    t += "(\n"
    t += "    local localSerial = GetHardDiskSerial()\n"
    t += "    if localSerial == \"\" then\n"
    t += "    (\n"
    t += "        messageBox \"æ— æ³•è·å–ç¡¬ç›˜åºåˆ—å·\" title:\"æˆæƒéªŒè¯å¤±è´¥\"\n"
    t += "        return false\n"
    t += "    )\n"
    t += "    local authList = GetAuthorizationList()\n"
    t += "    if authList == undefined then\n"
    t += "    (\n"
    t += "        messageBox \"æ— æ³•è·å–æˆæƒåˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ\" title:\"æˆæƒéªŒè¯å¤±è´¥\"\n"
    t += "        return false\n"
    t += "    )\n"
    t += "    local lines = filterString authList \"\\n\"\n"
    t += "    for line in lines do\n"
    t += "    (\n"
    t += "        local clean = trimLeft (trimRight line)\n"
    t += "        if clean != \"\" and (clean == localSerial or (stricmp clean localSerial == 0)) then\n"
    t += "            return true\n"
    t += "    )\n"
    t += "    messageBox (\"æ­¤è®¾å¤‡æœªè·æˆæƒ\\n\\nåºåˆ—å·: \" + localSerial) title:\"æˆæƒéªŒè¯å¤±è´¥\"\n"
    t += "    return false\n"
    t += ")\n\n"

    t += "fn getWebTime =\n"
    t += "(\n"
    t += "    try\n"
    t += "    (\n"
    t += "        local req = (dotNetClass \"System.Net.WebRequest\").Create \"https://www.baidu.com\"\n"
    t += "        req.Method = \"HEAD\"\n"
    t += "        req.Timeout = 5000\n"
    t += "        local resp = req.GetResponse()\n"
    t += "        local h = resp.GetResponseHeader \"Date\"\n"
    t += "        resp.Close()\n"
    t += "        if h != undefined and h != \"\" then\n"
    t += "            return ((dotNetClass \"System.DateTime\").Parse h).ToLocalTime()\n"
    t += "        return undefined\n"
    t += "    )\n"
    t += "    catch\n"
    t += "    (\n"
    t += "        messageBox \"ç½‘ç»œè¿æ¥å¤±è´¥\" title:\"é”™è¯¯\"\n"
    t += "        return undefined\n"
    t += "    )\n"
    t += ")\n\n"

    t += "fn verifyAuthAndRun =\n"
    t += "(\n"
    t += "    if not VerifyHardDiskAuth() then return()\n"
    t += "    \n"
    t += "    local nowT = getWebTime()\n"
    t += "    if nowT == undefined then return()\n"
    t += "    local expT = (dotNetClass \"System.DateTime\").ParseExact \"" + expStr + "\" \"yyyy-MM-dd HH:mm:ss\" undefined\n"
    t += "    if (expT.CompareTo nowT) < 0 then\n"
    t += "    (\n"
    t += "        messageBox \"æˆæƒå·²è¿‡æœŸ!\" title:\"æˆæƒè¿‡æœŸ\"\n"
    t += "        return()\n"
    t += "    )\n"
    t += "    \n"
    t += "    try\n"
    t += "    (\n"
    t += "        local bytes = (dotNetClass \"System.Convert\").FromBase64String \"" + base64Code + "\"\n"
    t += "        local code = (dotNetClass \"System.Text.Encoding\").UTF8.GetString bytes\n"
    t += "        execute code\n"
    t += "    )\n"
    t += "    catch (messageBox \"è„šæœ¬è§£ç å¤±è´¥\" title:\"é”™è¯¯\")\n"
    t += ")\n\n"
    t += "verifyAuthAndRun()\n"

    t
)

-- ========================================
-- Rollout UI - æ‰¹é‡å¤„ç†ç‰ˆ
-- ========================================
try(destroyDialog authWrapperCNRollout) catch()

rollout authWrapperCNRollout "è„šæœ¬æˆæƒæ·»åŠ å™¨ v2.7 (æ‰¹é‡åŠ å¼ºç‰ˆ)" width:380 height:540
(
    -- ç•Œé¢å˜é‡
    local scriptFiles = #()
    local expireDateTime = undefined
    local outputFolder = ""

    group "1. è„šæœ¬åˆ—è¡¨ (æ”¯æŒå¤šé€‰/æ‹–æ‹½)"
    (
        dotNetControl scriptListBox "System.Windows.Forms.ListBox" width:350 height:140
        button addScriptsBtn "æ·»åŠ è„šæœ¬æ–‡ä»¶..." width:170 height:26 across:2 align:#left
        button removeSelectedBtn "ç§»é™¤é€‰ä¸­é¡¹" width:170 height:26 align:#right
        button clearAllBtn "æ¸…ç©ºæ‰€æœ‰" width:350 height:20
    )
    
    group "2. æˆæƒé…ç½®"
    (
        label lbl_url "æˆæƒåˆ—è¡¨URL (TXTæ ¼å¼):" align:#left
        edittext authURLEdit "" fieldWidth:345 height:20
        
        label lbl_time "æˆæƒæ—¶é•¿:" align:#left across:3
        spinner monthsSpinner "æœˆ:" range:[0,120,1] type:#integer fieldWidth:40 offset:[15,0]
        spinner daysSpinner "å¤©:" range:[0,365,0] type:#integer fieldWidth:40 offset:[-20,0]
        
        label expireLabel "æˆªæ­¢æ—¥æœŸ: ----" align:#left style_sunkenedge:true width:345 height:18
        
        checkbox manualDateChk "æ‰‹åŠ¨æŒ‡å®šæ—¥æœŸ" checked:false align:#left
        edittext manualDateInput "" fieldWidth:345 enabled:false text:"2025-12-31 23:59:59"
    )
    
    group "3. è¾“å‡ºè®¾ç½®"
    (
        radiobuttons outputMode labels:#("ä¿å­˜åˆ°åŸæ–‡ä»¶å¤¹ (æ–‡ä»¶å+_æˆæƒç‰ˆ)", "æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹") columns:1 align:#left
        edittext outputFolderEdit "" fieldWidth:290 across:2 enabled:false
        button selectOutputFolderBtn "..." width:40 height:20 enabled:false
    )
    
    group "4. æ‰§è¡Œç”Ÿæˆ"
    (
        button wrapScriptBtn "å¼€å§‹æ‰¹é‡ç”Ÿæˆ" width:350 height:35
        progressbar wrapProgress value:0 width:350 height:10
        label statusLabel "å‡†å¤‡å°±ç»ª" align:#left
    )
    
    button testAuthBtn "ğŸ›  æµ‹è¯•æœ¬æœºæˆæƒçŠ¶æ€" width:350 height:26
    
    -- ========================================
    -- UI é€»è¾‘å‡½æ•°
    -- ========================================
    
    fn updateExpireLabel =
    (
        if expireDateTime != undefined then
            expireLabel.text = " æˆªæ­¢: " + (formatDateTime expireDateTime)
    )
    
    fn calcDateFromSpinners = 
    (
        local now = (dotNetClass "System.DateTime").Now
        expireDateTime = (now.AddMonths monthsSpinner.value).AddDays daysSpinner.value
        updateExpireLabel()
        manualDateInput.text = formatDateTime expireDateTime
    )
    
    fn updateListBox =
    (
        scriptListBox.Items.Clear()
        for f in scriptFiles do
        (
            scriptListBox.Items.Add (getFilenameFile f)
        )
        statusLabel.text = "åˆ—è¡¨æ–‡ä»¶æ•°: " + (scriptFiles.count as string)
    )

    -- ========================================
    -- äº‹ä»¶å¤„ç†
    -- ========================================

    on authWrapperCNRollout open do
    (
        calcDateFromSpinners()
        authURLEdit.text = g_AuthListURL
        
        -- è®¾ç½® ListBox å±æ€§
        scriptListBox.SelectionMode = (dotNetClass "System.Windows.Forms.SelectionMode").MultiExtended
        scriptListBox.HorizontalScrollbar = true
        scriptListBox.AllowDrop = true -- å¯ç”¨æ‹–æ‹½
    )
    
    -- å¤„ç†æ‹–æ‹½äº‹ä»¶
    on scriptListBox DragEnter e do
    (
        if e.Data.GetDataPresent (dotNetClass "System.Windows.Forms.DataFormats").FileDrop then
            e.Effect = (dotNetClass "System.Windows.Forms.DragDropEffects").Copy
        else
            e.Effect = (dotNetClass "System.Windows.Forms.DragDropEffects").None
    )
    
    on scriptListBox DragDrop e do
    (
        local droppedFiles = e.Data.GetData (dotNetClass "System.Windows.Forms.DataFormats").FileDrop
        if droppedFiles != undefined then
        (
            for f in droppedFiles do
            (
                -- ç®€å•çš„åç¼€åæ£€æŸ¥
                if (toLower (getFilenameType f)) == ".ms" then
                (
                    local exists = false
                    for sf in scriptFiles do (if sf == f then (exists = true; exit))
                    if not exists then append scriptFiles f
                )
            )
            updateListBox()
        )
    )

    on addScriptsBtn pressed do
    (
        -- === æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ .NET OpenFileDialog å®ç°çœŸæ­£çš„å¤šé€‰ ===
        local dlg = dotNetObject "System.Windows.Forms.OpenFileDialog"
        dlg.Title = "é€‰æ‹©è„šæœ¬æ–‡ä»¶ (æŒ‰ä½ Ctrl/Shift å¯å¤šé€‰)"
        dlg.Multiselect = true
        dlg.Filter = "MAXScript (*.ms)|*.ms|æ‰€æœ‰æ–‡ä»¶ (*.*)|*.*"
        
        local result = dlg.ShowDialog()
        if result.Equals (dotNetClass "System.Windows.Forms.DialogResult").OK then
        (
            local files = dlg.FileNames
            for f in files do
            (
                local exists = false
                for sf in scriptFiles do (if sf == f then (exists = true; exit))
                if not exists then append scriptFiles f
            )
            updateListBox()
        )
    )
    
    on removeSelectedBtn pressed do
    (
        local selectedIndices = scriptListBox.SelectedIndices
        if selectedIndices.Count > 0 then
        (
            local toRemove = #()
            -- å€’åºæ”¶é›†ç´¢å¼•ï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•é”™ä½
            for i = selectedIndices.Count - 1 to 0 by -1 do
                append toRemove (selectedIndices.Item[i] + 1) -- max æ•°ç»„ä»1å¼€å§‹
            
            -- å¯¹Maxæ•°ç»„è¿›è¡Œåˆ é™¤æ“ä½œ
            -- è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå°æŠ€å·§ï¼šå¤åˆ¶ä¸€ä»½æ–°çš„åˆ—è¡¨ï¼Œæ’é™¤æ‰è¦åˆ é™¤çš„
            local newFiles = #()
            for i = 1 to scriptFiles.count do
            (
                if (findItem toRemove i) == 0 then append newFiles scriptFiles[i]
            )
            scriptFiles = newFiles
            updateListBox()
        )
    )
    
    on clearAllBtn pressed do
    (
        scriptFiles = #()
        updateListBox()
    )
    
    on monthsSpinner changed val do if not manualDateChk.checked then calcDateFromSpinners()
    on daysSpinner changed val do if not manualDateChk.checked then calcDateFromSpinners()
    
    on manualDateChk changed state do
    (
        manualDateInput.enabled = state
        monthsSpinner.enabled = not state
        daysSpinner.enabled = not state
        
        if not state then calcDateFromSpinners() -- åˆ‡å›è‡ªåŠ¨æ—¶é‡æ–°è®¡ç®—
    )
    
    on manualDateInput entered txt do
    (
        if manualDateChk.checked and txt != "" then
        (
            try 
            (
                expireDateTime = (dotNetClass "System.DateTime").ParseExact txt "yyyy-MM-dd HH:mm:ss" undefined
                updateExpireLabel()
            )
            catch 
            (
                messageBox "æ—¥æœŸæ ¼å¼é”™è¯¯!\n\næ­£ç¡®æ ¼å¼: 2025-12-31 23:59:59" title:"é”™è¯¯"
            )
        )
    )
    
    on outputMode changed state do
    (
        local useCustomFolder = (state == 2)
        outputFolderEdit.enabled = useCustomFolder
        selectOutputFolderBtn.enabled = useCustomFolder
    )
    
    on selectOutputFolderBtn pressed do
    (
        local folder = getSavePath caption:"é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹"
        if folder != undefined then
        (
            outputFolder = folder
            outputFolderEdit.text = folder
        )
    )

    on wrapScriptBtn pressed do
    (
        if scriptFiles.count == 0 then (messageBox "åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ è„šæœ¬æ–‡ä»¶" title:"æç¤º"; return())
        if authURLEdit.text == "" then (messageBox "è¯·è®¾ç½®æˆæƒURL" title:"æç¤º"; return())
        
        -- å¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œç¡®ä¿æ—¶é—´è§£æäº†
        if manualDateChk.checked then
        (
             try (expireDateTime = (dotNetClass "System.DateTime").ParseExact manualDateInput.text "yyyy-MM-dd HH:mm:ss" undefined)
             catch (messageBox "æ‰‹åŠ¨æ—¥æœŸæ ¼å¼æ— æ•ˆ" title:"é”™è¯¯"; return())
        )
        
        if outputMode.state == 2 and outputFolderEdit.text == "" then
        (
            messageBox "è¯·é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹" title:"æç¤º"
            return()
        )
        
        local successCount = 0
        local failCount = 0
        local totalCount = scriptFiles.count
        
        wrapProgress.value = 0
        
        for i = 1 to totalCount do
        (
            local scriptPath = scriptFiles[i]
            local fname = getFilenameFile scriptPath
            
            statusLabel.text = "æ­£åœ¨å¤„ç†: " + fname
            
            local code = readFileContent scriptPath
            if code == undefined then
            (
                failCount += 1
                format "Read Error: %\n" scriptPath
            )
            else
            (
                local b64 = encodeToBase64 code
                local wrapped = generateAuthWrapperCN fname b64 expireDateTime authURLEdit.text
                
                local outPath = ""
                if outputMode.state == 1 then
                    outPath = (getFilenamePath scriptPath) + fname + "_æˆæƒç‰ˆ.ms"
                else
                    outPath = outputFolderEdit.text + "\\" + fname + "_æˆæƒç‰ˆ.ms"
                
                if saveFileContent outPath wrapped then
                    successCount += 1
                else
                    failCount += 1
            )
            
            wrapProgress.value = (i as float / totalCount * 100) as integer
        )
        
        wrapProgress.value = 100
        statusLabel.text = "å…¨éƒ¨å®Œæˆ"
        
        messageBox ("å¤„ç†å®Œæˆ!\n\næˆåŠŸ: " + successCount as string + "\nå¤±è´¥: " + failCount as string) title:"ç»“æœ"
    )
    
    on testAuthBtn pressed do
    (
        if authURLEdit.text == "" then (messageBox "è¯·å…ˆå¡«å†™æˆæƒURL"; return())
        
        local serial = GetHardDiskSerial()
        local content = GetGitHubContentRealtime authURLEdit.text
        
        if content != undefined then
        (
            local lines = filterString content "\n"
            local found = false
            
            for line in lines do
            (
                local clean = trimLeft (trimRight line)
                if clean == serial or (stricmp clean serial == 0) then (found = true; exit)
            )
            
            local status = if found then "âœ… å·²æˆæƒ" else "âŒ æœªæˆæƒ"
            messageBox ("ç¡¬ç›˜åºåˆ—å·: " + serial + "\n\nçŠ¶æ€: " + status) title:"æˆæƒæµ‹è¯•"
        )
        else
        (
            messageBox "æ— æ³•è¿æ¥åˆ°æˆæƒåˆ—è¡¨ URLï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åœ°å€ã€‚" title:"è¿æ¥é”™è¯¯"
        )
    )
)

createDialog authWrapperCNRollout