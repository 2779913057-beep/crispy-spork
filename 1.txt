<!DOCTYPE html>
<!-- saved from url=(0060)https://lmarena.ai/zh/c/019bb20e-3a6d-7296-b16e-aab6357c7b8c -->
<html lang="zh" class="m-0 h-svh w-full p-0 light" style="color-scheme: light;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="origin-trial" content="A7vZI3v+Gz7JfuRolKNM4Aff6zaGuT7X0mf3wtoZTnKv6497cVMnhy03KDqX7kBz/q/iidW7srW31oQbBt4VhgoAAACUeyJvcmlnaW4iOiJodHRwczovL3d3dy5nb29nbGUuY29tOjQ0MyIsImZlYXR1cmUiOiJEaXNhYmxlVGhpcmRQYXJ0eVN0b3JhZ2VQYXJ0aXRpb25pbmczIiwiZXhwaXJ5IjoxNzU3OTgwODAwLCJpc1N1YmRvbWFpbiI6dHJ1ZSwiaXNUaGlyZFBhcnR5Ijp0cnVlfQ=="><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><link rel="stylesheet" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/1dafe117bc82612b.css" data-precedence="next"><link rel="stylesheet" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/d2bb4bf599873a05.css" data-precedence="next"><link rel="stylesheet" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/24003cf8e1219369.css" data-precedence="next"><link rel="stylesheet" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/54dc5841a3267dfa.css" data-precedence="next"><link rel="preload" as="script" fetchpriority="low" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/webpack-af9fb3b534394843.js.下载"><script type="text/javascript" async="" charset="utf-8" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/recaptcha__zh_cn.js.下载" crossorigin="anonymous" integrity="sha384-HEs04IO/sdTLIDsmDcXbXtjxYvzKE6Vtb3lhB8kQxl8crc//m71fgxE1HrDjgTXJ"></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/12e27825-7391ba48b224d96a.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/39825-ed4f837d6d03837e.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/main-app-4d8892698d84f0ed.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/96732-d9441f5dc98a99a9.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/82214-8f84d964761bc4af.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/92027-3dd9233645836478.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/96624-f993d60e989ef23d.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/21368-ac2a239ad05c5330.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/74718-38b11a5bd42f68f4.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/layout-2c9a500082bc7919.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/04e11c28-ea9d8ee041e7d2ff.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/60294-0b8504d1daa65488.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/79181-1242f2d124392839.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/global-error-7e08b0d857a5bb33.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/8aacbce6-88a34b8eeaee694a.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/53f5d41f-7da185a24433e906.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/f79f5b6c-35f1a745a9c4cb2f.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/36707d36-e9915b22a5fc3d2e.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/60085-670df980123fc75b.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/11497-6ceeff1e9c85d138.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/91589-2a7b5f72e82cce6f.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/1060-d7e8cb52da646351.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/5915-7cadfb8426f9b95a.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/20186-93af0fc699237fbf.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/95090-270d0f209a7eeb0b.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/46192-170273cb5db9a009.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/26254-ee93dcaf2b2ee6fe.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/81069-d7eeb2c84c581251.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/49405-adfd94a6a9c3437c.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/28178-efe28f5ec012d57b.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/60319-b070350a64ccaa9a.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/7988-28b4de0512ac72e1.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/88637-8e47b66ea5fecf8a.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/72782-c3e6af85cb32f4c2.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/46855-96bf129bdf9f9797.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/82871-3574e180231e4044.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/52137-cd036403cad2c8b9.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/69138-4af705ad2a7847c4.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/45563-095cd84df4c113b7.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/26227-2040ad5da80249e2.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/19374-f9c90c5742d6ad45.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/55186-7f702a4ef02ccbcc.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/37066-1c2457b77bca2be7.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/62044-99b27a733dc76899.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/90399-ef06b81ca99f5332.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/25626-33122f1179407249.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/30296-1d9ae1f465e18785.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/5217-c8022b6a42c68a82.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/page-562a33df193ae675.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/65593-aad87134d3b6abda.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/layout-f0322cab8d6332d9.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/page-4989c6d8f0e5f9c6.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/18134-7c72418abca8186b.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/not-found-bd98bb6384035e0a.js.下载" async=""></script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/layout-cda7a0147393eb8b.js.下载" async=""></script><link rel="preload" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/js" as="script"><link rel="preload" href="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/enterprise.js.下载" as="script"><meta name="next-size-adjust" content=""><title>LMArena | Benchmark &amp; Compare the Best AI Models</title><meta name="description" content="Chat with multiple AI models side-by-side. Compare ChatGPT, Claude, Gemini, and other top LLMs. Crowdsourced benchmarks and leaderboards."><meta name="creator" content="LMArena | Benchmark &amp; Compare the Best AI Models"><meta name="robots" content="index, follow"><meta name="googlebot" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"><meta property="og:title" content="LMArena | Benchmark &amp; Compare the Best AI Models"><meta property="og:description" content="Chat with multiple AI models side-by-side. Compare ChatGPT, Claude, Gemini, and other top LLMs. Crowdsourced benchmarks and leaderboards."><meta property="og:url" content="https://lmarena.ai"><meta property="og:site_name" content="LMArena | Benchmark &amp; Compare the Best AI Models"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://lmarena.ai/images/og/default.jpg"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="LMArena | Benchmark &amp; Compare the Best AI Models"><meta name="twitter:description" content="Chat with multiple AI models side-by-side. Compare ChatGPT, Claude, Gemini, and other top LLMs. Crowdsourced benchmarks and leaderboards."><meta name="twitter:image" content="https://lmarena.ai/images/og/default.jpg"><link rel="icon" href="https://lmarena.ai/images/favicon-light.ico?v=1" media="(prefers-color-scheme: light)"><link rel="icon" href="https://lmarena.ai/images/favicon-dark.ico?v=1" media="(prefers-color-scheme: dark)"><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/polyfills-42372ed130431b0a.js.下载" nomodule=""></script><style type="text/css">[data-vaul-drawer]{touch-action:none;will-change:transform;transition:transform .5s cubic-bezier(.32, .72, 0, 1);animation-duration:.5s;animation-timing-function:cubic-bezier(0.32,0.72,0,1)}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=bottom][data-state=open]{animation-name:slideFromBottom}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=bottom][data-state=closed]{animation-name:slideToBottom}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=top][data-state=open]{animation-name:slideFromTop}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=top][data-state=closed]{animation-name:slideToTop}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=left][data-state=open]{animation-name:slideFromLeft}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=left][data-state=closed]{animation-name:slideToLeft}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=right][data-state=open]{animation-name:slideFromRight}[data-vaul-drawer][data-vaul-snap-points=false][data-vaul-drawer-direction=right][data-state=closed]{animation-name:slideToRight}[data-vaul-drawer][data-vaul-snap-points=true][data-vaul-drawer-direction=bottom]{transform:translate3d(0,var(--initial-transform,100%),0)}[data-vaul-drawer][data-vaul-snap-points=true][data-vaul-drawer-direction=top]{transform:translate3d(0,calc(var(--initial-transform,100%) * -1),0)}[data-vaul-drawer][data-vaul-snap-points=true][data-vaul-drawer-direction=left]{transform:translate3d(calc(var(--initial-transform,100%) * -1),0,0)}[data-vaul-drawer][data-vaul-snap-points=true][data-vaul-drawer-direction=right]{transform:translate3d(var(--initial-transform,100%),0,0)}[data-vaul-drawer][data-vaul-delayed-snap-points=true][data-vaul-drawer-direction=top]{transform:translate3d(0,var(--snap-point-height,0),0)}[data-vaul-drawer][data-vaul-delayed-snap-points=true][data-vaul-drawer-direction=bottom]{transform:translate3d(0,var(--snap-point-height,0),0)}[data-vaul-drawer][data-vaul-delayed-snap-points=true][data-vaul-drawer-direction=left]{transform:translate3d(var(--snap-point-height,0),0,0)}[data-vaul-drawer][data-vaul-delayed-snap-points=true][data-vaul-drawer-direction=right]{transform:translate3d(var(--snap-point-height,0),0,0)}[data-vaul-overlay][data-vaul-snap-points=false]{animation-duration:.5s;animation-timing-function:cubic-bezier(0.32,0.72,0,1)}[data-vaul-overlay][data-vaul-snap-points=false][data-state=open]{animation-name:fadeIn}[data-vaul-overlay][data-state=closed]{animation-name:fadeOut}[data-vaul-animate=false]{animation:none!important}[data-vaul-overlay][data-vaul-snap-points=true]{opacity:0;transition:opacity .5s cubic-bezier(.32, .72, 0, 1)}[data-vaul-overlay][data-vaul-snap-points=true]{opacity:1}[data-vaul-drawer]:not([data-vaul-custom-container=true])::after{content:'';position:absolute;background:inherit;background-color:inherit}[data-vaul-drawer][data-vaul-drawer-direction=top]::after{top:initial;bottom:100%;left:0;right:0;height:200%}[data-vaul-drawer][data-vaul-drawer-direction=bottom]::after{top:100%;bottom:initial;left:0;right:0;height:200%}[data-vaul-drawer][data-vaul-drawer-direction=left]::after{left:initial;right:100%;top:0;bottom:0;width:200%}[data-vaul-drawer][data-vaul-drawer-direction=right]::after{left:100%;right:initial;top:0;bottom:0;width:200%}[data-vaul-overlay][data-vaul-snap-points=true]:not([data-vaul-snap-points-overlay=true]):not(
[data-state=closed]
){opacity:0}[data-vaul-overlay][data-vaul-snap-points-overlay=true]{opacity:1}[data-vaul-handle]{display:block;position:relative;opacity:.7;background:#e2e2e4;margin-left:auto;margin-right:auto;height:5px;width:32px;border-radius:1rem;touch-action:pan-y}[data-vaul-handle]:active,[data-vaul-handle]:hover{opacity:1}[data-vaul-handle-hitarea]{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:max(100%,2.75rem);height:max(100%,2.75rem);touch-action:inherit}@media (hover:hover) and (pointer:fine){[data-vaul-drawer]{user-select:none}}@media (pointer:fine){[data-vaul-handle-hitarea]:{width:100%;height:100%}}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes fadeOut{to{opacity:0}}@keyframes slideFromBottom{from{transform:translate3d(0,var(--initial-transform,100%),0)}to{transform:translate3d(0,0,0)}}@keyframes slideToBottom{to{transform:translate3d(0,var(--initial-transform,100%),0)}}@keyframes slideFromTop{from{transform:translate3d(0,calc(var(--initial-transform,100%) * -1),0)}to{transform:translate3d(0,0,0)}}@keyframes slideToTop{to{transform:translate3d(0,calc(var(--initial-transform,100%) * -1),0)}}@keyframes slideFromLeft{from{transform:translate3d(calc(var(--initial-transform,100%) * -1),0,0)}to{transform:translate3d(0,0,0)}}@keyframes slideToLeft{to{transform:translate3d(calc(var(--initial-transform,100%) * -1),0,0)}}@keyframes slideFromRight{from{transform:translate3d(var(--initial-transform,100%),0,0)}to{transform:translate3d(0,0,0)}}@keyframes slideToRight{to{transform:translate3d(var(--initial-transform,100%),0,0)}}</style><style type="text/css">[data-sonner-toaster][dir=ltr],html[dir=ltr]{--toast-icon-margin-start:-3px;--toast-icon-margin-end:4px;--toast-svg-margin-start:-1px;--toast-svg-margin-end:0px;--toast-button-margin-start:auto;--toast-button-margin-end:0;--toast-close-button-start:0;--toast-close-button-end:unset;--toast-close-button-transform:translate(-35%, -35%)}[data-sonner-toaster][dir=rtl],html[dir=rtl]{--toast-icon-margin-start:4px;--toast-icon-margin-end:-3px;--toast-svg-margin-start:0px;--toast-svg-margin-end:-1px;--toast-button-margin-start:0;--toast-button-margin-end:auto;--toast-close-button-start:unset;--toast-close-button-end:0;--toast-close-button-transform:translate(35%, -35%)}[data-sonner-toaster]{position:fixed;width:var(--width);font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;--gray1:hsl(0, 0%, 99%);--gray2:hsl(0, 0%, 97.3%);--gray3:hsl(0, 0%, 95.1%);--gray4:hsl(0, 0%, 93%);--gray5:hsl(0, 0%, 90.9%);--gray6:hsl(0, 0%, 88.7%);--gray7:hsl(0, 0%, 85.8%);--gray8:hsl(0, 0%, 78%);--gray9:hsl(0, 0%, 56.1%);--gray10:hsl(0, 0%, 52.3%);--gray11:hsl(0, 0%, 43.5%);--gray12:hsl(0, 0%, 9%);--border-radius:8px;box-sizing:border-box;padding:0;margin:0;list-style:none;outline:0;z-index:999999999;transition:transform .4s ease}@media (hover:none) and (pointer:coarse){[data-sonner-toaster][data-lifted=true]{transform:none}}[data-sonner-toaster][data-x-position=right]{right:var(--offset-right)}[data-sonner-toaster][data-x-position=left]{left:var(--offset-left)}[data-sonner-toaster][data-x-position=center]{left:50%;transform:translateX(-50%)}[data-sonner-toaster][data-y-position=top]{top:var(--offset-top)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--offset-bottom)}[data-sonner-toast]{--y:translateY(100%);--lift-amount:calc(var(--lift) * var(--gap));z-index:var(--z-index);position:absolute;opacity:0;transform:var(--y);touch-action:none;transition:transform .4s,opacity .4s,height .4s,box-shadow .2s;box-sizing:border-box;outline:0;overflow-wrap:anywhere}[data-sonner-toast][data-styled=true]{padding:16px;background:var(--normal-bg);border:1px solid var(--normal-border);color:var(--normal-text);border-radius:var(--border-radius);box-shadow:0 4px 12px rgba(0,0,0,.1);width:var(--width);font-size:13px;display:flex;align-items:center;gap:6px}[data-sonner-toast]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-y-position=top]{top:0;--y:translateY(-100%);--lift:1;--lift-amount:calc(1 * var(--gap))}[data-sonner-toast][data-y-position=bottom]{bottom:0;--y:translateY(100%);--lift:-1;--lift-amount:calc(var(--lift) * var(--gap))}[data-sonner-toast][data-styled=true] [data-description]{font-weight:400;line-height:1.4;color:#3f3f3f}[data-rich-colors=true][data-sonner-toast][data-styled=true] [data-description]{color:inherit}[data-sonner-toaster][data-sonner-theme=dark] [data-description]{color:#e8e8e8}[data-sonner-toast][data-styled=true] [data-title]{font-weight:500;line-height:1.5;color:inherit}[data-sonner-toast][data-styled=true] [data-icon]{display:flex;height:16px;width:16px;position:relative;justify-content:flex-start;align-items:center;flex-shrink:0;margin-left:var(--toast-icon-margin-start);margin-right:var(--toast-icon-margin-end)}[data-sonner-toast][data-promise=true] [data-icon]>svg{opacity:0;transform:scale(.8);transform-origin:center;animation:sonner-fade-in .3s ease forwards}[data-sonner-toast][data-styled=true] [data-icon]>*{flex-shrink:0}[data-sonner-toast][data-styled=true] [data-icon] svg{margin-left:var(--toast-svg-margin-start);margin-right:var(--toast-svg-margin-end)}[data-sonner-toast][data-styled=true] [data-content]{display:flex;flex-direction:column;gap:2px}[data-sonner-toast][data-styled=true] [data-button]{border-radius:4px;padding-left:8px;padding-right:8px;height:24px;font-size:12px;color:var(--normal-bg);background:var(--normal-text);margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end);border:none;font-weight:500;cursor:pointer;outline:0;display:flex;align-items:center;flex-shrink:0;transition:opacity .4s,box-shadow .2s}[data-sonner-toast][data-styled=true] [data-button]:focus-visible{box-shadow:0 0 0 2px rgba(0,0,0,.4)}[data-sonner-toast][data-styled=true] [data-button]:first-of-type{margin-left:var(--toast-button-margin-start);margin-right:var(--toast-button-margin-end)}[data-sonner-toast][data-styled=true] [data-cancel]{color:var(--normal-text);background:rgba(0,0,0,.08)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-styled=true] [data-cancel]{background:rgba(255,255,255,.3)}[data-sonner-toast][data-styled=true] [data-close-button]{position:absolute;left:var(--toast-close-button-start);right:var(--toast-close-button-end);top:0;height:20px;width:20px;display:flex;justify-content:center;align-items:center;padding:0;color:var(--gray12);background:var(--normal-bg);border:1px solid var(--gray4);transform:var(--toast-close-button-transform);border-radius:50%;cursor:pointer;z-index:1;transition:opacity .1s,background .2s,border-color .2s}[data-sonner-toast][data-styled=true] [data-close-button]:focus-visible{box-shadow:0 4px 12px rgba(0,0,0,.1),0 0 0 2px rgba(0,0,0,.2)}[data-sonner-toast][data-styled=true] [data-disabled=true]{cursor:not-allowed}[data-sonner-toast][data-styled=true]:hover [data-close-button]:hover{background:var(--gray2);border-color:var(--gray5)}[data-sonner-toast][data-swiping=true]::before{content:'';position:absolute;left:-100%;right:-100%;height:100%;z-index:-1}[data-sonner-toast][data-y-position=top][data-swiping=true]::before{bottom:50%;transform:scaleY(3) translateY(50%)}[data-sonner-toast][data-y-position=bottom][data-swiping=true]::before{top:50%;transform:scaleY(3) translateY(-50%)}[data-sonner-toast][data-swiping=false][data-removed=true]::before{content:'';position:absolute;inset:0;transform:scaleY(2)}[data-sonner-toast][data-expanded=true]::after{content:'';position:absolute;left:0;height:calc(var(--gap) + 1px);bottom:100%;width:100%}[data-sonner-toast][data-mounted=true]{--y:translateY(0);opacity:1}[data-sonner-toast][data-expanded=false][data-front=false]{--scale:var(--toasts-before) * 0.05 + 1;--y:translateY(calc(var(--lift-amount) * var(--toasts-before))) scale(calc(-1 * var(--scale)));height:var(--front-toast-height)}[data-sonner-toast]>*{transition:opacity .4s}[data-sonner-toast][data-x-position=right]{right:0}[data-sonner-toast][data-x-position=left]{left:0}[data-sonner-toast][data-expanded=false][data-front=false][data-styled=true]>*{opacity:0}[data-sonner-toast][data-visible=false]{opacity:0;pointer-events:none}[data-sonner-toast][data-mounted=true][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset)));height:var(--initial-height)}[data-sonner-toast][data-removed=true][data-front=true][data-swipe-out=false]{--y:translateY(calc(var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=true]{--y:translateY(calc(var(--lift) * var(--offset) + var(--lift) * -100%));opacity:0}[data-sonner-toast][data-removed=true][data-front=false][data-swipe-out=false][data-expanded=false]{--y:translateY(40%);opacity:0;transition:transform .5s,opacity .2s}[data-sonner-toast][data-removed=true][data-front=false]::before{height:calc(var(--initial-height) + 20%)}[data-sonner-toast][data-swiping=true]{transform:var(--y) translateY(var(--swipe-amount-y,0)) translateX(var(--swipe-amount-x,0));transition:none}[data-sonner-toast][data-swiped=true]{user-select:none}[data-sonner-toast][data-swipe-out=true][data-y-position=bottom],[data-sonner-toast][data-swipe-out=true][data-y-position=top]{animation-duration:.2s;animation-timing-function:ease-out;animation-fill-mode:forwards}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=left]{animation-name:swipe-out-left}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=right]{animation-name:swipe-out-right}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=up]{animation-name:swipe-out-up}[data-sonner-toast][data-swipe-out=true][data-swipe-direction=down]{animation-name:swipe-out-down}@keyframes swipe-out-left{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) - 100%));opacity:0}}@keyframes swipe-out-right{from{transform:var(--y) translateX(var(--swipe-amount-x));opacity:1}to{transform:var(--y) translateX(calc(var(--swipe-amount-x) + 100%));opacity:0}}@keyframes swipe-out-up{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) - 100%));opacity:0}}@keyframes swipe-out-down{from{transform:var(--y) translateY(var(--swipe-amount-y));opacity:1}to{transform:var(--y) translateY(calc(var(--swipe-amount-y) + 100%));opacity:0}}@media (max-width:600px){[data-sonner-toaster]{position:fixed;right:var(--mobile-offset-right);left:var(--mobile-offset-left);width:100%}[data-sonner-toaster][dir=rtl]{left:calc(var(--mobile-offset-left) * -1)}[data-sonner-toaster] [data-sonner-toast]{left:0;right:0;width:calc(100% - var(--mobile-offset-left) * 2)}[data-sonner-toaster][data-x-position=left]{left:var(--mobile-offset-left)}[data-sonner-toaster][data-y-position=bottom]{bottom:var(--mobile-offset-bottom)}[data-sonner-toaster][data-y-position=top]{top:var(--mobile-offset-top)}[data-sonner-toaster][data-x-position=center]{left:var(--mobile-offset-left);right:var(--mobile-offset-right);transform:none}}[data-sonner-toaster][data-sonner-theme=light]{--normal-bg:#fff;--normal-border:var(--gray4);--normal-text:var(--gray12);--success-bg:hsl(143, 85%, 96%);--success-border:hsl(145, 92%, 87%);--success-text:hsl(140, 100%, 27%);--info-bg:hsl(208, 100%, 97%);--info-border:hsl(221, 91%, 93%);--info-text:hsl(210, 92%, 45%);--warning-bg:hsl(49, 100%, 97%);--warning-border:hsl(49, 91%, 84%);--warning-text:hsl(31, 92%, 45%);--error-bg:hsl(359, 100%, 97%);--error-border:hsl(359, 100%, 94%);--error-text:hsl(360, 100%, 45%)}[data-sonner-toaster][data-sonner-theme=light] [data-sonner-toast][data-invert=true]{--normal-bg:#000;--normal-border:hsl(0, 0%, 20%);--normal-text:var(--gray1)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast][data-invert=true]{--normal-bg:#fff;--normal-border:var(--gray3);--normal-text:var(--gray12)}[data-sonner-toaster][data-sonner-theme=dark]{--normal-bg:#000;--normal-bg-hover:hsl(0, 0%, 12%);--normal-border:hsl(0, 0%, 20%);--normal-border-hover:hsl(0, 0%, 25%);--normal-text:var(--gray1);--success-bg:hsl(150, 100%, 6%);--success-border:hsl(147, 100%, 12%);--success-text:hsl(150, 86%, 65%);--info-bg:hsl(215, 100%, 6%);--info-border:hsl(223, 43%, 17%);--info-text:hsl(216, 87%, 65%);--warning-bg:hsl(64, 100%, 6%);--warning-border:hsl(60, 100%, 9%);--warning-text:hsl(46, 87%, 65%);--error-bg:hsl(358, 76%, 10%);--error-border:hsl(357, 89%, 16%);--error-text:hsl(358, 100%, 81%)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]{background:var(--normal-bg);border-color:var(--normal-border);color:var(--normal-text)}[data-sonner-toaster][data-sonner-theme=dark] [data-sonner-toast] [data-close-button]:hover{background:var(--normal-bg-hover);border-color:var(--normal-border-hover)}[data-rich-colors=true][data-sonner-toast][data-type=success]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=success] [data-close-button]{background:var(--success-bg);border-color:var(--success-border);color:var(--success-text)}[data-rich-colors=true][data-sonner-toast][data-type=info]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=info] [data-close-button]{background:var(--info-bg);border-color:var(--info-border);color:var(--info-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=warning] [data-close-button]{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}[data-rich-colors=true][data-sonner-toast][data-type=error]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}[data-rich-colors=true][data-sonner-toast][data-type=error] [data-close-button]{background:var(--error-bg);border-color:var(--error-border);color:var(--error-text)}.sonner-loading-wrapper{--size:16px;height:var(--size);width:var(--size);position:absolute;inset:0;z-index:10}.sonner-loading-wrapper[data-visible=false]{transform-origin:center;animation:sonner-fade-out .2s ease forwards}.sonner-spinner{position:relative;top:50%;left:50%;height:var(--size);width:var(--size)}.sonner-loading-bar{animation:sonner-spin 1.2s linear infinite;background:var(--gray11);border-radius:6px;height:8%;left:-10%;position:absolute;top:-3.9%;width:24%}.sonner-loading-bar:first-child{animation-delay:-1.2s;transform:rotate(.0001deg) translate(146%)}.sonner-loading-bar:nth-child(2){animation-delay:-1.1s;transform:rotate(30deg) translate(146%)}.sonner-loading-bar:nth-child(3){animation-delay:-1s;transform:rotate(60deg) translate(146%)}.sonner-loading-bar:nth-child(4){animation-delay:-.9s;transform:rotate(90deg) translate(146%)}.sonner-loading-bar:nth-child(5){animation-delay:-.8s;transform:rotate(120deg) translate(146%)}.sonner-loading-bar:nth-child(6){animation-delay:-.7s;transform:rotate(150deg) translate(146%)}.sonner-loading-bar:nth-child(7){animation-delay:-.6s;transform:rotate(180deg) translate(146%)}.sonner-loading-bar:nth-child(8){animation-delay:-.5s;transform:rotate(210deg) translate(146%)}.sonner-loading-bar:nth-child(9){animation-delay:-.4s;transform:rotate(240deg) translate(146%)}.sonner-loading-bar:nth-child(10){animation-delay:-.3s;transform:rotate(270deg) translate(146%)}.sonner-loading-bar:nth-child(11){animation-delay:-.2s;transform:rotate(300deg) translate(146%)}.sonner-loading-bar:nth-child(12){animation-delay:-.1s;transform:rotate(330deg) translate(146%)}@keyframes sonner-fade-in{0%{opacity:0;transform:scale(.8)}100%{opacity:1;transform:scale(1)}}@keyframes sonner-fade-out{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.8)}}@keyframes sonner-spin{0%{opacity:1}100%{opacity:.15}}@media (prefers-reduced-motion){.sonner-loading-bar,[data-sonner-toast],[data-sonner-toast]>*{transition:none!important;animation:none!important}}.sonner-loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transform-origin:center;transition:opacity .2s,transform .2s}.sonner-loader[data-visible=false]{opacity:0;transform:scale(.8) translate(-50%,-50%)}</style><link rel="preload" href="https://lmarena.ai/_next/static/media/0e96d314a90a6138-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/268f004ea3786b37-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/5d259b4d93dec8ad-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/76fcc95954fbfc88-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/82ebfbcf8e635787-s.p.ttf?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/ttf"><link rel="preload" href="https://lmarena.ai/_next/static/media/b7ea2ab4a8ad1f81-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/c4b700dcb2187787-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/d7df244fe7b07b95-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://lmarena.ai/_next/static/media/e4af272ccee01ff0-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN" as="font" crossorigin="" type="font/woff2"><style data-emotion="css" data-s=""></style></head><body class="font-sans __variable_697da2 __variable_3916eb __variable_048822 text-text-primary bg-surface-primary !pointer-events-auto m-0 h-full min-h-svh w-full overflow-x-hidden p-0 antialiased" style=""><div hidden=""><!--$--><!--/$--></div><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/exception-autocapture.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/surveys.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/config.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/exception-autocapture.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/exception-autocapture.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/web-vitals.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/dead-clicks-autocapture.js.下载"></script><script type="text/javascript" crossorigin="anonymous" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/dead-clicks-autocapture.js.下载"></script><script>((a,b,c,d,e,f,g,h)=>{let i=document.documentElement,j=["light","dark"];function k(b){var c;(Array.isArray(a)?a:[a]).forEach(a=>{let c="class"===a,d=c&&f?e.map(a=>f[a]||a):e;c?(i.classList.remove(...d),i.classList.add(b)):i.setAttribute(a,b)}),c=b,h&&j.includes(c)&&(i.style.colorScheme=c)}if(d)k(d);else try{let a=localStorage.getItem(b)||c,d=g&&"system"===a?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":a;k(d)}catch(a){}})("class","theme","system",null,["light","dark"],null,true,true)</script><!--$--><!--/$--><section aria-label="Notifications alt+T" tabindex="-1" aria-live="polite" aria-relevant="additions text" aria-atomic="false"></section><div style="--app-banner-height:40px"><div class="bg-surface-secondary border-b-border-faint fixed left-0 right-0 top-0 z-50 flex h-[var(--app-banner-height,0px)] items-center border-b px-2 sm:px-10" data-banner="app-banner"><div class="text-text-primary flex w-full items-center justify-center gap-2"><span class="xs:inline-block hidden text-left text-sm font-medium">Stay updated on frontier AI capabilities</span><span class="xs:hidden inline-block text-left text-sm font-medium">For frontier AI news</span><a target="_blank" rel="noopener noreferrer" href="https://x.com/arena" class=""><button class="justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 px-3 text-xs font-medium text-text-interactive-inverted bg-header-primary hover:bg-header-primary/90 flex flex-shrink-0 items-center gap-1 py-1.5" type="button">Follow us on <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M16.6009 5H19.0542L13.6943 10.9304L20 19H15.0626L11.1957 14.1057L6.77089 19H4.31598L10.0489 12.6569L4 5H9.06245L12.5579 9.47348L16.6009 5ZM15.7398 17.5784H17.0993L8.32384 6.34694H6.86513L15.7398 17.5784Z" fill="currentColor"></path></svg></button></a></div><div class="absolute right-0 sm:right-4"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none h-8 w-8 flex-shrink-0" type="button" aria-label="Dismiss banner"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-4 w-4"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button></div></div><div style="--sidebar-width:240px;--sidebar-width-icon:3rem" class="group/sidebar-wrapper has-[[data-variant=inset]]:bg-sidebar flex min-h-svh w-full"><div class="text-sidebar-foreground group peer hidden md:block" data-state="expanded" data-collapsible="" data-variant="sidebar" data-side="left"><div class="relative w-[--sidebar-width] bg-transparent transition-[width] duration-100 ease-linear group-data-[collapsible=offcanvas]:w-0 group-data-[side=right]:rotate-180 group-data-[collapsible=icon]:w-[--sidebar-width-icon]"></div><div class="fixed z-10 hidden w-[--sidebar-width] transition-[left,right,width] duration-100 ease-linear md:flex left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)] border-border-faint group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l bottom-0 top-[var(--app-banner-height,0px)]"><div data-sidebar="sidebar" class="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col overflow-hidden group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow"><button data-sidebar="rail" aria-label="Toggle Sidebar" tabindex="-1" title="Toggle Sidebar" class="hover:after:bg-sidebar-border absolute inset-y-0 z-50 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex [[data-side=left]_&amp;]:cursor-w-resize [[data-side=right]_&amp;]:cursor-e-resize [[data-side=left][data-state=collapsed]_&amp;]:cursor-e-resize [[data-side=right][data-state=collapsed]_&amp;]:cursor-w-resize group-data-[collapsible=offcanvas]:hover:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full [[data-side=left][data-collapsible=offcanvas]_&amp;]:-right-2 [[data-side=right][data-collapsible=offcanvas]_&amp;]:-left-2"></button><div data-sidebar="header" class="flex flex-col gap-2 p-2 h-12"><div class="flex items-center justify-between"><ul data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-1"><li data-sidebar="menu-item" class="group/menu-item relative"><button data-sidebar="menu-button" data-size="lg" data-active="false" class="peer/menu-button flex items-center gap-2 overflow-hidden rounded-md p-2 text-left outline-none ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 [&amp;&gt;span:last-child]:truncate [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 [&amp;&gt;span]:group-data-[collapsible=icon]:hidden hover:bg-sidebar-accent hover:text-sidebar-accent-foreground text-sm group-data-[collapsible=icon]:!p-0 data-[state=open]:bg-sidebar data-[state=open]:text-sidebar-accent-foreground h-auto w-fit justify-start" type="button" id="radix-_r_4q_" aria-haspopup="menu" aria-expanded="false" data-state="closed"><div class="flex flex-shrink-0 items-center gap-1"><div class="flex items-center gap-1"><svg width="1530" height="300" viewBox="0 0 1535 300" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-header-primary" style="width: 102px; height: 20px; flex-shrink: 0;"><path d="M1456.56 269.994C1444.96 269.994 1435.32 267.929 1427.65 263.8C1419.99 259.671 1414.28 254.263 1410.55 247.578C1406.81 240.696 1404.94 233.224 1404.94 225.162C1404.94 210.218 1410.35 198.912 1421.16 191.243C1432.18 183.378 1446.82 179.445 1465.11 179.445H1505.22V176.496C1505.22 150.934 1493.52 138.153 1470.13 138.153C1460.69 138.153 1452.72 140.217 1446.23 144.347C1439.94 148.476 1435.91 154.965 1434.14 163.813H1408.78C1409.76 153.982 1413 145.527 1418.51 138.448C1424.21 131.369 1431.49 125.962 1440.34 122.226C1449.18 118.49 1459.11 116.622 1470.13 116.622C1490.97 116.622 1506.11 122.127 1515.55 133.139C1525.18 143.953 1530 158.406 1530 176.496V266.455H1508.76L1506.7 243.744H1504.63C1500.31 250.822 1494.51 257.016 1487.23 262.325C1480.15 267.438 1469.93 269.994 1456.56 269.994ZM1460.98 248.168C1470.42 248.168 1478.38 245.907 1484.87 241.384C1491.56 236.862 1496.57 230.864 1499.91 223.392C1503.45 215.92 1505.22 207.76 1505.22 198.912H1467.18C1453.81 198.912 1444.37 201.173 1438.86 205.696C1433.55 210.218 1430.9 216.215 1430.9 223.687C1430.9 231.356 1433.45 237.353 1438.57 241.679C1443.68 246.005 1451.15 248.168 1460.98 248.168Z" fill="currentColor"></path><path d="M1244.55 266.455V120.161H1265.2L1267.85 142.282H1269.33C1273.26 135.203 1279.45 129.206 1287.91 124.29C1296.36 119.178 1306.1 116.622 1317.11 116.622C1335 116.622 1348.37 121.931 1357.22 132.549C1366.27 143.167 1370.79 158.504 1370.79 178.561V266.455H1346.01V181.51C1346.01 168.532 1343.16 158.406 1337.46 151.13C1331.76 143.659 1322.91 139.923 1310.92 139.923C1299.31 139.923 1289.48 143.953 1281.42 152.015C1273.36 159.881 1269.33 171.285 1269.33 186.229V266.455H1244.55Z" fill="currentColor"></path><path d="M1146.72 269.994C1132.95 269.994 1120.76 266.848 1110.14 260.556C1099.72 254.067 1091.46 245.12 1085.37 233.716C1079.27 222.114 1076.22 208.645 1076.22 193.308C1076.22 177.971 1079.17 164.6 1085.07 153.195C1091.17 141.594 1099.52 132.647 1110.14 126.355C1120.76 119.866 1133.15 116.622 1147.31 116.622C1161.46 116.622 1173.56 119.866 1183.58 126.355C1193.61 132.647 1201.28 141.004 1206.59 151.425C1211.9 161.847 1214.55 173.055 1214.55 185.049C1214.55 187.212 1214.45 189.375 1214.26 191.538C1214.26 193.701 1214.26 196.159 1214.26 198.912H1100.7C1101.29 209.727 1103.75 218.772 1108.08 226.047C1112.6 233.126 1118.2 238.435 1124.89 241.974C1131.77 245.513 1139.05 247.283 1146.72 247.283C1157.53 247.283 1165.99 245.022 1172.08 240.499C1178.18 235.977 1182.8 229.685 1185.94 221.623H1210.42C1207.08 235.19 1200.1 246.693 1189.48 256.131C1178.86 265.373 1164.61 269.994 1146.72 269.994ZM1146.72 138.743C1135.31 138.743 1125.28 142.184 1116.63 149.066C1108.18 155.948 1102.97 165.583 1101 177.971H1190.07C1189.29 165.779 1184.86 156.243 1176.8 149.361C1168.93 142.282 1158.91 138.743 1146.72 138.743Z" fill="currentColor"></path><path d="M934.677 266.455V245.218H972.135V148.771C972.135 143.855 969.776 141.397 965.057 141.397H938.512V120.161H974.2C980.689 120.161 985.899 121.931 989.832 125.47C993.764 129.01 995.731 134.22 995.731 141.102V147.296H996.911C999.27 137.465 1003.69 129.894 1010.18 124.585C1016.87 119.276 1026.11 116.622 1037.91 116.622H1064.75V142.872H1034.37C1022.37 142.872 1013.13 146.903 1006.64 154.965C1000.15 162.83 996.911 172.957 996.911 185.344V245.218H1042.92V266.455H934.677Z" fill="currentColor"></path><path d="M757.801 266.464L822.393 60.001H851.003L915.3 266.464H888.165L873.123 215.143H799.977L784.935 266.464H757.801ZM835.96 94.8047L806.171 194.497H866.929L837.14 94.8047H835.96Z" fill="currentColor"></path><path d="M585.938 266.464V60.001H612.483L659.674 158.218L706.864 60.001H733.409V266.464H709.224V107.782L669.112 191.252H650.235L610.123 108.077V266.464H585.938Z" fill="currentColor"></path><path d="M420.007 266.464V60.001H444.783V244.048H549.487V266.464H420.007Z" fill="currentColor"></path><g clip-path="url(#clip0_900_2452)"><path d="M325.196 45.8314C325.196 45.7153 325.196 45.5991 325.196 45.483V45.3282C325.196 41.554 323.319 38.8249 322.254 37.5088C321.035 35.9991 319.564 34.7411 318.209 33.7153C315.461 31.6443 311.822 29.5927 307.68 27.5991C299.3 23.5733 287.571 19.1991 273.365 15.1346C244.952 7.04431 205.836 -0.000854492 162.617 -0.000854492C119.399 -0.000854492 80.2636 7.04431 51.8317 15.154C37.6447 19.1991 25.8965 23.5927 17.5159 27.6185C13.374 29.612 9.73537 31.6637 6.98702 33.7346C5.63219 34.7604 4.16124 36.0185 2.9419 37.5282C1.91611 38.8249 0.0387092 41.554 0.0387092 45.3282C0.0387092 45.3475 0.0387092 45.3862 0.0387092 45.4056C0.0387092 45.4249 0.0387092 45.4637 0.0387092 45.483C0.0387092 45.5991 0.0387092 45.7153 0.0387092 45.8314H0V274.838H0.0387092C0.0387092 278.844 2.0903 281.689 3.67738 283.277C5.2451 284.844 7.04508 285.889 8.53539 286.625C11.5547 288.115 15.3869 289.296 19.4901 290.264C27.8513 292.257 39.5608 293.98 53.5349 295.393C81.6184 298.238 120.192 299.98 162.637 299.98C205.082 299.98 243.636 298.238 271.739 295.393C285.713 293.98 297.422 292.257 305.784 290.264C309.887 289.277 313.719 288.115 316.738 286.625C318.229 285.889 320.029 284.825 321.596 283.277C323.183 281.689 325.235 278.844 325.235 274.838H325.274V45.8314H325.235H325.196ZM173.243 186.889V160.741C173.243 152.322 176.282 144.038 182.262 138.135C187.566 132.889 194.591 129.696 202.294 129.696C212.107 129.696 220.817 134.864 226.275 142.877C230.01 148.354 231.772 154.954 231.772 161.593V185.186C214.043 186.154 194.243 186.773 173.224 186.928L173.243 186.889ZM173.243 100.741C173.243 92.3217 176.282 84.0379 182.262 78.1346C187.566 72.8895 194.591 69.6959 202.294 69.6959C212.107 69.6959 220.817 74.8637 226.275 82.8766C230.01 88.354 231.772 94.954 231.772 101.593V107.767C214.043 108.735 194.243 109.354 173.224 109.509V100.78L173.243 100.741ZM301.177 177.27C294.093 179.051 283.429 180.754 269.745 182.206C263.997 182.825 257.784 183.386 251.145 183.889V155.225C251.145 145.412 255.481 135.909 263.397 130.083C268.042 126.677 273.519 124.625 279.248 124.625C282.287 124.625 285.229 125.128 287.977 126.077C298.874 129.793 305.9 140.457 305.9 151.973V175.877C304.738 176.283 303.19 176.767 301.197 177.27H301.177ZM251.145 97.5862C251.145 88.4508 254.784 79.5282 261.694 73.5475C266.552 69.3475 272.494 66.7733 278.745 66.7733C285.926 66.7733 292.468 69.754 297.422 74.6508C303.035 80.2056 305.88 87.9669 305.88 95.8637V98.4572C304.719 98.8637 303.171 99.3475 301.177 99.8508C294.093 101.631 283.429 103.335 269.745 104.786C263.997 105.406 257.784 105.967 251.145 106.47V97.5862ZM47.9027 66.9669C59.0509 66.9669 68.6895 72.154 73.3734 81.3669C75.212 84.9862 75.9862 89.0314 75.9862 93.0959V106.606C68.6315 106.064 61.7799 105.444 55.4897 104.786C41.806 103.335 31.1416 101.631 24.0578 99.8508C22.0643 99.3475 20.5159 98.883 19.3546 98.4766C19.4514 81.0766 32.1867 66.9862 47.8833 66.9862L47.9027 66.9669ZM95.3408 185.264V161.612C95.3408 155.631 96.7344 149.67 99.8118 144.541C105.173 135.599 114.386 129.696 124.857 129.696C132.54 129.696 139.547 132.87 144.831 138.077C150.831 143.98 153.869 152.244 153.869 160.664V186.909C132.908 186.773 113.108 186.212 95.3215 185.264H95.3408ZM153.889 109.489C132.928 109.354 113.128 108.793 95.3408 107.844V101.612C95.3408 95.6314 96.7344 89.6701 99.8118 84.5411C105.173 75.5991 114.386 69.6959 124.857 69.6959C132.54 69.6959 139.547 72.8701 144.831 78.0766C150.831 83.9798 153.869 92.2443 153.869 100.664V109.489H153.889ZM19.3933 154.877C19.3933 138.173 32.1674 124.625 47.9414 124.625C53.6704 124.625 59.1284 126.657 63.7541 130.064C71.6701 135.87 76.0056 145.354 76.0056 155.167V184.044C68.6508 183.502 61.7993 182.883 55.509 182.225C41.8253 180.773 31.1609 179.07 24.0771 177.289C22.0836 176.786 20.5352 176.322 19.374 175.896L19.4127 154.896L19.3933 154.877ZM19.3546 274.838V274.064C19.374 274.315 19.3933 274.567 19.3933 274.838H19.3546ZM19.3933 234.231C19.3933 217.528 32.1674 203.98 47.9414 203.98C53.6704 203.98 59.1284 206.012 63.7541 209.418C71.6701 215.225 76.0056 224.709 76.0056 234.522V277.896C68.6508 277.373 61.7799 276.793 55.4897 276.154C41.806 274.76 31.1029 273.154 23.9997 271.451C22.0643 270.986 20.5352 270.541 19.374 270.173L19.4127 234.251L19.3933 234.231ZM95.3408 279.057V239.012C95.3408 233.031 96.7344 227.07 99.8118 221.941C105.173 212.999 114.386 207.096 124.857 207.096C132.54 207.096 139.547 210.27 144.831 215.477C150.831 221.38 153.869 229.644 153.869 238.064V280.625C132.908 280.509 113.108 279.948 95.3215 279.057H95.3408ZM173.243 280.606V238.064C173.243 229.664 176.282 221.38 182.282 215.477C187.585 210.27 194.572 207.096 202.256 207.096C212.746 207.096 221.959 212.999 227.32 221.941C230.397 227.07 231.791 233.031 231.791 239.012V278.941C214.062 279.87 194.262 280.431 173.243 280.586V280.606ZM305.88 274.838H305.842C305.842 274.567 305.842 274.315 305.88 274.064V274.838ZM301.255 271.451C294.151 273.154 283.448 274.78 269.765 276.154C264.016 276.735 257.784 277.277 251.145 277.76V234.58C251.145 224.767 255.481 215.264 263.397 209.438C268.042 206.031 273.519 203.98 279.248 203.98C282.287 203.98 285.229 204.483 287.977 205.431C298.874 209.148 305.9 219.812 305.9 231.328V270.154C304.738 270.541 303.209 270.967 301.274 271.431L301.255 271.451Z" fill="currentColor"></path></g><defs><clippath id="clip0_900_2452"><rect width="325.235" height="300" fill="white"></rect></clippath></defs></svg></div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down text-header-primary mt-1.5 h-4 w-4 flex-shrink-0 transition-transform"><path d="m6 9 6 6 6-6"></path></svg></div></button></li></ul><button class="hover:bg-surface-tertiary flex-shrink-0 rounded-md p-1.5 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-panel-left-close text-text-primary size-4"><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M9 3v18"></path><path d="m16 15-3-3 3-3"></path></svg></button></div></div><div data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2"><ul data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-1"><li data-sidebar="menu-item" class="group/menu-item relative"><a class="peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left outline-none ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&amp;&gt;span:last-child]:truncate [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 [&amp;&gt;span]:group-data-[collapsible=icon]:hidden hover:bg-sidebar-accent hover:text-sidebar-accent-foreground h-8 text-sm text-text-primary data-[active=true]:bg-sidebar-accent" data-sidebar="menu-button" data-size="default" data-active="false" data-state="closed" data-slot="tooltip-trigger" href="https://lmarena.ai/zh/c/new?mode=direct"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen h-4 w-4"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"></path></svg><span>New Chat</span></a></li><li data-sidebar="menu-item" class="group/menu-item relative"><a class="peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left outline-none ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&amp;&gt;span:last-child]:truncate [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 [&amp;&gt;span]:group-data-[collapsible=icon]:hidden hover:bg-sidebar-accent hover:text-sidebar-accent-foreground h-8 text-sm text-text-primary group/leaderboard" data-sidebar="menu-button" data-size="default" data-active="false" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="radix-_R_jj9fl2ppfivb_" data-state="closed" data-slot="tooltip-trigger" href="https://lmarena.ai/zh/leaderboard"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy h-4 w-4"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><span>Leaderboard</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right ml-auto h-4 w-4 opacity-0 transition-opacity group-hover/leaderboard:opacity-100"><path d="m9 18 6-6-6-6"></path></svg></a></li></ul></div><div data-sidebar="content" class="flex min-h-0 flex-col gap-2 overflow-y-auto overflow-x-hidden group-data-[collapsible=icon]:overflow-hidden flex-1"><div data-sidebar="group" class="relative flex w-full min-w-0 flex-col p-2"><div data-sidebar="group-label" class="ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md outline-none transition-[margin,opacity] duration-150 ease-linear focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0 text-text-tertiary px-2 text-xs font-medium">Today</div><div data-sidebar="group-content" class="w-full text-sm"><ul data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-1"><li data-sidebar="menu-item" class="group/menu-item relative"><a class="peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left outline-none ring-sidebar-ring transition-[width,height,padding] focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&amp;&gt;span:last-child]:truncate [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 [&amp;&gt;span]:group-data-[collapsible=icon]:hidden hover:bg-sidebar-accent text-sm group/session text-text-secondary hover:text-text-primary data-[active=true]:text-text-primary h-auto py-1.5" data-sidebar="menu-button" data-size="default" data-active="true" data-state="closed" data-slot="tooltip-trigger" href="https://lmarena.ai/zh/c/019bb20e-3a6d-7296-b16e-aab6357c7b8c"><div class="bg-surface-secondary flex gap-0.5 rounded-full px-1 py-1"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white size-2.5"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg></div><span class="truncate text-sm">/* 
    Sin Wind Spring Generator V5.5 (Root Parent Fix)
    - Fix: Solves "transform in undefined" </span></a><button data-sidebar="menu-action" class="text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-none focus-visible:ring-2 [&amp;&gt;svg]:size-4 [&amp;&gt;svg]:shrink-0 after:absolute after:-inset-2 after:md:hidden peer-data-[size=sm]/menu-button:top-1 peer-data-[size=default]/menu-button:top-1.5 peer-data-[size=lg]/menu-button:top-2.5 group-data-[collapsible=icon]:hidden peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0 transition-opacity opacity-0 group-hover/session:opacity-100" type="button" id="radix-_r_4u_" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ellipsis h-4 w-4"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg><span class="sr-only">More</span></button></li></ul></div></div></div><div data-sidebar="footer" class="p-2 flex flex-col gap-2"><ul data-sidebar="menu" class="flex w-full min-w-0 flex-col gap-1"></ul><div data-orientation="horizontal" role="none" class="shrink-0 h-[1px] bg-sidebar-border -mx-2 w-auto" data-sidebar="separator"></div><div class="flex items-center justify-between px-2 text-[10px]"><a class="text-text-tertiary hover:text-text-secondary whitespace-nowrap" target="_blank" href="https://lmarena.ai/zh/terms-of-use">Terms of Use</a><a class="text-text-tertiary hover:text-text-secondary whitespace-nowrap" target="_blank" href="https://lmarena.ai/zh/privacy-policy">Privacy Policy</a><button class="text-text-tertiary hover:text-text-secondary whitespace-nowrap text-left">Cookies</button></div></div></div></div></div><main class="bg-background relative min-h-svh w-full flex-1 overflow-x-auto md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow pt-[var(--app-banner-height,0px)] flex h-svh flex-col"><main id="root-portal-target" class="h-full"><main class="h-full flex-1"><div id="chat-area" class="relative flex h-full flex-col overflow-hidden overscroll-none"><div class="bg-surface-primary border-border-faint flex-shrink-0 border-b"><div class="flex flex-col md:hidden"><div class="grid min-h-14 w-full flex-none grid-cols-[1fr_auto_1fr] items-center gap-2 px-3 py-2.5"><div class="flex justify-start"><div class="rounded-md"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 py-2 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary touch-hitbox px-2" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-panel-right-close"><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M15 3v18"></path><path d="m8 9 3 3-3 3"></path></svg></button></div></div><div class="flex justify-center"><button type="button" role="combobox" aria-controls="radix-_R_15anpfiupfd9fl2ppfivb_" aria-expanded="false" aria-autocomplete="none" dir="ltr" data-state="closed" class="border-border text-header-secondary hover:text-header-primary data-[state=open]:text-text-tertiary ring-offset-background placeholder:text-muted-foreground focus:ring-ring group flex items-center justify-between whitespace-nowrap rounded-md border px-3 py-2 text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&amp;&gt;span]:block [&amp;&gt;span]:truncate h-[29px] w-[280px] max-w-max border-none"><span style="pointer-events:none"><div class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal h-[18px] w-[18px]"><path d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z"></path><path d="M6 12h16"></path></svg><p class="font-heading text-base font-medium">Direct Chat</p></div></span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down h-[18px] w-[18px] transition-transform duration-200 group-data-[state=open]:-rotate-180" aria-hidden="true"><path d="m6 9 6 6 6-6"></path></svg></button></div><div class="flex justify-end"><a class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 h-8 w-8 text-interactive-active hover:text-interactive-normal active:text-text-tertiary touch-hitbox" type="button" href="https://lmarena.ai/zh"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"></path></svg></a></div><div class="col-span-3 flex w-full"><button class="inline-flex items-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 py-2 text-sm font-medium text-interactive-active border border-border-faint bg-transparent hover:text-interactive-normal hover:bg-surface-secondary active:text-text-tertiary min-w-0 max-w-full flex-1 flex-shrink basis-[200px] justify-between gap-0.5 px-2 md:h-auto md:border-0 md:px-4" type="button" role="combobox" aria-expanded="false" aria-haspopup="dialog" aria-controls="radix-_R_25anpfiupfd9fl2ppfivb_" data-state="closed"><div class="flex min-w-0 items-center gap-2"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white size-[18px] flex-none"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="min-w-0 truncate">claude-opus-4-5-20251101-thinking-32k</span></div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-[18px] flex-none transition-transform"><path d="m6 9 6 6 6-6"></path></svg></button></div></div></div><div class="hidden h-12 items-center justify-between gap-2 px-4 md:flex"><div class="flex min-w-0 items-center justify-start gap-2"><button type="button" role="combobox" aria-controls="radix-_R_2panpfiupfd9fl2ppfivb_" aria-expanded="false" aria-autocomplete="none" dir="ltr" data-state="closed" class="border-border text-header-secondary hover:text-header-primary data-[state=open]:text-text-tertiary ring-offset-background placeholder:text-muted-foreground focus:ring-ring group flex items-center justify-between whitespace-nowrap rounded-md border px-3 py-2 text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&amp;&gt;span]:block [&amp;&gt;span]:truncate h-[29px] w-[280px] max-w-max border-none"><span style="pointer-events:none"><div class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal h-[18px] w-[18px]"><path d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z"></path><path d="M6 12h16"></path></svg><p class="font-heading text-base font-medium">Direct Chat</p></div></span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down h-[18px] w-[18px] transition-transform duration-200 group-data-[state=open]:-rotate-180" aria-hidden="true"><path d="m6 9 6 6 6-6"></path></svg></button><button class="inline-flex items-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 py-2 text-sm font-medium text-interactive-active border border-border-faint bg-transparent hover:text-interactive-normal hover:bg-surface-secondary active:text-text-tertiary min-w-0 max-w-full flex-1 flex-shrink basis-[200px] justify-between gap-0.5 px-2 md:h-auto md:border-0 md:px-4" type="button" role="combobox" aria-expanded="false" aria-haspopup="dialog" aria-controls="radix-_R_4panpfiupfd9fl2ppfivb_" data-state="closed"><div class="flex min-w-0 items-center gap-2"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white size-[18px] flex-none"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="min-w-0 truncate">claude-opus-4-5-20251101-thinking-32k</span></div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-[18px] flex-none transition-transform"><path d="m6 9 6 6 6-6"></path></svg></button></div><div class="flex items-center gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 px-4 py-2 text-sm font-medium text-text-interactive-inverted bg-header-primary hover:bg-header-primary/90" type="button">Login</button></div></div></div><div class="flex min-h-0 flex-1 justify-center overflow-hidden overscroll-none"><main class="relative flex h-full min-w-0 flex-1 flex-col overflow-hidden overscroll-none outline-none" role="presentation" tabindex="0"><div class="relative flex min-h-0 flex-1 flex-col"><div class="absolute inset-0 flex flex-col"><div class="-mb-4 min-h-0 flex-1"><div dir="ltr" class="relative overflow-hidden h-full min-h-0 flex-1" style="position:relative;--radix-scroll-area-corner-width:0px;--radix-scroll-area-corner-height:0px"><style>[data-radix-scroll-area-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-scroll-area-viewport]::-webkit-scrollbar{display:none}</style><div data-radix-scroll-area-viewport="" class="h-full w-full rounded-[inherit] [&amp;&gt;div]:!block [&amp;&gt;div]:!h-full" style="overflow: hidden scroll;"><div style="min-width:100%;display:table"><div class="relative h-full w-full overscroll-none"><div class="flex flex-col items-center px-[--chat-padding] [--chat-padding:theme(spacing.4)]"><ol class="mt-8 flex w-full max-w-screen-xl grow flex-col-reverse justify-end gap-4 overscroll-none pb-2 duration-500"><div class="h-0"></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="open" class="not-prose mb-4"><button type="button" aria-controls="radix-_r_b_" aria-expanded="true" data-state="open" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for 13 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-180"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="open" id="radix-_r_b_" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style="--radix-collapsible-content-height: 541.5px; --radix-collapsible-content-width: 768px;"><div class="relative pl-6 pr-2"><div class="absolute bottom-0 left-1 top-0 w-px bg-gray-200 dark:bg-gray-800"></div><div class="space-y-4 size-full [&amp;&gt;*:first-child]:mt-0 [&amp;&gt;*:last-child]:mb-0 font-mono text-xs leading-relaxed"><p>用户提出了两个问题：</p><ol class="ml-4 list-outside list-decimal whitespace-normal" data-streamdown="ordered-list" node="[object Object]">
<li class="py-1" data-streamdown="list-item" node="[object Object]">VirtualEnd_1 在计算后应该被清理掉（即使 debugVirtualEnd 没有勾选）</li>
<li class="py-1" data-streamdown="list-item" node="[object Object]">惯性系统用回之前的第一版（V7.2那个简单版本），但要能K帧，并且不要锁死数值范围</li>
</ol><p>让我回顾一下V7.2的惯性系统：</p><div class="my-4 w-full overflow-hidden rounded-xl border" data-code-block-container="true" data-language=""><div class="flex items-center justify-between bg-muted/80 p-3 text-muted-foreground text-xs" data-code-block-header="true" data-language=""><span class="ml-1 font-mono lowercase"></span><div class="flex items-center gap-2"><button class="cursor-pointer p-1 text-muted-foreground transition-all hover:text-foreground" title="Download file" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download" aria-hidden="true"><path d="M12 15V3"></path><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><path d="m7 10 5 5 5-5"></path></svg></button><button class="cursor-pointer p-1 text-muted-foreground transition-all hover:text-foreground" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy" aria-hidden="true"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div><div class="w-full"><div class="min-w-full"><div class="dark:hidden overflow-x-auto border-t" data-code-block="true" data-language="" data-streamdown="code-block"><pre class="overflow-x-auto font-mono text-xs p-4 bg-muted/40" tabindex="0"><code><span class="line"><span>-- ★ 惯性参数</span></span>
<span class="line"><span>local inertiaStrength = spn_inertia.value</span></span>
<span class="line"><span>local inertiaDamping = spn_inertiaDamping.value</span></span>
<span class="line"><span>local massDistribution = spn_massDistribution.value</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 惯性计算：</span></span>
<span class="line"><span>if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local inertiaPos = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>    currentPos = currentPos + inertiaPos</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 更新速度</span></span>
<span class="line"><span>local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>local newVelocity = newPos - prevPositions[j]</span></span>
<span class="line"><span>velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)</span></span>
<span class="line"><span>prevPositions[j] = newPos</span></span>
<span class="line"><span></span></span></code></pre></div><div class="hidden dark:block overflow-x-auto border-t" data-code-block="true" data-language="" data-streamdown="code-block"><pre class="overflow-x-auto font-mono text-xs p-4 bg-muted/40" tabindex="0"><code><span class="line"><span>-- ★ 惯性参数</span></span>
<span class="line"><span>local inertiaStrength = spn_inertia.value</span></span>
<span class="line"><span>local inertiaDamping = spn_inertiaDamping.value</span></span>
<span class="line"><span>local massDistribution = spn_massDistribution.value</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 惯性计算：</span></span>
<span class="line"><span>if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local inertiaPos = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>    currentPos = currentPos + inertiaPos</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 更新速度</span></span>
<span class="line"><span>local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>local newVelocity = newPos - prevPositions[j]</span></span>
<span class="line"><span>velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)</span></span>
<span class="line"><span>prevPositions[j] = newPos</span></span>
<span class="line"><span></span></span></code></pre></div></div></div></div><p>这个版本很简单直接：</p><ul class="ml-4 list-outside list-disc whitespace-normal" data-streamdown="unordered-list" node="[object Object]">
<li class="py-1" data-streamdown="list-item" node="[object Object]">inertiaStrength: 惯性强度</li>
<li class="py-1" data-streamdown="list-item" node="[object Object]">inertiaDamping: 惯性衰减（速度保持程度）</li>
<li class="py-1" data-streamdown="list-item" node="[object Object]">massDistribution: 质量分布</li>
</ul><p>用户希望：</p><ol class="ml-4 list-outside list-decimal whitespace-normal" data-streamdown="ordered-list" node="[object Object]">
<li class="py-1" data-streamdown="list-item" node="[object Object]">能K帧 - 放到控制器上</li>
<li class="py-1" data-streamdown="list-item" node="[object Object]">不锁死数值 - 扩大range范围</li>
</ol><p>让我修改代码：</p><p>需要在控制器上添加惯性参数并设置合理的范围：inertiaStrength 范围 [0, 5, 0.3]、inertiaDamping 范围 [0, 1, 0.95]、massDistribution 范围 [0, 5, 1.0]，这样既能K帧又不会限制数值。同时修复VirtualEnd_1的清理逻辑，确保在非debug模式下也能正确清理。</p></div></div></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>好的，我来修复VirtualEnd清理问题，并恢复简单有效的第一版惯性系统，同时让它可K帧且不锁死数值：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V8.0 Ultimate</span></span>
<span class="line"><span>    - 修复VirtualEnd清理问题</span></span>
<span class="line"><span>    - 恢复简单有效的惯性系统（可K帧，数值不锁死）</span></span>
<span class="line"><span>    - 所有核心参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V8.0" width:650</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:300 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:300 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 必须使用V8.0版本的控制器" style_sunken:true align:#center color:(color 255 150 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:200 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:200 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:200 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localX_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localY_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转" range:[-90,90,8] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:190</span></span>
<span class="line"><span>        label lbl_empty0 "" width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:190</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        label lbl_empty1 "" width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:120</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:150</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:630</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:630 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:100 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:100</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:100</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:100</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:100</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:100 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller_V80" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParamsV80" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 重力参数</span></span>
<span class="line"><span>                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX</span></span>
<span class="line"><span>                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY</span></span>
<span class="line"><span>                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 简单惯性系统 (可K帧，不锁死数值)</span></span>
<span class="line"><span>                    inertiaStrength type:#float default:0.3 animatable:true ui:spn_inertia</span></span>
<span class="line"><span>                    inertiaDamping type:#float default:0.95 animatable:true ui:spn_inertiaDamp</span></span>
<span class="line"><span>                    massDistribution type:#float default:1.0 animatable:true ui:spn_massDist</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 V8.0 (可K帧)" width:320</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 重力 (XYZ可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_gravX "重力 X:" range:[-999,999,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravY "重力 Y:" range:[-999,999,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravZ "重力 Z:" range:[-999,999,0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 惯性系统 (简单有效)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_inertia "惯性强度:" range:[0,10,0.3] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"速度延续强度，越大惯性越强"</span></span>
<span class="line"><span>                        spinner spn_inertiaDamp "惯性衰减:" range:[0,1,0.95] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"速度保持程度，越大速度保持越久"</span></span>
<span class="line"><span>                        spinner spn_massDist "质量分布:" range:[0,10,1.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"0=均匀, 1+=末端更重"</span></span>
<span class="line"><span>                        label lbl_tip1 "强度0.3+衰减0.95=自然惯性" align:#left</span></span>
<span class="line"><span>                        label lbl_tip2 "强度0.8+衰减0.98=强惯性" align:#left</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1: (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localX_posStr.value else d = d * spn_localX_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2: (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localY_posStr.value else d = d * spn_localY_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3: (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localZ_posStr.value else d = d * spn_localZ_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateMassFactor boneIndex totalBones massDistribution =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if massDistribution == 0 then return 1.0</span></span>
<span class="line"><span>        local progress = boneIndex as float / totalBones as float</span></span>
<span class="line"><span>        return 1.0 + (progress * massDistribution)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do </span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do </span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do </span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    rotate objectArray[a][b] (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then </span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else </span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM</span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform </span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then </span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else </span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器V8.0已创建！\n\n惯性系统说明：\n- 惯性强度: 速度延续强度\n- 惯性衰减: 速度保持程度\n- 质量分布: 末端权重\n\n所有参数都可K帧，数值不锁死。" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not isProperty ctrlObj "inertiaStrength" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请重新创建V8.0版本控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 惯性系统数据</span></span>
<span class="line"><span>        local allVelocities = #()</span></span>
<span class="line"><span>        local allPrevPositions = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                local velocities = #()</span></span>
<span class="line"><span>                local prevPositions = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    append boneLengths (getBoneLength b)</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions b.transform.pos</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for v = 1 to 3 do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local vTM = matrix3 1</span></span>
<span class="line"><span>                    vTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                    append boneRelTMs vTM</span></span>
<span class="line"><span>                    append boneLengths virtualLen</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local parentTM</span></span>
<span class="line"><span>                    if v == 1 then </span></span>
<span class="line"><span>                        parentTM = lastBone.transform </span></span>
<span class="line"><span>                    else </span></span>
<span class="line"><span>                        parentTM = simTMs[simTMs.count]</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local vWorldTM = vTM * parentTM</span></span>
<span class="line"><span>                    append simTMs vWorldTM</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions vWorldTM.pos</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then </span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else </span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                append allVelocities velocities</span></span>
<span class="line"><span>                append allPrevPositions prevPositions</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 调试用虚拟末端helper</span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true wirecolor:(color 255 0 255) pos:simTMs[chain.count + 1].pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %)...\n" loopsCount</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 循环缝合</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then </span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then </span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else if chain[j].parent != undefined then </span></span>
<span class="line"><span>                                    chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 读取控制器参数</span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local gravityX = at time t ctrlObj.gravityX</span></span>
<span class="line"><span>                local gravityY = at time t ctrlObj.gravityY</span></span>
<span class="line"><span>                local gravityZ = at time t ctrlObj.gravityZ</span></span>
<span class="line"><span>                local gravityVec = [gravityX, gravityY, gravityZ]</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 惯性参数 (可K帧)</span></span>
<span class="line"><span>                local inertiaStrength = at time t ctrlObj.inertiaStrength</span></span>
<span class="line"><span>                local inertiaDamping = at time t ctrlObj.inertiaDamping</span></span>
<span class="line"><span>                local massDistribution = at time t ctrlObj.massDistribution</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        local velocities = allVelocities[cIdx]</span></span>
<span class="line"><span>                        local prevPositions = allPrevPositions[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local newPosX = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local newPosY = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local newPosZ = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [newPosX, newPosY, newPosZ]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 局部Sin</span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local lsX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local lsY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local lsZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat lsX) * (quat lsY) * (quat lsZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then </span></span>
<span class="line"><span>                                currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then </span></span>
<span class="line"><span>                                currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else </span></span>
<span class="line"><span>                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 末端阻尼</span></span>
<span class="line"><span>                            local boneDamping</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 质量因子</span></span>
<span class="line"><span>                            local massFactor = calculateMassFactor j totalNodes massDistribution</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 简单惯性计算</span></span>
<span class="line"><span>                            if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                -- 应用惯性（速度 * 强度 * 质量）</span></span>
<span class="line"><span>                                local inertiaOffset = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>                                currentPos = currentPos + inertiaOffset</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 应用重力</span></span>
<span class="line"><span>                            currentPos = currentPos + gravityVec * massFactor * 0.01</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1</span></span>
<span class="line"><span>                                if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1</span></span>
<span class="line"><span>                                if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1</span></span>
<span class="line"><span>                                if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3) * (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveMaxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 计算并更新速度</span></span>
<span class="line"><span>                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>                            local newVelocity = newPos - prevPositions[j]</span></span>
<span class="line"><span>                            velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)</span></span>
<span class="line"><span>                            prevPositions[j] = newPos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then </span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then </span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else if chain[j].parent != undefined then </span></span>
<span class="line"><span>                                            chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                            chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 调试helper更新</span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then </span></span>
<span class="line"><span>                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- 更新惯性数据</span></span>
<span class="line"><span>                        allVelocities[cIdx] = velocities</span></span>
<span class="line"><span>                        allPrevPositions[cIdx] = prevPositions</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 清理虚拟末端helper（无论是否debug模式）</span></span>
<span class="line"><span>        for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            try</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if isValidNode h then delete h</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            catch()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 额外清理场景中可能残留的VirtualEnd</span></span>
<span class="line"><span>        local strayHelpers = for obj in objects where (matchPattern obj.name pattern:"VirtualEnd_*") collect obj</span></span>
<span class="line"><span>        for h in strayHelpers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            try (delete h) catch()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        if strayHelpers.count &gt; 0 then format "清理了 % 个残留的虚拟末端helper\n" strayHelpers.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        BoneLoopStart (sortArrayByHeirarchy (selection as array))</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        spn_localX_posStr.value = 1</span></span>
<span class="line"><span>        spn_localX_negStr.value = 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        spn_localY_posStr.value = 1</span></span>
<span class="line"><span>        spn_localY_negStr.value = 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        spn_localZ_posStr.value = 1</span></span>
<span class="line"><span>        spn_localZ_negStr.value = 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1</span></span>
<span class="line"><span>        spn_blend_y.value = 1</span></span>
<span class="line"><span>        spn_blend_z.value = 1</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local tf = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = tf</span></span>
<span class="line"><span>        spn_localY_period.value = tf</span></span>
<span class="line"><span>        spn_localZ_period.value = tf</span></span>
<span class="line"><span>        format "Sin+Spring V8.0 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring V8.0 惯性系统说明:\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "惯性强度 (0-10, 可K帧):\n"</span></span>
<span class="line"><span>format "  速度延续的强度\n"</span></span>
<span class="line"><span>format "  0=无惯性, 0.3=轻微, 1+=强惯性\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "惯性衰减 (0-1, 可K帧):\n"</span></span>
<span class="line"><span>format "  速度保持程度\n"</span></span>
<span class="line"><span>format "  0=立即停止, 0.95=自然衰减, 0.99=很慢衰减\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "质量分布 (0-10, 可K帧):\n"</span></span>
<span class="line"><span>format "  0=均匀, 1=末端稍重, 2+=末端很重\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "推荐组合:\n"</span></span>
<span class="line"><span>format "  自然惯性: 强度0.3, 衰减0.95\n"</span></span>
<span class="line"><span>format "  强惯性:   强度0.8, 衰减0.98\n"</span></span>
<span class="line"><span>format "  重物感:   强度0.5, 衰减0.95, 质量2\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>V8.0 修复内容：</h2><h3>1. <strong>VirtualEnd清理问题修复</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- 计算完成后清理所有虚拟末端helper</span></span>
<span class="line"><span>for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    try</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if isValidNode h then delete h</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    catch()</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>allVirtualEndHelpers = #()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 额外清理场景中可能残留的VirtualEnd</span></span>
<span class="line"><span>local strayHelpers = for obj in objects where (matchPattern obj.name pattern:"VirtualEnd_*") collect obj</span></span>
<span class="line"><span>for h in strayHelpers do</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    try (delete h) catch()</span></span>
<span class="line"><span>)</span></span></code></pre></div></div></pre><h3>2. <strong>恢复简单有效的惯性系统</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- 简单惯性计算</span></span>
<span class="line"><span>if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local inertiaOffset = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>    currentPos = currentPos + inertiaOffset</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 速度更新</span></span>
<span class="line"><span>local newVelocity = newPos - prevPositions[j]</span></span>
<span class="line"><span>velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)</span></span></code></pre></div></div></pre><h3>3. <strong>惯性参数可K帧且不锁死</strong></h3><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">范围</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">默认值</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">惯性强度</td><td node="[object Object]" class="px-3 py-2">0-10</td><td node="[object Object]" class="px-3 py-2">0.3</td><td node="[object Object]" class="px-3 py-2">速度延续强度</td></tr><tr><td node="[object Object]" class="px-3 py-2">惯性衰减</td><td node="[object Object]" class="px-3 py-2">0-1</td><td node="[object Object]" class="px-3 py-2">0.95</td><td node="[object Object]" class="px-3 py-2">速度保持程度</td></tr><tr><td node="[object Object]" class="px-3 py-2">质量分布</td><td node="[object Object]" class="px-3 py-2">0-10</td><td node="[object Object]" class="px-3 py-2">1.0</td><td node="[object Object]" class="px-3 py-2">末端权重</td></tr></tbody></table></div><h3>4. <strong>推荐参数组合</strong></h3><ul>
<li><strong>自然惯性</strong>: 强度=0.3, 衰减=0.95</li>
<li><strong>强惯性</strong>: 强度=0.8, 衰减=0.98</li>
<li><strong>重物感</strong>: 强度=0.5, 衰减=0.95, 质量=2</li>
<li><strong>K帧渐变</strong>: 从强度0渐变到0.5实现惯性渐入</li>
</ul></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_r_9_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>VirtualEnd_1在计算后应该清理的，惯性系统还是用回之前第一版吧，但是我要他能K帧，然后不要锁死我的数值</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5d1hjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->2 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5d1hjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>抱歉，MaxScript中多行数组语法有问题。让我修复这个语法错误：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.9 Ultimate</span></span>
<span class="line"><span>    - 修复惯性系统：基础惯性 + 阻尼振荡</span></span>
<span class="line"><span>    - 更直观的参数控制</span></span>
<span class="line"><span>    - 所有参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.9" width:650</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:300 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:300 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 必须使用V7.9版本的控制器" style_sunken:true align:#center color:(color 255 150 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:200 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:200 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:200 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localX_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localY_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转" range:[-90,90,8] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:190</span></span>
<span class="line"><span>        label lbl_empty0 "" width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:190</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        label lbl_empty1 "" width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:120</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:150</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:630</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:630 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:100 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:100</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:100</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:100</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:100</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:100 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller_V79" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParamsV79" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 重力参数</span></span>
<span class="line"><span>                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX</span></span>
<span class="line"><span>                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY</span></span>
<span class="line"><span>                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 惯性系统 (简化但有效)</span></span>
<span class="line"><span>                    inertiaEnable type:#float default:1.0 animatable:true ui:spn_inertiaEnable</span></span>
<span class="line"><span>                    inertiaMomentum type:#float default:0.85 animatable:true ui:spn_momentum</span></span>
<span class="line"><span>                    inertiaOscFreq type:#float default:3.0 animatable:true ui:spn_oscFreq</span></span>
<span class="line"><span>                    inertiaOscAmp type:#float default:0.5 animatable:true ui:spn_oscAmp</span></span>
<span class="line"><span>                    inertiaOscDecay type:#float default:0.92 animatable:true ui:spn_oscDecay</span></span>
<span class="line"><span>                    inertiaMass type:#float default:1.0 animatable:true ui:spn_mass</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 V7.9 (可K帧)" width:320</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 重力 (XYZ可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_gravX "重力 X:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravY "重力 Y:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravZ "重力 Z:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 惯性系统 (余韵晃动)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_inertiaEnable "惯性开关:" range:[0,1,1.0] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"0=关闭, 1=开启"</span></span>
<span class="line"><span>                        spinner spn_momentum "动量保持:" range:[0.5,0.99,0.85] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"速度保持程度，越大惯性越强"</span></span>
<span class="line"><span>                        spinner spn_oscFreq "振荡频率:" range:[0.5,15,3.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"停止后晃动的快慢"</span></span>
<span class="line"><span>                        spinner spn_oscAmp "振荡振幅:" range:[0,3,0.5] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"停止后晃动的幅度"</span></span>
<span class="line"><span>                        spinner spn_oscDecay "振荡衰减:" range:[0.5,0.99,0.92] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"晃动能量保持，越大晃动越久"</span></span>
<span class="line"><span>                        spinner spn_mass "质量分布:" range:[0,3,1.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"0=均匀, 1+=末端更重"</span></span>
<span class="line"><span>                        label lbl_tip1 "动量0.9+振荡0.5=自然余韵" align:#left</span></span>
<span class="line"><span>                        label lbl_tip2 "振荡频率高=快速抖动" align:#left</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1: (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localX_posStr.value else d = d * spn_localX_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2: (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localY_posStr.value else d = d * spn_localY_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3: (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localZ_posStr.value else d = d * spn_localZ_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateMassFactor boneIndex totalBones massDistribution =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if massDistribution == 0 then return 1.0</span></span>
<span class="line"><span>        local progress = boneIndex as float / totalBones as float</span></span>
<span class="line"><span>        return 1.0 + (progress * massDistribution)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do </span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do </span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do </span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    rotate objectArray[a][b] (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then </span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else </span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM</span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform </span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then </span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else </span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器V7.9已创建！\n\n惯性系统说明：\n- 动量保持: 速度延续程度 (0.85-0.95推荐)\n- 振荡频率: 晃动快慢 (1-5正常, 8+抖动)\n- 振荡振幅: 晃动幅度\n- 振荡衰减: 晃动持续时间\n- 质量分布: 末端权重" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not isProperty ctrlObj "inertiaMomentum" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请重新创建V7.9版本控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 惯性系统数据</span></span>
<span class="line"><span>        local allVelocities = #()</span></span>
<span class="line"><span>        local allPrevPositions = #()</span></span>
<span class="line"><span>        local allOscPhases = #()</span></span>
<span class="line"><span>        local allOscEnergies = #()</span></span>
<span class="line"><span>        local allPrevVelocities = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                local velocities = #()</span></span>
<span class="line"><span>                local prevPositions = #()</span></span>
<span class="line"><span>                local oscPhases = #()</span></span>
<span class="line"><span>                local oscEnergies = #()</span></span>
<span class="line"><span>                local prevVelocities = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    append boneLengths (getBoneLength b)</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions b.transform.pos</span></span>
<span class="line"><span>                    append oscPhases (random 0.0 360.0)</span></span>
<span class="line"><span>                    append oscEnergies 0.0</span></span>
<span class="line"><span>                    append prevVelocities [0,0,0]</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for v = 1 to 3 do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local vTM = matrix3 1</span></span>
<span class="line"><span>                    vTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                    append boneRelTMs vTM</span></span>
<span class="line"><span>                    append boneLengths virtualLen</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local parentTM</span></span>
<span class="line"><span>                    if v == 1 then </span></span>
<span class="line"><span>                        parentTM = lastBone.transform </span></span>
<span class="line"><span>                    else </span></span>
<span class="line"><span>                        parentTM = simTMs[simTMs.count]</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local vWorldTM = vTM * parentTM</span></span>
<span class="line"><span>                    append simTMs vWorldTM</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions vWorldTM.pos</span></span>
<span class="line"><span>                    append oscPhases (random 0.0 360.0)</span></span>
<span class="line"><span>                    append oscEnergies 0.0</span></span>
<span class="line"><span>                    append prevVelocities [0,0,0]</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then </span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else </span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                append allVelocities velocities</span></span>
<span class="line"><span>                append allPrevPositions prevPositions</span></span>
<span class="line"><span>                append allOscPhases oscPhases</span></span>
<span class="line"><span>                append allOscEnergies oscEnergies</span></span>
<span class="line"><span>                append allPrevVelocities prevVelocities</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true wirecolor:(color 255 0 255) pos:simTMs[chain.count + 1].pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %)...\n" loopsCount</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 循环缝合</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then </span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then </span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else if chain[j].parent != undefined then </span></span>
<span class="line"><span>                                    chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 读取控制器参数</span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local gravityX = at time t ctrlObj.gravityX</span></span>
<span class="line"><span>                local gravityY = at time t ctrlObj.gravityY</span></span>
<span class="line"><span>                local gravityZ = at time t ctrlObj.gravityZ</span></span>
<span class="line"><span>                local gravityVec = [gravityX, gravityY, gravityZ]</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 惯性参数</span></span>
<span class="line"><span>                local inertiaEnable = at time t ctrlObj.inertiaEnable</span></span>
<span class="line"><span>                local momentum = at time t ctrlObj.inertiaMomentum</span></span>
<span class="line"><span>                local oscFreq = at time t ctrlObj.inertiaOscFreq</span></span>
<span class="line"><span>                local oscAmp = at time t ctrlObj.inertiaOscAmp</span></span>
<span class="line"><span>                local oscDecay = at time t ctrlObj.inertiaOscDecay</span></span>
<span class="line"><span>                local massParam = at time t ctrlObj.inertiaMass</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        local velocities = allVelocities[cIdx]</span></span>
<span class="line"><span>                        local prevPositions = allPrevPositions[cIdx]</span></span>
<span class="line"><span>                        local oscPhases = allOscPhases[cIdx]</span></span>
<span class="line"><span>                        local oscEnergies = allOscEnergies[cIdx]</span></span>
<span class="line"><span>                        local prevVelocities = allPrevVelocities[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 修复：分开计算每个分量</span></span>
<span class="line"><span>                            local newPosX = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local newPosY = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local newPosZ = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [newPosX, newPosY, newPosZ]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 局部Sin</span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local lsX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local lsY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local lsZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat lsX) * (quat lsY) * (quat lsZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then </span></span>
<span class="line"><span>                                currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then </span></span>
<span class="line"><span>                                currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else </span></span>
<span class="line"><span>                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 末端阻尼</span></span>
<span class="line"><span>                            local boneDamping</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 质量因子</span></span>
<span class="line"><span>                            local massFactor = calculateMassFactor j totalNodes massParam</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 惯性系统计算</span></span>
<span class="line"><span>                            if inertiaEnable &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                -- 1. 计算当前帧的速度</span></span>
<span class="line"><span>                                local currentVelocity = currentPos - prevPositions[j]</span></span>
<span class="line"><span>                                local velocityMag = length currentVelocity</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 2. 检测速度变化（减速/方向变化）→ 给振荡充能</span></span>
<span class="line"><span>                                local velocityChange = length (currentVelocity - prevVelocities[j])</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 当速度变化时（减速或改变方向），振荡能量增加</span></span>
<span class="line"><span>                                if velocityChange &gt; 0.01 then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    local energyInput = velocityChange * oscAmp * massFactor * inertiaEnable</span></span>
<span class="line"><span>                                    oscEnergies[j] = oscEnergies[j] + energyInput</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 3. 更新振荡相位</span></span>
<span class="line"><span>                                oscPhases[j] = oscPhases[j] + oscFreq * 10.0</span></span>
<span class="line"><span>                                if oscPhases[j] &gt; 360000 then oscPhases[j] = mod oscPhases[j] 360.0</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 4. 计算振荡偏移</span></span>
<span class="line"><span>                                local oscValue = sin(oscPhases[j]) * oscEnergies[j]</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 振荡方向：垂直于当前速度方向</span></span>
<span class="line"><span>                                local oscDir = [0,0,0]</span></span>
<span class="line"><span>                                if velocityMag &gt; 0.001 then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    oscDir = normalize (cross (normalize currentVelocity) [0,0,1])</span></span>
<span class="line"><span>                                    if length oscDir &lt; 0.001 then oscDir = normalize (cross (normalize currentVelocity) [0,1,0])</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                else if length velocities[j] &gt; 0.001 then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    oscDir = normalize (cross (normalize velocities[j]) [0,0,1])</span></span>
<span class="line"><span>                                    if length oscDir &lt; 0.001 then oscDir = normalize (cross (normalize velocities[j]) [0,1,0])</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                else</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    oscDir = [1,0,0]</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local oscillationOffset = oscDir * oscValue * inertiaEnable</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 5. 振荡能量衰减</span></span>
<span class="line"><span>                                oscEnergies[j] = oscEnergies[j] * oscDecay</span></span>
<span class="line"><span>                                if oscEnergies[j] &lt; 0.0001 then oscEnergies[j] = 0.0</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 6. 动量累积 (速度延续)</span></span>
<span class="line"><span>                                velocities[j] = velocities[j] * momentum + currentVelocity * (1.0 - momentum)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 7. 应用惯性偏移</span></span>
<span class="line"><span>                                local inertiaOffset = velocities[j] * inertiaEnable * massFactor</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 8. 最终位置</span></span>
<span class="line"><span>                                currentPos = currentPos + inertiaOffset + oscillationOffset</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 9. 更新前一帧速度</span></span>
<span class="line"><span>                                prevVelocities[j] = currentVelocity</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 应用重力</span></span>
<span class="line"><span>                            currentPos = currentPos + gravityVec * massFactor * 0.01</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1</span></span>
<span class="line"><span>                                if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1</span></span>
<span class="line"><span>                                if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1</span></span>
<span class="line"><span>                                if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3) * (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveMaxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 更新位置记录</span></span>
<span class="line"><span>                            prevPositions[j] = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then </span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then </span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else if chain[j].parent != undefined then </span></span>
<span class="line"><span>                                            chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                            chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then </span></span>
<span class="line"><span>                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- 更新惯性数据</span></span>
<span class="line"><span>                        allVelocities[cIdx] = velocities</span></span>
<span class="line"><span>                        allPrevPositions[cIdx] = prevPositions</span></span>
<span class="line"><span>                        allOscPhases[cIdx] = oscPhases</span></span>
<span class="line"><span>                        allOscEnergies[cIdx] = oscEnergies</span></span>
<span class="line"><span>                        allPrevVelocities[cIdx] = prevVelocities</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>                try(delete h)catch()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        BoneLoopStart (sortArrayByHeirarchy (selection as array))</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        spn_localX_posStr.value = 1</span></span>
<span class="line"><span>        spn_localX_negStr.value = 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        spn_localY_posStr.value = 1</span></span>
<span class="line"><span>        spn_localY_negStr.value = 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        spn_localZ_posStr.value = 1</span></span>
<span class="line"><span>        spn_localZ_negStr.value = 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1</span></span>
<span class="line"><span>        spn_blend_y.value = 1</span></span>
<span class="line"><span>        spn_blend_z.value = 1</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local tf = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = tf</span></span>
<span class="line"><span>        spn_localY_period.value = tf</span></span>
<span class="line"><span>        spn_localZ_period.value = tf</span></span>
<span class="line"><span>        format "Sin+Spring V7.9 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring V7.9 惯性系统说明:\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "动量保持 (0.5-0.99):\n"</span></span>
<span class="line"><span>format "  越高=速度越持久=惯性越强\n"</span></span>
<span class="line"><span>format "  0.85=正常, 0.95=很强惯性\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "振荡频率 (0.5-15):\n"</span></span>
<span class="line"><span>format "  越高=晃动越快\n"</span></span>
<span class="line"><span>format "  1-3=缓慢晃荡, 8+=快速抖动\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "振荡振幅 (0-3):\n"</span></span>
<span class="line"><span>format "  晃动的幅度大小\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "振荡衰减 (0.5-0.99):\n"</span></span>
<span class="line"><span>format "  越高=晃动持续越久\n"</span></span>
<span class="line"><span>format "  0.8=快速停止, 0.95=长时间晃动\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "推荐组合:\n"</span></span>
<span class="line"><span>format "自然余韵: 动量0.88, 频率2, 振幅0.5, 衰减0.9\n"</span></span>
<span class="line"><span>format "果冻感: 动量0.92, 频率4, 振幅0.8, 衰减0.93\n"</span></span>
<span class="line"><span>format "快速抖动: 动量0.8, 频率10, 振幅0.3, 衰减0.85\n"</span></span>
<span class="line"><span>format "重物晃荡: 动量0.9, 频率1, 振幅1.2, 衰减0.95\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><p>修复的语法错误是这一行：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- 错误写法 (多行数组):</span></span>
<span class="line"><span>currentPTM.pos = [</span></span>
<span class="line"><span>    currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x),</span></span>
<span class="line"><span>    currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y),</span></span>
<span class="line"><span>    currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 正确写法 (分开计算):</span></span>
<span class="line"><span>local newPosX = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>local newPosY = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>local newPosZ = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>currentPTM.pos = [newPosX, newPosY, newPosZ]</span></span></code></pre></div></div></pre><p>MaxScript不支持在方括号内直接换行，必须分开计算或者写在一行。现在脚本应该可以正常运行了。</p></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_21hjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p><a href="https://lmarena.ai/zh/c/019bb20e-3a6d-7296-b16e-aab6357c7b8c">AttributeDef:sprbTM</a><br>
<!-- -->-- 匿名 codeblock; 文件名: ; 位置: 34124; line: 778 中发生错误<br>
<!-- -->-- 语法错误: 位于 eol，需要 ,<br>
<!-- -->--  所在行:                                 currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5d3hjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->3 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5d3hjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>你说得对，我把惯性逻辑搞复杂后反而破坏了原有的效果。让我重新设计一个更直观有效的惯性系统：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.9 Ultimate</span></span>
<span class="line"><span>    - 修复惯性系统：基础惯性 + 阻尼振荡</span></span>
<span class="line"><span>    - 更直观的参数控制</span></span>
<span class="line"><span>    - 所有参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.9" width:650</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:300 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:300 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 必须使用V7.9版本的控制器" style_sunken:true align:#center color:(color 255 150 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:200 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:200 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:200 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localX_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localY_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转" range:[-90,90,8] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:190</span></span>
<span class="line"><span>        label lbl_empty0 "" width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:190</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        label lbl_empty1 "" width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:120</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:150</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:630</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:630 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:100 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:100</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:100</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:100</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:100</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:100 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller_V79" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParamsV79" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 重力参数</span></span>
<span class="line"><span>                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX</span></span>
<span class="line"><span>                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY</span></span>
<span class="line"><span>                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 惯性系统 (简化但有效)</span></span>
<span class="line"><span>                    inertiaEnable type:#float default:1.0 animatable:true ui:spn_inertiaEnable</span></span>
<span class="line"><span>                    inertiaMomentum type:#float default:0.85 animatable:true ui:spn_momentum</span></span>
<span class="line"><span>                    inertiaOscFreq type:#float default:3.0 animatable:true ui:spn_oscFreq</span></span>
<span class="line"><span>                    inertiaOscAmp type:#float default:0.5 animatable:true ui:spn_oscAmp</span></span>
<span class="line"><span>                    inertiaOscDecay type:#float default:0.92 animatable:true ui:spn_oscDecay</span></span>
<span class="line"><span>                    inertiaMass type:#float default:1.0 animatable:true ui:spn_mass</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 V7.9 (可K帧)" width:320</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 重力 (XYZ可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_gravX "重力 X:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravY "重力 Y:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravZ "重力 Z:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 惯性系统 (余韵晃动)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_inertiaEnable "惯性开关:" range:[0,1,1.0] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"0=关闭, 1=开启"</span></span>
<span class="line"><span>                        spinner spn_momentum "动量保持:" range:[0.5,0.99,0.85] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"速度保持程度，越大惯性越强"</span></span>
<span class="line"><span>                        spinner spn_oscFreq "振荡频率:" range:[0.5,15,3.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"停止后晃动的快慢"</span></span>
<span class="line"><span>                        spinner spn_oscAmp "振荡振幅:" range:[0,3,0.5] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"停止后晃动的幅度"</span></span>
<span class="line"><span>                        spinner spn_oscDecay "振荡衰减:" range:[0.5,0.99,0.92] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"晃动能量保持，越大晃动越久"</span></span>
<span class="line"><span>                        spinner spn_mass "质量分布:" range:[0,3,1.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"0=均匀, 1+=末端更重"</span></span>
<span class="line"><span>                        label lbl_tip1 "动量0.9+振荡0.5=自然余韵" align:#left</span></span>
<span class="line"><span>                        label lbl_tip2 "振荡频率高=快速抖动" align:#left</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1: (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localX_posStr.value else d = d * spn_localX_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2: (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localY_posStr.value else d = d * spn_localY_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3: (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then d = d * spn_localZ_posStr.value else d = d * spn_localZ_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateMassFactor boneIndex totalBones massDistribution =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if massDistribution == 0 then return 1.0</span></span>
<span class="line"><span>        local progress = boneIndex as float / totalBones as float</span></span>
<span class="line"><span>        return 1.0 + (progress * massDistribution)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else i += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #(); lastbonerot = #(); bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    rotate objectArray[a][b] (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try (</span></span>
<span class="line"><span>                            local targetTM = if bn.parent != undefined then bn.boneTM * bn.parent.transform else bn.boneTM</span></span>
<span class="line"><span>                            if classof bn == CATBone then bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then (local newTM = copy bn.parent.transform; newTM.pos = bn.transform.pos; bn.transform = newTM)</span></span>
<span class="line"><span>                    ) catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器V7.9已创建！\n\n惯性系统说明：\n- 动量保持: 速度延续程度 (0.85-0.95推荐)\n- 振荡频率: 晃动快慢 (1-5正常, 8+抖动)\n- 振荡振幅: 晃动幅度\n- 振荡衰减: 晃动持续时间\n- 质量分布: 末端权重" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then (messageBox "请选择骨骼根部"; return false)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then (messageBox "请先拾取风向控制器"; return false)</span></span>
<span class="line"><span>        if not isProperty ctrlObj "inertiaMomentum" then (messageBox "请重新创建V7.9版本控制器"; return false)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 惯性系统数据</span></span>
<span class="line"><span>        local allVelocities = #()       -- 速度向量</span></span>
<span class="line"><span>        local allPrevPositions = #()    -- 前一帧位置</span></span>
<span class="line"><span>        local allOscPhases = #()        -- 振荡相位</span></span>
<span class="line"><span>        local allOscEnergies = #()      -- 振荡能量</span></span>
<span class="line"><span>        local allPrevVelocities = #()   -- 前一帧速度 (用于检测速度变化)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                local velocities = #()</span></span>
<span class="line"><span>                local prevPositions = #()</span></span>
<span class="line"><span>                local oscPhases = #()</span></span>
<span class="line"><span>                local oscEnergies = #()</span></span>
<span class="line"><span>                local prevVelocities = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM = if isProperty b "boneTM" then b.boneTM </span></span>
<span class="line"><span>                                  else (if b.parent != undefined then b.transform * inverse b.parent.transform else b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    append boneLengths (getBoneLength b)</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions b.transform.pos</span></span>
<span class="line"><span>                    append oscPhases (random 0.0 360.0) -- 随机初始相位避免同步</span></span>
<span class="line"><span>                    append oscEnergies 0.0</span></span>
<span class="line"><span>                    append prevVelocities [0,0,0]</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for v = 1 to 3 do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local vTM = matrix3 1</span></span>
<span class="line"><span>                    vTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                    append boneRelTMs vTM</span></span>
<span class="line"><span>                    append boneLengths virtualLen</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local parentTM = if v == 1 then lastBone.transform else simTMs[simTMs.count]</span></span>
<span class="line"><span>                    local vWorldTM = vTM * parentTM</span></span>
<span class="line"><span>                    append simTMs vWorldTM</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions vWorldTM.pos</span></span>
<span class="line"><span>                    append oscPhases (random 0.0 360.0)</span></span>
<span class="line"><span>                    append oscEnergies 0.0</span></span>
<span class="line"><span>                    append prevVelocities [0,0,0]</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                append allVelocities velocities</span></span>
<span class="line"><span>                append allPrevPositions prevPositions</span></span>
<span class="line"><span>                append allOscPhases oscPhases</span></span>
<span class="line"><span>                append allOscEnergies oscEnergies</span></span>
<span class="line"><span>                append allPrevVelocities prevVelocities</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true wirecolor:(color 255 0 255) pos:simTMs[chain.count + 1].pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %)...\n" loopsCount</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 循环缝合</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else if chain[j].parent != undefined then chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                else chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 读取控制器参数</span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local gravityVec = [at time t ctrlObj.gravityX, at time t ctrlObj.gravityY, at time t ctrlObj.gravityZ]</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 惯性参数</span></span>
<span class="line"><span>                local inertiaEnable = at time t ctrlObj.inertiaEnable</span></span>
<span class="line"><span>                local momentum = at time t ctrlObj.inertiaMomentum</span></span>
<span class="line"><span>                local oscFreq = at time t ctrlObj.inertiaOscFreq</span></span>
<span class="line"><span>                local oscAmp = at time t ctrlObj.inertiaOscAmp</span></span>
<span class="line"><span>                local oscDecay = at time t ctrlObj.inertiaOscDecay</span></span>
<span class="line"><span>                local massParam = at time t ctrlObj.inertiaMass</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        local velocities = allVelocities[cIdx]</span></span>
<span class="line"><span>                        local prevPositions = allPrevPositions[cIdx]</span></span>
<span class="line"><span>                        local oscPhases = allOscPhases[cIdx]</span></span>
<span class="line"><span>                        local oscEnergies = allOscEnergies[cIdx]</span></span>
<span class="line"><span>                        local prevVelocities = allPrevVelocities[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            currentPTM.pos = [</span></span>
<span class="line"><span>                                currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x),</span></span>
<span class="line"><span>                                currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y),</span></span>
<span class="line"><span>                                currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            ]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else currentPTM = matrix3 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 局部Sin</span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local lsX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local lsY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local lsZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat lsX) * (quat lsY) * (quat lsZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 末端阻尼</span></span>
<span class="line"><span>                            local boneDamping = if isRealBone then calculateEndDamping j chain.count endDamping endFalloff else endDamping * 1.5</span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 质量因子</span></span>
<span class="line"><span>                            local massFactor = calculateMassFactor j totalNodes massParam</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 惯性系统计算</span></span>
<span class="line"><span>                            if inertiaEnable &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                -- 1. 计算当前帧的速度</span></span>
<span class="line"><span>                                local currentVelocity = currentPos - prevPositions[j]</span></span>
<span class="line"><span>                                local velocityMag = length currentVelocity</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 2. 检测速度变化（减速/方向变化）→ 给振荡充能</span></span>
<span class="line"><span>                                local prevVelMag = length prevVelocities[j]</span></span>
<span class="line"><span>                                local velocityChange = length (currentVelocity - prevVelocities[j])</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 当速度变化时（减速或改变方向），振荡能量增加</span></span>
<span class="line"><span>                                if velocityChange &gt; 0.01 then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    local energyInput = velocityChange * oscAmp * massFactor * inertiaEnable</span></span>
<span class="line"><span>                                    oscEnergies[j] = oscEnergies[j] + energyInput</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 3. 更新振荡相位</span></span>
<span class="line"><span>                                oscPhases[j] = oscPhases[j] + oscFreq * 10.0</span></span>
<span class="line"><span>                                if oscPhases[j] &gt; 360000 then oscPhases[j] = mod oscPhases[j] 360.0</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 4. 计算振荡偏移</span></span>
<span class="line"><span>                                local oscValue = sin(oscPhases[j]) * oscEnergies[j]</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 振荡方向：垂直于当前速度方向</span></span>
<span class="line"><span>                                local oscDir = [0,0,0]</span></span>
<span class="line"><span>                                if velocityMag &gt; 0.001 then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    oscDir = normalize (cross (normalize currentVelocity) [0,0,1])</span></span>
<span class="line"><span>                                    if length oscDir &lt; 0.001 then oscDir = normalize (cross (normalize currentVelocity) [0,1,0])</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                else if length velocities[j] &gt; 0.001 then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    oscDir = normalize (cross (normalize velocities[j]) [0,0,1])</span></span>
<span class="line"><span>                                    if length oscDir &lt; 0.001 then oscDir = normalize (cross (normalize velocities[j]) [0,1,0])</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                else</span></span>
<span class="line"><span>                                    oscDir = [1,0,0]</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local oscillationOffset = oscDir * oscValue * inertiaEnable</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 5. 振荡能量衰减</span></span>
<span class="line"><span>                                oscEnergies[j] = oscEnergies[j] * oscDecay</span></span>
<span class="line"><span>                                if oscEnergies[j] &lt; 0.0001 then oscEnergies[j] = 0.0</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 6. 动量累积 (速度延续)</span></span>
<span class="line"><span>                                velocities[j] = velocities[j] * momentum + currentVelocity * (1.0 - momentum)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 7. 应用惯性偏移</span></span>
<span class="line"><span>                                local inertiaOffset = velocities[j] * inertiaEnable * massFactor</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 8. 最终位置</span></span>
<span class="line"><span>                                currentPos = currentPos + inertiaOffset + oscillationOffset</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 9. 更新前一帧速度</span></span>
<span class="line"><span>                                prevVelocities[j] = currentVelocity</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 应用重力</span></span>
<span class="line"><span>                            currentPos = currentPos + gravityVec * massFactor * 0.01</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                dot1 = amax -1.0 (amin 1.0 dot1)</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                dot2 = amax -1.0 (amin 1.0 dot2)</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                dot3 = amax -1.0 (amin 1.0 dot3)</span></span>
<span class="line"><span>                                springAngle = acos(dot3) * (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle * (if isVirtualEnd then 0.5 else if j == chain.count then 0.7 else 1.0)</span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 更新位置记录</span></span>
<span class="line"><span>                            prevPositions[j] = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then (local finalTM = copy targetBoneTM; finalTM.rotation = finalRotation; chain[j].transform = finalTM)</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else if chain[j].parent != undefined then chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                        else chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 and cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- 更新惯性数据</span></span>
<span class="line"><span>                        allVelocities[cIdx] = velocities</span></span>
<span class="line"><span>                        allPrevPositions[cIdx] = prevPositions</span></span>
<span class="line"><span>                        allOscPhases[cIdx] = oscPhases</span></span>
<span class="line"><span>                        allOscEnergies[cIdx] = oscEnergies</span></span>
<span class="line"><span>                        allPrevVelocities[cIdx] = prevVelocities</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then for h in allVirtualEndHelpers do try(delete h)catch()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then (messageBox "请先选择父对象！"; return false)</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then (messageBox "请先选择骨骼！"; return false)</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        BoneLoopStart (sortArrayByHeirarchy (selection as array))</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) and obj.rotation.controller != undefined do</span></span>
<span class="line"><span>        (obj.Rotation.Controller = TCB_Rotation(); obj.Rotation.Controller = Euler_XYZ())</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) and obj.rotation.controller != undefined do</span></span>
<span class="line"><span>            obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) and obj.rotation.controller != undefined do</span></span>
<span class="line"><span>            obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0; spn_localX_rot.value = 5; spn_localX_inc.value = 2; spn_localX_delay.value = 4; spn_localX_period.value = 40; spn_localX_posStr.value = 1; spn_localX_negStr.value = 1</span></span>
<span class="line"><span>        spn_localY_switch.value = 0; spn_localY_rot.value = 5; spn_localY_inc.value = 2; spn_localY_delay.value = 4; spn_localY_period.value = 40; spn_localY_posStr.value = 1; spn_localY_negStr.value = 1</span></span>
<span class="line"><span>        spn_localZ_switch.value = 1; spn_localZ_rot.value = 8; spn_localZ_inc.value = 3; spn_localZ_delay.value = 4; spn_localZ_period.value = 40; spn_localZ_posStr.value = 1; spn_localZ_negStr.value = 1</span></span>
<span class="line"><span>        spn_springDelay.value = 0.3; spn_xSpring.value = 0.3; spn_subs.value = 1; spn_scaleMotion.value = 1.0; spn_boneCount.value = 50</span></span>
<span class="line"><span>        spn_endDamping.value = 0.5; spn_endFalloff.value = 3; spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0; spn_softness.value = 0.3; spn_blend_x.value = 1; spn_blend_y.value = 1; spn_blend_z.value = 1</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local tf = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = tf; spn_localY_period.value = tf; spn_localZ_period.value = tf</span></span>
<span class="line"><span>        format "Sin+Spring V7.9 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring V7.9 惯性系统说明:\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "动量保持 (0.5-0.99):\n"</span></span>
<span class="line"><span>format "  越高=速度越持久=惯性越强\n"</span></span>
<span class="line"><span>format "  0.85=正常, 0.95=很强惯性\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "振荡频率 (0.5-15):\n"</span></span>
<span class="line"><span>format "  越高=晃动越快\n"</span></span>
<span class="line"><span>format "  1-3=缓慢晃荡, 8+=快速抖动\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "振荡振幅 (0-3):\n"</span></span>
<span class="line"><span>format "  晃动的幅度大小\n"</span></span>
<span class="line"><span>format "----------------------------------------\n"</span></span>
<span class="line"><span>format "振荡衰减 (0.5-0.99):\n"</span></span>
<span class="line"><span>format "  越高=晃动持续越久\n"</span></span>
<span class="line"><span>format "  0.8=快速停止, 0.95=长时间晃动\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "推荐组合:\n"</span></span>
<span class="line"><span>format "自然余韵: 动量0.88, 频率2, 振幅0.5, 衰减0.9\n"</span></span>
<span class="line"><span>format "果冻感: 动量0.92, 频率4, 振幅0.8, 衰减0.93\n"</span></span>
<span class="line"><span>format "快速抖动: 动量0.8, 频率10, 振幅0.3, 衰减0.85\n"</span></span>
<span class="line"><span>format "重物晃荡: 动量0.9, 频率1, 振幅1.2, 衰减0.95\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>V7.9 惯性系统修复说明：</h2><h3>问题分析</h3><p>V7.8中惯性失效的原因：</p><ol>
<li>速度更新公式系数过小 (<code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">inertiaDamping * 0.05</code>)</li>
<li>振荡能量只在特定条件下累积</li>
<li>逻辑过于复杂导致参数相互抵消</li>
</ol><h3>V7.9 修复的核心逻辑</h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>1. 速度延续（动量）</span></span>
<span class="line"><span>   velocity = velocity * momentum + currentVelocity * (1 - momentum)</span></span>
<span class="line"><span>   → momentum=0.9 意味着90%保留之前速度</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. 振荡能量累积</span></span>
<span class="line"><span>   当检测到速度变化时 → 给振荡充能</span></span>
<span class="line"><span>   oscEnergies += velocityChange * amplitude</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. 振荡计算</span></span>
<span class="line"><span>   oscillation = sin(phase) * energy</span></span>
<span class="line"><span>   → 产生来回晃动效果</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. 应用到位置</span></span>
<span class="line"><span>   finalPos = currentPos + inertiaOffset + oscillationOffset</span></span></code></pre></div></div></pre><h3>参数说明</h3><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">范围</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">惯性开关</td><td node="[object Object]" class="px-3 py-2">0-1</td><td node="[object Object]" class="px-3 py-2">总开关</td></tr><tr><td node="[object Object]" class="px-3 py-2">动量保持</td><td node="[object Object]" class="px-3 py-2">0.5-0.99</td><td node="[object Object]" class="px-3 py-2">速度延续程度，<strong>越高惯性越强</strong></td></tr><tr><td node="[object Object]" class="px-3 py-2">振荡频率</td><td node="[object Object]" class="px-3 py-2">0.5-15</td><td node="[object Object]" class="px-3 py-2">晃动快慢</td></tr><tr><td node="[object Object]" class="px-3 py-2">振荡振幅</td><td node="[object Object]" class="px-3 py-2">0-3</td><td node="[object Object]" class="px-3 py-2">晃动幅度</td></tr><tr><td node="[object Object]" class="px-3 py-2">振荡衰减</td><td node="[object Object]" class="px-3 py-2">0.5-0.99</td><td node="[object Object]" class="px-3 py-2">晃动持续时间，<strong>越高晃动越久</strong></td></tr><tr><td node="[object Object]" class="px-3 py-2">质量分布</td><td node="[object Object]" class="px-3 py-2">0-3</td><td node="[object Object]" class="px-3 py-2">末端权重</td></tr></tbody></table></div><h3>推荐参数组合</h3><p><strong>自然余韵（头发/飘带）：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>动量=0.88, 频率=2, 振幅=0.5, 衰减=0.9</span></span></code></pre></div></div></pre><p><strong>果冻质感：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>动量=0.92, 频率=4, 振幅=0.8, 衰减=0.93</span></span></code></pre></div></div></pre><p><strong>快速抖动（触电/惊吓）：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>动量=0.8, 频率=10, 振幅=0.3, 衰减=0.85</span></span></code></pre></div></div></pre><p><strong>重物晃荡（厚重布料）：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>动量=0.9, 频率=1, 振幅=1.2, 衰减=0.95, 质量=2</span></span></code></pre></div></div></pre></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_23hjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 px-3 py-2 transition-[border-radius] duration-150 rounded-3xl"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>怎么这个惯性系统更改后，却完全没有了惯性的感觉，他直接就停止了，这里面肯定有问题</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5d5hjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->2 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5d5hjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>你说得对，我来重新设计一个更完善的惯性系统，添加频率和振幅控制：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.8 Ultimate</span></span>
<span class="line"><span>    - 完善惯性系统：频率/振幅/衰减全可控</span></span>
<span class="line"><span>    - 惯性衰减解锁全范围</span></span>
<span class="line"><span>    - 局部Sin正负轴向强度</span></span>
<span class="line"><span>    - 所有核心参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.8" width:650</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:300 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:300 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 必须使用V7.8版本的控制器，旧版请重新创建" style_sunken:true align:#center color:(color 255 150 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:200 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:200 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:200 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localX_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localY_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转" range:[-90,90,8] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:190</span></span>
<span class="line"><span>        label lbl_empty0 "" width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制 (解决末端折叠)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:190</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        label lbl_empty1 "" width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:120</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:150</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:630</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:630 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:100 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:100</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:100</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:100</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:100</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:100 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) </span></span>
<span class="line"><span>            catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller_V78" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParamsV78" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 重力参数</span></span>
<span class="line"><span>                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX</span></span>
<span class="line"><span>                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY</span></span>
<span class="line"><span>                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 完善惯性系统 (全可K帧)</span></span>
<span class="line"><span>                    inertiaStrength type:#float default:0.5 animatable:true ui:spn_inertia</span></span>
<span class="line"><span>                    inertiaFrequency type:#float default:2.0 animatable:true ui:spn_inertiaFreq</span></span>
<span class="line"><span>                    inertiaAmplitude type:#float default:1.0 animatable:true ui:spn_inertiaAmp</span></span>
<span class="line"><span>                    inertiaDamping type:#float default:0.5 animatable:true ui:spn_inertiaDamp</span></span>
<span class="line"><span>                    inertiaStiffness type:#float default:0.5 animatable:true ui:spn_inertiaStiff</span></span>
<span class="line"><span>                    massDistribution type:#float default:1.0 animatable:true ui:spn_massDist</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 V7.8 (可K帧)" width:320</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 重力 (XYZ可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_gravX "重力 X:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravY "重力 Y:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravZ "重力 Z:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 惯性系统 (完整控制)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_inertia "惯性强度:" range:[0,2,0.5] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"总体惯性大小，0=无惯性"</span></span>
<span class="line"><span>                        spinner spn_inertiaFreq "晃动频率:" range:[0.1,20,2.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"停止后晃动的快慢，越大晃动越快"</span></span>
<span class="line"><span>                        spinner spn_inertiaAmp "晃动振幅:" range:[0,5,1.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"停止后晃动的幅度，越大幅度越大"</span></span>
<span class="line"><span>                        spinner spn_inertiaDamp "衰减速度:" range:[0,1,0.5] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"晃动消失的速度，0=不衰减，1=立即消失"</span></span>
<span class="line"><span>                        spinner spn_inertiaStiff "弹簧刚度:" range:[0,1,0.5] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"回弹的硬度，越大回弹越快越硬"</span></span>
<span class="line"><span>                        spinner spn_massDist "质量分布:" range:[0,3,1.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"0=均匀, 1=末端重, 2+=末端很重"</span></span>
<span class="line"><span>                        label lbl_inertiaTip1 "频率高+衰减慢=抖动" align:#left</span></span>
<span class="line"><span>                        label lbl_inertiaTip2 "频率低+振幅大=晃荡" align:#left</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then </span></span>
<span class="line"><span>            return angle</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then</span></span>
<span class="line"><span>                    d = d * spn_localX_posStr.value</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    d = d * spn_localX_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then</span></span>
<span class="line"><span>                    d = d * spn_localY_posStr.value</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    d = d * spn_localY_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                if d &gt; 0 then</span></span>
<span class="line"><span>                    d = d * spn_localZ_posStr.value</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    d = d * spn_localZ_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateMassFactor boneIndex totalBones massDistribution =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if massDistribution == 0 then return 1.0</span></span>
<span class="line"><span>        local progress = boneIndex as float / totalBones as float</span></span>
<span class="line"><span>        return 1.0 + (progress * massDistribution)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器V7.8已创建！\n\n惯性系统参数说明：\n- 惯性强度: 总体惯性大小\n- 晃动频率: 余韵晃动快慢\n- 晃动振幅: 余韵晃动幅度\n- 衰减速度: 晃动消失速度\n- 弹簧刚度: 回弹硬度\n- 质量分布: 末端重量" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 检查V7.8版本</span></span>
<span class="line"><span>        if not isProperty ctrlObj "inertiaFrequency" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器版本过旧！\n\n请点击[创建风向控制器]按钮重新创建V7.8版本的控制器。"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 惯性系统数据结构</span></span>
<span class="line"><span>        local allVelocities = #()      -- 速度</span></span>
<span class="line"><span>        local allAccelerations = #()   -- 加速度</span></span>
<span class="line"><span>        local allPrevPositions = #()   -- 前一帧位置</span></span>
<span class="line"><span>        local allOscillationPhase = #() -- 振荡相位</span></span>
<span class="line"><span>        local allOscillationEnergy = #() -- 振荡能量</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        format "末端控制: 阻尼=% 衰减起始=% 虚拟末端长度=%\n" endDamping endFalloff virtualEndScale</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                local velocities = #()</span></span>
<span class="line"><span>                local accelerations = #()</span></span>
<span class="line"><span>                local prevPositions = #()</span></span>
<span class="line"><span>                local oscPhases = #()</span></span>
<span class="line"><span>                local oscEnergies = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local boneLen = getBoneLength b</span></span>
<span class="line"><span>                    append boneLengths boneLen</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 惯性数据初始化</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append accelerations [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions b.transform.pos</span></span>
<span class="line"><span>                    append oscPhases 0.0</span></span>
<span class="line"><span>                    append oscEnergies 0.0</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端1</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndRelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEndRelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEndRelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform</span></span>
<span class="line"><span>                append simTMs virtualEndWorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append accelerations [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEndWorldTM.pos</span></span>
<span class="line"><span>                append oscPhases 0.0</span></span>
<span class="line"><span>                append oscEnergies 0.0</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端2</span></span>
<span class="line"><span>                local virtualEnd2RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd2RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd2RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd2WorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append accelerations [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEnd2WorldTM.pos</span></span>
<span class="line"><span>                append oscPhases 0.0</span></span>
<span class="line"><span>                append oscEnergies 0.0</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端3</span></span>
<span class="line"><span>                local virtualEnd3RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd3RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd3RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd3WorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append accelerations [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEnd3WorldTM.pos</span></span>
<span class="line"><span>                append oscPhases 0.0</span></span>
<span class="line"><span>                append oscEnergies 0.0</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                append allVelocities velocities</span></span>
<span class="line"><span>                append allAccelerations accelerations</span></span>
<span class="line"><span>                append allPrevPositions prevPositions</span></span>
<span class="line"><span>                append allOscillationPhase oscPhases</span></span>
<span class="line"><span>                append allOscillationEnergy oscEnergies</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true \</span></span>
<span class="line"><span>                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼 + 3个虚拟末端点\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local gravityX = at time t ctrlObj.gravityX</span></span>
<span class="line"><span>                local gravityY = at time t ctrlObj.gravityY</span></span>
<span class="line"><span>                local gravityZ = at time t ctrlObj.gravityZ</span></span>
<span class="line"><span>                local gravityVec = [gravityX, gravityY, gravityZ]</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 惯性参数 (全可K帧)</span></span>
<span class="line"><span>                local inertiaStrength = at time t ctrlObj.inertiaStrength</span></span>
<span class="line"><span>                local inertiaFrequency = at time t ctrlObj.inertiaFrequency</span></span>
<span class="line"><span>                local inertiaAmplitude = at time t ctrlObj.inertiaAmplitude</span></span>
<span class="line"><span>                local inertiaDamping = at time t ctrlObj.inertiaDamping</span></span>
<span class="line"><span>                local inertiaStiffness = at time t ctrlObj.inertiaStiffness</span></span>
<span class="line"><span>                local massDistribution = at time t ctrlObj.massDistribution</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        local velocities = allVelocities[cIdx]</span></span>
<span class="line"><span>                        local accelerations = allAccelerations[cIdx]</span></span>
<span class="line"><span>                        local prevPositions = allPrevPositions[cIdx]</span></span>
<span class="line"><span>                        local oscPhases = allOscillationPhase[cIdx]</span></span>
<span class="line"><span>                        local oscEnergies = allOscillationEnergy[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then</span></span>
<span class="line"><span>                                currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then</span></span>
<span class="line"><span>                                currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local boneDamping = 0.0</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local massFactor = calculateMassFactor j totalNodes massDistribution</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 完善的惯性系统计算</span></span>
<span class="line"><span>                            if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                -- 计算当前速度</span></span>
<span class="line"><span>                                local currentVelocity = currentPos - prevPositions[j]</span></span>
<span class="line"><span>                                local velocityMagnitude = length currentVelocity</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 计算加速度变化 (用于检测减速)</span></span>
<span class="line"><span>                                local newAcceleration = currentVelocity - velocities[j]</span></span>
<span class="line"><span>                                local deceleration = length (newAcceleration - accelerations[j])</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 当检测到减速时，增加振荡能量</span></span>
<span class="line"><span>                                local decelerationThreshold = 0.1</span></span>
<span class="line"><span>                                if deceleration &gt; decelerationThreshold then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    oscEnergies[j] = oscEnergies[j] + (deceleration * inertiaAmplitude * massFactor)</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 振荡相位累加</span></span>
<span class="line"><span>                                oscPhases[j] = oscPhases[j] + (inertiaFrequency * 0.1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 计算振荡偏移 (阻尼弹簧振动)</span></span>
<span class="line"><span>                                local oscillation = sin(oscPhases[j] * 360.0) * oscEnergies[j]</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 应用弹簧刚度影响振荡频率</span></span>
<span class="line"><span>                                local stiffnessOsc = cos(oscPhases[j] * 360.0 * (1.0 + inertiaStiffness)) * oscEnergies[j] * inertiaStiffness * 0.5</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 振荡衰减</span></span>
<span class="line"><span>                                oscEnergies[j] = oscEnergies[j] * (1.0 - inertiaDamping * 0.1)</span></span>
<span class="line"><span>                                if oscEnergies[j] &lt; 0.001 then oscEnergies[j] = 0.0</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 应用惯性到位置</span></span>
<span class="line"><span>                                local inertiaOffset = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 应用振荡 (沿速度方向垂直振动)</span></span>
<span class="line"><span>                                local oscDirection = if velocityMagnitude &gt; 0.01 then </span></span>
<span class="line"><span>                                    normalize (cross velocities[j] [0,0,1])</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    [0,1,0]</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if length oscDirection &lt; 0.01 then oscDirection = [1,0,0]</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local oscOffset = oscDirection * (oscillation + stiffnessOsc) * inertiaStrength</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                currentPos = currentPos + inertiaOffset + oscOffset</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- 更新速度和加速度</span></span>
<span class="line"><span>                                velocities[j] = velocities[j] * (1.0 - inertiaDamping * 0.05) + currentVelocity * inertiaDamping * 0.05</span></span>
<span class="line"><span>                                accelerations[j] = newAcceleration</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 应用重力</span></span>
<span class="line"><span>                            currentPos = currentPos + gravityVec * massFactor * 0.01</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 更新前一帧位置</span></span>
<span class="line"><span>                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>                            prevPositions[j] = newPos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then</span></span>
<span class="line"><span>                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- ★ 更新惯性数据</span></span>
<span class="line"><span>                        allVelocities[cIdx] = velocities</span></span>
<span class="line"><span>                        allAccelerations[cIdx] = accelerations</span></span>
<span class="line"><span>                        allPrevPositions[cIdx] = prevPositions</span></span>
<span class="line"><span>                        allOscillationPhase[cIdx] = oscPhases</span></span>
<span class="line"><span>                        allOscillationEnergy[cIdx] = oscEnergies</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                try(delete h)catch()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        spn_localX_posStr.value = 1.0</span></span>
<span class="line"><span>        spn_localX_negStr.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        spn_localY_posStr.value = 1.0</span></span>
<span class="line"><span>        spn_localY_negStr.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        spn_localZ_posStr.value = 1.0</span></span>
<span class="line"><span>        spn_localZ_negStr.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V7.8 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V7.8\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 惯性系统完整参数:\n"</span></span>
<span class="line"><span>format "  惯性强度 (0-2): 总体惯性大小\n"</span></span>
<span class="line"><span>format "  晃动频率 (0.1-20): 余韵晃动快慢\n"</span></span>
<span class="line"><span>format "  晃动振幅 (0-5): 余韵晃动幅度\n"</span></span>
<span class="line"><span>format "  衰减速度 (0-1): 晃动消失速度\n"</span></span>
<span class="line"><span>format "  弹簧刚度 (0-1): 回弹硬度\n"</span></span>
<span class="line"><span>format "  质量分布 (0-3): 末端重量\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 惯性效果组合示例:\n"</span></span>
<span class="line"><span>format "  抖动效果: 频率=10, 振幅=0.5, 衰减=0.3\n"</span></span>
<span class="line"><span>format "  晃荡效果: 频率=1, 振幅=2, 衰减=0.1\n"</span></span>
<span class="line"><span>format "  果冻效果: 频率=3, 振幅=1.5, 刚度=0.8\n"</span></span>
<span class="line"><span>format "  重物感: 频率=0.5, 振幅=1, 质量分布=2\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>V7.8 惯性系统完整参数说明：</h2><h3>惯性系统参数（全部可K帧）</h3><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">范围</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">惯性强度</td><td node="[object Object]" class="px-3 py-2">0-2</td><td node="[object Object]" class="px-3 py-2">总体惯性大小，0=无惯性</td></tr><tr><td node="[object Object]" class="px-3 py-2">晃动频率</td><td node="[object Object]" class="px-3 py-2">0.1-20</td><td node="[object Object]" class="px-3 py-2">余韵晃动的快慢，越大越快</td></tr><tr><td node="[object Object]" class="px-3 py-2">晃动振幅</td><td node="[object Object]" class="px-3 py-2">0-5</td><td node="[object Object]" class="px-3 py-2">余韵晃动的幅度，越大幅度越大</td></tr><tr><td node="[object Object]" class="px-3 py-2">衰减速度</td><td node="[object Object]" class="px-3 py-2">0-1</td><td node="[object Object]" class="px-3 py-2">晃动消失的速度，0=不衰减，1=立即消失</td></tr><tr><td node="[object Object]" class="px-3 py-2">弹簧刚度</td><td node="[object Object]" class="px-3 py-2">0-1</td><td node="[object Object]" class="px-3 py-2">回弹的硬度，越大回弹越硬越快</td></tr><tr><td node="[object Object]" class="px-3 py-2">质量分布</td><td node="[object Object]" class="px-3 py-2">0-3</td><td node="[object Object]" class="px-3 py-2">0=均匀，1=末端重，2+=末端很重</td></tr></tbody></table></div><h3>效果组合示例</h3><p><strong>快速抖动（像触电）：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>频率=10-15, 振幅=0.3-0.5, 衰减=0.3-0.5</span></span></code></pre></div></div></pre><p><strong>缓慢晃荡（像钟摆）：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>频率=0.5-2, 振幅=1.5-2.5, 衰减=0.05-0.15</span></span></code></pre></div></div></pre><p><strong>果冻质感：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>频率=3-5, 振幅=1-1.5, 刚度=0.7-0.9, 衰减=0.2</span></span></code></pre></div></div></pre><p><strong>重物下坠感：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>频率=0.3-0.8, 振幅=0.8-1.2, 质量分布=2-3</span></span></code></pre></div></div></pre><p><strong>弹性回弹：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>频率=4-6, 振幅=1, 刚度=0.8-1, 衰减=0.4</span></span></code></pre></div></div></pre><h3>K帧使用场景</h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>场景: 角色突然停下</span></span>
<span class="line"><span>第0帧: 惯性强度=0.5, 衰减=0.1 (正常晃动)</span></span>
<span class="line"><span>第30帧: 惯性强度=1.5, 振幅=2 (撞击后大幅晃动)</span></span>
<span class="line"><span>第60帧: 惯性强度=0.3, 衰减=0.5 (逐渐平静)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景: 从柔软变硬</span></span>
<span class="line"><span>第0帧: 刚度=0.2, 频率=1 (柔软)</span></span>
<span class="line"><span>第50帧: 刚度=0.9, 频率=8 (变硬抖动)</span></span></code></pre></div></div></pre></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_25hjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>惯性的衰减被锁死在0.8了，不能更方便的调节了，解锁，然后是这个惯性系统太简陋了，我没办法准确控制他停下来的晃动频率，我有时候希望他晃动的快一些，或者慢一些，或者幅度大一些</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5d7hjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->1 second</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5d7hjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>好的，我来修复这个问题并添加你要求的功能：</p><ol>
<li>修复旧控制器兼容性问题</li>
<li>惯性参数放到控制器上（可K帧）</li>
<li>局部Sin添加正负轴向强度</li>
</ol><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.5 Ultimate</span></span>
<span class="line"><span>    - 惯性系统可K帧</span></span>
<span class="line"><span>    - 局部Sin正负轴向强度控制</span></span>
<span class="line"><span>    - 重力XYZ可K帧</span></span>
<span class="line"><span>    - 修复旧控制器兼容性</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.5" width:650</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:300 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:300 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 必须使用V7.5版本的控制器，旧版请重新创建" style_sunken:true align:#center color:(color 255 150 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:200 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:200 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:200 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localX_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75 toolTip:"正向旋转强度倍率"</span></span>
<span class="line"><span>        spinner spn_localX_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75 toolTip:"负向旋转强度倍率"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转" range:[-90,90,5] width:75</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:75</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localY_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75 toolTip:"正向旋转强度倍率"</span></span>
<span class="line"><span>        spinner spn_localY_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75 toolTip:"负向旋转强度倍率"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转" range:[-90,90,8] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:75</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:75</span></span>
<span class="line"><span>        spinner spn_localZ_posStr "+强度" range:[0.1,5,1] scale:0.1 width:75 toolTip:"正向旋转强度倍率"</span></span>
<span class="line"><span>        spinner spn_localZ_negStr "-强度" range:[0.1,5,1] scale:0.1 width:75 toolTip:"负向旋转强度倍率"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:190</span></span>
<span class="line"><span>        label lbl_empty0 "" width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制 (解决末端折叠)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:190</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:190</span></span>
<span class="line"><span>        label lbl_empty1 "" width:190</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:190</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:120</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:150</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:630</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:630 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:100 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:100</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:100</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:100</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:100</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:100 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) </span></span>
<span class="line"><span>            catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller_V75" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParamsV75" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 重力参数</span></span>
<span class="line"><span>                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX</span></span>
<span class="line"><span>                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY</span></span>
<span class="line"><span>                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 惯性参数 (可K帧)</span></span>
<span class="line"><span>                    inertiaStrength type:#float default:0.3 animatable:true ui:spn_inertia</span></span>
<span class="line"><span>                    inertiaDamping type:#float default:0.95 animatable:true ui:spn_inertiaDamp</span></span>
<span class="line"><span>                    massDistribution type:#float default:1.0 animatable:true ui:spn_massDist</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 V7.5 (可K帧)" width:300</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 重力 (XYZ可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_gravX "重力 X:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravY "重力 Y:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                        spinner spn_gravZ "重力 Z:" range:[-500,500,0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 惯性系统 (可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_inertia "惯性强度:" range:[0,0.99,0.3] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"越大余韵越长"</span></span>
<span class="line"><span>                        spinner spn_inertiaDamp "惯性衰减:" range:[0.8,0.99,0.95] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"越大衰减越慢"</span></span>
<span class="line"><span>                        spinner spn_massDist "质量分布:" range:[0,2,1.0] type:#float scale:0.1 \</span></span>
<span class="line"><span>                                toolTip:"0=均匀, 1=末端重, 2=末端很重"</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then </span></span>
<span class="line"><span>            return angle</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- ★ 改进的局部Sin旋转（支持正负轴向强度）</span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1: -- X轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                -- ★ 应用正负轴向强度</span></span>
<span class="line"><span>                if d &gt; 0 then</span></span>
<span class="line"><span>                    d = d * spn_localX_posStr.value</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    d = d * spn_localX_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2: -- Y轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                -- ★ 应用正负轴向强度</span></span>
<span class="line"><span>                if d &gt; 0 then</span></span>
<span class="line"><span>                    d = d * spn_localY_posStr.value</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    d = d * spn_localY_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3: -- Z轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                -- ★ 应用正负轴向强度</span></span>
<span class="line"><span>                if d &gt; 0 then</span></span>
<span class="line"><span>                    d = d * spn_localZ_posStr.value</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    d = d * spn_localZ_negStr.value</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateMassFactor boneIndex totalBones massDistribution =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if massDistribution == 0 then return 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = boneIndex as float / totalBones as float</span></span>
<span class="line"><span>        return 1.0 + (progress * massDistribution)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器V7.5已创建！\n\n选中控制器后，在修改面板可K帧调整：\n- 混合/风力/扰动参数\n- 重力 XYZ\n- 惯性系统" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 检查是否是V7.5版本的控制器</span></span>
<span class="line"><span>        if not isProperty ctrlObj "inertiaStrength" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器版本过旧，缺少惯性/重力属性！\n\n请点击[创建风向控制器]按钮重新创建V7.5版本的控制器。"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        local allVelocities = #()</span></span>
<span class="line"><span>        local allPrevPositions = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        format "末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\n" endDamping endFalloff virtualEndScale</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                local velocities = #()</span></span>
<span class="line"><span>                local prevPositions = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local boneLen = getBoneLength b</span></span>
<span class="line"><span>                    append boneLengths boneLen</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions b.transform.pos</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端1</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndRelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEndRelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEndRelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform</span></span>
<span class="line"><span>                append simTMs virtualEndWorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEndWorldTM.pos</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端2</span></span>
<span class="line"><span>                local virtualEnd2RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd2RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd2RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd2WorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEnd2WorldTM.pos</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端3</span></span>
<span class="line"><span>                local virtualEnd3RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd3RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd3RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd3WorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEnd3WorldTM.pos</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                append allVelocities velocities</span></span>
<span class="line"><span>                append allPrevPositions prevPositions</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true \</span></span>
<span class="line"><span>                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼 + 3个虚拟末端点\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 从控制器读取重力和惯性 (可K帧)</span></span>
<span class="line"><span>                local gravityX = at time t ctrlObj.gravityX</span></span>
<span class="line"><span>                local gravityY = at time t ctrlObj.gravityY</span></span>
<span class="line"><span>                local gravityZ = at time t ctrlObj.gravityZ</span></span>
<span class="line"><span>                local gravityVec = [gravityX, gravityY, gravityZ]</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local inertiaStrength = at time t ctrlObj.inertiaStrength</span></span>
<span class="line"><span>                local inertiaDamping = at time t ctrlObj.inertiaDamping</span></span>
<span class="line"><span>                local massDistribution = at time t ctrlObj.massDistribution</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        local velocities = allVelocities[cIdx]</span></span>
<span class="line"><span>                        local prevPositions = allPrevPositions[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then</span></span>
<span class="line"><span>                                currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then</span></span>
<span class="line"><span>                                currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local boneDamping = 0.0</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local massFactor = calculateMassFactor j totalNodes massDistribution</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 应用惯性</span></span>
<span class="line"><span>                            if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local inertiaPos = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>                                currentPos = currentPos + inertiaPos</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 应用重力</span></span>
<span class="line"><span>                            currentPos = currentPos + gravityVec * massFactor * 0.01</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 计算速度用于惯性</span></span>
<span class="line"><span>                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>                            local newVelocity = newPos - prevPositions[j]</span></span>
<span class="line"><span>                            velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)</span></span>
<span class="line"><span>                            prevPositions[j] = newPos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 调试helper</span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then</span></span>
<span class="line"><span>                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        allVelocities[cIdx] = velocities</span></span>
<span class="line"><span>                        allPrevPositions[cIdx] = prevPositions</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                try(delete h)catch()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        spn_localX_posStr.value = 1.0</span></span>
<span class="line"><span>        spn_localX_negStr.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        spn_localY_posStr.value = 1.0</span></span>
<span class="line"><span>        spn_localY_negStr.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        spn_localZ_posStr.value = 1.0</span></span>
<span class="line"><span>        spn_localZ_negStr.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V7.5 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V7.5\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ V7.5 新功能:\n"</span></span>
<span class="line"><span>format "  - 惯性系统可K帧 (在控制器上)\n"</span></span>
<span class="line"><span>format "  - 局部Sin正负轴向强度控制\n"</span></span>
<span class="line"><span>format "  - 必须使用V7.5版本控制器\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 控制器可K帧参数:\n"</span></span>
<span class="line"><span>format "  - 混合: Spring/全局风/局部Sin\n"</span></span>
<span class="line"><span>format "  - Sin风力: 基础风压/幅度/周期\n"</span></span>
<span class="line"><span>format "  - 扰动: 强度/频率/速度/层数\n"</span></span>
<span class="line"><span>format "  - 重力: X/Y/Z\n"</span></span>
<span class="line"><span>format "  - 惯性: 强度/衰减/质量分布\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 局部Sin正负强度用法:\n"</span></span>
<span class="line"><span>format "  +强度=1, -强度=2: 负向幅度更大\n"</span></span>
<span class="line"><span>format "  +强度=2, -强度=0.5: 正向幅度更大\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>V7.5 更新内容：</h2><h3>1. <strong>惯性系统可K帧</strong></h3><p>现在惯性参数都在控制器上，可以K帧：</p><ul>
<li>惯性强度 (0-0.99)</li>
<li>惯性衰减 (0.8-0.99)</li>
<li>质量分布 (0-2)</li>
</ul><p><strong>使用场景：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>第0帧: 惯性强度=0 (静止状态)</span></span>
<span class="line"><span>第30帧: 惯性强度=0.5 (开始有余韵)</span></span>
<span class="line"><span>第60帧: 惯性强度=0.9 (果冻效果)</span></span></code></pre></div></div></pre><h3>2. <strong>局部Sin正负轴向强度</strong></h3><p>每个轴都有 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">+强度</code> 和 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">-强度</code> 参数：</p><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">+强度</td><td node="[object Object]" class="px-3 py-2">正向旋转的倍率</td></tr><tr><td node="[object Object]" class="px-3 py-2">-强度</td><td node="[object Object]" class="px-3 py-2">负向旋转的倍率</td></tr></tbody></table></div><p><strong>使用示例：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>场景1: 只向一边摆动</span></span>
<span class="line"><span>  +强度=1.0, -强度=0.2 → 正向大，负向小</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景2: 负向摆动更大</span></span>
<span class="line"><span>  +强度=0.5, -强度=1.5 → 负向更大</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景3: 不对称波形</span></span>
<span class="line"><span>  +强度=2.0, -强度=1.0 → 正向幅度翻倍</span></span></code></pre></div></div></pre><h3>3. <strong>版本检查</strong></h3><p>脚本会检查控制器版本，如果使用旧版控制器会提示重新创建。</p><h3>4. <strong>控制器命名</strong></h3><p>新版控制器名称为 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">Wind_Controller_V75</code>，方便区分。</p></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_27hjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><h1>惯性系统我也希望可以K帧呢，然后我们的局部骨骼sin，我下午分正负轴向呢，比如-y和y的强度也可以单独设置一下</h1><p>初始化模拟状态 (基于帧 0)...<br>
<!-- -->末端控制: 阻尼=0.5 衰减起始=3 虚拟末端长度倍率=1.0<br>
<!-- -->惯性系统: 强度=0.3 衰减=0.95 质量分布=1.0<br>
<!-- -->链 1: 7 根骨骼 + 3个虚拟末端点<br>
<!-- -->开始模拟 (循环次数: 2, 链数: 1)...<br>
<!-- -->-- t loop; 文件名: ; 位置: 33183; line: 843 中发生错误<br>
<!-- -->--  帧:<br>
<!-- -->--   swingAmp: 8.0<br>
<!-- -->--   springMix: 1.0<br>
<!-- -->--   turbLayers: 3<br>
<!-- -->--   gravityY: undefined<br>
<!-- -->--   windDir: [0,-1,0]<br>
<!-- -->--   period: 30.0<br>
<!-- -->--   gravityZ: undefined<br>
<!-- -->--   globalWindMix: 0.0<br>
<!-- -->--   turbRoughness: 2.0<br>
<!-- -->--   t: 0<br>
<!-- -->--   localSinMix: 0.0<br>
<!-- -->--   turbStrength: 15.0<br>
<!-- -->--   turbSeed: 2<br>
<!-- -->--   gravityVec: undefined<br>
<!-- -->--   currTime: 0.0<br>
<!-- -->--   windTM: (matrix3 [1,0,0] [0,1,0] [0,0,1] [0,0,0])<br>
<!-- -->--   turbFreq: 3.0<br>
<!-- -->--   gravityX: undefined<br>
<!-- -->--   globalStr: 1.0<br>
<!-- -->--   baseWind: 20.0<br>
<!-- -->--   turbSpeed: 2.0<br>
<!-- -->--   在  l loop; 文件名: ; 位置: 46421; 行: 1073 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   isWritePass: false<br>
<!-- -->--   l: 1<br>
<!-- -->--   在  btn_Bake.pressed(); 文件名: ; 位置: 46432; 行: 1074 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   inertiaStrength: 0.3<br>
<!-- -->--   allChains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))<br>
<!-- -->--   ctrlObj: $Wind_Controller<br>
<!-- -->--   subs: 1<br>
<!-- -->--   allBoneLengths: #(#(20.3258, 26.581, 15.8307, 22.8501, 22.7351, 16.6523, 4.0, 4.0, 4.0, 4.0))<br>
<!-- -->--   allVirtualEndHelpers: #()<br>
<!-- -->--   delay: 0.3<br>
<!-- -->--   massDistribution: 1.0<br>
<!-- -->--   chains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))<br>
<!-- -->--   xSpring: 0.3<br>
<!-- -->--   subframe: 1.0<br>
<!-- -->--   softness: 0.3<br>
<!-- -->--   scaleMotion: 1.0<br>
<!-- -->--   totalFrames: 202<br>
<!-- -->--   blend_x: 1.0<br>
<!-- -->--   frameCounter: 1<br>
<!-- -->--   blend_y: 1.0<br>
<!-- -->--   blend_z: 1.0<br>
<!-- -->--   inertiaDamping: 0.95<br>
<!-- -->--   loopsCount: 2<br>
<!-- -->--   virtualEndScale: 1.0<br>
<!-- -->--   debugVirtualEnd: false<br>
<!-- -->--   allVelocities: #(#([0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0]))<br>
<!-- -->--   endF: 100<br>
<!-- -->--   allBoneTM: #(#((matrix3 [0.744569,0,-0.667545] [0.667545,-1.62921e-007,0.744569] [0,-1,-1.21306e-007] [-31.5721,-5.08113e-006,116.243]), (matrix3 [0.957454,-0.288585,0] [0.288585,0.957454,0] [0,0,1] [20.3258,0.000289917,0]), (matrix3 [0.92174,-0.387808,0] [0.387808,0.92174,0] [0,0,1] [26.581,3.8147e-006,8.10998e-007]), (matrix3 [0.999407,-0.0344413,0] [0.0344413,0.999407,0] [0,0,1] [15.8307,2.86102e-006,1.05333e-006]), (matrix3 [0.962204,-0.272332,-1.55791e-007] [0.272332,0.962204,0] [1.39403e-007,0,1] [22.8501,-9.53674e-007,1.58213e-006]), (matrix3 [0.897357,-0.441305,0] [0.441305,0.897357,1.80916e-007] [0,-1.67414e-007,1] [22.735,-1.43051e-006,1.99225e-006]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [16.6523,-3.8147e-006,1.71636e-006]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0])))<br>
<!-- -->--   startF: 0<br>
<!-- -->--   maxAngle: 80.0<br>
<!-- -->--   endDamping: 0.5<br>
<!-- -->--   allPreTimeBoneTM: #(#((matrix3 [0.744569,0,-0.667545] [0.667545,-1.62921e-007,0.744569] [0,-1,-1.21306e-007] [-31.5721,-5.08113e-006,116.243]), (matrix3 [0.520247,0,-0.854016] [0.854016,-1.55989e-007,0.520247] [0,-1,-1.21306e-007] [-16.4379,-5.09381e-006,102.674]), (matrix3 [0.148339,1.33044e-007,-0.988937] [0.988937,-1.25548e-007,0.148339] [0,-1,-1.50196e-007] [-2.60924,-4.65507e-006,79.9739]), (matrix3 [0.114191,1.37289e-007,-0.993459] [0.993459,-1.21918e-007,0.114191] [0,-1,-1.50313e-007] [-0.260921,-3.60222e-006,64.3183]), (matrix3 [-0.160675,3.21093e-007,-0.987007] [0.987007,0,-0.160675] [-1.68528e-007,-1,-2.97885e-007] [2.34835,-2.04728e-006,41.6177]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-1.30462,3.26053e-006,19.1781]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-10.9589,7.40414e-006,5.60989]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-13.2779,8.81174e-006,2.35073]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-15.5969,1.02193e-005,-0.908438]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-17.9159,1.16269e-005,-4.1676])))<br>
<!-- -->--   endFalloff: 3<br>
<!-- -->--   allPrePos: #([-16.4379,-5.09381e-006,102.674])<br>
<!-- -->--   allPrevPositions: #(#([-31.5721,-5.08113e-006,116.243], [-16.4379,-5.09381e-006,102.674], [-2.60924,-4.65507e-006,79.9739], [-0.260921,-3.60222e-006,64.3183], [2.34835,-2.04728e-006,41.6177], [-1.30462,3.26053e-006,19.1781], [-10.9589,7.40414e-006,5.60989], [-13.2779,8.81174e-006,2.35073], [-15.5969,1.02193e-005,-0.908438], [-17.9159,1.16269e-005,-4.1676]))</p><blockquote>
<blockquote>
<p>MAXScript 卷展栏处理程序 异常:<br>
<!-- -->-- 未知属性:“gravityX”位于 $点辅助对象:Wind_Controller @ [0.000000,0.000000,0.000000] &lt;&lt;</p>
</blockquote>
</blockquote></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5d9hjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->1 second</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5d9hjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>好的，我来添加惯性系统和更完善的重力控制：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.2 Ultimate</span></span>
<span class="line"><span>    - 新增惯性系统（质量感）</span></span>
<span class="line"><span>    - 完善重力控制（XYZ三轴 + 可K帧）</span></span>
<span class="line"><span>    - 虚拟末端点解决末端折叠</span></span>
<span class="line"><span>    - 所有核心参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.2" width:620</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (所有可K帧参数都在控制器上)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:280 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:280 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动/重力参数" style_sunken:true align:#center color:(color 50 200 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:190 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:190 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:190 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:105</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:105</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:105</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:105</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:105</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:105</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:105</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:105</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:105</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:105</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:105</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:105</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:105</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:105</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:105</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:180</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:180</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:180</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:180</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:180</span></span>
<span class="line"><span>        label lbl_empty0 "" width:180</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 惯性系统 (质量感)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_inertia "惯性强度" range:[0.0, 0.99, 0.3] scale:0.01 align:#left across:3 width:180 \</span></span>
<span class="line"><span>                toolTip:"越大惯性越强，运动停止后会有延续"</span></span>
<span class="line"><span>        spinner spn_inertiaDamping "惯性衰减" range:[0.8, 0.99, 0.95] scale:0.01 width:180 \</span></span>
<span class="line"><span>                toolTip:"惯性的衰减速度，越小衰减越快"</span></span>
<span class="line"><span>        spinner spn_massDistribution "质量分布" range:[0.0, 2.0, 1.0] scale:0.1 width:180 \</span></span>
<span class="line"><span>                toolTip:"0=均匀, 1=末端更重, 2=末端非常重"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_inertiaTip "提示: 惯性让骨骼停止时有'晃动余韵'的质量感" align:#center style_sunken:true</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. ★ 末端控制 (解决末端折叠)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:180</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:180</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:180</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:180</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:180</span></span>
<span class="line"><span>        label lbl_empty1 "" width:180</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:180</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:180</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:180</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "8. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:100</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:140</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:140</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:600</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:600 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:95 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:95</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:95</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:95</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:95</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:95 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) </span></span>
<span class="line"><span>            catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 重力参数 (XYZ可K帧)</span></span>
<span class="line"><span>                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX</span></span>
<span class="line"><span>                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY</span></span>
<span class="line"><span>                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 (可K帧)" width:280</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 重力 (XYZ可K帧)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_gravX "重力 X:" range:[-500,500,0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"X轴方向的力 (可K帧实现变化)"</span></span>
<span class="line"><span>                        spinner spn_gravY "重力 Y:" range:[-500,500,0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"Y轴方向的力"</span></span>
<span class="line"><span>                        spinner spn_gravZ "重力 Z:" range:[-500,500,0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"Z轴方向的力 (负值=向下)"</span></span>
<span class="line"><span>                        label lbl_gravTip "提示: 负Z=向下, 正Y=向前" align:#left</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then </span></span>
<span class="line"><span>            return angle</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- ★ 计算骨骼质量因子 (用于惯性)</span></span>
<span class="line"><span>    fn calculateMassFactor boneIndex totalBones massDistribution =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if massDistribution == 0 then return 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = boneIndex as float / totalBones as float</span></span>
<span class="line"><span>        return 1.0 + (progress * massDistribution)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器已创建！\n\n选中控制器后，在右侧修改面板中可以K帧调整：\n- 混合/风力/扰动参数\n- 重力 XYZ (可K帧)" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not isProperty ctrlObj "springMix" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器缺少必要属性，请重新创建风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 惯性参数</span></span>
<span class="line"><span>        local inertiaStrength = spn_inertia.value</span></span>
<span class="line"><span>        local inertiaDamping = spn_inertiaDamping.value</span></span>
<span class="line"><span>        local massDistribution = spn_massDistribution.value</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 惯性速度存储</span></span>
<span class="line"><span>        local allVelocities = #()</span></span>
<span class="line"><span>        local allPrevPositions = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        format "末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\n" endDamping endFalloff virtualEndScale</span></span>
<span class="line"><span>        format "惯性系统: 强度=% 衰减=% 质量分布=%\n" inertiaStrength inertiaDamping massDistribution</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                local velocities = #()</span></span>
<span class="line"><span>                local prevPositions = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local boneLen = getBoneLength b</span></span>
<span class="line"><span>                    append boneLengths boneLen</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- ★ 初始化速度和前一帧位置</span></span>
<span class="line"><span>                    append velocities [0,0,0]</span></span>
<span class="line"><span>                    append prevPositions b.transform.pos</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端1</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndRelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEndRelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEndRelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform</span></span>
<span class="line"><span>                append simTMs virtualEndWorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEndWorldTM.pos</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端2</span></span>
<span class="line"><span>                local virtualEnd2RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd2RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd2RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd2WorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEnd2WorldTM.pos</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端3</span></span>
<span class="line"><span>                local virtualEnd3RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd3RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd3RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd3WorldTM</span></span>
<span class="line"><span>                append velocities [0,0,0]</span></span>
<span class="line"><span>                append prevPositions virtualEnd3WorldTM.pos</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                append allVelocities velocities</span></span>
<span class="line"><span>                append allPrevPositions prevPositions</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true \</span></span>
<span class="line"><span>                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼 + 3个虚拟末端点\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 从控制器读取重力 (可K帧)</span></span>
<span class="line"><span>                local gravityX = at time t ctrlObj.gravityX</span></span>
<span class="line"><span>                local gravityY = at time t ctrlObj.gravityY</span></span>
<span class="line"><span>                local gravityZ = at time t ctrlObj.gravityZ</span></span>
<span class="line"><span>                local gravityVec = [gravityX, gravityY, gravityZ]</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        local velocities = allVelocities[cIdx]</span></span>
<span class="line"><span>                        local prevPositions = allPrevPositions[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 安全获取currentPos</span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then</span></span>
<span class="line"><span>                                currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then</span></span>
<span class="line"><span>                                currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 计算末端阻尼</span></span>
<span class="line"><span>                            local boneDamping = 0.0</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 计算质量因子</span></span>
<span class="line"><span>                            local massFactor = calculateMassFactor j totalNodes massDistribution</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 应用惯性 (将速度加到当前位置)</span></span>
<span class="line"><span>                            if inertiaStrength &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local inertiaPos = velocities[j] * inertiaStrength * massFactor</span></span>
<span class="line"><span>                                currentPos = currentPos + inertiaPos</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 添加重力到currentPos</span></span>
<span class="line"><span>                            currentPos = currentPos + gravityVec * massFactor * 0.01</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 末端角度限制</span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 计算并存储速度 (用于下一帧的惯性)</span></span>
<span class="line"><span>                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]</span></span>
<span class="line"><span>                            local newVelocity = newPos - prevPositions[j]</span></span>
<span class="line"><span>                            velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)</span></span>
<span class="line"><span>                            prevPositions[j] = newPos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 只对真实骨骼写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 调试helper</span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then</span></span>
<span class="line"><span>                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- ★ 更新速度数组引用</span></span>
<span class="line"><span>                        allVelocities[cIdx] = velocities</span></span>
<span class="line"><span>                        allPrevPositions[cIdx] = prevPositions</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                try(delete h)catch()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_inertia.value = 0.3</span></span>
<span class="line"><span>        spn_inertiaDamping.value = 0.95</span></span>
<span class="line"><span>        spn_massDistribution.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V7.2 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V7.2\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 新增功能:\n"</span></span>
<span class="line"><span>format "  - 惯性系统: 质量感/余韵晃动\n"</span></span>
<span class="line"><span>format "  - 重力XYZ: 可K帧控制方向和强度\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "惯性参数说明:\n"</span></span>
<span class="line"><span>format "  - 惯性强度: 0=无惯性, 0.5=中等, 0.9=很强\n"</span></span>
<span class="line"><span>format "  - 惯性衰减: 越大衰减越慢\n"</span></span>
<span class="line"><span>format "  - 质量分布: 0=均匀, 1=末端重, 2=末端很重\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "重力参数说明 (在控制器上可K帧):\n"</span></span>
<span class="line"><span>format "  - 重力Z: 负值=向下, 推荐-50到-200\n"</span></span>
<span class="line"><span>format "  - 重力Y: 正值=向前\n"</span></span>
<span class="line"><span>format "  - 重力X: 正值=向右\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>新增功能说明：</h2><h3>1. <strong>惯性系统 (质量感)</strong></h3><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">范围</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">惯性强度</td><td node="[object Object]" class="px-3 py-2">0-0.99</td><td node="[object Object]" class="px-3 py-2">越大惯性越强，运动停止后会有延续晃动</td></tr><tr><td node="[object Object]" class="px-3 py-2">惯性衰减</td><td node="[object Object]" class="px-3 py-2">0.8-0.99</td><td node="[object Object]" class="px-3 py-2">越大衰减越慢，余韵越长</td></tr><tr><td node="[object Object]" class="px-3 py-2">质量分布</td><td node="[object Object]" class="px-3 py-2">0-2</td><td node="[object Object]" class="px-3 py-2">0=均匀分布, 1=末端更重, 2=末端非常重</td></tr></tbody></table></div><p><strong>效果说明：</strong></p><ul>
<li>惯性=0：骨骼停止时立即静止</li>
<li>惯性=0.3：停止后有轻微晃动</li>
<li>惯性=0.6：停止后有明显余韵</li>
<li>惯性=0.9：停止后长时间晃动（像果冻）</li>
</ul><p><strong>质量分布效果：</strong></p><ul>
<li>0：所有骨骼惯性相同</li>
<li>1：末端骨骼惯性更大（像甩鞭子）</li>
<li>2：末端骨骼惯性非常大（像重物挂在末端）</li>
</ul><h3>2. <strong>重力控制 (XYZ可K帧)</strong></h3><p>在风向控制器上新增三个可K帧的重力参数：</p><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">建议值</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">重力 X</td><td node="[object Object]" class="px-3 py-2">-500~500</td><td node="[object Object]" class="px-3 py-2">左右方向的力</td></tr><tr><td node="[object Object]" class="px-3 py-2">重力 Y</td><td node="[object Object]" class="px-3 py-2">-500~500</td><td node="[object Object]" class="px-3 py-2">前后方向的力</td></tr><tr><td node="[object Object]" class="px-3 py-2">重力 Z</td><td node="[object Object]" class="px-3 py-2">-500~500</td><td node="[object Object]" class="px-3 py-2">上下方向的力 (负值=向下)</td></tr></tbody></table></div><p><strong>使用场景：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>场景1: 自然下垂</span></span>
<span class="line"><span>  重力Z = -100</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景2: 风从后方吹来</span></span>
<span class="line"><span>  重力Y = 50, 重力Z = -50</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景3: K帧实现重力变化</span></span>
<span class="line"><span>  第0帧: 重力Z = 0 (无重力)</span></span>
<span class="line"><span>  第30帧: 重力Z = -200 (突然下坠)</span></span></code></pre></div></div></pre><h3>推荐参数组合</h3><p><strong>飘带/丝带:</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>惯性强度: 0.4</span></span>
<span class="line"><span>惯性衰减: 0.93</span></span>
<span class="line"><span>质量分布: 1.0</span></span>
<span class="line"><span>重力Z: -30</span></span></code></pre></div></div></pre><p><strong>长发:</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>惯性强度: 0.3</span></span>
<span class="line"><span>惯性衰减: 0.95</span></span>
<span class="line"><span>质量分布: 0.5</span></span>
<span class="line"><span>重力Z: -80</span></span></code></pre></div></div></pre><p><strong>厚重布料:</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>惯性强度: 0.5</span></span>
<span class="line"><span>惯性衰减: 0.90</span></span>
<span class="line"><span>质量分布: 1.5</span></span>
<span class="line"><span>重力Z: -150</span></span></code></pre></div></div></pre><p><strong>弹性绳索:</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>惯性强度: 0.7</span></span>
<span class="line"><span>惯性衰减: 0.97</span></span>
<span class="line"><span>质量分布: 2.0</span></span>
<span class="line"><span>重力Z: -50</span></span></code></pre></div></div></pre></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_29hjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>可以再添加一个惯性的参数吗，我希望通过这个开关他停下来的时候，不要完全静止，有一点质量的感觉，而且我需要一个重力的调节</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5dbhjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->2 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5dbhjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>问题在于当 j = 9（最后一个虚拟末端）时，<code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">simTMs[j+1].pos</code> 超出了数组范围。让我修复这个边界检查问题：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.0 Ultimate (Fixed)</span></span>
<span class="line"><span>    - 修复虚拟末端数组越界问题</span></span>
<span class="line"><span>    - 虚拟末端点解决末端折叠问题</span></span>
<span class="line"><span>    - 所有核心参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.0" width:600</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (所有可K帧参数都在控制器上)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:270 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:270 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数" style_sunken:true align:#center color:(color 50 200 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:180 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:180 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:180 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_gravity "重力.Z" type:#float range:[-990.0,999,0] width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:170</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制 (解决末端折叠)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:170 \</span></span>
<span class="line"><span>                toolTip:"末端骨骼的额外阻尼，越大越稳定"</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:170 \</span></span>
<span class="line"><span>                toolTip:"从第几根骨骼开始应用末端阻尼"</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:170 \</span></span>
<span class="line"><span>                toolTip:"虚拟末端点的延伸长度倍率"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        label lbl_empty1 "" width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:80</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:130</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:130</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:580</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:580 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:90 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:90</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:90</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:90</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:90</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:90 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) </span></span>
<span class="line"><span>            catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            return 10.0</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 (可K帧)" width:280</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then </span></span>
<span class="line"><span>            return angle</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if parentArray[l].children.count &gt; 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器已创建！\n\n选中控制器后，在右侧修改面板中可以K帧调整参数。" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not isProperty ctrlObj "springMix" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器缺少必要属性，请重新创建风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local gravity = spn_gravity.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        format "末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\n" endDamping endFalloff virtualEndScale</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local boneLen = getBoneLength b</span></span>
<span class="line"><span>                    append boneLengths boneLen</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端1</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndRelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEndRelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEndRelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform</span></span>
<span class="line"><span>                append simTMs virtualEndWorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端2</span></span>
<span class="line"><span>                local virtualEnd2RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd2RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd2RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd2WorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端3 (用于最后一个虚拟点的计算)</span></span>
<span class="line"><span>                local virtualEnd3RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd3RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd3RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd3WorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true \</span></span>
<span class="line"><span>                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼 + 3个虚拟末端点, simTMs数量=%\n" cIdx chain.count simTMs.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- ★ 总节点数 = 真实骨骼 + 3个虚拟末端 (但只处理到倒数第二个)</span></span>
<span class="line"><span>                        local totalNodes = simTMs.count - 1  -- 不处理最后一个，它只用来提供位置</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 修复: 安全获取currentPos</span></span>
<span class="line"><span>                            local currentPos</span></span>
<span class="line"><span>                            if j == 1 then</span></span>
<span class="line"><span>                                currentPos = prePos</span></span>
<span class="line"><span>                            else if j + 1 &lt;= simTMs.count then</span></span>
<span class="line"><span>                                currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 计算末端阻尼</span></span>
<span class="line"><span>                            local boneDamping = 0.0</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 末端角度限制</span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 只对真实骨骼写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 调试helper</span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 修复: 安全更新下一个位置</span></span>
<span class="line"><span>                            if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then</span></span>
<span class="line"><span>                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                try(delete h)catch()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_gravity.value = 0</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V7.0 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V7.0 (Fixed)\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>修复的问题：</h2><h3>1. <strong>数组越界修复</strong></h3><p>原来的问题是当 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">j = 9</code>（最后一个虚拟末端）时，<code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">simTMs[j+1].pos</code> 访问了不存在的第10个元素。</p><p><strong>修复方案：</strong></p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- ★ 修复: 安全获取currentPos</span></span>
<span class="line"><span>local currentPos</span></span>
<span class="line"><span>if j == 1 then</span></span>
<span class="line"><span>    currentPos = prePos</span></span>
<span class="line"><span>else if j + 1 &lt;= simTMs.count then</span></span>
<span class="line"><span>    currentPos = simTMs[j+1].pos</span></span>
<span class="line"><span>else</span></span>
<span class="line"><span>    -- 最后一个节点，用当前节点沿X轴延伸估算位置</span></span>
<span class="line"><span>    currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]</span></span></code></pre></div></div></pre><h3>2. <strong>增加一个虚拟末端点</strong></h3><p>现在添加了3个虚拟末端点（原来是2个），这样最后一个处理的节点总是有下一个位置可用。</p><h3>3. <strong>处理范围修正</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- 只处理到倒数第二个，最后一个只提供位置</span></span>
<span class="line"><span>local totalNodes = simTMs.count - 1</span></span></code></pre></div></div></pre><h3>4. <strong>安全更新下一个位置</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>if j + 1 &lt;= simTMs.count and j + 1 &lt;= targetRelTMs.count then</span></span>
<span class="line"><span>    simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span></code></pre></div></div></pre><p>现在脚本应该可以正常运行了！</p></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_2bhjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>========================================<br>
<!-- -->初始化模拟状态 (基于帧 0)...<br>
<!-- -->末端控制: 阻尼=0.5 衰减起始=3 虚拟末端长度倍率=1.0<br>
<!-- -->链 1: 7 根骨骼 + 2个虚拟末端点<br>
<!-- -->开始模拟 (循环次数: 2, 链数: 1)...<br>
<!-- -->-- j loop; 文件名: ; 位置: 32650; line: 824 中发生错误<br>
<!-- -->--  帧:<br>
<!-- -->--   localSinRotX: undefined<br>
<!-- -->--   vt1: undefined<br>
<!-- -->--   newTM1: undefined<br>
<!-- -->--   tvector: undefined<br>
<!-- -->--   isRealBone: false<br>
<!-- -->--   springVT: undefined<br>
<!-- -->--   localSinQuat: (quat 0 0 0 1)<br>
<!-- -->--   ssvt: undefined<br>
<!-- -->--   currentPos: undefined<br>
<!-- -->--   dot1: undefined<br>
<!-- -->--   dot2: undefined<br>
<!-- -->--   finalRotation: undefined<br>
<!-- -->--   dot3: undefined<br>
<!-- -->--   effectiveMaxAngle: undefined<br>
<!-- -->--   sangle: undefined<br>
<!-- -->--   windAngle: undefined<br>
<!-- -->--   j: 9<br>
<!-- -->--   isVirtualEnd: true<br>
<!-- -->--   windRotMat: undefined<br>
<!-- -->--   cvector: undefined<br>
<!-- -->--   ttm: undefined<br>
<!-- -->--   targetboneTM: (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.8041,-0.0387631,16.8059])<br>
<!-- -->--   effectiveDelay: undefined<br>
<!-- -->--   angX: undefined<br>
<!-- -->--   finalTM: undefined<br>
<!-- -->--   localSinRotY: undefined<br>
<!-- -->--   tpos: undefined<br>
<!-- -->--   boneDamping: undefined<br>
<!-- -->--   angY1: undefined<br>
<!-- -->--   localSinRotZ: undefined<br>
<!-- -->--   springAngle: undefined<br>
<!-- -->--   xaxisdelay: undefined<br>
<!-- -->--   tempTM: undefined<br>
<!-- -->--   在  cidx loop; 文件名: ; 位置: 41132; 行: 966 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   temp_x: undefined<br>
<!-- -->--   targetRelTMs: #((matrix3 [0.592197,0.000221683,-0.805793] [0.805793,1.06989e-006,0.592197] [0.000132142,-1,-0.000177997] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.998517,-0.054437,-0.000290907] [0.0544369,0.998517,7.97361e-005] [0.000286135,-9.5454e-005,1] [11.2772,3.8147e-006,0]), (matrix3 [0.975443,-0.220251,8.961e-005] [0.220251,0.975443,-1.90787e-005] [-8.32073e-005,3.83469e-005,1] [11.5231,-7.62939e-006,0]), (matrix3 [0.97496,-0.222379,0.00016429] [0.222379,0.97496,-0.0001807] [-0.000119993,0.00021271,1] [11.6788,7.62939e-006,2.49594e-007]), (matrix3 [0.999925,0.012298,7.33372e-005] [-0.012298,0.999925,5.5463e-005] [-7.26496e-005,-5.63606e-005,1] [8.42004,0,3.50177e-007]), (matrix3 [0.9954,-0.0958044,2.5727e-005] [0.0958044,0.9954,-0.000153374] [-1.09147e-005,0.000155134,1] [8.99675,-0.000106812,3.67872e-007]), (matrix3 [1,-0.000351239,0.00033469] [0.000351131,1,0.000302826] [-0.000334797,-0.000302708,1] [7.61336,6.86646e-005,3.72762e-007]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]))<br>
<!-- -->--   currentPTM_start: undefined<br>
<!-- -->--   simTMs: #((matrix3 [0.557944,0.307106,-0.770963] [0.821015,-0.0688555,0.566739] [0.120964,-0.949181,-0.290557] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.54738,-0.100305,-0.830852] [0.831498,-0.0472777,0.553513] [-0.0948011,-0.993833,0.0575248] [26.8333,3.46329,69.9073]), (matrix3 [0.356759,-0.155269,-0.921203] [0.928409,-0.0506648,0.36809] [-0.103825,-0.986572,0.126078] [33.1408,2.30746,60.3333]), (matrix3 [0.151673,-0.0789285,-0.985274] [0.986071,-0.0567579,0.156342] [-0.068262,-0.995263,0.0692205] [37.3073,0.494113,49.5748]), (matrix3 [0.155363,-0.0219836,-0.987613] [0.987154,-0.0342777,0.156054] [-0.0372837,-0.999171,0.0163757] [38.5844,-0.170469,41.2787]), (matrix3 [0.0558305,0.0116808,-0.998372] [0.998272,-0.0190027,0.0556026] [-0.0183223,-0.999751,-0.0127216] [39.982,-0.368246,32.3934]), (matrix3 [0.0505352,0.0293371,-0.998292] [0.998697,-0.00862972,0.0503021] [-0.00713926,-0.999532,-0.0297349] [40.4072,-0.279317,24.7924]), (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.6093,-0.161969,20.7993]), (matrix3 [0.0489683,-0.000222649,-0.998801] [0.9988,0.000147182,0.0489683] [0.000136102,-1,0.00022959] [40.8041,-0.0387631,16.8059]))<br>
<!-- -->--   totalNodes: 9<br>
<!-- -->--   temp_z: undefined<br>
<!-- -->--   prePos: [27.2196,0.00249658,69.5145]<br>
<!-- -->--   currentPTM: (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.6093,-0.161969,20.7993])<br>
<!-- -->--   temp_y: undefined<br>
<!-- -->--   chain: #($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007)<br>
<!-- -->--   cidx: 1<br>
<!-- -->--   boneLengths: #(11.2772, 11.5231, 11.6788, 8.42004, 8.99675, 7.61336, 4.0, 4.0, 4.0)<br>
<!-- -->--   在  sf loop; 文件名: ; 位置: 41155; 行: 967 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   sf: 1<br>
<!-- -->--   在  t loop; 文件名: ; 位置: 41174; 行: 968 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   currTime: 1.0<br>
<!-- -->--   turbSpeed: 2.0<br>
<!-- -->--   windTM: (matrix3 [1,0,0] [0,1,0] [0,0,1] [0,0,0])<br>
<!-- -->--   globalStr: 1.0<br>
<!-- -->--   swingAmp: 8.0<br>
<!-- -->--   turbSeed: 0<br>
<!-- -->--   t: 0<br>
<!-- -->--   windDir: [0,-1,0]<br>
<!-- -->--   springMix: 1.0<br>
<!-- -->--   localSinMix: 0.0<br>
<!-- -->--   turbStrength: 15.0<br>
<!-- -->--   turbLayers: 3<br>
<!-- -->--   turbRoughness: 2.0<br>
<!-- -->--   baseWind: 20.0<br>
<!-- -->--   period: 30.0<br>
<!-- -->--   turbFreq: 3.0<br>
<!-- -->--   globalWindMix: 1.0<br>
<!-- -->--   在  l loop; 文件名: ; 位置: 41189; 行: 969 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   l: 1<br>
<!-- -->--   isWritePass: false<br>
<!-- -->--   在  btn_Bake.pressed(); 文件名: ; 位置: 41200; 行: 970 中调用<br>
<!-- -->--  帧:<br>
<!-- -->--   startF: 0<br>
<!-- -->--   delay: 0.3<br>
<!-- -->--   blend_x: 1.0<br>
<!-- -->--   debugVirtualEnd: false<br>
<!-- -->--   allPreTimeBoneTM: #(#((matrix3 [0.557944,0.307106,-0.770963] [0.821015,-0.0688555,0.566739] [0.120964,-0.949181,-0.290557] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.54738,-0.100305,-0.830852] [0.831498,-0.0472777,0.553513] [-0.0948011,-0.993833,0.0575248] [26.8333,3.46329,69.9073]), (matrix3 [0.356759,-0.155269,-0.921203] [0.928409,-0.0506648,0.36809] [-0.103825,-0.986572,0.126078] [33.1408,2.30746,60.3333]), (matrix3 [0.151673,-0.0789285,-0.985274] [0.986071,-0.0567579,0.156342] [-0.068262,-0.995263,0.0692205] [37.3073,0.494113,49.5748]), (matrix3 [0.155363,-0.0219836,-0.987613] [0.987154,-0.0342777,0.156054] [-0.0372837,-0.999171,0.0163757] [38.5844,-0.170469,41.2787]), (matrix3 [0.0558305,0.0116808,-0.998372] [0.998272,-0.0190027,0.0556026] [-0.0183223,-0.999751,-0.0127216] [39.982,-0.368246,32.3934]), (matrix3 [0.0505352,0.0293371,-0.998292] [0.998697,-0.00862972,0.0503021] [-0.00713926,-0.999532,-0.0297349] [40.4072,-0.279317,24.7924]), (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.6093,-0.161969,20.7993]), (matrix3 [0.0489683,-0.000222649,-0.998801] [0.9988,0.000147182,0.0489683] [0.000136102,-1,0.00022959] [40.8041,-0.0387631,16.8059])))<br>
<!-- -->--   allPrePos: #([26.8333,3.46329,69.9073])<br>
<!-- -->--   allChains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))<br>
<!-- -->--   allBoneLengths: #(#(11.2772, 11.5231, 11.6788, 8.42004, 8.99675, 7.61336, 4.0, 4.0, 4.0))<br>
<!-- -->--   maxAngle: 80.0<br>
<!-- -->--   allVirtualEndHelpers: #()<br>
<!-- -->--   gravity: 0.0<br>
<!-- -->--   blend_y: 1.0<br>
<!-- -->--   endDamping: 0.5<br>
<!-- -->--   virtualEndScale: 1.0<br>
<!-- -->--   softness: 0.3<br>
<!-- -->--   ctrlObj: $Wind_Controller196<br>
<!-- -->--   chains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))<br>
<!-- -->--   xSpring: 0.3<br>
<!-- -->--   subframe: 1.0<br>
<!-- -->--   totalFrames: 202<br>
<!-- -->--   scaleMotion: 1.0<br>
<!-- -->--   blend_z: 1.0<br>
<!-- -->--   frameCounter: 1<br>
<!-- -->--   subs: 1<br>
<!-- -->--   loopsCount: 2<br>
<!-- -->--   endF: 100<br>
<!-- -->--   endFalloff: 3<br>
<!-- -->--   allBoneTM: #(#((matrix3 [0.592197,0.000221683,-0.805793] [0.805793,1.06989e-006,0.592197] [0.000132142,-1,-0.000177997] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.998517,-0.054437,-0.000290907] [0.0544369,0.998517,7.97361e-005] [0.000286135,-9.5454e-005,1] [11.2772,3.8147e-006,0]), (matrix3 [0.975443,-0.220251,8.961e-005] [0.220251,0.975443,-1.90787e-005] [-8.32073e-005,3.83469e-005,1] [11.5231,-7.62939e-006,0]), (matrix3 [0.97496,-0.222379,0.00016429] [0.222379,0.97496,-0.0001807] [-0.000119993,0.00021271,1] [11.6788,7.62939e-006,2.49594e-007]), (matrix3 [0.999925,0.012298,7.33372e-005] [-0.012298,0.999925,5.5463e-005] [-7.26496e-005,-5.63606e-005,1] [8.42004,0,3.50177e-007]), (matrix3 [0.9954,-0.0958044,2.5727e-005] [0.0958044,0.9954,-0.000153374] [-1.09147e-005,0.000155134,1] [8.99675,-0.000106812,3.67872e-007]), (matrix3 [1,-0.000351239,0.00033469] [0.000351131,1,0.000302826] [-0.000334797,-0.000302708,1] [7.61336,6.86646e-005,3.72762e-007]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0])))</p><blockquote>
<blockquote>
<p>MAXScript 卷展栏处理程序 异常:<br>
<!-- -->-- 未知属性:“pos”位于 undefined &lt;&lt;</p>
</blockquote>
</blockquote></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5ddhjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->3 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5ddhjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>抱歉，我发现了语法错误。问题在于 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if ... do</code> 后面不能接 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">else</code>，需要用 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if ... then ... else</code>。让我修复：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.0 Ultimate</span></span>
<span class="line"><span>    - 虚拟末端点解决末端折叠问题</span></span>
<span class="line"><span>    - 末端阻尼控制</span></span>
<span class="line"><span>    - 所有核心参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.0" width:600</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (所有可K帧参数都在控制器上)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:270 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:270 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数" style_sunken:true align:#center color:(color 50 200 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:180 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:180 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:180 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_gravity "重力.Z" type:#float range:[-990.0,999,0] width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:170</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制 (解决末端折叠)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:170 \</span></span>
<span class="line"><span>                toolTip:"末端骨骼的额外阻尼，越大越稳定"</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:170 \</span></span>
<span class="line"><span>                toolTip:"从第几根骨骼开始应用末端阻尼"</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:170 \</span></span>
<span class="line"><span>                toolTip:"虚拟末端点的延伸长度倍率"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        label lbl_empty1 "" width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:80</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:130</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:130</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:580</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:580 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:90 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:90</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:90</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:90</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:90</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:90 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- 获取骨骼长度</span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            -- 尝试从bounding box获取长度</span></span>
<span class="line"><span>            local len = 0.0</span></span>
<span class="line"><span>            try </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>            ) </span></span>
<span class="line"><span>            catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 如果有父级，用父级到自己的距离</span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            return 10.0  -- 默认长度</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 (可K帧)" width:280</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then </span></span>
<span class="line"><span>            return angle</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 then up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 then return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- ★ 计算末端阻尼因子</span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 then</span></span>
<span class="line"><span>                append parentArray obj</span></span>
<span class="line"><span>            else </span></span>
<span class="line"><span>                append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i = 1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    i += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l = 1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" then CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" then </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then </span></span>
<span class="line"><span>                                bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then </span></span>
<span class="line"><span>                                biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) </span></span>
<span class="line"><span>                        catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    curr = curr.children[1]</span></span>
<span class="line"><span>                    append bones curr</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then </span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) </span></span>
<span class="line"><span>                    catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器已创建！\n\n选中控制器后，在右侧修改面板中可以K帧调整参数。" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请选择骨骼根部"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先拾取风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not isProperty ctrlObj "springMix" then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器缺少必要属性，请重新创建风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local gravity = spn_gravity.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 末端控制参数</span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        format "末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\n" endDamping endFalloff virtualEndScale</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    local boneLen = getBoneLength b</span></span>
<span class="line"><span>                    append boneLengths boneLen</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 虚拟末端</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndRelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEndRelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEndRelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform</span></span>
<span class="line"><span>                append simTMs virtualEndWorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd2RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd2RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd2WorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if debugVirtualEnd then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true \</span></span>
<span class="line"><span>                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼 + 2个虚拟末端点\n" cIdx chain.count</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try </span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            ) </span></span>
<span class="line"><span>                            catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local totalNodes = chain.count + 2</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos</span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 计算末端阻尼</span></span>
<span class="line"><span>                            local boneDamping = 0.0</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 then rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 then angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 末端角度限制 (修复语法)</span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count then</span></span>
<span class="line"><span>                                effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 then rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 then rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 只对真实骨骼写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try </span></span>
<span class="line"><span>                                    (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                    ) </span></span>
<span class="line"><span>                                    catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 调试helper</span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count then</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j &lt; totalNodes then simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not debugVirtualEnd then</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                try(delete h)catch()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择父对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择骨骼！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 then </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "请先选择对象！"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined then </span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_gravity.value = 0</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V7.0 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V7.0\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 末端控制功能:\n"</span></span>
<span class="line"><span>format "  - 末端阻尼: 稳定末端骨骼\n"</span></span>
<span class="line"><span>format "  - 末端衰减: 从第几根开始应用阻尼\n"</span></span>
<span class="line"><span>format "  - 虚拟末端长度: 调整虚拟点距离\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>修复的语法错误：</h2><ol>
<li>
<p><strong><code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if ... do</code> 改为 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if ... then</code></strong>：MaxScript中 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if</code> 后面需要用 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">then</code>（带返回值/多行）或 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">do</code>（单行无返回值），但 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">else</code> 只能跟在 <code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">then</code> 后面</p>
</li>
<li>
<p><strong>多处语法统一</strong>：</p>
<ul>
<li><code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if condition do action</code> → 无else的单行</li>
<li><code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if condition then action else action</code> → 有else的情况</li>
<li><code class="rounded px-1.5 py-0.5 bg-surface-tertiary font-mono text-[0.9em] text-text-primary font-medium" node="[object Object]">if condition then (block) else (block)</code> → 多行块</li>
</ul>
</li>
<li>
<p><strong>主要修改位置</strong>：</p>
<pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- 原来错误的写法:</span></span>
<span class="line"><span>if isVirtualEnd do effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>else if j == chain.count do effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 修复后:</span></span>
<span class="line"><span>if isVirtualEnd then</span></span>
<span class="line"><span>    effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>else if j == chain.count then</span></span>
<span class="line"><span>    effectiveMaxAngle = maxAngle * 0.7</span></span></code></pre></div></div></pre>
</li>
</ol><p>现在脚本应该可以正常运行了。</p></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_2dhjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>-- 匿名 codeblock; 文件名: ; 位置: 37119; line: 869 中发生错误<br>
<!-- -->-- 语法错误: 位于 else，需要 &lt;因子&gt;<br>
<!-- -->--  所在行:                             else i</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5dfhjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->2 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5dfhjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>你说得对！末端骨骼因为没有子级约束，会出现过度旋转的问题。我来添加虚拟末端点和末端阻尼控制：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V7.0 Ultimate</span></span>
<span class="line"><span>    - 虚拟末端点解决末端折叠问题</span></span>
<span class="line"><span>    - 末端阻尼控制</span></span>
<span class="line"><span>    - 所有核心参数可K帧</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V7.0" width:600</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (所有可K帧参数都在控制器上)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:270 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:270 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数" style_sunken:true align:#center color:(color 50 200 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:180 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:180 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:180 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_gravity "重力.Z" type:#float range:[-990.0,999,0] width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:170</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 末端控制 (解决末端折叠)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_endDamping "末端阻尼" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:170 \</span></span>
<span class="line"><span>                toolTip:"末端骨骼的额外阻尼，越大越稳定"</span></span>
<span class="line"><span>        spinner spn_endFalloff "末端衰减" range:[1, 10, 3] type:#integer width:170 \</span></span>
<span class="line"><span>                toolTip:"从第几根骨骼开始应用末端阻尼"</span></span>
<span class="line"><span>        spinner spn_virtualEndScale "虚拟末端长度" range:[0.1, 3.0, 1.0] scale:0.1 width:170 \</span></span>
<span class="line"><span>                toolTip:"虚拟末端点的延伸长度倍率"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_debugVirtualEnd "调试: 显示虚拟末端" checked:false align:#left</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        label lbl_empty1 "" width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:80</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:130</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:130</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:580</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:580 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:90 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:90</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:90</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:90</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:90</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:90 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- 获取骨骼长度</span></span>
<span class="line"><span>    fn getBoneLength bone =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if bone.children.count &gt; 0 then</span></span>
<span class="line"><span>            return distance bone.pos bone.children[1].pos</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            -- 尝试从bounding box获取长度</span></span>
<span class="line"><span>            try (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox bone bone.transform</span></span>
<span class="line"><span>                local len = abs(bbox[2].x - bbox[1].x)</span></span>
<span class="line"><span>                if len &gt; 0.1 then return len</span></span>
<span class="line"><span>            ) catch()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 如果有父级，用父级到自己的距离</span></span>
<span class="line"><span>            if bone.parent != undefined then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentDist = distance bone.pos bone.parent.pos</span></span>
<span class="line"><span>                if parentDist &gt; 0.1 then return parentDist</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            return 10.0  -- 默认长度</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 (可K帧)" width:280</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 do return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 do up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- ★ 计算末端阻尼因子</span></span>
<span class="line"><span>    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        -- 从倒数第endFalloff根骨骼开始应用阻尼</span></span>
<span class="line"><span>        local startDampingAt = totalBones - endFalloff + 1</span></span>
<span class="line"><span>        if boneIndex &lt; startDampingAt then return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 线性插值阻尼</span></span>
<span class="line"><span>        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float</span></span>
<span class="line"><span>        return endDamping * progress</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 do (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 </span></span>
<span class="line"><span>            then append parentArray obj</span></span>
<span class="line"><span>            else append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i=1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else(i += 1)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l=1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" do CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" do </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器已创建！\n\n选中控制器后，在右侧修改面板中可以K帧调整参数。" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请选择骨骼根部"; return false)</span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj do (messageBox "请先拾取风向控制器"; return false)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        if not isProperty ctrlObj "springMix" do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器缺少必要属性，请重新创建风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local gravity = spn_gravity.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 末端控制参数</span></span>
<span class="line"><span>        local endDamping = spn_endDamping.value</span></span>
<span class="line"><span>        local endFalloff = spn_endFalloff.value</span></span>
<span class="line"><span>        local virtualEndScale = spn_virtualEndScale.value</span></span>
<span class="line"><span>        local debugVirtualEnd = chk_debugVirtualEnd.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        local allBoneLengths = #()  -- ★ 存储每根骨骼的长度</span></span>
<span class="line"><span>        local allVirtualEndHelpers = #() -- ★ 调试用的虚拟末端helper</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        format "末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\n" endDamping endFalloff virtualEndScale</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 (改进虚拟末端) ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                local boneLengths = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 收集骨骼数据和长度</span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 计算骨骼长度</span></span>
<span class="line"><span>                    local boneLen = getBoneLength b</span></span>
<span class="line"><span>                    append boneLengths boneLen</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 创建虚拟末端 (使用最后一根骨骼的长度)</span></span>
<span class="line"><span>                local lastBone = chain[chain.count]</span></span>
<span class="line"><span>                local lastBoneLen = boneLengths[boneLengths.count]</span></span>
<span class="line"><span>                local virtualLen = lastBoneLen * virtualEndScale</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端的相对变换 (沿X轴延伸)</span></span>
<span class="line"><span>                local virtualEndRelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEndRelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEndRelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 虚拟末端的世界变换</span></span>
<span class="line"><span>                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform</span></span>
<span class="line"><span>                append simTMs virtualEndWorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 再添加一个虚拟末端的末端 (用于计算虚拟末端本身)</span></span>
<span class="line"><span>                local virtualEnd2RelTM = matrix3 1</span></span>
<span class="line"><span>                virtualEnd2RelTM.pos = [virtualLen, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs virtualEnd2RelTM</span></span>
<span class="line"><span>                append boneLengths virtualLen</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM</span></span>
<span class="line"><span>                append simTMs virtualEnd2WorldTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 初始位置 (用第二根骨骼或虚拟末端)</span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>                append allBoneLengths boneLengths</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 调试: 创建虚拟末端helper</span></span>
<span class="line"><span>                if debugVirtualEnd do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local helper = Point name:("VirtualEnd_" + cIdx as string) size:5 cross:true \</span></span>
<span class="line"><span>                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos</span></span>
<span class="line"><span>                    append allVirtualEndHelpers helper</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                format "链 %: % 根骨骼 + 2个虚拟末端点, 最后骨骼长度=%, 虚拟长度=%\n" \</span></span>
<span class="line"><span>                       cIdx chain.count lastBoneLen virtualLen</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 缝合逻辑</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 从控制器读取参数</span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        local boneLengths = allBoneLengths[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- ★ 总节点数 = 真实骨骼 + 2个虚拟末端</span></span>
<span class="line"><span>                        local totalNodes = chain.count + 2</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- ★ 遍历所有节点 (包括虚拟末端)</span></span>
<span class="line"><span>                        for j = 1 to totalNodes do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local isVirtualEnd = (j &gt; chain.count)</span></span>
<span class="line"><span>                            local isRealBone = (j &lt;= chain.count)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 计算局部Sin旋转 (只对真实骨骼)</span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 and isRealBone do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos</span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 计算末端阻尼 (真实骨骼和虚拟末端都应用)</span></span>
<span class="line"><span>                            local boneDamping = 0.0</span></span>
<span class="line"><span>                            if isRealBone then</span></span>
<span class="line"><span>                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                boneDamping = endDamping * 1.5  -- 虚拟末端额外阻尼</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 实际使用的delay (加上末端阻尼)</span></span>
<span class="line"><span>                            local effectiveDelay = delay + boneDamping * (1.0 - delay)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 do rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 do angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- ★ 使用有效delay (包含末端阻尼)</span></span>
<span class="line"><span>                                springAngle *= (1.0 - effectiveDelay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind (全局模式，只对第一根骨骼)</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 对末端应用更严格的角度限制</span></span>
<span class="line"><span>                            local effectiveMaxAngle = maxAngle</span></span>
<span class="line"><span>                            if isVirtualEnd do effectiveMaxAngle = maxAngle * 0.5</span></span>
<span class="line"><span>                            else if j == chain.count do effectiveMaxAngle = maxAngle * 0.7</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle effectiveMaxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 do rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 do rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 只对真实骨骼写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs and isRealBone do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 do</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ 调试: 更新虚拟末端helper位置</span></span>
<span class="line"><span>                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                if cIdx &lt;= allVirtualEndHelpers.count do</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j &lt; totalNodes do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 清理调试helper</span></span>
<span class="line"><span>        if not debugVirtualEnd do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for h in allVirtualEndHelpers do try(delete h)catch()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择父对象！"; return false)</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择骨骼！"; return false)</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_gravity.value = 0</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_endDamping.value = 0.5</span></span>
<span class="line"><span>        spn_endFalloff.value = 3</span></span>
<span class="line"><span>        spn_virtualEndScale.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V7.0 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V7.0\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 新增末端控制:\n"</span></span>
<span class="line"><span>format "  - 末端阻尼: 稳定末端骨骼\n"</span></span>
<span class="line"><span>format "  - 末端衰减: 从第几根开始应用阻尼\n"</span></span>
<span class="line"><span>format "  - 虚拟末端长度: 调整虚拟点距离\n"</span></span>
<span class="line"><span>format "  - 调试显示: 可视化虚拟末端位置\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>主要改进：</h2><h3>1. <strong>虚拟末端系统</strong></h3><ul>
<li>在每条骨骼链末端添加 <strong>2个虚拟末端点</strong></li>
<li>虚拟末端沿骨骼X轴方向延伸</li>
<li>长度基于最后一根骨骼的长度 × 倍率</li>
<li>虚拟末端参与Spring计算但不写入关键帧</li>
</ul><h3>2. <strong>末端控制参数</strong></h3><div class="overflow-x-auto"><table node="[object Object]" class="min-w-full"><thead><tr><th node="[object Object]" class="whitespace-nowrap px-3 py-2">参数</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">范围</th><th node="[object Object]" class="whitespace-nowrap px-3 py-2">说明</th></tr></thead><tbody><tr><td node="[object Object]" class="px-3 py-2">末端阻尼</td><td node="[object Object]" class="px-3 py-2">0-1</td><td node="[object Object]" class="px-3 py-2">越大末端越稳定，0.5为推荐值</td></tr><tr><td node="[object Object]" class="px-3 py-2">末端衰减</td><td node="[object Object]" class="px-3 py-2">1-10</td><td node="[object Object]" class="px-3 py-2">从倒数第几根骨骼开始应用阻尼</td></tr><tr><td node="[object Object]" class="px-3 py-2">虚拟末端长度</td><td node="[object Object]" class="px-3 py-2">0.1-3.0</td><td node="[object Object]" class="px-3 py-2">虚拟点距离倍率</td></tr></tbody></table></div><h3>3. <strong>阻尼计算逻辑</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>- 普通骨骼: 使用基础delay</span></span>
<span class="line"><span>- 接近末端的骨骼: delay + 末端阻尼 × 渐变</span></span>
<span class="line"><span>- 虚拟末端: 末端阻尼 × 1.5 (额外稳定)</span></span></code></pre></div></div></pre><h3>4. <strong>角度限制</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>- 普通骨骼: 最大角度 100%</span></span>
<span class="line"><span>- 最后一根真实骨骼: 最大角度 70%</span></span>
<span class="line"><span>- 虚拟末端: 最大角度 50%</span></span></code></pre></div></div></pre><h3>5. <strong>调试功能</strong></h3><p>勾选"调试:显示虚拟末端"后，会创建紫色Point显示虚拟末端位置，方便观察。</p><h3>推荐参数：</h3><ul>
<li><strong>飘带/头发</strong>: 末端阻尼=0.5, 衰减=3</li>
<li><strong>很长的链条</strong>: 末端阻尼=0.7, 衰减=5</li>
<li><strong>硬质物体</strong>: 末端阻尼=0.8, 衰减=2</li>
</ul></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_2fhjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>这个算法，末端他似乎会出现前所未有的旋转增幅曲线，和前一节完全不同，他会出现不同程度的旋转折叠，你能帮助我虚拟一个假的末端，解决这个问题吗</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5dhhjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->2 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5dhhjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>你说得对！把这些参数放到风向控制器上就可以K帧了。让我重新设计：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V6.8 Ultimate</span></span>
<span class="line"><span>    - 混合控制参数可K帧</span></span>
<span class="line"><span>    - 扰动参数可K帧</span></span>
<span class="line"><span>    - 所有核心参数都在风向控制器上</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V6.8" width:600</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器 (所有可K帧参数都在控制器上)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:270 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:270 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_ctrlInfo "★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数" style_sunken:true align:#center color:(color 50 200 50)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:180 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:180 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:180 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 局部骨骼Sin控制 (当localSinMix&gt;0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_gravity "重力.Z" type:#float range:[-990.0,999,0] width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:170</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        label lbl_empty1 "" width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:80</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:130</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:130</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:580</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:580 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:90 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:90</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:90</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:90</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:90</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:90 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- ★ 完整的可K帧参数定义</span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    -- 混合控制</span></span>
<span class="line"><span>                    springMix type:#float default:1.0 animatable:true ui:spn_springMix</span></span>
<span class="line"><span>                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix</span></span>
<span class="line"><span>                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 全局强度</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- Sin风力参数</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    period type:#float default:30.0 animatable:true ui:spn_period</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- 扰动参数</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq</span></span>
<span class="line"><span>                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed</span></span>
<span class="line"><span>                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers</span></span>
<span class="line"><span>                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough</span></span>
<span class="line"><span>                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数 (可K帧)" width:280</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    group "★ 混合控制"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_springMix "Spring弹簧:" range:[0,1,1.0] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"弹簧物理效果 (通常保持1)"</span></span>
<span class="line"><span>                        spinner spn_globalWindMix "全局风向:" range:[0,1,1.0] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"风向控制器驱动的Sin风力"</span></span>
<span class="line"><span>                        spinner spn_localSinMix "局部Sin:" range:[0,1,0.0] type:#float scale:0.01 \</span></span>
<span class="line"><span>                                toolTip:"每根骨骼独立的Sin波动"</span></span>
<span class="line"><span>                        label lbl_mixTip "提示: 可K帧实现渐变过渡" align:#left</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "全局强度"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "Sin风力参数"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_base "基础风压(度):" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度(度):" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_period "周期(帧):" range:[1,500,30.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "★ 多层扰动 (多股风冲撞)"</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        spinner spn_turbStr "扰动强度(度):" range:[0,90,15.0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"总体力度，越大波动越剧烈"</span></span>
<span class="line"><span>                        spinner spn_turbFreq "扰动频率:" range:[0.1,50,3.0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"波峰波谷密度，越大冲击越频繁"</span></span>
<span class="line"><span>                        spinner spn_turbSpeed "扰动速度:" range:[0.1,20,2.0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"变化快慢"</span></span>
<span class="line"><span>                        spinner spn_turbLayers "扰动层数:" range:[1,8,3] type:#integer \</span></span>
<span class="line"><span>                                toolTip:"叠加层数，越多越复杂"</span></span>
<span class="line"><span>                        spinner spn_turbRough "粗糙度:" range:[0.1,5,2.0] type:#float \</span></span>
<span class="line"><span>                                toolTip:"高频细节强度"</span></span>
<span class="line"><span>                        spinner spn_turbSeed "随机种子:" range:[0,9999,0] type:#integer \</span></span>
<span class="line"><span>                                toolTip:"不同种子不同模式"</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- ★ 多层扰动计算函数</span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 do return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 do up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3:</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 do (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 </span></span>
<span class="line"><span>            then append parentArray obj</span></span>
<span class="line"><span>            else append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i=1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else(i += 1)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l=1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" do CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" do </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>        messageBox "风向控制器已创建！\n\n选中控制器后，在右侧修改面板中可以：\n- K帧混合控制参数\n- K帧风力参数\n- K帧扰动参数" title:"提示"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请选择骨骼根部"; return false)</span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj do (messageBox "请先拾取风向控制器"; return false)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 验证控制器有必要的属性</span></span>
<span class="line"><span>        if not isProperty ctrlObj "springMix" do </span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            messageBox "控制器缺少必要属性，请重新创建风向控制器"</span></span>
<span class="line"><span>            return false</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local gravity = spn_gravity.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]</span></span>
<span class="line"><span>                    append boneRelTMs lastRelTM </span></span>
<span class="line"><span>                    local endWorldTM = lastRelTM * chain[chain.count].transform</span></span>
<span class="line"><span>                    append simTMs endWorldTM</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                    local endTM = matrix3 1</span></span>
<span class="line"><span>                    endTM.pos = [bbox[2].x, 0, 0]</span></span>
<span class="line"><span>                    append boneRelTMs endTM</span></span>
<span class="line"><span>                    local endWorldTM = endTM * chain[1].transform</span></span>
<span class="line"><span>                    append simTMs endWorldTM</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 缝合逻辑</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- ★ 从控制器读取所有可K帧参数</span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 混合参数 (可K帧)</span></span>
<span class="line"><span>                local springMix = at time t ctrlObj.springMix</span></span>
<span class="line"><span>                local globalWindMix = at time t ctrlObj.globalWindMix</span></span>
<span class="line"><span>                local localSinMix = at time t ctrlObj.localSinMix</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 风力参数 (可K帧)</span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local period = at time t ctrlObj.period</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                -- 扰动参数 (可K帧)</span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                local turbSpeed = at time t ctrlObj.turbSpeed</span></span>
<span class="line"><span>                local turbLayers = at time t ctrlObj.turbLayers</span></span>
<span class="line"><span>                local turbRoughness = at time t ctrlObj.turbRoughness</span></span>
<span class="line"><span>                local turbSeed = ctrlObj.turbSeed</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            -- 计算局部Sin旋转</span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos</span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring计算</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 do rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 do angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - delay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind (全局模式)</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle maxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle maxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 do rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 do rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 写入关键帧</span></span>
<span class="line"><span>                            if isWritePass and sf == subs do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 do</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j &lt; chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择父对象！"; return false)</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择骨骼！"; return false)</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_gravity.value = 0</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V6.8 已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V6.8\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "★ 可K帧参数 (在风向控制器修改面板中):\n"</span></span>
<span class="line"><span>format "  - 混合控制: Spring/全局风/局部Sin\n"</span></span>
<span class="line"><span>format "  - 风力参数: 基础风压/Sin幅度/周期\n"</span></span>
<span class="line"><span>format "  - 扰动参数: 强度/频率/速度/层数/粗糙度\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "使用方法:\n"</span></span>
<span class="line"><span>format "1. 创建风向控制器\n"</span></span>
<span class="line"><span>format "2. 选中控制器，在修改面板调整/K帧参数\n"</span></span>
<span class="line"><span>format "3. 选择骨骼根部，点击生成\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>主要改进：</h2><h3>1. <strong>所有核心参数都在风向控制器上，可K帧</strong></h3><p>选中Wind_Controller后，在修改面板中可以看到并K帧：</p><p><strong>混合控制:</strong></p><ul>
<li>Spring弹簧 (0-1)</li>
<li>全局风向 (0-1)</li>
<li>局部Sin (0-1)</li>
</ul><p><strong>风力参数:</strong></p><ul>
<li>总体强度</li>
<li>基础风压</li>
<li>Sin幅度</li>
<li>周期</li>
</ul><p><strong>扰动参数:</strong></p><ul>
<li>扰动强度</li>
<li>扰动频率</li>
<li>扰动速度</li>
<li>扰动层数</li>
<li>粗糙度</li>
<li>随机种子</li>
</ul><h3>2. <strong>使用方法</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>场景A: 从无风到有风</span></span>
<span class="line"><span>- 在第0帧: globalWindMix = 0</span></span>
<span class="line"><span>- 在第30帧: globalWindMix = 1</span></span>
<span class="line"><span>- 风会渐渐吹起来</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景B: 风力渐强</span></span>
<span class="line"><span>- 在第0帧: turbStrength = 5</span></span>
<span class="line"><span>- 在第50帧: turbStrength = 40</span></span>
<span class="line"><span>- 扰动会越来越剧烈</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景C: 模式切换</span></span>
<span class="line"><span>- 第0-50帧: localSinMix=0, globalWindMix=1 (全局风)</span></span>
<span class="line"><span>- 第50-100帧: localSinMix=1, globalWindMix=0 (局部Sin)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景D: 纯Spring</span></span>
<span class="line"><span>- springMix=1, globalWindMix=0, localSinMix=0</span></span></code></pre></div></div></pre><h3>3. <strong>UI简化</strong></h3><p>主面板不再显示混合控制和扰动参数，因为它们都在控制器上可K帧调整。</p></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_2hhjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 px-3 py-2 transition-[border-radius] duration-150 rounded-3xl"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>混合控制的三个参数可以写在风向控制面板上面，我希望可以K帧，包括扰动面板也希望可以K帧</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5djhjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->3 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5djhjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>你说得对！我需要把混合系统拆分成独立参数，并且大幅改进扰动系统。让我重新设计：</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V6.5 Ultimate</span></span>
<span class="line"><span>    - 三参数独立混合系统：全局风/局部Sin/Spring</span></span>
<span class="line"><span>    - 全新多层扰动系统（多股风冲撞效果）</span></span>
<span class="line"><span>    - 扰动频率/层数/速度完整控制</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V6.5" width:600</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:270 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:270 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:180 align:#left across:3 height:25</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:180 align:#center height:25</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:180 align:#right height:25</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. ★ 混合控制 (核心)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_mix "三个参数独立控制，可任意组合：" align:#left</span></span>
<span class="line"><span>        spinner spn_springMix "Spring弹簧" range:[0.0, 1.0, 1.0] scale:0.01 align:#left across:3 width:170 \</span></span>
<span class="line"><span>                toolTip:"弹簧物理效果强度 (通常保持1)"</span></span>
<span class="line"><span>        spinner spn_globalWindMix "全局风向" range:[0.0, 1.0, 1.0] scale:0.01 width:170 \</span></span>
<span class="line"><span>                toolTip:"风向控制器驱动的Sin风力"</span></span>
<span class="line"><span>        spinner spn_localSinMix "局部Sin" range:[0.0, 1.0, 0.0] scale:0.01 width:170 \</span></span>
<span class="line"><span>                toolTip:"每根骨骼独立的Sin波动"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_mixTip "提示: 纯Spring=只开Spring | 自然飘动=Spring+全局风 | 精细控制=Spring+局部Sin" align:#center style_sunken:true</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. 全局Sin风力参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_baseWind "基础风压(度)" range:[0.0, 90.0, 20.0] type:#float align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_swingAmp "Sin幅度(度)" range:[0.0, 60.0, 8.0] type:#float width:170</span></span>
<span class="line"><span>        spinner spn_period "周期(帧)" range:[1, 500, 30] type:#integer width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. ★ 多层扰动系统 (多股风冲撞)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_turb "模拟多股气流冲击效果：" align:#left</span></span>
<span class="line"><span>        spinner spn_turbStrength "扰动强度(度)" range:[0.0, 90.0, 15.0] type:#float align:#left across:3 width:170 \</span></span>
<span class="line"><span>                toolTip:"扰动的总体力度，越大波动越剧烈"</span></span>
<span class="line"><span>        spinner spn_turbFreq "扰动频率" range:[0.1, 50.0, 3.0] scale:0.1 type:#float width:170 \</span></span>
<span class="line"><span>                toolTip:"波峰波谷的密度，越大冲击越频繁"</span></span>
<span class="line"><span>        spinner spn_turbSpeed "扰动速度" range:[0.1, 20.0, 2.0] scale:0.1 type:#float width:170 \</span></span>
<span class="line"><span>                toolTip:"扰动变化的速度"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_turbLayers "扰动层数" range:[1, 8, 3] type:#integer align:#left across:3 width:170 \</span></span>
<span class="line"><span>                toolTip:"叠加的噪波层数，层数越多越复杂"</span></span>
<span class="line"><span>        spinner spn_turbRoughness "粗糙度" range:[0.1, 5.0, 2.0] scale:0.1 type:#float width:170 \</span></span>
<span class="line"><span>                toolTip:"高频细节的强度"</span></span>
<span class="line"><span>        spinner spn_turbSeed "随机种子" range:[0, 9999, 0] type:#integer width:170 \</span></span>
<span class="line"><span>                toolTip:"不同种子产生不同扰动模式"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        checkbox chk_turbPreview "预览扰动曲线" checked:false align:#left across:2</span></span>
<span class="line"><span>        button btn_testTurb "测试扰动效果" width:150 align:#right height:20</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 局部骨骼Sin控制"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:100</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:100</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:100</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:100</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:100</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_gravity "重力.Z" type:#float range:[-990.0,999,0] width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:170</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "8. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:170</span></span>
<span class="line"><span>        label lbl_empty1 "" width:170</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:170</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "9. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4</span></span>
<span class="line"><span>        label lbl_empty2 "" width:80</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:130</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:130</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:580</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:580 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:90 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:90</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:90</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:90</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:90</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:90 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    turbStrength type:#float default:15.0 animatable:true ui:spn_turb</span></span>
<span class="line"><span>                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbF</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数(可K帧)" (</span></span>
<span class="line"><span>                    group "核心参数" (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_base "基础风压:" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "Sin幅度:" range:[0,60,8.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "扰动参数" (</span></span>
<span class="line"><span>                        spinner spn_turb "扰动强度:" range:[0,90,15.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turbF "扰动频率:" range:[0.1,50,3.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- ★ 全新多层扰动计算函数</span></span>
<span class="line"><span>    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if turbStrength == 0 do return 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalTurb = 0.0</span></span>
<span class="line"><span>        local amplitude = turbStrength</span></span>
<span class="line"><span>        local frequency = turbFreq</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for layer = 1 to turbLayers do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            -- 每层使用不同的噪波采样位置</span></span>
<span class="line"><span>            local timeOffset = absTime * frequency * turbSpeed * 0.05</span></span>
<span class="line"><span>            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 获取噪波值 (-1 到 1)</span></span>
<span class="line"><span>            local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 添加额外的高频细节</span></span>
<span class="line"><span>            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]</span></span>
<span class="line"><span>            local detailNoise = noise3 detailPos</span></span>
<span class="line"><span>            noiseValue = noiseValue * 0.7 + detailNoise * 0.3</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 累加到总扰动</span></span>
<span class="line"><span>            totalTurb += noiseValue * amplitude</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 下一层：频率加倍，振幅减半（分形噪波原理）</span></span>
<span class="line"><span>            amplitude *= 0.6</span></span>
<span class="line"><span>            frequency *= 1.8</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return totalTurb</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- 计算带扰动的根骨骼风力</span></span>
<span class="line"><span>    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        -- 基础Sin波</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 多层扰动</span></span>
<span class="line"><span>        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        return baseWind + swingComponent + turbulence</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 do up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- 局部Sin旋转计算函数</span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1: -- X轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2: -- Y轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3: -- Z轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 do (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 </span></span>
<span class="line"><span>            then append parentArray obj</span></span>
<span class="line"><span>            else append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i=1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else(i += 1)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l=1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" do CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" do </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- 测试扰动效果</span></span>
<span class="line"><span>    on btn_testTurb pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        format "\n========== 扰动测试 ==========\n"</span></span>
<span class="line"><span>        format "扰动强度: %  频率: %  速度: %  层数: %  粗糙度: %\n" \</span></span>
<span class="line"><span>            spn_turbStrength.value spn_turbFreq.value spn_turbSpeed.value spn_turbLayers.value spn_turbRoughness.value</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "\n前50帧扰动值预览:\n"</span></span>
<span class="line"><span>        for t = 0 to 50 by 5 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local turbVal = calculate_multi_layer_turbulence t spn_turbStrength.value spn_turbFreq.value \</span></span>
<span class="line"><span>                            spn_turbSpeed.value spn_turbLayers.value spn_turbRoughness.value spn_turbSeed.value</span></span>
<span class="line"><span>            local bar = ""</span></span>
<span class="line"><span>            local barLen = (abs(turbVal) / spn_turbStrength.value * 20) as integer</span></span>
<span class="line"><span>            if barLen &gt; 20 do barLen = 20</span></span>
<span class="line"><span>            for i = 1 to barLen do bar += if turbVal &gt; 0 then "+" else "-"</span></span>
<span class="line"><span>            format "帧%: % (%.1f度)\n" (formattedPrint t format:"02d") bar turbVal</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "================================\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        ctrl.baseForce = spn_baseWind.value</span></span>
<span class="line"><span>        ctrl.swingAmp = spn_swingAmp.value</span></span>
<span class="line"><span>        ctrl.turbStrength = spn_turbStrength.value</span></span>
<span class="line"><span>        ctrl.turbFreq = spn_turbFreq.value</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请选择骨骼根部"; return false)</span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj do (messageBox "请先拾取风向控制器"; return false)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 获取混合参数</span></span>
<span class="line"><span>        local springMix = spn_springMix.value</span></span>
<span class="line"><span>        local globalWindMix = spn_globalWindMix.value</span></span>
<span class="line"><span>        local localSinMix = spn_localSinMix.value</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local period = spn_period.value</span></span>
<span class="line"><span>        local gravity = spn_gravity.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- 扰动参数</span></span>
<span class="line"><span>        local turbSpeed = spn_turbSpeed.value</span></span>
<span class="line"><span>        local turbLayers = spn_turbLayers.value</span></span>
<span class="line"><span>        local turbRoughness = spn_turbRoughness.value</span></span>
<span class="line"><span>        local turbSeed = spn_turbSeed.value</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "混合模式: Spring=% | 全局风=% | 局部Sin=%\n" springMix globalWindMix localSinMix</span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]</span></span>
<span class="line"><span>                    append boneRelTMs lastRelTM </span></span>
<span class="line"><span>                    local endWorldTM = lastRelTM * chain[chain.count].transform</span></span>
<span class="line"><span>                    append simTMs endWorldTM</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                    local endTM = matrix3 1</span></span>
<span class="line"><span>                    endTM.pos = [bbox[2].x, 0, 0]</span></span>
<span class="line"><span>                    append boneRelTMs endTM</span></span>
<span class="line"><span>                    local endWorldTM = endTM * chain[1].transform</span></span>
<span class="line"><span>                    append simTMs endWorldTM</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 缝合逻辑</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local turbStrength = at time t ctrlObj.turbStrength</span></span>
<span class="line"><span>                local turbFreq = at time t ctrlObj.turbFreq</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            -- 根部位置权重混合</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            -- 计算局部Sin旋转 (根据混合值)</span></span>
<span class="line"><span>                            local localSinQuat = quat 0 0 0 1</span></span>
<span class="line"><span>                            if localSinMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                                local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos</span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ Spring计算 (根据springMix控制)</span></span>
<span class="line"><span>                            local springAngle = 0.0</span></span>
<span class="line"><span>                            local springVT = [0,0,1]</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if springMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                -- Twist X</span></span>
<span class="line"><span>                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                                if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                                local angX = acos(dot1)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                if angX &gt; 0.001 do rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- Spring Y/Z</span></span>
<span class="line"><span>                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                                local angY1 = acos(dot2)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                                local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                                angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                if dot ssvt targetBoneTM.row1 &gt; 0 do angY1 = -angY1</span></span>
<span class="line"><span>                                if abs angY1 &gt; 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                                newTM1.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                -- Main Bend (加入重力)</span></span>
<span class="line"><span>                                local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])</span></span>
<span class="line"><span>                                springVT = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                                if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                                springAngle = acos(dot3)</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= (1.0 - delay)</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local sangle = springAngle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- ★ Root Wind (全局模式，根据globalWindMix控制)</span></span>
<span class="line"><span>                            if j == 1 and globalWindMix &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \</span></span>
<span class="line"><span>                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * globalWindMix</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                springAngle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- 应用Spring混合</span></span>
<span class="line"><span>                            springAngle *= springMix</span></span>
<span class="line"><span>                            sangle *= springMix</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            springAngle = applySoftLimit springAngle maxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle maxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs springAngle &gt; 0.001 do rotate targetBoneTM (quat springAngle springVT)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 do rotate ttm (quat sangle springVT)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- === 写入关键帧 ===</span></span>
<span class="line"><span>                            if isWritePass and sf == subs do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (</span></span>
<span class="line"><span>                                        -- 计算最终旋转</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        -- 混合局部Sin</span></span>
<span class="line"><span>                                        if localSinMix &gt; 0 do</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j &lt; chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        format "========================================\n"</span></span>
<span class="line"><span>        format "生成完毕！\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具按钮事件 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择父对象！"; return false)</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择骨骼！"; return false)</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_springMix.value = 1.0</span></span>
<span class="line"><span>        spn_globalWindMix.value = 1.0</span></span>
<span class="line"><span>        spn_localSinMix.value = 0.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_baseWind.value = 20.0</span></span>
<span class="line"><span>        spn_swingAmp.value = 8.0</span></span>
<span class="line"><span>        spn_period.value = 30</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_turbStrength.value = 15.0</span></span>
<span class="line"><span>        spn_turbFreq.value = 3.0</span></span>
<span class="line"><span>        spn_turbSpeed.value = 2.0</span></span>
<span class="line"><span>        spn_turbLayers.value = 3</span></span>
<span class="line"><span>        spn_turbRoughness.value = 2.0</span></span>
<span class="line"><span>        spn_turbSeed.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_gravity.value = 0</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V6.5 终极版已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V6.5\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "新功能:\n"</span></span>
<span class="line"><span>format "1. 三参数独立混合: Spring/全局风/局部Sin\n"</span></span>
<span class="line"><span>format "2. 多层扰动系统: 强度/频率/速度/层数/粗糙度\n"</span></span>
<span class="line"><span>format "3. 测试扰动按钮: 可预览扰动曲线\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "使用示例:\n"</span></span>
<span class="line"><span>format "- 纯Spring: Spring=1, 其他=0\n"</span></span>
<span class="line"><span>format "- 自然飘动: Spring=1, 全局风=1\n"</span></span>
<span class="line"><span>format "- 精细控制: Spring=1, 局部Sin=1\n"</span></span>
<span class="line"><span>format "- 混合效果: 三个都设为0.5-1\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>主要改进：</h2><h3>1. <strong>三参数独立混合系统</strong></h3><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>Spring弹簧: 0-1  (物理弹簧效果)</span></span>
<span class="line"><span>全局风向:   0-1  (风向控制器驱动)</span></span>
<span class="line"><span>局部Sin:    0-1  (每根骨骼独立控制)</span></span></code></pre></div></div></pre><p>现在你可以：</p><ul>
<li><strong>纯Spring</strong>：Spring=1, 全局风=0, 局部Sin=0</li>
<li><strong>Spring+风</strong>：Spring=1, 全局风=1, 局部Sin=0</li>
<li><strong>Spring+局部</strong>：Spring=1, 全局风=0, 局部Sin=1</li>
<li><strong>全混合</strong>：三个都=1</li>
</ul><h3>2. <strong>全新多层扰动系统</strong></h3><ul>
<li><strong>扰动强度(度)</strong>：0-90度，控制总体力度</li>
<li><strong>扰动频率</strong>：0.1-50，越大波峰波谷越密集</li>
<li><strong>扰动速度</strong>：控制变化快慢</li>
<li><strong>扰动层数</strong>：1-8层，叠加多股风的效果</li>
<li><strong>粗糙度</strong>：高频细节强度</li>
<li><strong>随机种子</strong>：不同种子产生不同模式</li>
</ul><h3>3. <strong>测试扰动按钮</strong></h3><p>可以在Listener中预览扰动曲线，帮助你调参。</p><h3>4. <strong>推荐参数组合</strong></h3><p>狂风效果：</p><ul>
<li>扰动强度: 30-50</li>
<li>扰动频率: 5-10</li>
<li>扰动层数: 4-6</li>
</ul><p>微风效果：</p><ul>
<li>扰动强度: 5-10</li>
<li>扰动频率: 1-2</li>
<li>扰动层数: 2-3</li>
</ul></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_2jhjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>我看了一下你这个模式混合啊，0=局部sin，1=全局风动，没有把spring算在里面啊，如果我只单纯想要spring怎么办呢，所以我需要把这些混合数字，都拆分成三个参数才对，而且这个扰动强度啊，并不理想，我希望的是，可以很多很多股风冲撞到我的骨骼链的感觉，波峰波谷在我打高这个数值的时候是接踵而至的，现在力度非常小，而且没有频率控制参数</p></div></div></div></div></div><div class="bg-surface-primary relative flex w-full min-w-0 flex-1 flex-col overflow-hidden transition-all duration-300 gap-2 border-border-faint lg:max-w-[768px]"><div class="bg-surface-primary sticky top-0 flex w-full flex-none items-center justify-between gap-2"><div class="pointer-events-none absolute right-2 top-2 flex size-6 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake absolute opacity-0 transition-opacity duration-300"><path d="m11 17 2 2a1 1 0 1 0 3-3"></path><path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path><path d="m21 3 1 11h-2"></path><path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy absolute opacity-0 transition-opacity duration-300"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down absolute opacity-0 transition-opacity duration-300"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></div><div class="flex min-w-0 flex-1 items-center gap-2"><span class="xs:max-w-full flex min-w-0 max-w-[250px] items-center gap-1 font-mono text-sm font-normal"><svg fill="currentColor" fill-rule="evenodd" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-black dark:text-white mr-2 flex-shrink-0 size-4"><title>Anthropic</title><path d="M13.827 3.52h3.603L24 20h-3.603l-6.57-16.48zm-7.258 0h3.767L16.906 20h-3.674l-1.343-3.461H5.017l-1.344 3.46H0L6.57 3.522zm4.132 9.959L8.453 7.687 6.205 13.48H10.7z"></path></svg><span class="truncate">claude-opus-4-5-20251101-thinking-32k</span></span></div></div><div class="no-scrollbar relative flex w-full flex-1 flex-col overflow-x-auto transition-[max-height] duration-300"><div class="min-w-0"><div data-state="closed" class="not-prose mb-4"><button type="button" aria-controls="radix-_R_5dlhjmanpfiupfd9fl2ppfivb_" aria-expanded="false" data-state="closed" class="text-text-secondary hover:text-text-tertiary flex w-full items-center gap-1.5 text-sm transition-colors"><p class="leading-[normal]">Thought for <!-- -->4 seconds</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 transition-transform rotate-0"><path d="m6 9 6 6 6-6"></path></svg></button><div data-state="closed" id="radix-_R_5dlhjmanpfiupfd9fl2ppfivb_" hidden="" class="mt-4 text-sm data-[state=closed]:fade-out-0 data-[state=closed]:slide-out-to-top-2 data-[state=open]:slide-in-from-top-2 data-[state=closed]:animate-out data-[state=open]:animate-in data-[state=closed]:duration-150 data-[state=open]:duration-150 text-text-secondary outline-none" style=""></div></div><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><h1>Sin Wind Spring Generator V6.0 终极整合版</h1><p>我帮你整合两个脚本的优点，创建一个终极版本。主要改进：</p><ol>
<li><strong>修正默认值</strong>：子采样=1，根骨骼缩放=1</li>
<li><strong>双模式控制</strong>：全局风向控制 + 局部骨骼Sin控制</li>
<li><strong>激活控制切换</strong>：激活=1用全局风，激活=0用局部控制</li>
<li><strong>混合模式</strong>：可以设置两者之间的混合比例</li>
<li><strong>保留所有附加工具</strong></li>
</ol><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">maxscript</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>/* </span></span>
<span class="line"><span>    Sin Wind Spring Generator V6.0 Ultimate</span></span>
<span class="line"><span>    - 整合全局风向控制 + 局部骨骼Sin控制</span></span>
<span class="line"><span>    - 激活控制切换/混合模式</span></span>
<span class="line"><span>    - 修正默认值：子采样=1，根骨骼缩放=1</span></span>
<span class="line"><span>    - 保留所有原有功能</span></span>
<span class="line"><span>*/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>try(destroyDialog rol_SinWindSpringUltimate)catch()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global sprboneCA = attributes sprbTM</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    parameters main</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        boneTM type:#matrix3</span></span>
<span class="line"><span>    )   </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>rollout rol_SinWindSpringUltimate "Sin + Spring 风力生成器 V6.0 终极版" width:580</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    -- === UI 布局 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "1. 风向控制器"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_createWindCtrl "1. 创建风向控制器" width:260 align:#left across:2 height:30</span></span>
<span class="line"><span>        pickbutton pck_ctrl "2. 拾取控制器" width:260 align:#right height:30 autoDisplay:true</span></span>
<span class="line"><span>        label lbl_info "提示: 控制器的Activation参数控制全局/局部混合比例" style_sunken:true align:#center</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "2. 姿态与形态"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_setPose "★ 设定参考姿态" width:170 align:#left across:3 height:25 toolTip:"将当前骨骼形状存为弹簧的目标形态"</span></span>
<span class="line"><span>        button btn_pastePose "粘贴姿态" width:170 align:#center height:25 toolTip:"复位到参考姿态"</span></span>
<span class="line"><span>        button btn_straighten "拉直骨骼" width:170 align:#right height:25 toolTip:"拉直骨骼链"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "3. 全局Sin风力 (Activation=1时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_baseWind "基础风压(度)" range:[0.0, 90.0, 20.0] type:#float align:#left across:3 width:150</span></span>
<span class="line"><span>        spinner spn_swingAmp "摆动幅度(度)" range:[0.0, 30.0, 5.0] type:#float width:150</span></span>
<span class="line"><span>        spinner spn_period "周期(帧)" range:[1, 200, 30] type:#integer width:150</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_turbulence "扰动强度" range:[0.0, 30.0, 2.0] type:#float align:#left across:2 width:150</span></span>
<span class="line"><span>        spinner spn_turbFreq "扰动频率" range:[0.1, 20.0, 0.5] scale:0.01 type:#float width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "4. 局部骨骼Sin控制 (Activation=0时生效)"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkBox chk_enableLocalSin "启用局部Sin (当Activation&lt;1时自动启用)" checked:true align:#left</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localX "X轴(扭转):" align:#left</span></span>
<span class="line"><span>        spinner spn_localX_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:90 toolTip:"0=关闭 1=全开"</span></span>
<span class="line"><span>        spinner spn_localX_rot "旋转量" range:[-90,90,5] width:90 toolTip:"基础旋转角度"</span></span>
<span class="line"><span>        spinner spn_localX_inc "递增" range:[-90,90,2] width:90 toolTip:"每根骨骼递增量"</span></span>
<span class="line"><span>        spinner spn_localX_delay "延迟" range:[-999,999,4] type:#integer width:90 toolTip:"时间延迟"</span></span>
<span class="line"><span>        spinner spn_localX_period "周期" range:[5,999,40] type:#integer width:90 toolTip:"循环周期"</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localY "Y轴(左右):" align:#left</span></span>
<span class="line"><span>        spinner spn_localY_switch "开关" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:90</span></span>
<span class="line"><span>        spinner spn_localY_rot "旋转量" range:[-90,90,5] width:90</span></span>
<span class="line"><span>        spinner spn_localY_inc "递增" range:[-90,90,2] width:90</span></span>
<span class="line"><span>        spinner spn_localY_delay "延迟" range:[-999,999,4] type:#integer width:90</span></span>
<span class="line"><span>        spinner spn_localY_period "周期" range:[5,999,40] type:#integer width:90</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        label lbl_localZ "Z轴(前后):" align:#left</span></span>
<span class="line"><span>        spinner spn_localZ_switch "开关" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:90</span></span>
<span class="line"><span>        spinner spn_localZ_rot "旋转量" range:[-90,90,8] width:90</span></span>
<span class="line"><span>        spinner spn_localZ_inc "递增" range:[-90,90,3] width:90</span></span>
<span class="line"><span>        spinner spn_localZ_delay "延迟" range:[-999,999,4] type:#integer width:90</span></span>
<span class="line"><span>        spinner spn_localZ_period "周期" range:[5,999,40] type:#integer width:90</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "5. Spring弹簧参数"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_springDelay "弹簧硬度" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:150 \</span></span>
<span class="line"><span>                toolTip:"越小越硬，越大越软"</span></span>
<span class="line"><span>        spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 width:150 \</span></span>
<span class="line"><span>                toolTip:"X轴抗扭强度"</span></span>
<span class="line"><span>        spinner spn_gravity "重力.Z" type:#float range:[-990.0,999,0] width:150</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_subs "子采样" range:[1, 10, 1] type:#integer align:#left across:3 width:150 \</span></span>
<span class="line"><span>                toolTip:"计算精度，默认1"</span></span>
<span class="line"><span>        spinner spn_scaleMotion "根骨骼缩放" range:[0.1, 3.0, 1.0] scale:0.1 width:150 \</span></span>
<span class="line"><span>                toolTip:"根骨骼运动幅度，默认1"</span></span>
<span class="line"><span>        spinner spn_boneCount "骨骼数量" range:[1, 1000, 50] type:#integer width:150 toolTip:"最大处理骨骼数"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "6. 角度限制 &amp; 根部权重"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spinner spn_maxAngle "最大角度" range:[10.0, 180.0, 80.0] type:#float align:#left across:2 width:150</span></span>
<span class="line"><span>        spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01 width:150</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spinner spn_blend_x "根部X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:150</span></span>
<span class="line"><span>        spinner spn_blend_y "根部Y权重" type:#float range:[0.0,1.0,1] scale:0.01 width:150</span></span>
<span class="line"><span>        spinner spn_blend_z "根部Z权重" type:#float range:[0.0,1.0,1] scale:0.01 width:150</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    group "7. 动画设置"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        checkbox chk_loops "无缝循环" checked:true align:#left across:4 toolTip:"第0帧自动缝合"</span></span>
<span class="line"><span>        label lbl_empty "" width:50</span></span>
<span class="line"><span>        spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer width:120</span></span>
<span class="line"><span>        spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:120</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    progressbar pb_progress "进度" color:red height:20 width:560</span></span>
<span class="line"><span>    button btn_bake "生成 Sin+Spring 风场动画" width:560 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    group "附加工具"</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        button btn_selectChildren "选择子级" width:85 align:#left across:6</span></span>
<span class="line"><span>        button btn_LoopStart "首尾循环" width:85</span></span>
<span class="line"><span>        button btn_EulerFilter "欧拉过滤" width:85</span></span>
<span class="line"><span>        button btn_TCB "转TCB" width:85</span></span>
<span class="line"><span>        button btn_Euler "转欧拉" width:85</span></span>
<span class="line"><span>        button btn_reset "重置参数" width:85 align:#right</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 辅助函数 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn createWindController =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>        arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>        arrow.wirecolor = yellow</span></span>
<span class="line"><span>        arrow.parent = ctrl</span></span>
<span class="line"><span>        arrow.pos = [0,30,0]</span></span>
<span class="line"><span>        rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        custAttributes.add ctrl (</span></span>
<span class="line"><span>            attributes "WindParams" (</span></span>
<span class="line"><span>                parameters main rollout:rlt (</span></span>
<span class="line"><span>                    strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                    baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                    swingAmp type:#float default:5.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                    turbAmt type:#float default:2.0 animatable:true ui:spn_turb</span></span>
<span class="line"><span>                    activation type:#float default:1.0 animatable:true ui:spn_activation</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                rollout rlt "风力参数(可K帧)" (</span></span>
<span class="line"><span>                    group "核心参数" (</span></span>
<span class="line"><span>                        spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_base "基础风压:" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_swing "摆动幅度:" range:[0,30,5.0] type:#float</span></span>
<span class="line"><span>                        spinner spn_turb "扰动强度:" range:[0,30,2.0] type:#float</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    group "模式混合 (0=局部Sin, 1=全局风向)" (</span></span>
<span class="line"><span>                        spinner spn_activation "激活混合:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>        local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>        local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>        local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>        return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn calculate_root_wind absTime baseWind swingAmp turbAmount period turbFreq =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>        local sinValue = sin(timePhase)</span></span>
<span class="line"><span>        local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>        local noisePos = [absTime * turbFreq * 0.1, 0, 0]</span></span>
<span class="line"><span>        local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>        return baseWind + swingComponent + (noiseValue * turbAmount)</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local up = [0,0,1]</span></span>
<span class="line"><span>        if (abs (dot windDir up)) &gt; 0.99 do up = [0,1,0]</span></span>
<span class="line"><span>        local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>        local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>        local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>        local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>        return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- 局部Sin旋转计算函数</span></span>
<span class="line"><span>    fn get_local_sin_rotation frameTime boneIndex axisType =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local result = eulerAngles 0 0 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        case axisType of</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            1: -- X轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localX_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localX_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles (spn_localX_switch.value * d) 0 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            2: -- Y轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localY_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localY_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = cos(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 (spn_localY_switch.value * d) 0</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            3: -- Z轴</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if spn_localZ_switch.value == 0 do return result</span></span>
<span class="line"><span>                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value</span></span>
<span class="line"><span>                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value</span></span>
<span class="line"><span>                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))</span></span>
<span class="line"><span>                local d = sin(radtodeg((frameTime - timeOffset) * b))</span></span>
<span class="line"><span>                d = radtodeg(d * (degtorad rotAmount))</span></span>
<span class="line"><span>                result = eulerAngles 0 0 (spn_localZ_switch.value * d)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return result</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getBoneChains roots maxBones = </span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local chains = #()</span></span>
<span class="line"><span>        for r in roots do (</span></span>
<span class="line"><span>            if (findItem roots r.parent) == 0 do (</span></span>
<span class="line"><span>                local chain = #()</span></span>
<span class="line"><span>                local curr = r</span></span>
<span class="line"><span>                local count = 0</span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 and count &lt; maxBones do (</span></span>
<span class="line"><span>                    curr = curr.children[1] </span></span>
<span class="line"><span>                    append chain curr</span></span>
<span class="line"><span>                    count += 1</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                append chains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return chains</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn getAllChildren obj =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local childrenArray = #()</span></span>
<span class="line"><span>        for c in obj.children do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            append childrenArray c</span></span>
<span class="line"><span>            join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        return childrenArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>    ( </span></span>
<span class="line"><span>        local sortedArray = #()</span></span>
<span class="line"><span>        local listArray = #()</span></span>
<span class="line"><span>        local parentArray = #()</span></span>
<span class="line"><span>        local childArray = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for obj in objectArray do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem objectArray obj.parent) == 0 </span></span>
<span class="line"><span>            then append parentArray obj</span></span>
<span class="line"><span>            else append childArray obj  </span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        while childArray.count &gt; 0 do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local i=1</span></span>
<span class="line"><span>            while i &lt;= childArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>                if parentIdx != 0 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>                    deleteItem childArray i</span></span>
<span class="line"><span>                ) </span></span>
<span class="line"><span>                else(i += 1)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local a = 1</span></span>
<span class="line"><span>        for l=1 to parentArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                append listArray parentArray[l]</span></span>
<span class="line"><span>                sortedArray[a] = listArray</span></span>
<span class="line"><span>                listArray = #()</span></span>
<span class="line"><span>                a += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        sortedArray</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    fn BoneLoopStart objectArray =</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local firstbonerot = #()</span></span>
<span class="line"><span>        local lastbonerot = #()</span></span>
<span class="line"><span>        local bonesub = #()</span></span>
<span class="line"><span>        local bonelistsub = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local startFrame = (animationrange.start as string) as integer</span></span>
<span class="line"><span>        local endFrame = (animationrange.end as string) as integer</span></span>
<span class="line"><span>        local cycleFrame = 30</span></span>
<span class="line"><span>        if (endFrame - startframe) &lt; 30 then cycleFrame = (endFrame - startframe)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for i = 1 to objectArray.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = animationrange.start</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            slidertime = animationrange.end</span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append bonelistsub bonesub</span></span>
<span class="line"><span>            firstbonerot = #()</span></span>
<span class="line"><span>            lastbonerot = #()</span></span>
<span class="line"><span>            bonesub = #()</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        set animate on</span></span>
<span class="line"><span>        for f = 0 to cycleframe do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            slidertime = endFrame - f</span></span>
<span class="line"><span>            local per = (float)(cycleFrame - f) / cycleFrame</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for a = 1 to objectArray.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local r = bonelistsub[a][b]</span></span>
<span class="line"><span>                    if b &gt; 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)</span></span>
<span class="line"><span>                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))</span></span>
<span class="line"><span>                    rotate objectArray[a][b] rot</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        set animate off</span></span>
<span class="line"><span>        slidertime = startframe</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 姿态控制 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local count = 0</span></span>
<span class="line"><span>        for obj in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local curr = obj</span></span>
<span class="line"><span>            local bones = #(curr)</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (</span></span>
<span class="line"><span>                curr = curr.children[1]</span></span>
<span class="line"><span>                append bones curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for b in bones do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if not isProperty b "boneTM" do CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>                if b.parent != undefined then</span></span>
<span class="line"><span>                    b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                    b.boneTM = b.transform</span></span>
<span class="line"><span>                count += 1</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for bn in bones do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    if isProperty bn "boneTM" do </span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try (</span></span>
<span class="line"><span>                            local targetTM </span></span>
<span class="line"><span>                            if bn.parent != undefined then</span></span>
<span class="line"><span>                                targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                targetTM = bn.boneTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                            if classof bn == CATBone then bn.transform = targetTM</span></span>
<span class="line"><span>                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                            else if bn.parent != undefined then</span></span>
<span class="line"><span>                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                            else</span></span>
<span class="line"><span>                                bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                        ) catch()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        animate on</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for b in selection do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bones = #(b)</span></span>
<span class="line"><span>                local curr = b</span></span>
<span class="line"><span>                while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to bones.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bn = bones[i]</span></span>
<span class="line"><span>                    try (</span></span>
<span class="line"><span>                        if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                            biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then (</span></span>
<span class="line"><span>                            local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                            newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                            bn.transform = newTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    ) catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local ctrl = createWindController()</span></span>
<span class="line"><span>        ctrl.baseForce = spn_baseWind.value</span></span>
<span class="line"><span>        ctrl.swingAmp = spn_swingAmp.value</span></span>
<span class="line"><span>        ctrl.turbAmt = spn_turbulence.value</span></span>
<span class="line"><span>        pck_ctrl.object = ctrl</span></span>
<span class="line"><span>        select ctrl</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    on btn_bake pressed do with undo "Bake Sin+Spring Ultimate" on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        clearListener()</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请选择骨骼根部"; return false)</span></span>
<span class="line"><span>        local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>        if not isValidNode ctrlObj do (messageBox "请先拾取风向控制器"; return false)</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local chains = getBoneChains (selection as array) spn_boneCount.value</span></span>
<span class="line"><span>        local startF = spn_start.value</span></span>
<span class="line"><span>        local endF = spn_end.value</span></span>
<span class="line"><span>        local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>        local softness = spn_softness.value</span></span>
<span class="line"><span>        local delay = spn_springDelay.value</span></span>
<span class="line"><span>        local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>        local subs = spn_subs.value</span></span>
<span class="line"><span>        local subframe = 1.0 / subs</span></span>
<span class="line"><span>        local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>        local turbFreq = spn_turbFreq.value </span></span>
<span class="line"><span>        local period = spn_period.value</span></span>
<span class="line"><span>        local gravity = spn_gravity.value</span></span>
<span class="line"><span>        local blend_x = spn_blend_x.value</span></span>
<span class="line"><span>        local blend_y = spn_blend_y.value</span></span>
<span class="line"><span>        local blend_z = spn_blend_z.value</span></span>
<span class="line"><span>        local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>        local enableLocalSin = chk_enableLocalSin.checked</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local allBoneTM = #()       </span></span>
<span class="line"><span>        local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>        local allPrePos = #()       </span></span>
<span class="line"><span>        local allChains = #()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "初始化模拟状态 (基于帧 %)...\n" startF</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 初始化数据 ===</span></span>
<span class="line"><span>        at time startF</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local chain = chains[cIdx]</span></span>
<span class="line"><span>                local boneRelTMs = #()</span></span>
<span class="line"><span>                local simTMs = #()</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for i = 1 to chain.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local b = chain[i]</span></span>
<span class="line"><span>                    local relTM</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    if isProperty b "boneTM" then</span></span>
<span class="line"><span>                        relTM = b.boneTM </span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        if b.parent != undefined then</span></span>
<span class="line"><span>                            relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            relTM = b.transform</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    append boneRelTMs relTM</span></span>
<span class="line"><span>                    append simTMs (copy b.transform)</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]</span></span>
<span class="line"><span>                    append boneRelTMs lastRelTM </span></span>
<span class="line"><span>                    local endWorldTM = lastRelTM * chain[chain.count].transform</span></span>
<span class="line"><span>                    append simTMs endWorldTM</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                    local endTM = matrix3 1</span></span>
<span class="line"><span>                    endTM.pos = [bbox[2].x, 0, 0]</span></span>
<span class="line"><span>                    append boneRelTMs endTM</span></span>
<span class="line"><span>                    local endWorldTM = endTM * chain[1].transform</span></span>
<span class="line"><span>                    append simTMs endWorldTM</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if chain.count &gt; 1 then</span></span>
<span class="line"><span>                    append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append allBoneTM boneRelTMs</span></span>
<span class="line"><span>                append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>                append allChains chain</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "开始模拟 (循环次数: %, 链数: %)...\n" loopsCount allChains.count</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>        local frameCounter = 0</span></span>
<span class="line"><span>        pb_progress.value = 0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        suspendEditing()</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- === 主循环 ===</span></span>
<span class="line"><span>        for L = 1 to loopsCount do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            -- 缝合逻辑</span></span>
<span class="line"><span>            if isWritePass and chk_loops.checked do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                format "&gt;&gt; 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>                animate on at time startF</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            try (</span></span>
<span class="line"><span>                                if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                    chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                                else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                                else </span></span>
<span class="line"><span>                                    if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                    else</span></span>
<span class="line"><span>                                        chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                            ) catch ()</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for t = startF to endF do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if keyboard.escPressed then exit</span></span>
<span class="line"><span>                frameCounter += 1</span></span>
<span class="line"><span>                pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local currTime = t as float</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>                local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>                local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>                local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>                local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>                local turbAmount = at time t ctrlObj.turbAmt</span></span>
<span class="line"><span>                local activation = at time t ctrlObj.activation</span></span>
<span class="line"><span>                local localBlend = 1.0 - activation  -- 局部Sin混合权重</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for sf = 1 to subs do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    currTime += subframe</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local chain = allChains[cIdx]</span></span>
<span class="line"><span>                        local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                        local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                        local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local currentPTM </span></span>
<span class="line"><span>                        if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                            -- 根部位置权重混合</span></span>
<span class="line"><span>                            local currentPTM_start = at time startF chain[1].parent.transform</span></span>
<span class="line"><span>                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>                            currentPTM.pos = [temp_x, temp_y, temp_z]</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            currentPTM = matrix3 1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        for j = 1 to chain.count do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            -- 计算局部Sin旋转</span></span>
<span class="line"><span>                            local localSinRotX = get_local_sin_rotation (t - startF) j 1</span></span>
<span class="line"><span>                            local localSinRotY = get_local_sin_rotation (t - startF) j 2</span></span>
<span class="line"><span>                            local localSinRotZ = get_local_sin_rotation (t - startF) j 3</span></span>
<span class="line"><span>                            local localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos</span></span>
<span class="line"><span>                            local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Twist X</span></span>
<span class="line"><span>                            local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                            if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                            local angX = acos(dot1)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                            local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                            if angX &gt; 0.001 do rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                            newTM1.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Spring Y/Z</span></span>
<span class="line"><span>                            local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                            if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                            local angY1 = acos(dot2)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                            local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                            angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if dot ssvt targetBoneTM.row1 &gt; 0 do angY1 = -angY1</span></span>
<span class="line"><span>                            if abs angY1 &gt; 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                            newTM1.pos = tpos</span></span>
<span class="line"><span>                            targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Main Bend (加入重力)</span></span>
<span class="line"><span>                            local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                            local cvector = normalize (currentPos - tpos + [0, 0, -gravity])</span></span>
<span class="line"><span>                            local vt = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                            if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                            local angle = acos(dot3)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            angle *= (1.0 - delay)</span></span>
<span class="line"><span>                            local sangle = angle</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- Root Wind (全局模式)</span></span>
<span class="line"><span>                            if j == 1 and activation &gt; 0 do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                local windAngle = calculate_root_wind currTime baseWind swingAmp turbAmount period turbFreq</span></span>
<span class="line"><span>                                windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                                windAngle *= globalStr * activation</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                                local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                                tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                                tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                                tempTM.pos = tpos</span></span>
<span class="line"><span>                                targetBoneTM = tempTM</span></span>
<span class="line"><span>                                </span></span>
<span class="line"><span>                                angle *= scaleMotion</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            angle = applySoftLimit angle maxAngle softness</span></span>
<span class="line"><span>                            sangle = applySoftLimit sangle maxAngle softness</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if abs angle &gt; 0.001 do rotate targetBoneTM (quat angle vt)</span></span>
<span class="line"><span>                            if j == 1 and abs sangle &gt; 0.001 do rotate ttm (quat sangle vt)</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                            ttm.pos = tpos</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            -- === 写入关键帧 ===</span></span>
<span class="line"><span>                            if isWritePass and sf == subs do</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                animate on at time (t + 1f)</span></span>
<span class="line"><span>                                (</span></span>
<span class="line"><span>                                    try (</span></span>
<span class="line"><span>                                        -- 计算最终旋转 (混合全局和局部Sin)</span></span>
<span class="line"><span>                                        local finalRotation = targetBoneTM.rotation</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        -- 当局部Sin启用且activation&lt;1时，混合局部Sin</span></span>
<span class="line"><span>                                        if enableLocalSin and localBlend &gt; 0 do</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localBlend</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        </span></span>
<span class="line"><span>                                        if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        (</span></span>
<span class="line"><span>                                            local finalTM = copy targetBoneTM</span></span>
<span class="line"><span>                                            finalTM.rotation = finalRotation</span></span>
<span class="line"><span>                                            chain[j].transform = finalTM</span></span>
<span class="line"><span>                                        )</span></span>
<span class="line"><span>                                        else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                            biped.setTransform chain[j] #rotation finalRotation true</span></span>
<span class="line"><span>                                        else </span></span>
<span class="line"><span>                                            if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                            else</span></span>
<span class="line"><span>                                                chain[j].rotation.controller.value = finalRotation</span></span>
<span class="line"><span>                                    ) catch ()</span></span>
<span class="line"><span>                                )</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                            simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                            if j &lt; chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        resumeEditing()</span></span>
<span class="line"><span>        pb_progress.value = 100</span></span>
<span class="line"><span>        print "生成完毕！" </span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 附加工具按钮事件 ===</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_selectChildren pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择父对象！"; return false)</span></span>
<span class="line"><span>        local currentSel = selection as array</span></span>
<span class="line"><span>        local allChildren = #()</span></span>
<span class="line"><span>        for obj in currentSel do join allChildren (getAllChildren obj)</span></span>
<span class="line"><span>        if allChildren.count &gt; 0 then select (currentSel + allChildren)</span></span>
<span class="line"><span>        format "选择了 % 个子对象\n" allChildren.count</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择骨骼！"; return false)</span></span>
<span class="line"><span>        local aBState = animButtonState</span></span>
<span class="line"><span>        animButtonState = false</span></span>
<span class="line"><span>        local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>        BoneLoopStart sortedArr</span></span>
<span class="line"><span>        animButtonState = aBState</span></span>
<span class="line"><span>        format "首尾循环处理完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        local sel = selection as array</span></span>
<span class="line"><span>        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>                obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        format "欧拉过滤完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>        format "TCB曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        if selection.count == 0 do (messageBox "请先选择对象！"; return false)</span></span>
<span class="line"><span>        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do</span></span>
<span class="line"><span>            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>        format "欧拉曲线转换完成\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on btn_reset pressed do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_baseWind.value = 20.0</span></span>
<span class="line"><span>        spn_swingAmp.value = 5.0</span></span>
<span class="line"><span>        spn_period.value = 30</span></span>
<span class="line"><span>        spn_turbulence.value = 2.0</span></span>
<span class="line"><span>        spn_turbFreq.value = 0.5</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localX_switch.value = 0</span></span>
<span class="line"><span>        spn_localX_rot.value = 5</span></span>
<span class="line"><span>        spn_localX_inc.value = 2</span></span>
<span class="line"><span>        spn_localX_delay.value = 4</span></span>
<span class="line"><span>        spn_localX_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localY_switch.value = 0</span></span>
<span class="line"><span>        spn_localY_rot.value = 5</span></span>
<span class="line"><span>        spn_localY_inc.value = 2</span></span>
<span class="line"><span>        spn_localY_delay.value = 4</span></span>
<span class="line"><span>        spn_localY_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_localZ_switch.value = 1</span></span>
<span class="line"><span>        spn_localZ_rot.value = 8</span></span>
<span class="line"><span>        spn_localZ_inc.value = 3</span></span>
<span class="line"><span>        spn_localZ_delay.value = 4</span></span>
<span class="line"><span>        spn_localZ_period.value = 40</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_springDelay.value = 0.3</span></span>
<span class="line"><span>        spn_xSpring.value = 0.3</span></span>
<span class="line"><span>        spn_gravity.value = 0</span></span>
<span class="line"><span>        spn_subs.value = 1</span></span>
<span class="line"><span>        spn_scaleMotion.value = 1.0</span></span>
<span class="line"><span>        spn_boneCount.value = 50</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        spn_maxAngle.value = 80.0</span></span>
<span class="line"><span>        spn_softness.value = 0.3</span></span>
<span class="line"><span>        spn_blend_x.value = 1.0</span></span>
<span class="line"><span>        spn_blend_y.value = 1.0</span></span>
<span class="line"><span>        spn_blend_z.value = 1.0</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        format "参数已重置\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    on rol_SinWindSpringUltimate open do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        spn_start.value = animationRange.start.frame</span></span>
<span class="line"><span>        spn_end.value = animationRange.end.frame</span></span>
<span class="line"><span>        local totalFrames = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>        spn_localX_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localY_period.value = totalFrames</span></span>
<span class="line"><span>        spn_localZ_period.value = totalFrames</span></span>
<span class="line"><span>        format "Sin+Spring V6.0 终极版已加载\n"</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>createDialog rol_SinWindSpringUltimate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "Sin+Spring 风力生成器 V6.0 终极版\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span>
<span class="line"><span>format "整合功能:\n"</span></span>
<span class="line"><span>format "- 全局风向控制 (带控制器方向)\n"</span></span>
<span class="line"><span>format "- 局部骨骼Sin控制 (XYZ轴独立)\n"</span></span>
<span class="line"><span>format "- Activation混合: 1=全局风, 0=局部Sin\n"</span></span>
<span class="line"><span>format "- 重力支持\n"</span></span>
<span class="line"><span>format "- 根部位置权重\n"</span></span>
<span class="line"><span>format "- 默认值修正: 子采样=1, 根骨骼缩放=1\n"</span></span>
<span class="line"><span>format "========================================\n"</span></span></code></pre></div></div></pre><h2>主要改进说明：</h2><h3>1. <strong>修正默认值</strong></h3><ul>
<li>子采样：1（原来是3）</li>
<li>根骨骼缩放：1.0（原来是1.5）</li>
</ul><h3>2. <strong>双模式控制系统</strong></h3><ul>
<li><strong>Activation = 1</strong>：完全使用全局风向控制器</li>
<li><strong>Activation = 0</strong>：完全使用局部骨骼Sin控制</li>
<li><strong>Activation = 0.5</strong>：两者混合</li>
</ul><h3>3. <strong>局部骨骼Sin控制面板</strong></h3><p>每个轴(X/Y/Z)都有独立控制：</p><ul>
<li>开关（0-1）</li>
<li>旋转量（基础角度）</li>
<li>递增量（每根骨骼叠加）</li>
<li>时间延迟（波浪延迟效果）</li>
<li>周期（循环长度）</li>
</ul><h3>4. <strong>新增功能</strong></h3><ul>
<li>重力控制</li>
<li>根部位置XYZ权重混合</li>
<li>骨骼数量限制</li>
<li>所有附加工具（欧拉过滤、首尾循环等）</li>
</ul><h3>5. <strong>使用方法</strong></h3><ol>
<li>创建风向控制器</li>
<li>设定参考姿态</li>
<li>调整Activation：<!-- -->
<ul>
<li>需要自然飘动 → Activation=1，使用全局风力</li>
<li>需要精细控制 → Activation=0，调整局部Sin参数</li>
<li>需要混合效果 → Activation=0.5</li>
</ul>
</li>
</ol></div></div></div><div class="flex items-center gap-2 pb-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Like this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up transition-colors"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none size-3 rounded-md p-3 transition-all hover:bg-accent" type="button" aria-label="Dislike this response" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down transition-colors"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path></svg></button><div class="text-text-primary flex items-center gap-2 transition-opacity duration-300"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary hover:text-accent-foreground focus-visible:outline-none focus-visible:border-none relative size-3 rounded-md p-3" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div></div></div><h2 id="radix-_R_2lhjmanpfiupfd9fl2ppfivbH1_" class="text-lg font-semibold leading-none tracking-tight hidden">Message from <!-- -->claude-opus-4-5-20251101-thinking-32k</h2><div class="group flex max-w-[min(768px,100%)] flex-col gap-1 self-end"><div class="flex flex-col gap-4"><div class="flex min-w-0 flex-1 items-center justify-end gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium hover:bg-surface-tertiary focus-visible:outline-none focus-visible:border-none relative text-text-secondary hover:text-text-primary size-6 flex-shrink-0 rounded-md p-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><div class="bg-surface-secondary w-fit min-w-0 max-w-prose flex-1 rounded-lg px-3 py-2 transition-[border-radius] duration-150"><div class="prose prose-sm prose-pre:bg-transparent prose-pre:p-0 text-wrap break-words"><p>/*<br>
<!-- -->Sin Wind Spring Generator V5.5 (Root Parent Fix)<br>
<!-- -->- Fix: Solves "transform in undefined" crash when Root Bone has no parent.<br>
<!-- -->- Feature: Stitches Frame 0 for perfect loops.<br>
<!-- -->*/</p><p>try(destroyDialog rol_SinWindSpring)catch()</p><p>global sprboneCA = attributes sprbTM<br>
<!-- -->(<br>
<!-- -->parameters main<br>
<!-- -->(<br>
<!-- -->boneTM type:#matrix3<br>
<!-- -->)<br>
<!-- -->)</p><p>struct BoneInitData<br>
<!-- -->(<br>
<!-- -->obj,<br>
<!-- -->relativeTM,<br>
<!-- -->boneName,<br>
<!-- -->hasParent<br>
<!-- -->)</p><p>rollout rol_SinWindSpring "Sin + Spring 风力生成器 V5.5 Stable" width:540<br>
<!-- -->(<br>
<!-- -->-- === UI 布局 ===<br>
<!-- -->group "1. 风向控制"<br>
<!-- -->(<br>
<!-- -->button btn_createWindCtrl "1. 创建风向控制器" width:240 align:#left across:2 height:30<br>
<!-- -->pickbutton pck_ctrl "2. 拾取控制器" width:240 align:#right height:30 autoDisplay:true<br>
<!-- -->label lbl_info "提示: 旋转Y轴(绿轴)改变风向" style_sunken:true align:#center<br>
<!-- -->)</p><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>group "2. 姿态与形态"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    button btn_setPose "★ 设定参考姿态 (Set)" width:160 align:#left across:3 height:25 toolTip:"将当前骨骼形状存为弹簧的目标形态"</span></span>
<span class="line"><span>    button btn_pastePose "粘贴姿态 (Paste)" width:160 align:#center height:25 toolTip:"复位到参考姿态"</span></span>
<span class="line"><span>    button btn_straighten "拉直骨骼 (Straight)" width:160 align:#right height:25 toolTip:"拉直骨骼链"</span></span>
<span class="line"><span>    label lbl_poseInfo "重要: 开启循环时，请务必先摆好Pose并点击[设定参考姿态]" style_sunken:true align:#center color:green</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>group "3. Sin风力参数 (第一根骨骼)"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    spinner spn_baseWind "基础风压 (度)" range:[0.0, 90.0, 20.0] type:#float align:#left across:2</span></span>
<span class="line"><span>    spinner spn_swingAmp "Sin摆动幅度 (度)" range:[0.0, 30.0, 5.0] type:#float</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    spinner spn_period "摆动周期 (帧)" range:[1, 200, 30] type:#integer align:#left across:2</span></span>
<span class="line"><span>    spinner spn_turbulence "扰动强度 (度)" range:[0.0, 30.0, 2.0] type:#float</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    spinner spn_turbFreq "扰动频率" range:[0.1, 20.0, 0.5] scale:0.01 type:#float align:#left across:2</span></span>
<span class="line"><span>    label lbl_dummy1 "" </span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>group "4. Spring弹簧参数 (后续骨骼)"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    spinner spn_springDelay "Spring延迟" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:2 \</span></span>
<span class="line"><span>            toolTip:"越小越硬，越大越软"</span></span>
<span class="line"><span>    spinner spn_xSpring "X轴弹簧" range:[0.1, 1.0, 0.3] scale:0.01 \</span></span>
<span class="line"><span>            toolTip:"X轴抗扭强度"</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    spinner spn_subs "子采样" range:[1, 10, 3] type:#integer align:#left across:2 \</span></span>
<span class="line"><span>            toolTip:"计算精度"</span></span>
<span class="line"><span>    spinner spn_scaleMotion "根骨骼缩放" range:[0.5, 3.0, 1.5] scale:0.1 \</span></span>
<span class="line"><span>            toolTip:"根骨骼运动幅度倍率"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>group "5. 角度限制"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    spinner spn_maxAngle "最大角度 (度)" range:[10.0, 180.0, 80.0] type:#float align:#left across:2</span></span>
<span class="line"><span>    spinner spn_softness "软限制" range:[0.0, 1.0, 0.3] scale:0.01</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>group "6. 动画设置"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    checkbox chk_loops "无缝循环 (Loop)" checked:true align:#left across:2 toolTip:"开启后第0帧将自动缝合，无缝衔接。"</span></span>
<span class="line"><span>    label lbl_empty ""</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    spinner spn_start "起始帧" range:[-99999,99999,0] type:#integer align:#left across:2 width:100</span></span>
<span class="line"><span>    spinner spn_end "结束帧" range:[-99999,99999,100] type:#integer width:100</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>progressbar pb_progress "进度" color:red height:20 width:520</span></span>
<span class="line"><span>button btn_bake "生成 Sin+Spring 风场动画" width:520 height:40 highlightColor:green</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- === 辅助函数 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn createWindController =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local ctrl = Point name:"Wind_Controller" size:30 cross:true axistripod:true \</span></span>
<span class="line"><span>                      centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8</span></span>
<span class="line"><span>    arrow.name = "Wind_Arrow"</span></span>
<span class="line"><span>    arrow.wirecolor = yellow</span></span>
<span class="line"><span>    arrow.parent = ctrl</span></span>
<span class="line"><span>    arrow.pos = [0,30,0]</span></span>
<span class="line"><span>    rotate arrow (eulerAngles -90 0 0)</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    custAttributes.add ctrl (</span></span>
<span class="line"><span>        attributes "WindParams" (</span></span>
<span class="line"><span>            parameters main rollout:rlt (</span></span>
<span class="line"><span>                strength type:#float default:1.0 animatable:true ui:spn_str</span></span>
<span class="line"><span>                baseForce type:#float default:20.0 animatable:true ui:spn_base</span></span>
<span class="line"><span>                swingAmp type:#float default:5.0 animatable:true ui:spn_swing</span></span>
<span class="line"><span>                turbAmt type:#float default:2.0 animatable:true ui:spn_turb</span></span>
<span class="line"><span>                activation type:#float default:1.0 animatable:true ui:spn_activation</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            rollout rlt "风力参数(可K帧)" (</span></span>
<span class="line"><span>                group "核心参数" (</span></span>
<span class="line"><span>                    spinner spn_str "总体强度:" range:[0,10,1.0] type:#float</span></span>
<span class="line"><span>                    spinner spn_base "基础风压:" range:[0,90,20.0] type:#float</span></span>
<span class="line"><span>                    spinner spn_swing "摆动幅度:" range:[0,30,5.0] type:#float</span></span>
<span class="line"><span>                    spinner spn_turb "扰动强度:" range:[0,30,2.0] type:#float</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                group "激活控制" (</span></span>
<span class="line"><span>                    spinner spn_activation "激活:" range:[0,1,1.0] type:#float scale:0.01</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    return ctrl</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn applySoftLimit angle maxAngle softness =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    if abs(angle) &lt;= maxAngle then return angle</span></span>
<span class="line"><span>    local excess = abs(angle) - maxAngle</span></span>
<span class="line"><span>    local sign = if angle &gt; 0 then 1 else -1</span></span>
<span class="line"><span>    local softExcess = excess * (1.0 - softness)</span></span>
<span class="line"><span>    return sign * (maxAngle + softExcess)</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn calculate_root_wind absTime baseWind swingAmp turbAmount period turbFreq =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local timePhase = (absTime / period) * 360.0</span></span>
<span class="line"><span>    local sinValue = sin(timePhase)</span></span>
<span class="line"><span>    local swingComponent = sinValue * swingAmp</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    local noisePos = [absTime * turbFreq * 0.1, 0, 0]</span></span>
<span class="line"><span>    local noiseValue = noise3 noisePos</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    return baseWind + swingComponent + (noiseValue * turbAmount)</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn angleToRotationMatrix angle windDir =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local up = [0,0,1]</span></span>
<span class="line"><span>    if (abs (dot windDir up)) &gt; 0.99 do up = [0,1,0]</span></span>
<span class="line"><span>    local perpAxis1 = normalize (cross windDir up)</span></span>
<span class="line"><span>    local perpAxis2 = normalize (cross windDir perpAxis1)</span></span>
<span class="line"><span>    local rot1 = quat (angle * 0.7) perpAxis1</span></span>
<span class="line"><span>    local rot2 = quat (angle * 0.3) perpAxis2</span></span>
<span class="line"><span>    return (rot1 * rot2) as matrix3</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn getBoneChains roots = </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local chains = #()</span></span>
<span class="line"><span>    for r in roots do (</span></span>
<span class="line"><span>        if (findItem roots r.parent) == 0 do (</span></span>
<span class="line"><span>            local chain = #()</span></span>
<span class="line"><span>            local curr = r</span></span>
<span class="line"><span>            append chain curr</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (</span></span>
<span class="line"><span>                curr = curr.children[1] </span></span>
<span class="line"><span>                append chain curr</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            append chains chain</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    return chains</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- === 姿态控制函数 (修复根骨骼无父级崩溃) ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_setPose pressed do with undo "Set Spring Pose" on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local count = 0</span></span>
<span class="line"><span>    for obj in selection do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local curr = obj</span></span>
<span class="line"><span>        local bones = #(curr)</span></span>
<span class="line"><span>        while curr.children.count &gt; 0 do (</span></span>
<span class="line"><span>            curr = curr.children[1]</span></span>
<span class="line"><span>            append bones curr</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for b in bones do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>             if not isProperty b "boneTM" do CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>             </span></span>
<span class="line"><span>             -- [修复] 检查父物体是否存在</span></span>
<span class="line"><span>             if b.parent != undefined then</span></span>
<span class="line"><span>                b.boneTM = b.transform * (inverse b.parent.transform)</span></span>
<span class="line"><span>             else</span></span>
<span class="line"><span>                b.boneTM = b.transform -- 如果没有父物体，直接存世界矩阵</span></span>
<span class="line"><span>             </span></span>
<span class="line"><span>             count += 1</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    messageBox ("已为 " + count as string + " 根骨骼设定参考姿态。") title:"姿态已设定"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_pastePose pressed do with undo "Paste Spring Pose" on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    suspendEditing()</span></span>
<span class="line"><span>    animate on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for b in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local bones = #(b)</span></span>
<span class="line"><span>            local curr = b</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for bn in bones do </span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                if isProperty bn "boneTM" do </span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    try (</span></span>
<span class="line"><span>                        -- [修复] 检查父物体</span></span>
<span class="line"><span>                        local targetTM </span></span>
<span class="line"><span>                        if bn.parent != undefined then</span></span>
<span class="line"><span>                            targetTM = bn.boneTM * bn.parent.transform</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            targetTM = bn.boneTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                        if classof bn == CATBone then bn.transform = targetTM</span></span>
<span class="line"><span>                        else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true</span></span>
<span class="line"><span>                        else if bn.parent != undefined then</span></span>
<span class="line"><span>                            bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation</span></span>
<span class="line"><span>                        else</span></span>
<span class="line"><span>                            bn.rotation = targetTM.rotation</span></span>
<span class="line"><span>                    ) catch()</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    resumeEditing()</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_straighten pressed do with undo "Straighten Bones" on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    suspendEditing()</span></span>
<span class="line"><span>    animate on</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for b in selection do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local bones = #(b)</span></span>
<span class="line"><span>            local curr = b</span></span>
<span class="line"><span>            while curr.children.count &gt; 0 do (curr = curr.children[1]; append bones curr)</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for i = 1 to bones.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bn = bones[i]</span></span>
<span class="line"><span>                try (</span></span>
<span class="line"><span>                    if classof bn == Biped_Object and bn.parent != undefined then </span></span>
<span class="line"><span>                        biped.setTransform bn #rotation bn.parent.transform.rotation true</span></span>
<span class="line"><span>                    else if bn.parent != undefined then (</span></span>
<span class="line"><span>                        local newTM = copy bn.parent.transform</span></span>
<span class="line"><span>                        newTM.pos = bn.transform.pos</span></span>
<span class="line"><span>                        bn.transform = newTM</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                ) catch()</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    resumeEditing()</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- === 核心烘焙逻辑 ===</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_createWindCtrl pressed do</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    local ctrl = createWindController()</span></span>
<span class="line"><span>    ctrl.baseForce = spn_baseWind.value</span></span>
<span class="line"><span>    ctrl.swingAmp = spn_swingAmp.value</span></span>
<span class="line"><span>    ctrl.turbAmt = spn_turbulence.value</span></span>
<span class="line"><span>    pck_ctrl.object = ctrl</span></span>
<span class="line"><span>    select ctrl</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_bake pressed do with undo "Bake Sin+Spring" on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>    clearListener()</span></span>
<span class="line"><span>    if selection.count == 0 do (messageBox "请选择骨骼根部"; return false)</span></span>
<span class="line"><span>    local ctrlObj = pck_ctrl.object</span></span>
<span class="line"><span>    if not isValidNode ctrlObj do (messageBox "请先拾取风向控制器"; return false)</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    local chains = getBoneChains (selection as array)</span></span>
<span class="line"><span>    local startF = spn_start.value</span></span>
<span class="line"><span>    local endF = spn_end.value</span></span>
<span class="line"><span>    local maxAngle = spn_maxAngle.value</span></span>
<span class="line"><span>    local softness = spn_softness.value</span></span>
<span class="line"><span>    local delay = spn_springDelay.value</span></span>
<span class="line"><span>    local xSpring = spn_xSpring.value</span></span>
<span class="line"><span>    local subs = spn_subs.value</span></span>
<span class="line"><span>    local subframe = 1.0 / subs</span></span>
<span class="line"><span>    local scaleMotion = spn_scaleMotion.value</span></span>
<span class="line"><span>    local turbFreq = spn_turbFreq.value </span></span>
<span class="line"><span>    local period = spn_period.value</span></span>
<span class="line"><span>    local loopsCount = if chk_loops.checked then 2 else 1</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    local allBoneTM = #()       </span></span>
<span class="line"><span>    local allPreTimeBoneTM = #() </span></span>
<span class="line"><span>    local allPrePos = #()       </span></span>
<span class="line"><span>    local allChains = #()</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    format "初始化模拟状态 (基于帧 % )...\n" startF</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 初始化数据 (带父物体检查) ===</span></span>
<span class="line"><span>    at time startF</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        for cIdx = 1 to chains.count do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            local chain = chains[cIdx]</span></span>
<span class="line"><span>            local boneRelTMs = #()</span></span>
<span class="line"><span>            local simTMs = #()</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for i = 1 to chain.count do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local b = chain[i]</span></span>
<span class="line"><span>                local relTM</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                if isProperty b "boneTM" then</span></span>
<span class="line"><span>                    relTM = b.boneTM </span></span>
<span class="line"><span>                else</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    -- [修复] 根骨骼无父物体时的崩溃修复</span></span>
<span class="line"><span>                    if b.parent != undefined then</span></span>
<span class="line"><span>                        relTM = b.transform * inverse b.parent.transform</span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                        relTM = b.transform -- 如果无父级，认为是世界坐标</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                append boneRelTMs relTM</span></span>
<span class="line"><span>                append simTMs (copy b.transform)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if chain.count &gt; 1 then</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local lastRelTM = copy boneRelTMs[boneRelTMs.count]</span></span>
<span class="line"><span>                append boneRelTMs lastRelTM </span></span>
<span class="line"><span>                local endWorldTM = lastRelTM * chain[chain.count].transform</span></span>
<span class="line"><span>                append simTMs endWorldTM</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                local endTM = matrix3 1</span></span>
<span class="line"><span>                endTM.pos = [bbox[2].x, 0, 0]</span></span>
<span class="line"><span>                append boneRelTMs endTM</span></span>
<span class="line"><span>                local endWorldTM = endTM * chain[1].transform</span></span>
<span class="line"><span>                append simTMs endWorldTM</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            if chain.count &gt; 1 then</span></span>
<span class="line"><span>                append allPrePos chain[2].transform.pos</span></span>
<span class="line"><span>            else</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                local bbox = nodeGetBoundingBox chain[1] chain[1].transform</span></span>
<span class="line"><span>                append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            append allBoneTM boneRelTMs</span></span>
<span class="line"><span>            append allPreTimeBoneTM simTMs</span></span>
<span class="line"><span>            append allChains chain</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    format "开始模拟 (循环次数: % )...\n" loopsCount</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    local totalFrames = (endF - startF + 1) * loopsCount</span></span>
<span class="line"><span>    local frameCounter = 0</span></span>
<span class="line"><span>    pb_progress.value = 0</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    suspendEditing()</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    -- === 主循环 ===</span></span>
<span class="line"><span>    for L = 1 to loopsCount do</span></span>
<span class="line"><span>    (</span></span>
<span class="line"><span>        local isWritePass = (L == loopsCount) </span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        -- [缝合逻辑] 将预热结束的状态强制写入第0帧</span></span>
<span class="line"><span>        if isWritePass and chk_loops.checked do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            format "&gt;&gt; Loop 2: 正在缝合首尾，修正第 % 帧...\n" startF</span></span>
<span class="line"><span>            animate on at time startF</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local chain = allChains[cIdx]</span></span>
<span class="line"><span>                    local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for j = 1 to chain.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        try (</span></span>
<span class="line"><span>                            if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                chain[j].transform = simTMs[j]</span></span>
<span class="line"><span>                            else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                biped.setTransform chain[j] #rotation simTMs[j].rotation true</span></span>
<span class="line"><span>                            else </span></span>
<span class="line"><span>                                if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                    chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation</span></span>
<span class="line"><span>                                else</span></span>
<span class="line"><span>                                    chain[j].rotation.controller.value = simTMs[j].rotation</span></span>
<span class="line"><span>                        ) catch ()</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        for t = startF to endF do</span></span>
<span class="line"><span>        (</span></span>
<span class="line"><span>            if keyboard.escPressed then exit</span></span>
<span class="line"><span>            frameCounter += 1</span></span>
<span class="line"><span>            pb_progress.value = (100.0 * frameCounter / totalFrames)</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local currTime = t as float</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            local windTM = at time t ctrlObj.transform</span></span>
<span class="line"><span>            local windDir = normalize (-windTM.row2)</span></span>
<span class="line"><span>            local globalStr = at time t ctrlObj.strength</span></span>
<span class="line"><span>            local baseWind = at time t ctrlObj.baseForce</span></span>
<span class="line"><span>            local swingAmp = at time t ctrlObj.swingAmp</span></span>
<span class="line"><span>            local turbAmount = at time t ctrlObj.turbAmt</span></span>
<span class="line"><span>            local activation = at time t ctrlObj.activation</span></span>
<span class="line"><span>            </span></span>
<span class="line"><span>            for sf = 1 to subs do</span></span>
<span class="line"><span>            (</span></span>
<span class="line"><span>                currTime += subframe</span></span>
<span class="line"><span>                </span></span>
<span class="line"><span>                for cIdx = 1 to allChains.count do</span></span>
<span class="line"><span>                (</span></span>
<span class="line"><span>                    local chain = allChains[cIdx]</span></span>
<span class="line"><span>                    local targetRelTMs = allBoneTM[cIdx]</span></span>
<span class="line"><span>                    local simTMs = allPreTimeBoneTM[cIdx] </span></span>
<span class="line"><span>                    local prePos = allPrePos[cIdx]</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    -- [修复] 主循环中对父物体的检查</span></span>
<span class="line"><span>                    local currentPTM </span></span>
<span class="line"><span>                    if chain[1].parent != undefined then</span></span>
<span class="line"><span>                        currentPTM = at time currTime chain[1].parent.transform</span></span>
<span class="line"><span>                    else</span></span>
<span class="line"><span>                        currentPTM = matrix3 1 -- 如果没有父物体，假设世界原点</span></span>
<span class="line"><span>                    </span></span>
<span class="line"><span>                    for j = 1 to chain.count do</span></span>
<span class="line"><span>                    (</span></span>
<span class="line"><span>                        local targetBoneTM = targetRelTMs[j] * currentPTM</span></span>
<span class="line"><span>                        local currentPos = if j == 1 then prePos else simTMs[j+1].pos</span></span>
<span class="line"><span>                        local tpos = targetBoneTM.pos</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- Twist X</span></span>
<span class="line"><span>                        local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)</span></span>
<span class="line"><span>                        if dot1 &gt; 1 then dot1 = 1 else if dot1 &lt; -1 then dot1 = -1</span></span>
<span class="line"><span>                        local angX = acos(dot1)</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local newTM1 = copy simTMs[j]</span></span>
<span class="line"><span>                        local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)</span></span>
<span class="line"><span>                        if angX &gt; 0.001 do rotate newTM1 (quat angX -vt1)</span></span>
<span class="line"><span>                        newTM1.pos = tpos</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- Spring Y/Z</span></span>
<span class="line"><span>                        local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                        if dot2 &gt; 1 then dot2 = 1 else if dot2 &lt; -1 then dot2 = -1</span></span>
<span class="line"><span>                        local angY1 = acos(dot2)</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)</span></span>
<span class="line"><span>                        local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))</span></span>
<span class="line"><span>                        angY1 = angY1 * xAxisDelay</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        if dot ssvt targetBoneTM.row1 &gt; 0 do angY1 = -angY1</span></span>
<span class="line"><span>                        if abs angY1 &gt; 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)</span></span>
<span class="line"><span>                        newTM1.pos = tpos</span></span>
<span class="line"><span>                        targetBoneTM = copy newTM1</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- Main Bend</span></span>
<span class="line"><span>                        local tvector = normalize targetBoneTM.row1</span></span>
<span class="line"><span>                        local cvector = normalize (currentPos - tpos)</span></span>
<span class="line"><span>                        local vt = normalize (cross cvector tvector)</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local dot3 = dot cvector tvector</span></span>
<span class="line"><span>                        if dot3 &gt; 1 then dot3 = 1 else if dot3 &lt; -1 then dot3 = -1</span></span>
<span class="line"><span>                        local angle = acos(dot3)</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        angle *= (1.0 - delay)</span></span>
<span class="line"><span>                        local sangle = angle</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- Root Sin Wind</span></span>
<span class="line"><span>                        if j == 1 do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            local windAngle = calculate_root_wind currTime baseWind swingAmp turbAmount period turbFreq</span></span>
<span class="line"><span>                            windAngle = applySoftLimit windAngle maxAngle softness</span></span>
<span class="line"><span>                            windAngle *= globalStr * activation</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            local windRotMat = angleToRotationMatrix windAngle windDir</span></span>
<span class="line"><span>                            local tempTM = copy targetBoneTM</span></span>
<span class="line"><span>                            tempTM.pos = [0,0,0]</span></span>
<span class="line"><span>                            tempTM = tempTM * windRotMat</span></span>
<span class="line"><span>                            tempTM.pos = tpos</span></span>
<span class="line"><span>                            targetBoneTM = tempTM</span></span>
<span class="line"><span>                            </span></span>
<span class="line"><span>                            angle *= scaleMotion</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        angle = applySoftLimit angle maxAngle softness</span></span>
<span class="line"><span>                        sangle = applySoftLimit sangle maxAngle softness</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        local ttm = copy targetBoneTM</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        if abs angle &gt; 0.001 do rotate targetBoneTM (quat angle vt)</span></span>
<span class="line"><span>                        if j == 1 and abs sangle &gt; 0.001 do rotate ttm (quat sangle vt)</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        targetBoneTM.pos = tpos</span></span>
<span class="line"><span>                        ttm.pos = tpos</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        -- === 写入关键帧 (t+1) ===</span></span>
<span class="line"><span>                        if isWritePass and sf == subs do</span></span>
<span class="line"><span>                        (</span></span>
<span class="line"><span>                            animate on at time (t + 1f)</span></span>
<span class="line"><span>                            (</span></span>
<span class="line"><span>                                try (</span></span>
<span class="line"><span>                                    if classof chain[j] == CATBone then</span></span>
<span class="line"><span>                                        chain[j].transform = copy targetBoneTM</span></span>
<span class="line"><span>                                    else if classof chain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>                                        biped.setTransform chain[j] #rotation targetBoneTM.rotation true</span></span>
<span class="line"><span>                                    else </span></span>
<span class="line"><span>                                        -- [修复] 写入时的父物体检查</span></span>
<span class="line"><span>                                        if chain[j].parent != undefined then</span></span>
<span class="line"><span>                                            chain[j].rotation.controller.value = targetBoneTM.rotation * inverse currentPTM.rotation</span></span>
<span class="line"><span>                                        else</span></span>
<span class="line"><span>                                            chain[j].rotation.controller.value = targetBoneTM.rotation</span></span>
<span class="line"><span>                                ) catch ()</span></span>
<span class="line"><span>                            )</span></span>
<span class="line"><span>                        )</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        currentPTM = copy targetBoneTM</span></span>
<span class="line"><span>                        simTMs[j] = copy targetBoneTM</span></span>
<span class="line"><span>                        </span></span>
<span class="line"><span>                        if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm</span></span>
<span class="line"><span>                        if j &lt; chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM</span></span>
<span class="line"><span>                    )</span></span>
<span class="line"><span>                )</span></span>
<span class="line"><span>            )</span></span>
<span class="line"><span>        )</span></span>
<span class="line"><span>    )</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    resumeEditing()</span></span>
<span class="line"><span>    pb_progress.value = 100</span></span>
<span class="line"><span>    print "生成完毕！" </span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>)</span></span></code></pre></div></div></pre><p>)</p><p>createDialog rol_SinWindSpring</p><p>这个脚本他子采样应该启动的时候默认为1才对，根骨骼缩放为1才对，然后这个脚本可操作性比较少啊，我有另一个spring脚本，他虽然没有控制风的方向，但是他可以单独控制每根骨骼的sin摆动，还有混合的力度，相对来说是一个很不错的局部控制的方式，我在想，如果我没有激活控制的时候，是不是应该可以切换到局部控制每个骨骼的轴向的混合会更方便，所以我希望你能帮我添加结合，大家核心算法都是spring算法，只是sin有一点不同，我平常只有两个用法，要么sin开为1，直接算完第一根后，关闭sin，重新计算一次spring来达到变成自然飘动的效果，要么，直接sin的力度改成0.5，让他们混合，来达到，平滑的进入sin的效果，当然，这个问题再这边已经解决了，我这是希望可以单独控制一下，可以调整的参数更多，我希望你能帮我结合一下，下面是另一个脚本</p><p>--------------------------Ver.  1.11 Ultimate    Author : Si-Chung Yuan 2017.9 + Advanced Features --------------------------------------------------------------</p><p>-- 先关闭已存在的对话框<br>
<!-- -->if springMagic_rol != undefined do destroyDialog springMagic_rol</p><p>-- 自定义属性定义<br>
<!-- -->vposCA = attributes vipos<br>
<!-- -->(<br>
<!-- -->parameters main<br>
<!-- -->(<br>
<!-- -->vpos type:#point3Tab tabSizeVariable:true animatable:false<br>
<!-- -->)<br>
<!-- -->)</p><p>sprboneCA = attributes sprbTM<br>
<!-- -->(<br>
<!-- -->parameters main<br>
<!-- -->(<br>
<!-- -->boneTM type:#matrix3<br>
<!-- -->)<br>
<!-- -->)</p><p>-- 全局变量定义<br>
<!-- -->framestart = undefined<br>
<!-- -->frameEnd = undefined<br>
<!-- -->simbones = #()<br>
<!-- -->bone_TM = #()<br>
<!-- -->preTimebone_TM = #()<br>
<!-- -->prePos = #()<br>
<!-- -->bcnt = #()</p><p>rollout springMagic_rol "飘带魔法工具 V1.11 终极版" width:500<br>
<!-- -->(<br>
<!-- -->-- 基础弹簧参数组<br>
<!-- -->group "基础弹簧参数"<br>
<!-- -->(<br>
<!-- -->spinner delaysp "弹簧硬度" type:#float scale:0.01 range:[0.01,1,0.3] align:#left across:3<br>
<!-- -->spinner scaleMotion "运动缩放" type:#float scale:0.01 range:[0,999,1]<br>
<!-- -->spinner test_G "重力.Z" type:#float range:[-990.0,999,0] align:#right</p>
<pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>	spinner subs "子步数" type:#integer range:[1,30,1] align:#left across:3</span></span>
<span class="line"><span>	spinner upspring "X弹簧" type:#float scale:0.01 range:[0.1,1,0.3]</span></span>
<span class="line"><span>	spinner bnum "骨骼数量" type:#integer range:[0,1000,50] align:#right</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	checkBox loops "循环计算" align:#left</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 多对象偏移控制</span></span>
<span class="line"><span>group "多对象控制"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	spinner spn_frameOffset "动画帧偏移" type:#integer range:[0,50,0] align:#left across:2</span></span>
<span class="line"><span>	spinner spn_perBoneOffset "每对象差异帧" type:#integer range:[0,20,2] toolTip:"用于错开多个对象动画时间" align:#right</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 根部位置权重</span></span>
<span class="line"><span>group "根部位置权重"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	spinner test_blend_x "X权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3</span></span>
<span class="line"><span>	spinner test_blend_y "Y权重" type:#float range:[0.0,1.0,1] scale:0.01</span></span>
<span class="line"><span>	spinner test_blend_z "Z权重" type:#float range:[0.0,1.0,1] scale:0.01 align:#right</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- Sin扰动控制面板 (增强版)</span></span>
<span class="line"><span>group "Sin波扰动控制 (增强版)"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	checkBox chk_enableSinWave "启用Sin波" checked:false align:#left</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	-- X轴控制 (增强版 - 正负值强度)</span></span>
<span class="line"><span>	label lbl_x "X轴控制 (扭转)" align:#left</span></span>
<span class="line"><span>	spinner test_rota_x "X开关" type:#float range:[0.0,1.0,0] scale:0.01 toolTip:"X轴开关" align:#left across:4</span></span>
<span class="line"><span>	spinner test_max_rota_x "X旋转量" range:[-990.0,999,5] toolTip:"X旋转量"</span></span>
<span class="line"><span>	spinner spn_xPos "X+强度" type:#float range:[0.1,5,1] toolTip:"正向强度比例"</span></span>
<span class="line"><span>	spinner spn_xNeg "X-强度" type:#float range:[0.1,5,1] toolTip:"负向强度比例"</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	spinner test_offsettime_x "X时间延迟" range:[-999,999,4] type:#integer align:#left across:3</span></span>
<span class="line"><span>	spinner test_max2_rota_x "X递增量" range:[-999,999,5] toolTip:"X递增量"</span></span>
<span class="line"><span>	spinner test_timelenght_x "X周期长度" range:[5,999,40] type:#integer toolTip:"X循环长度"</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	-- Y轴控制 (增强版 - 正负值强度)</span></span>
<span class="line"><span>	label lbl_y "Y轴控制 (左右摆动)" align:#left</span></span>
<span class="line"><span>	spinner test_rota_y "Y开关" type:#float range:[0.0,1.0,0] scale:0.01 toolTip:"Y轴开关" align:#left across:4</span></span>
<span class="line"><span>	spinner test_max_rota_y "Y旋转量" range:[-990.0,999,5] toolTip:"Y旋转量"</span></span>
<span class="line"><span>	spinner spn_yPos "Y+强度" type:#float range:[0.1,5,1] toolTip:"正向强度比例"</span></span>
<span class="line"><span>	spinner spn_yNeg "Y-强度" type:#float range:[0.1,5,1] toolTip:"负向强度比例"</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	spinner test_offsettime_y "Y时间延迟" range:[-999,999,4] type:#integer align:#left across:3</span></span>
<span class="line"><span>	spinner test_max2_rota_y "Y递增量" range:[-999,999,5] toolTip:"Y递增量"</span></span>
<span class="line"><span>	spinner test_timelenght_y "Y周期长度" range:[5,999,40] type:#integer toolTip:"Y循环长度"</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	-- Z轴控制 (增强版 - 正负值强度)</span></span>
<span class="line"><span>	label lbl_z "Z轴控制 (前后摆动)" align:#left</span></span>
<span class="line"><span>	spinner test_rota_z "Z开关" type:#float range:[0.0,1.0,0] scale:0.01 toolTip:"Z轴开关" align:#left across:4</span></span>
<span class="line"><span>	spinner test_max_rota "Z旋转量" range:[-990.0,999,5] toolTip:"Z旋转量"</span></span>
<span class="line"><span>	spinner spn_zPos "Z+强度" type:#float range:[0.1,5,1] toolTip:"正向强度比例"</span></span>
<span class="line"><span>	spinner spn_zNeg "Z-强度" type:#float range:[0.1,5,1] toolTip:"负向强度比例"</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	spinner test_offsettime "Z时间延迟" range:[-990,999,4] type:#integer align:#left across:3</span></span>
<span class="line"><span>	spinner test_max2_rota "Z递增量" range:[-999,999,5] toolTip:"Z递增量"</span></span>
<span class="line"><span>	spinner test_timelenght "Z周期长度" range:[5,999,40] type:#integer toolTip:"Z循环长度"</span></span>
<span class="line"><span>)</span></span></code></pre></div></div></pre><pre><div class="not-prose my-0 flex w-full flex-col overflow-clip border border-border text-text-primary rounded-lg not-prose relative" data-code-block="true"><div class="border-border flex items-center justify-between border-b px-4 py-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code text-text-secondary"><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path></svg><span class="text-text-secondary text-sm font-medium">text</span></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-sm font-medium text-interactive-active hover:text-interactive-normal active:text-text-tertiary relative rounded-lg p-[6px]" type="button" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-interactive-positive absolute left-1.5 top-1.5 rotate-90 opacity-0 transition-all duration-300"><path d="M20 6 9 17l-5-5"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy opacity-100 transition-opacity duration-300"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><div class="code-block_container__lbMX4"><pre class="shiki github-light shiki-code-block" style="background-color:#fff;color:#24292e" tabindex="0"><code class="whitespace-pre-wrap break-words"><span class="line"><span>-- 骨骼姿态工具</span></span>
<span class="line"><span>group "骨骼姿态工具"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	button pasteRp "粘贴姿态" toolTip:"选择首节骨骼" align:#left across:4</span></span>
<span class="line"><span>	button setRp "设置姿态" toolTip:"设置初始姿态"</span></span>
<span class="line"><span>	button stretch "打直骨骼" toolTip:"打直选择骨骼"</span></span>
<span class="line"><span>	button btn_reset "重置参数" toolTip:"重置UI数值" align:#right</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 关键帧范围</span></span>
<span class="line"><span>group "关键帧范围"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	radiobuttons a1 labels:#("活动范围", "自定义") align:#left across:3</span></span>
<span class="line"><span>	spinner aframeStart "起始帧" type:#integer range:[-10000,100000,1]</span></span>
<span class="line"><span>	spinner aframeEnd "结束帧" type:#integer range:[0,100000,10] align:#right</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 应用按钮</span></span>
<span class="line"><span>group "执行计算"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	button applybone "烘焙动画" toolTip:"选择首节骨骼开始计算" align:#left across:2</span></span>
<span class="line"><span>	progressBar doit_prog "进度" color:red align:#right</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 附加工具面板</span></span>
<span class="line"><span>group "附加工具"</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	button btn_selectChildren "选择所有子级" toolTip:"选择所有子对象" align:#left across:6</span></span>
<span class="line"><span>	button btn_LoopStart "首尾循环" toolTip:"首尾循环处理"</span></span>
<span class="line"><span>	button btn_EulerFilter "欧拉过滤" toolTip:"欧拉过滤"</span></span>
<span class="line"><span>	button btn_TCB "转TCB曲线" toolTip:"转换为TCB曲线"</span></span>
<span class="line"><span>	button btn_Euler "转欧拉曲线" toolTip:"转换为欧拉曲线"</span></span>
<span class="line"><span>	button btn_SelectAllBones "选择所有骨骼" toolTip:"选择场景中所有骨骼" align:#right</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>label lab_aut "作者: Si-Chung Yuan + 终极增强版" align:#left</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 递归获取所有子对象的函数</span></span>
<span class="line"><span>fn getAllChildren obj =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	local childrenArray = #()</span></span>
<span class="line"><span>	for c in obj.children do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		append childrenArray c</span></span>
<span class="line"><span>		join childrenArray (getAllChildren c)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	return childrenArray</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 排序数组函数</span></span>
<span class="line"><span>fn sortArrayByHeirarchy objectArray =</span></span>
<span class="line"><span>( </span></span>
<span class="line"><span>	local sortedArray = #()</span></span>
<span class="line"><span>	local listArray = #()</span></span>
<span class="line"><span>	local parentArray = #()</span></span>
<span class="line"><span>	local childArray = #()</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	for obj in objectArray do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if (finditem objectArray obj.parent) == 0 </span></span>
<span class="line"><span>		then append parentArray obj</span></span>
<span class="line"><span>		else append childArray obj  </span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	while childArray.count &gt; 0 do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		local i=1</span></span>
<span class="line"><span>		while i &lt;= childArray.count do</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			local parentIdx = finditem parentArray childArray[i].parent</span></span>
<span class="line"><span>			if parentIdx != 0 then</span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				insertItem childArray[i] parentArray (parentIdx+1) </span></span>
<span class="line"><span>				deleteItem childArray i</span></span>
<span class="line"><span>			) </span></span>
<span class="line"><span>			else(i += 1)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local a = 1</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	for l=1 to parentArray.count do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if (finditem parentArray (parentArray[l].children)[1]) != 0 then</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			append listArray parentArray[l]</span></span>
<span class="line"><span>		) </span></span>
<span class="line"><span>		else</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			append listArray parentArray[l]</span></span>
<span class="line"><span>			sortedArray[a] = listArray</span></span>
<span class="line"><span>			listArray = #()</span></span>
<span class="line"><span>			a += 1</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	sortedArray</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 首尾循环函数</span></span>
<span class="line"><span>fn BoneLoopStart objectArray=</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	local firstbonerot = #()</span></span>
<span class="line"><span>	local lastbonerot = #()</span></span>
<span class="line"><span>	local bonesub = #()</span></span>
<span class="line"><span>	local bonelistsub = #()</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local startFrame=(animationrange.start as string) as integer</span></span>
<span class="line"><span>	local endFrame=(animationrange.end as string) as integer</span></span>
<span class="line"><span>	local cycleFrame=30</span></span>
<span class="line"><span>	if (endFrame-startframe)&lt;30 then cycleFrame=(endFrame-startframe)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	for i = 1 to objectArray.count do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		slidertime=animationrange.start</span></span>
<span class="line"><span>		for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			append firstbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		slidertime=animationrange.end</span></span>
<span class="line"><span>		for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			append lastbonerot objectArray[i][j].transform.rotation</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		for j = 1 to objectArray[i].count do</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>		append bonesub (quattoeuler (firstbonerot[j]-lastbonerot[j]))</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		append bonelistsub bonesub</span></span>
<span class="line"><span>		firstbonerot = #()</span></span>
<span class="line"><span>		lastbonerot = #()</span></span>
<span class="line"><span>		bonesub = #()</span></span>
<span class="line"><span>	)	</span></span>
<span class="line"><span>	set animate on</span></span>
<span class="line"><span>	for f = 0 to cycleframe do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		slidertime = endFrame - f;</span></span>
<span class="line"><span>		local per=(float)(cycleFrame-f)/cycleFrame</span></span>
<span class="line"><span>		</span></span>
<span class="line"><span>		for a = 1 to objectArray.count do</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			for b = 1 to objectArray[a].count do</span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				local r = bonelistsub[a][b];</span></span>
<span class="line"><span>				if b &gt; 1 then(r=quattoeuler  (bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat))</span></span>
<span class="line"><span>				local rot = (eulerangles (r.x*per) (r.y*per) (r.z*per))</span></span>
<span class="line"><span>				rotate objectArray[a][b] rot</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	set animate off</span></span>
<span class="line"><span>	slidertime=startframe</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn setStartEndFrame = </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	if a1.state == 1 then </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		framestart = animationRange.start-1f</span></span>
<span class="line"><span>		frameEnd = animationRange.end-1f</span></span>
<span class="line"><span>	) </span></span>
<span class="line"><span>	else </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		framestart = aframeStart.value-1f as time</span></span>
<span class="line"><span>		frameEnd = aframeEnd.value-1f as time</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn reset_control_value =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	local timelenght = animationRange.end.frame - animationRange.start.frame </span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	delaysp.value = 0.3</span></span>
<span class="line"><span>	scaleMotion.value = 1.0</span></span>
<span class="line"><span>	subs.value = 1</span></span>
<span class="line"><span>	upspring.value = 0.3</span></span>
<span class="line"><span>	bnum.value = 50</span></span>
<span class="line"><span>	loops.checked = false</span></span>
<span class="line"><span>	test_G.value = 0.0</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	spn_frameOffset.value = 0</span></span>
<span class="line"><span>	spn_perBoneOffset.value = 2</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	test_blend_x.value = 1.0</span></span>
<span class="line"><span>	test_blend_y.value = 1.0</span></span>
<span class="line"><span>	test_blend_z.value = 1.0</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	chk_enableSinWave.checked = false</span></span>
<span class="line"><span>	test_rota_x.value = 0</span></span>
<span class="line"><span>	test_rota_y.value = 0</span></span>
<span class="line"><span>	test_rota_z.value = 0</span></span>
<span class="line"><span>	test_max_rota_x.value = 5.0</span></span>
<span class="line"><span>	test_max_rota_y.value = 5.0</span></span>
<span class="line"><span>	test_max_rota.value = 5.0</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	spn_xPos.value = 1.0</span></span>
<span class="line"><span>	spn_xNeg.value = 1.0</span></span>
<span class="line"><span>	spn_yPos.value = 1.0</span></span>
<span class="line"><span>	spn_yNeg.value = 1.0</span></span>
<span class="line"><span>	spn_zPos.value = 1.0</span></span>
<span class="line"><span>	spn_zNeg.value = 1.0</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	test_offsettime_x.value = 4</span></span>
<span class="line"><span>	test_offsettime_y.value = 4</span></span>
<span class="line"><span>	test_offsettime.value = 4</span></span>
<span class="line"><span>	test_max2_rota_x.value = 5</span></span>
<span class="line"><span>	test_max2_rota_y.value = 5</span></span>
<span class="line"><span>	test_max2_rota.value = 5</span></span>
<span class="line"><span>	test_timelenght_x.value = timelenght</span></span>
<span class="line"><span>	test_timelenght_y.value = timelenght</span></span>
<span class="line"><span>	test_timelenght.value = timelenght</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	format "调试: 参数已重置为默认值\n"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn getBoneChain bone = </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	local bonechain = #()</span></span>
<span class="line"><span>	local bonetype = classof bone</span></span>
<span class="line"><span>	local num = 1</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	if bone.parent == undefined do </span></span>
<span class="line"><span>	( </span></span>
<span class="line"><span>		messageBox (((bone.name as string)+"必须有父级节点!"))</span></span>
<span class="line"><span>		continue</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	local parnode = bone.parent</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	while bone!=undefined do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		bonechain[num] = bone</span></span>
<span class="line"><span>		local childfind = false</span></span>
<span class="line"><span>		if bone.children.count == 0 or num&gt;bnum.value then exit</span></span>
<span class="line"><span>		else </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			for c in bone.children do</span></span>
<span class="line"><span>				if classof c == bonetype or classof c == Dummy then </span></span>
<span class="line"><span>				(</span></span>
<span class="line"><span>					bone = c</span></span>
<span class="line"><span>					num += 1 </span></span>
<span class="line"><span>					childfind = true</span></span>
<span class="line"><span>					exit</span></span>
<span class="line"><span>				)</span></span>
<span class="line"><span>				else continue</span></span>
<span class="line"><span>			if childfind == false do bone = undefined</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	append simBones bonechain</span></span>
<span class="line"><span>	format "调试: 收集到骨骼链，包含 % 根骨骼\n" bonechain.count</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	local pTM = parnode.transform</span></span>
<span class="line"><span>	local preTM = #()</span></span>
<span class="line"><span>	local bTM = #()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	for j in 1 to bonechain.count do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if classof bonechain[j] == Dummy and classof bonechain[j].controller == BipSlave_Control then</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			for i = 1 to (custAttributes.count bonechain[j]) do </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				local a = CustAttributes.get bonechain[j] i</span></span>
<span class="line"><span>				if isProperty a "boneTM" do </span></span>
<span class="line"><span>				(</span></span>
<span class="line"><span>					CustAttributes.delete bonechain[j] i</span></span>
<span class="line"><span>					local isDelete = true</span></span>
<span class="line"><span>				)</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		else</span></span>
<span class="line"><span>			if not isProperty bonechain[j] "boneTM" then </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				CustAttributes.add bonechain[j] sprboneCA</span></span>
<span class="line"><span>				bonechain[j].boneTM = bonechain[j].transform * inverse bonechain[j].parent.transform</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		</span></span>
<span class="line"><span>		if isProperty bonechain[j] "boneTM" then</span></span>
<span class="line"><span>			append bTM bonechain[j].boneTM</span></span>
<span class="line"><span>		else</span></span>
<span class="line"><span>			append bTM (bonechain[j].transform * inverse bonechain[j].parent.transform)</span></span>
<span class="line"><span>		</span></span>
<span class="line"><span>		append preTM bonechain[j].transform</span></span>
<span class="line"><span>	)	</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	if bonechain.count &gt; 1 then</span></span>
<span class="line"><span>		append prePos bonechain[2].transform.pos</span></span>
<span class="line"><span>	else </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		local bbox = nodeGetBoundingBox bonechain[1] bonechain[1].transform</span></span>
<span class="line"><span>		append prePos (bonechain[1].transform.pos + bonechain[1].transform.row1 * bbox[2].x)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	-- Add End</span></span>
<span class="line"><span>	if bnum.value &gt;= bonechain.count do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if bonechain.count &gt; 1 then </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			local ltm = copy bTM[bTM.count]</span></span>
<span class="line"><span>			append bTM ltm</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		else </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			local ltm = matrix3 1</span></span>
<span class="line"><span>			local bbox = nodeGetBoundingBox bonechain[1] bonechain[1].transform</span></span>
<span class="line"><span>			ltm.pos = [bbox[2].x, 0 ,0]</span></span>
<span class="line"><span>			append bTM ltm</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		local tm = ltm * bonechain[preTM.count].transform</span></span>
<span class="line"><span>		append preTM tm</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	if classof bonechain[bonechain.count] == Dummy and \</span></span>
<span class="line"><span>		classof bonechain[bonechain.count].controller == BipSlave_Control do</span></span>
<span class="line"><span>		bonechain.count = bonechain.count - 1</span></span>
<span class="line"><span>	if bonechain.count &gt; bnum.value do bonechain.count = bnum.value</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	append bcnt bTM.count</span></span>
<span class="line"><span>	append preTimebone_TM preTM</span></span>
<span class="line"><span>	append bone_TM bTM</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	format "调试: bTM数量=% preTM数量=% 骨骼链数量=%\n" bTM.count preTM.count bonechain.count</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 增强的sin旋转计算函数 (支持正负值强度)</span></span>
<span class="line"><span>fn get_sin_rotation_enhanced F_time offset_ rota type objectIndex =</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	-- 添加对象偏移</span></span>
<span class="line"><span>	local adjustedTime = F_time + (objectIndex - 1) * spn_perBoneOffset.value + spn_frameOffset.value</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	case type of</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		3: -- Z轴</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			if not chk_enableSinWave.checked or test_rota_z.value == 0 do return (eulerAngles 0 0 0)</span></span>
<span class="line"><span>			local b = 1.0 / (test_timelenght.value / (2.0*pi))</span></span>
<span class="line"><span>			local d = sin (radtodeg (adjustedTime - offset_)*b)</span></span>
<span class="line"><span>			d = radtodeg (d* (degtorad rota))</span></span>
<span class="line"><span>			-- 应用正负值强度</span></span>
<span class="line"><span>			local finalD = if d &gt; 0 then d * spn_zPos.value else d * spn_zNeg.value</span></span>
<span class="line"><span>			eulerAngles 0 0 (test_rota_z.value * finalD)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		2: -- Y轴</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			if not chk_enableSinWave.checked or test_rota_y.value == 0 do return (eulerAngles 0 0 0)</span></span>
<span class="line"><span>			local b = 1.0 / (test_timelenght_y.value / (2.0*pi))</span></span>
<span class="line"><span>			local d = cos (radtodeg (adjustedTime - offset_)*b)</span></span>
<span class="line"><span>			d = radtodeg (d* (degtorad rota))</span></span>
<span class="line"><span>			-- 应用正负值强度</span></span>
<span class="line"><span>			local finalD = if d &gt; 0 then d * spn_yPos.value else d * spn_yNeg.value</span></span>
<span class="line"><span>			eulerAngles 0 (test_rota_y.value * finalD) 0</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		1: -- X轴</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			if not chk_enableSinWave.checked or test_rota_x.value == 0 do return (eulerAngles 0 0 0)</span></span>
<span class="line"><span>			local b = 1.0 / (test_timelenght_x.value / (2.0*pi))</span></span>
<span class="line"><span>			local d = sin (radtodeg (adjustedTime - offset_)*b)</span></span>
<span class="line"><span>			d = radtodeg (d* (degtorad rota))</span></span>
<span class="line"><span>			-- 应用正负值强度</span></span>
<span class="line"><span>			local finalD = if d &gt; 0 then d * spn_xPos.value else d * spn_xNeg.value</span></span>
<span class="line"><span>			eulerAngles (test_rota_x.value * finalD) 0 0</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on applybone pressed do with undo on </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	format "调试: 开始飘带魔法终极计算...\n"</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	-- 权重混合</span></span>
<span class="line"><span>	local blend_z = test_blend_z.value</span></span>
<span class="line"><span>	local blend_y = test_blend_y.value</span></span>
<span class="line"><span>	local blend_x = test_blend_x.value</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	simbones=#()</span></span>
<span class="line"><span>	setStartEndFrame()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	-- Clear arrays</span></span>
<span class="line"><span>	simBones = #()</span></span>
<span class="line"><span>	bone_TM = #()</span></span>
<span class="line"><span>	preTimebone_TM = #()</span></span>
<span class="line"><span>	prePos = #()</span></span>
<span class="line"><span>	bcnt = #()</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local delay = delaysp.value</span></span>
<span class="line"><span>	format "调试: 正在处理 % 个选中对象\n" selection.count</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	-- 为每个选中的对象建立骨骼链</span></span>
<span class="line"><span>	local objectIndex = 0</span></span>
<span class="line"><span>	for object in selection do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if superClassOf object != shape do </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			objectIndex += 1</span></span>
<span class="line"><span>			format "调试: 正在处理对象 % - %\n" objectIndex object.name</span></span>
<span class="line"><span>			at time frameStart getBoneChain object</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	format "调试: 总共找到 % 个骨骼链\n" simBones.count</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	-- Start calculation</span></span>
<span class="line"><span>	local loopsv = if loops.checked then 2 else 1 </span></span>
<span class="line"><span>	local subframe = 1f/subs.value</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local pv = 100.0/ loopsv / (frameEnd - framestart + 1)</span></span>
<span class="line"><span>	doit_prog.value = 0.0</span></span>
<span class="line"><span>	local totalVal = 0</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	format "调试: 开始主计算循环, 循环次数=%, 子帧=%\n" loopsv subframe</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	for L = 1 to loopsv do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		format "调试: 循环 % / %\n" L loopsv</span></span>
<span class="line"><span>		</span></span>
<span class="line"><span>		for t = framestart to frameEnd do </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			if keyboard.escPressed then exit</span></span>
<span class="line"><span>			local currtTime = t</span></span>
<span class="line"><span></span></span>
<span class="line"><span>			for sf in 1 to subs.value do </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				currtTime += subframe</span></span>
<span class="line"><span></span></span>
<span class="line"><span>				for i in 1 to simbones.count do </span></span>
<span class="line"><span>				(</span></span>
<span class="line"><span>					local currentPTM = at time currtTime simbones[i][1].parent.transform</span></span>
<span class="line"><span>					</span></span>
<span class="line"><span>					-- 根部位置权重混合</span></span>
<span class="line"><span>					local currentPTM_up = at time framestart simbones[i][1].parent.transform</span></span>
<span class="line"><span>					local temp_z = currentPTM.pos.z * blend_z + currentPTM_up.pos.z * (1.0 - blend_z)</span></span>
<span class="line"><span>					local temp_y = currentPTM.pos.y * blend_y + currentPTM_up.pos.y * (1.0 - blend_y)</span></span>
<span class="line"><span>					local temp_x = currentPTM.pos.x * blend_x + currentPTM_up.pos.x * (1.0 - blend_x)</span></span>
<span class="line"><span>					currentPTM.pos = [temp_x,temp_y,temp_z]</span></span>
<span class="line"><span>					</span></span>
<span class="line"><span>					for j in 1 to simbones[i].count do </span></span>
<span class="line"><span>					(</span></span>
<span class="line"><span>						-- Sin旋转量递增计算 (增强版 - 支持多对象)</span></span>
<span class="line"><span>						local sin_rota_x = test_max_rota_x.value + (j - 1.0) * test_max2_rota_x.value</span></span>
<span class="line"><span>						local sin_rota_y = test_max_rota_y.value + (j - 1.0) * test_max2_rota_y.value</span></span>
<span class="line"><span>						local sin_rota_z = test_max_rota.value + (j - 1.0) * test_max2_rota.value</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						local test_rotat_x = get_sin_rotation_enhanced (t - framestart) ((j - 1)*test_offsettime_x.value) sin_rota_x 1 i</span></span>
<span class="line"><span>						local test_rotat_y = get_sin_rotation_enhanced (t - framestart) ((j - 1)*test_offsettime_y.value) sin_rota_y 2 i</span></span>
<span class="line"><span>						local test_rotat_z = get_sin_rotation_enhanced (t - framestart) ((j - 1)*test_offsettime.value) sin_rota_z 3 i</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						local targetboneTM = bone_TM[i][j] * currentPTM</span></span>
<span class="line"><span>						local currentPos = if j==1 then prePos[i] else preTimebone_TM[i][j+1].pos</span></span>
<span class="line"><span>						local tpos = targetboneTM.pos</span></span>
<span class="line"><span>							</span></span>
<span class="line"><span>						-- Twist X calculation (springmagic_v1.11 algorithm)</span></span>
<span class="line"><span>						local angX = acos(dot (normalize preTimebone_TM[i][j].row1) (normalize targetboneTM.row1))</span></span>
<span class="line"><span>						local newTM1 = copy preTimebone_TM[i][j]</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						local vt1 = normalize (cross preTimebone_TM[i][j].row1 targetboneTM.row1)</span></span>
<span class="line"><span>							</span></span>
<span class="line"><span>						if not bit.isNAN angX do rotate newTM1 (quat angX -vt1) </span></span>
<span class="line"><span>					</span></span>
<span class="line"><span>						newTM1.pos = tpos</span></span>
<span class="line"><span></span></span>
<span class="line"><span>						local angY1 = acos(dot (normalize newTM1[2]) (normalize targetboneTM.row2))	</span></span>
<span class="line"><span>						local ssvt = cross (normalize newTM1[2]) (normalize targetboneTM.row2)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>						local xaxisdelay = (upspring.value + ((simbones[i].count-j)/(simbones[i].count)*(1.0-upspring.value)) )</span></span>
<span class="line"><span>						angY1 = angY1 * xaxisdelay</span></span>
<span class="line"><span>						if dot ssvt targetboneTM.row1 &gt;0 do angY1 = -angY1</span></span>
<span class="line"><span>						if not bit.isNAN angY1 do rotate newTM1 (quat angY1 targetboneTM.row1) </span></span>
<span class="line"><span>						newTM1.pos = tpos</span></span>
<span class="line"><span>						targetboneTM = copy newTM1</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						-- Main spring calculation with gravity</span></span>
<span class="line"><span>						local tvector = normalize targetboneTM.row1</span></span>
<span class="line"><span>						local cvector = normalize (currentPos - tpos + [0, 0, -test_G.value])</span></span>
<span class="line"><span>						local vt = normalize (cross cvector tvector)</span></span>
<span class="line"><span>						local angel = acos(dot (normalize cvector) (normalize tvector))</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						angel *= (1.0-delay)</span></span>
<span class="line"><span>						local sangel = angel </span></span>
<span class="line"><span>						if j == 1 do angel *= scaleMotion.value</span></span>
<span class="line"><span>						local ttm = copy targetboneTM</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						if not bit.isNAN angel do</span></span>
<span class="line"><span>							rotate targetboneTM (quat angel vt)</span></span>
<span class="line"><span>						if j == 1 do </span></span>
<span class="line"><span>							if not bit.isNAN sangel do rotate ttm (quat sangel vt)</span></span>
<span class="line"><span>						targetboneTM.pos = ttm.pos = tpos</span></span>
<span class="line"><span></span></span>
<span class="line"><span>						if L == loopsv and sf == subs.value do </span></span>
<span class="line"><span>						(</span></span>
<span class="line"><span>							animate on at time (t + 1f)</span></span>
<span class="line"><span>							(</span></span>
<span class="line"><span>								if classof simbones[i][j].controller == BipSlave_Control and classof simbones[i][j] != Dummy then</span></span>
<span class="line"><span>									biped.setTransform simbones[i][j] #rotation targetboneTM.rotation true</span></span>
<span class="line"><span>								else if classof simbones[i][j] == CATBone then</span></span>
<span class="line"><span>									simbones[i][j].transform = copy targetboneTM</span></span>
<span class="line"><span>								else </span></span>
<span class="line"><span>									-- Sin旋转叠加 (增强版)</span></span>
<span class="line"><span>									simbones[i][j].rotation.controller.value = (quat test_rotat_x)*(quat test_rotat_y)*(quat test_rotat_z)* (targetboneTM.rotation * inverse currentPTM.rotation)</span></span>
<span class="line"><span>							)</span></span>
<span class="line"><span>						)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>						currentPTM = copy targetboneTM</span></span>
<span class="line"><span>						preTimebone_TM[i][j] = copy targetboneTM</span></span>
<span class="line"><span>						</span></span>
<span class="line"><span>						if j == 1 do </span></span>
<span class="line"><span>							prePos[i] = bone_TM[i][j+1].pos * ttm</span></span>
<span class="line"><span></span></span>
<span class="line"><span>						preTimebone_TM[i][j+1].pos = bone_TM[i][j+1].pos * targetboneTM	</span></span>
<span class="line"><span>					)</span></span>
<span class="line"><span>				)</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>			totalVal += pv</span></span>
<span class="line"><span>			if totalVal &gt;= 20.0 do </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				doit_prog.value += totalVal</span></span>
<span class="line"><span>				totalVal = 0.0</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	doit_prog.value = 100.0</span></span>
<span class="line"><span>	format "调试: 飘带魔法终极计算完成!\n"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 附加工具函数</span></span>
<span class="line"><span>on btn_selectChildren pressed do</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	if selection.count == 0 do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "请先选择一个或多个父对象！"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local currentSelection = selection as array</span></span>
<span class="line"><span>	local allChildrenToSelect = #()</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	for obj in currentSelection do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		join allChildrenToSelect (getAllChildren obj)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	if allChildrenToSelect.count &gt; 0 then</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		select (currentSelection + allChildrenToSelect)</span></span>
<span class="line"><span>		format "调试: 选择了 % 个子对象\n" allChildrenToSelect.count</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	else</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "当前选择的对象没有子级。"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_LoopStart pressed do with undo on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	if selection.count == 0 do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "请先选择骨骼对象！"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local aBState = animButtonState</span></span>
<span class="line"><span>	animButtonState = false</span></span>
<span class="line"><span>	local sortedArr = sortArrayByHeirarchy (selection as array)</span></span>
<span class="line"><span>	boneLoopStart sortedArr</span></span>
<span class="line"><span>	animButtonState = aBState</span></span>
<span class="line"><span>	format "调试: 首尾循环处理完成\n"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_EulerFilter pressed do with undo on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	if selection.count == 0 do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "请先选择骨骼对象！"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local sel = (selection as array)</span></span>
<span class="line"><span>	local processedCount = 0</span></span>
<span class="line"><span>	for i=1 to sel.count where(isKindOf sel[i] GeometryClass or isKindOf sel[i] Helper) do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if sel[i].rotation.controller != undefined then</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			sel[i].Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>			sel[i].Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>			processedCount += 1</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	format "调试: 欧拉过滤应用到 % 个对象\n" processedCount</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_TCB pressed do with undo on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	if selection.count == 0 do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "请先选择骨骼对象！"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local sel = (selection as array)</span></span>
<span class="line"><span>	local processedCount = 0</span></span>
<span class="line"><span>	for i=1 to sel.count where(isKindOf sel[i] GeometryClass or isKindOf sel[i] Helper) do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if sel[i].rotation.controller != undefined then</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			sel[i].Rotation.Controller = TCB_Rotation()</span></span>
<span class="line"><span>			processedCount += 1</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	format "调试: TCB曲线转换应用到 % 个对象\n" processedCount</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_Euler pressed do with undo on</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	if selection.count == 0 do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "请先选择骨骼对象！"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	local sel = (selection as array)</span></span>
<span class="line"><span>	local processedCount = 0</span></span>
<span class="line"><span>	for i=1 to sel.count where(isKindOf sel[i] GeometryClass or isKindOf sel[i] Helper) do</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if sel[i].rotation.controller != undefined then</span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			sel[i].Rotation.Controller = Euler_XYZ()</span></span>
<span class="line"><span>			processedCount += 1</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	format "调试: 欧拉曲线转换应用到 % 个对象\n" processedCount</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_SelectAllBones pressed do</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	local allBones = for b in objects where(classOf b == BoneGeometry and b.isHidden==false) collect b</span></span>
<span class="line"><span>	if allBones.count &gt; 0 then</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		select allBones</span></span>
<span class="line"><span>		format "调试: 选择了 % 个骨骼对象\n" allBones.count</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	else</span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		messageBox "场景中没有找到骨骼对象"</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on pasteRp pressed do </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	for bone in selection do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		local bonetype = classof bone</span></span>
<span class="line"><span>		if superClassOf bone == shape do continue</span></span>
<span class="line"><span>		if bone.parent == undefined do continue</span></span>
<span class="line"><span>		local bones=#()</span></span>
<span class="line"><span>		local num = 1</span></span>
<span class="line"><span>		while bone!=undefined do </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			bones[num] = bone</span></span>
<span class="line"><span>			local childfind = false</span></span>
<span class="line"><span>			if bone.children.count == 0 then exit</span></span>
<span class="line"><span>			else </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				for c in bone.children do</span></span>
<span class="line"><span>					if classof c == bonetype or classof c == Dummy then </span></span>
<span class="line"><span>					(</span></span>
<span class="line"><span>						bone = c</span></span>
<span class="line"><span>						num += 1 </span></span>
<span class="line"><span>						childfind = true</span></span>
<span class="line"><span>						exit</span></span>
<span class="line"><span>					)</span></span>
<span class="line"><span>					else continue</span></span>
<span class="line"><span>				if childfind == false do bone = undefined</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		</span></span>
<span class="line"><span>		for b in bones do </span></span>
<span class="line"><span>			if isProperty b "boneTM" do </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				animate on</span></span>
<span class="line"><span>				(</span></span>
<span class="line"><span>					if classof b == CATBone then </span></span>
<span class="line"><span>					(</span></span>
<span class="line"><span>						b.transform = b.boneTM * b.parent.transform</span></span>
<span class="line"><span>					) </span></span>
<span class="line"><span>					else if classof b == Biped_Object then </span></span>
<span class="line"><span>						biped.setTransform b #rotation (b.boneTM*b.parent.transform).rotation true</span></span>
<span class="line"><span>					else if classof b.controller != BipSlave_Control do </span></span>
<span class="line"><span>						b.rotation.controller.value = b.boneTM.rotation</span></span>
<span class="line"><span>				)</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	format "调试: 骨骼姿态已粘贴\n"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on setRp pressed do </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	for obj in selection do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		local objtype = classof obj</span></span>
<span class="line"><span>		if superClassOf obj != GeometryClass do continue</span></span>
<span class="line"><span>		if obj.parent == undefined do continue</span></span>
<span class="line"><span>		local bones=#()</span></span>
<span class="line"><span>		append bones obj</span></span>
<span class="line"><span>		</span></span>
<span class="line"><span>		while obj != undefined do </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			if keyboard.escPressed then exit</span></span>
<span class="line"><span>			local isfind = false</span></span>
<span class="line"><span>			for c in obj.children do </span></span>
<span class="line"><span>				if classof c == objtype or classof c == Dummy then </span></span>
<span class="line"><span>				(</span></span>
<span class="line"><span>					append bones c</span></span>
<span class="line"><span>					obj = c</span></span>
<span class="line"><span>					isfind = true</span></span>
<span class="line"><span>					exit</span></span>
<span class="line"><span>				)</span></span>
<span class="line"><span>				else continue</span></span>
<span class="line"><span>			if not isfind do obj = undefined</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		for b in bones do</span></span>
<span class="line"><span>			if classof b == objtype do </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				if not isProperty b "boneTM" do </span></span>
<span class="line"><span>					CustAttributes.add b sprboneCA</span></span>
<span class="line"><span>			</span></span>
<span class="line"><span>				b.boneTM = b.transform*(inverse b.parent.transform)</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	format "调试: 骨骼姿态已设置\n"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on stretch pressed do with undo on </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	for bone in selection do </span></span>
<span class="line"><span>	(</span></span>
<span class="line"><span>		if bone.children.count == 0 do continue</span></span>
<span class="line"><span>		bone = bone.children[1]</span></span>
<span class="line"><span>		local bonetype = classof bone</span></span>
<span class="line"><span>		if superClassOf bone == shape do continue</span></span>
<span class="line"><span>		if bone.parent == undefined do continue</span></span>
<span class="line"><span>		local bones=#()</span></span>
<span class="line"><span>		local num = 1</span></span>
<span class="line"><span>		while bone!=undefined do </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			bones[num] = bone</span></span>
<span class="line"><span>			local childfind = false</span></span>
<span class="line"><span>			if bone.children.count == 0 then exit</span></span>
<span class="line"><span>			else </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				for c in bone.children do</span></span>
<span class="line"><span>					if classof c == bonetype or classof c == Dummy then </span></span>
<span class="line"><span>					(</span></span>
<span class="line"><span>						bone = c</span></span>
<span class="line"><span>						num += 1 </span></span>
<span class="line"><span>						childfind = true</span></span>
<span class="line"><span>						exit</span></span>
<span class="line"><span>					)</span></span>
<span class="line"><span>					else continue</span></span>
<span class="line"><span>				if childfind == false do bone = undefined</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>		for b in bones do </span></span>
<span class="line"><span>		(</span></span>
<span class="line"><span>			if bonetype == Biped_Object then </span></span>
<span class="line"><span>				biped.setTransform b #rotation b.parent.transform.rotation true</span></span>
<span class="line"><span>			else </span></span>
<span class="line"><span>			(</span></span>
<span class="line"><span>				local c = copy b.parent.transform</span></span>
<span class="line"><span>				c.pos = b.transform.position</span></span>
<span class="line"><span>				b.transform = c</span></span>
<span class="line"><span>			)</span></span>
<span class="line"><span>		)</span></span>
<span class="line"><span>	)</span></span>
<span class="line"><span>	format "调试: 骨骼已打直\n"</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on btn_reset pressed do </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	reset_control_value()</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-- 控制Sin Wave相关控件的启用状态</span></span>
<span class="line"><span>on chk_enableSinWave changed state do</span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	format "调试: Sin波启用状态: %\n" state</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on springMagic_rol open do </span></span>
<span class="line"><span>(</span></span>
<span class="line"><span>	aframestart.value = animationRange.start.frame</span></span>
<span class="line"><span>	aframeEnd.value = animationRange.end.frame</span></span>
<span class="line"><span>	test_timelenght.value = animationRange.end.frame - animationRange.start.frame </span></span>
<span class="line"><span>	test_timelenght_y.value = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>	test_timelenght_x.value = animationRange.end.frame - animationRange.start.frame</span></span>
<span class="line"><span>	</span></span>
<span class="line"><span>	format "调试: 飘带魔法终极版UI已初始化\n"</span></span>
<span class="line"><span>	format "调试: 动画范围: % 到 %\n" animationRange.start.frame animationRange.end.frame</span></span>
<span class="line"><span>)</span></span></code></pre></div></div></pre><p>)</p><p>createDialog springMagic_rol</p><p>format "========================================\n"<br>
<!-- -->format "飘带魔法工具 V1.11 终极版 已加载!\n"<br>
<!-- -->format "功能特性:\n"<br>
<!-- -->format "- SpringMagic V1.11 核心算法\n"<br>
<!-- -->format "- 天晴 Sin波扰动系统\n"<br>
<!-- -->format "- 多对象支持与时间偏移\n"<br>
<!-- -->format "- 正负轴向强度控制\n"<br>
<!-- -->format "- 附加工具 (欧拉过滤, 循环等)\n"<br>
<!-- -->format "========================================\n"</p></div></div></div></div></div></ol></div></div></div></div></div></div><div class="relative flex flex-col items-center pb-6"><div class="flex w-full flex-col gap-3"><div class="relative order-2 w-full px-4 md:order-1"><div class="bg-surface-primary relative flex flex-col rounded-[0.9rem] md:items-center md:gap-2"><div class="border-border-faint bg-surface-primary relative mx-auto min-h-0 w-full flex-none rounded-[14px] border md:mx-4"><form class="flex w-full flex-col items-start justify-center p-2" data-gtm-form-interact-id="0"><div class="flex w-full flex-col justify-between gap-5 md:gap-2"><input accept="image/png,.png,image/jpeg,.jpg,.jpeg,image/webp,.webp" multiple="" type="file" style="border:0;clip:rect(0, 0, 0, 0);clip-path:inset(50%);height:1px;margin:0 -1px -1px 0;overflow:hidden;padding:0;position:absolute;width:1px;white-space:nowrap" tabindex="-1" class="hidden"><textarea rows="1" class="bg-surface-primary box-border w-full flex-none resize-none focus:outline-none active:outline-none max-h-[40vh] p-1 md:p-3" name="message" autofocus="" autocomplete="off" placeholder="Ask followup…" style="height: 48px !important;" data-gtm-form-interact-field-id="0"></textarea><div class="flex justify-between gap-4"><div class="mr-1 flex h-8 flex-none gap-2"><div class="flex items-center gap-2"><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-interactive-active border border-border-faint bg-transparent active:text-text-tertiary touch-hitbox group/modality-button hover:text-interactive-active relative h-8 w-8 rounded-md p-0 transition-colors duration-150 ease-out active:transition-transform active:duration-75 hover:bg-interactive-normal/10 hover:border-interactive-normal/10" type="button" aria-label="Search" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe size-4"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-interactive-active border border-border-faint bg-transparent active:text-text-tertiary touch-hitbox group/modality-button hover:text-interactive-active relative h-8 w-8 rounded-md p-0 transition-colors duration-150 ease-out active:transition-transform active:duration-75 hover:bg-interactive-normal/10 hover:border-interactive-normal/10" type="button" aria-label="Image" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image size-4"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg></button><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 text-interactive-active border border-border-faint bg-transparent active:text-text-tertiary touch-hitbox group/modality-button hover:text-interactive-active relative h-8 w-8 rounded-md p-0 transition-colors duration-150 ease-out active:transition-transform active:duration-75 hover:bg-interactive-normal/10 hover:border-interactive-normal/10" type="button" aria-label="Code" data-state="closed" data-slot="tooltip-trigger"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code size-4"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg></button></div></div><div class="flex items-center gap-2"><div data-state="closed" data-slot="tooltip-trigger"><button type="button" class="text-interactive-normal hover:text-interactive-active focus-visible:text-interactive-active flex cursor-pointer select-none items-center justify-center transition-colors duration-200 rounded-md p-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="2 2 19 19" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" style="overflow:visible" stroke-linejoin="round"><g stroke="currentColor" transform-origin="12.013019561767578px 14.971955299377441px" style="transform: none; transform-origin: 12.013px 14.972px;"><path d="M11 14h2a2 2 0 1 0 0-4h-3c-.6 0-1.1.2-1.4.6L3 16"></path><path d="m7 20 1.6-1.4c.3-.4.8-.6 1.4-.6h4c1.1 0 2.1-.4 2.8-1.2l4.6-4.4a2 2 0 0 0-2.75-2.91l-4.2 3.9"></path><path d="m2 15 6 6"></path></g><path d="M19.5 8.5c.7-.7 1.5-1.6 1.5-2.7A2.73 2.73 0 0 0 16 4a2.78 2.78 0 0 0-5 1.8c0 1.2.8 2 1.5 2.8L16 12Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="transparent" stroke="currentColor" transform-origin="16.007304191589355px 7.379882335662842px" style="transform: none; transform-origin: 16.0073px 7.37988px;"></path></svg></button></div><button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 h-8 w-8 active:bg-interactive-cta-active opacity-50 pointer-events-none bg-header-primary hover:bg-header-primary/90 text-interactive-on-cta touch-hitbox" type="submit" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up size-4"><path d="m5 12 7-7 7 7"></path><path d="M12 19V5"></path></svg></button></div></div></div><div class="absolute -bottom-5 flex w-full justify-center"><p class="text-text-muted whitespace-nowrap text-[10px]">Inputs are processed by third-party AI and responses may be inaccurate.</p></div></form><div class="absolute z-10 w-full -bottom-2 translate-y-full hidden" inert=""><div class="bg-surface-primary text-text-secondary border-border-faint animate-in fade-in rounded-xl border p-3 opacity-100 shadow-sm transition-all duration-300"><div class="text-xs leading-relaxed"><p>Your conversations and certain other personal information will be disclosed to the relevant AI providers and may otherwise be disclosed publicly to help support our community and advance AI research.</p><p class="mt-3">Do not submit to our Services any personal information or other sensitive information that you would not want to be shared publicly. By continuing to use our Services, you acknowledge and direct us to engage in such sharing.</p></div></div></div></div></div></div></div></div></div></div></main></div></div><!--$--><!--/$--></main></main></main></div></div><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/webpack-af9fb3b534394843.js.下载" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[39443,[],\"\"]\n3:I[15567,[],\"\"]\n6:I[56362,[],\"ClientSegmentRoot\"]\n7:I[51570,[\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"74718\",\"static/chunks/74718-38b11a5bd42f68f4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"64392\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/(fade)/layout-2c9a500082bc7919.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"default\"]\n9:I[33441,[],\"OutletBoundary\"]\nb:I[5103,[],\"AsyncMetadataOutlet\"]\nd:I[33441,[],\"ViewportBoundary\"]\nf:I[33441,[],\"MetadataBoundary\"]\n10:\"$Sreact.suspense\"\n12:I[11985,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"34219\",\"static/chunks/app/global-error-7e08b0d857a5bb33.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"default\"]\n"])</script><script>self.__next_f.push([1,"13:I[15951,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60461\",\"static/chunks/53f5d41f-7da185a24433e906.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"76751\",\"static/chunks/36707d36-e9915b22a5fc3d2e.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60319\",\"static/chunks/60319-b070350a64ccaa9a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"88637\",\"static/chunks/88637-8e47b66ea5fecf8a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"72782\",\"static/chunks/72782-c3e6af85cb32f4c2.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82871\",\"static/chunks/82871-3574e180231e4044.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"52137\",\"static/chunks/52137-cd036403cad2c8b9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"45563\",\"static/chunks/45563-095cd84df4c113b7.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26227\",\"static/chunks/26227-2040ad5da80249e2.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"19374\",\"static/chunks/19374-f9c90c5742d6ad45.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"37066\",\"static/chunks/37066-1c2457b77bca2be7.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"62044\",\"static/chunks/62044-99b27a733dc76899.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5217\",\"static/chunks/5217-c8022b6a42c68a82.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"12781\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/(fade)/c/%5Bid%5D/page-562a33df193ae675.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"Evaluation\",1]\n"])</script><script>self.__next_f.push([1,"14:I[90063,[],\"IconMark\"]\n:HL[\"/_next/static/media/0e96d314a90a6138-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/268f004ea3786b37-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/5d259b4d93dec8ad-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/76fcc95954fbfc88-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/82ebfbcf8e635787-s.p.ttf?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/ttf\"}]\n:HL[\"/_next/static/media/b7ea2ab4a8ad1f81-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/c4b700dcb2187787-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/d7df244fe7b07b95-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/1dafe117bc82612b.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"style\"]\n:HL[\"/_next/static/css/d2bb4bf599873a05.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"style\"]\n:HL[\"/_next/static/css/24003cf8e1219369.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"style\"]\n:HL[\"/_next/static/css/54dc5841a3267dfa.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"Ulq2HthYfIpj0zFRp0b6o\",\"p\":\"\",\"c\":[\"\",\"zh\",\"c\",\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\"],\"i\":false,\"f\":[[[\"\",{\"children\":[[\"locale\",\"zh\",\"d\"],{\"children\":[\"(app)\",{\"children\":[\"(with-sidebar)\",{\"children\":[\"(fade)\",{\"children\":[\"c\",{\"children\":[[\"id\",\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]}]}]},\"$undefined\",\"$undefined\",true]}]}],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"locale\",\"zh\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"(app)\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/1dafe117bc82612b.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/d2bb4bf599873a05.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],\"$L4\"]}],{\"children\":[\"(with-sidebar)\",[\"$\",\"$1\",\"c\",{\"children\":[null,\"$L5\"]}],{\"children\":[\"(fade)\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/24003cf8e1219369.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L6\",null,{\"Component\":\"$7\",\"slots\":{\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]},\"params\":{\"locale\":\"zh\"}}]]}],{\"children\":[\"c\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L8\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/54dc5841a3267dfa.css?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L9\",null,{\"children\":[\"$La\",[\"$\",\"$Lb\",null,{\"promise\":\"$@c\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[[\"$\",\"$Ld\",null,{\"children\":\"$Le\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]],[\"$\",\"$Lf\",null,{\"children\":[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$10\",null,{\"fallback\":null,\"children\":\"$L11\"}]}]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$12\",[]],\"s\":false,\"S\":false}\n"])</script><script>self.__next_f.push([1,"8:[\"$\",\"$L13\",null,{}]\ne:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1, viewport-fit=cover\"}]]\na:null\n"])</script><script>self.__next_f.push([1,"c:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"LMArena | Benchmark \u0026 Compare the Best AI Models\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Chat with multiple AI models side-by-side. Compare ChatGPT, Claude, Gemini, and other top LLMs. Crowdsourced benchmarks and leaderboards.\"}],[\"$\",\"meta\",\"2\",{\"name\":\"creator\",\"content\":\"LMArena | Benchmark \u0026 Compare the Best AI Models\"}],[\"$\",\"meta\",\"3\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"4\",{\"name\":\"googlebot\",\"content\":\"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"LMArena | Benchmark \u0026 Compare the Best AI Models\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Chat with multiple AI models side-by-side. Compare ChatGPT, Claude, Gemini, and other top LLMs. Crowdsourced benchmarks and leaderboards.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:url\",\"content\":\"https://lmarena.ai\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:site_name\",\"content\":\"LMArena | Benchmark \u0026 Compare the Best AI Models\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:locale\",\"content\":\"en_US\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:image\",\"content\":\"https://lmarena.ai/images/og/default.jpg\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:title\",\"content\":\"LMArena | Benchmark \u0026 Compare the Best AI Models\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:description\",\"content\":\"Chat with multiple AI models side-by-side. Compare ChatGPT, Claude, Gemini, and other top LLMs. Crowdsourced benchmarks and leaderboards.\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:image\",\"content\":\"https://lmarena.ai/images/og/default.jpg\"}],[\"$\",\"link\",\"16\",{\"rel\":\"icon\",\"href\":\"/images/favicon-light.ico?v=1\",\"media\":\"(prefers-color-scheme: light)\"}],[\"$\",\"link\",\"17\",{\"rel\":\"icon\",\"href\":\"/images/favicon-dark.ico?v=1\",\"media\":\"(prefers-color-scheme: dark)\"}],[\"$\",\"$L14\",\"18\",{}]],\"error\":null,\"digest\":\"$undefined\"}\n"])</script><script>self.__next_f.push([1,"11:\"$c:metadata\"\n"])</script><script>self.__next_f.push([1,"15:I[82097,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"72782\",\"static/chunks/72782-c3e6af85cb32f4c2.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82871\",\"static/chunks/82871-3574e180231e4044.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"65593\",\"static/chunks/65593-aad87134d3b6abda.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"74718\",\"static/chunks/74718-38b11a5bd42f68f4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"3899\",\"static/chunks/app/%5Blocale%5D/(app)/layout-f0322cab8d6332d9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"ChunkReloadHandler\"]\n"])</script><script>self.__next_f.push([1,"16:I[30652,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"72782\",\"static/chunks/72782-c3e6af85cb32f4c2.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82871\",\"static/chunks/82871-3574e180231e4044.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"65593\",\"static/chunks/65593-aad87134d3b6abda.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"74718\",\"static/chunks/74718-38b11a5bd42f68f4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"3899\",\"static/chunks/app/%5Blocale%5D/(app)/layout-f0322cab8d6332d9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"RootProviders\",1]\n"])</script><script>self.__next_f.push([1,"4:[\"$\",\"html\",null,{\"lang\":\"zh\",\"suppressHydrationWarning\":true,\"className\":\"m-0 h-svh w-full p-0\",\"children\":[\"$\",\"body\",null,{\"className\":\"font-sans __variable_697da2 __variable_3916eb __variable_048822 text-text-primary bg-surface-primary !pointer-events-auto m-0 h-full min-h-svh w-full overflow-x-hidden p-0 antialiased\",\"children\":[[\"$\",\"$L15\",null,{}],false,[\"$\",\"$L16\",null,{\"user\":{\"id\":\"019bb20d-d385-7729-93cc-4fd65a481c5b\",\"supabaseUserId\":\"e81dbec9-7e24-4e26-9237-dedec78b840a\",\"touConsentTimestamp\":\"2026-01-12 12:12:37.813+00\",\"avatarUrl\":null,\"email\":\"\",\"emailProvider\":null,\"username\":null},\"userId\":\"019bb20d-d385-7729-93cc-4fd65a481c5b\",\"userState\":\"anonymous\",\"locale\":\"zh\",\"cookiePreferences\":null,\"ipCountry\":\"US\",\"posthogFlags\":{\"app-banner-enabled\":true,\"code_arena_cta\":true,\"pointwise-feedback-enabled\":true,\"video-modality-enabled\":\"treatment-1\",\"modality-buttons-experiment\":\"control\",\"rebrand\":\"control\",\"in-app-chat-notifications-m1-round-2\":\"treatment-1\",\"p2l-enabled\":\"control\",\"auto-modality-enabled\":\"control\",\"battles-in-direct\":\"control\",\"new-model-selector\":\"control\",\"webdev-voting-buttons\":\"treatment\",\"vote-translations-enabled\":\"treatment-1\",\"model-selector-featured-models\":true,\"file-upload-M1\":\"control\",\"posthog-test-experiment-split\":\"control\"},\"vercelFlags\":{\"isCspReportOnly\":true,\"isWebDevArenaEnabled\":false,\"isAdminDashboardVisible\":true},\"isE2ETest\":false,\"canShowAppBanner\":true,\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$L17\",[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],false]}]}]\n"])</script><script>self.__next_f.push([1,"18:I[38399,[\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"31945\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/(fade)/c/page-4989c6d8f0e5f9c6.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"default\"]\n"])</script><script>self.__next_f.push([1,"19:I[98318,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"18134\",\"static/chunks/18134-7c72418abca8186b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"80490\",\"static/chunks/app/%5Blocale%5D/(static)/not-found-bd98bb6384035e0a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"ThemeProvider\"]\n"])</script><script>self.__next_f.push([1,"1a:Tb50,"])</script><script>self.__next_f.push([1,"M22.68 5.055v-.033a.833.833 0 0 0-.196-.521 1.54 1.54 0 0 0-.27-.253 4.284 4.284 0 0 0-.702-.408c-.558-.268-1.34-.56-2.288-.831C17.33 2.469 14.723 2 11.841 2c-2.881 0-5.49.47-7.386 1.01-.945.27-1.729.563-2.287.831-.276.133-.519.27-.702.408-.09.068-.189.152-.27.253a.841.841 0 0 0-.193.52v.033H1v15.268h.003c0 .267.136.456.242.562.105.105.225.174.324.223.201.1.457.178.73.243.558.133 1.338.248 2.27.342 1.872.19 4.444.306 7.274.306s5.4-.116 7.273-.306c.932-.094 1.712-.21 2.27-.342.273-.066.529-.143.73-.243.1-.049.22-.12.324-.223a.795.795 0 0 0 .243-.562h.002V5.055h-.005ZM12.55 14.46v-1.743c0-.561.202-1.113.601-1.507.354-.35.822-.563 1.335-.563.655 0 1.235.345 1.6.88.248.364.366.804.366 1.247v1.573a83.603 83.603 0 0 1-3.904.116l.002-.003Zm0-5.743c0-.561.202-1.113.601-1.507.354-.35.822-.563 1.335-.563.655 0 1.235.345 1.6.88.248.364.366.804.366 1.247v.412a83.628 83.628 0 0 1-3.904.116v-.582l.002-.003Zm8.529 5.102c-.473.119-1.184.232-2.096.33-.383.04-.797.078-1.24.111v-1.91c0-.655.29-1.288.817-1.677.31-.227.675-.364 1.057-.364.202 0 .398.034.582.097.726.248 1.195.959 1.195 1.727v1.593c-.078.027-.181.06-.314.093h-.001Zm-3.336-5.312c0-.61.243-1.204.704-1.603.323-.28.72-.451 1.136-.451.479 0 .915.198 1.245.525.375.37.564.888.564 1.414v.173c-.077.027-.18.06-.313.093-.473.118-1.184.232-2.096.329-.383.041-.797.079-1.24.112v-.592ZM4.193 6.465c.744 0 1.386.345 1.699.96.122.24.174.51.174.781v.901a44.79 44.79 0 0 1-1.367-.121c-.912-.097-1.623-.21-2.095-.33a3.734 3.734 0 0 1-.314-.09c.007-1.16.856-2.1 1.902-2.1l.002-.001Zm3.163 7.886v-1.577c0-.398.093-.796.298-1.138.358-.596.972-.99 1.67-.99.512 0 .98.212 1.332.56.4.393.602.944.602 1.505v1.75a84.414 84.414 0 0 1-3.903-.11h.001Zm3.903-5.052a84.423 84.423 0 0 1-3.903-.11v-.415c0-.399.093-.796.298-1.138.358-.596.972-.99 1.67-.99.512 0 .98.212 1.332.56.4.393.602.944.602 1.505v.588h.001Zm-8.966 3.026c0-1.113.852-2.017 1.903-2.017.382 0 .746.136 1.054.363.528.387.817 1.02.817 1.674v1.925c-.49-.037-.947-.078-1.366-.122-.913-.096-1.624-.21-2.096-.329a3.288 3.288 0 0 1-.313-.093l.002-1.4h-.001Zm-.003 7.998v-.052a.655.655 0 0 1 .003.052H2.29Zm.003-2.707c0-1.114.852-2.017 1.903-2.017.382 0 .746.135 1.054.362.528.387.817 1.02.817 1.674v2.891c-.49-.034-.948-.073-1.368-.116-.912-.093-1.625-.2-2.099-.313a4.498 4.498 0 0 1-.308-.085l.002-2.395-.001-.002Zm5.063 2.988v-2.67c0-.399.093-.796.298-1.138.358-.596.972-.99 1.67-.99.512 0 .98.212 1.332.56.4.393.602.944.602 1.505v2.837a88.799 88.799 0 0 1-3.903-.104h.001Zm5.194.103v-2.836c0-.56.202-1.112.602-1.506.354-.347.82-.558 1.332-.558.7 0 1.313.393 1.67.99.206.341.299.738.299 1.137v2.662a87.72 87.72 0 0 1-3.903.11v.001Zm8.842-.384h-.002c0-.018 0-.035.002-.052v.052Zm-.308-.226c-.474.113-1.187.222-2.1.313-.383.039-.798.075-1.24.107V17.64c0-.654.288-1.288.816-1.676.31-.227.675-.364 1.057-.364.202 0 .398.033.582.096.726.248 1.195.96 1.195 1.727v2.588c-.078.026-.18.054-.309.085l-.001.002Z"])</script><script>self.__next_f.push([1,"17:[\"$\",\"$L18\",null,{\"formats\":{\"dateTime\":{\"short\":{\"day\":\"numeric\",\"month\":\"short\",\"year\":\"numeric\"}},\"number\":{\"precise\":{\"maximumFractionDigits\":5}},\"list\":{\"enumeration\":{\"style\":\"long\",\"type\":\"conjunction\"}}},\"locale\":\"en\",\"messages\":{\"HomePage\":{\"title\":\"Current User\"}},\"now\":\"$undefined\",\"timeZone\":\"UTC\",\"children\":[\"$\",\"$L19\",null,{\"attribute\":\"class\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"div\",null,{\"className\":\"flex h-full w-full flex-col\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex min-h-0 flex-1 flex-col items-center justify-center p-4\",\"children\":[[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"viewBox\":\"0 0 24 24\",\"width\":48,\"height\":48,\"fill\":\"none\",\"children\":[\"$\",\"path\",null,{\"fill\":\"currentColor\",\"d\":\"$1a\"}]}],\"$L1b\",\"$L1c\",\"$L1d\"]}]}]}]}]\n"])</script><script>self.__next_f.push([1,"1e:I[12002,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"18134\",\"static/chunks/18134-7c72418abca8186b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"80490\",\"static/chunks/app/%5Blocale%5D/(static)/not-found-bd98bb6384035e0a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"Link\"]\n"])</script><script>self.__next_f.push([1,"1b:[\"$\",\"p\",null,{\"className\":\"font-mono text-[96px] font-normal\",\"children\":\"404\"}]\n1c:[\"$\",\"p\",null,{\"className\":\"text-text-secondary text-center text-lg font-normal\",\"children\":\"Sorry, we cannot find the page you are looking for.\"}]\n"])</script><script>self.__next_f.push([1,"1d:[\"$\",\"div\",null,{\"className\":\"mt-6 flex flex-row gap-2 md:gap-4\",\"children\":[[\"$\",\"$L1e\",null,{\"href\":\"/\",\"children\":[[\"$\",\"svg\",null,{\"ref\":\"$undefined\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":16,\"height\":16,\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":2,\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"lucide lucide-message-circle\",\"children\":[[\"$\",\"path\",\"vv11sd\",{\"d\":\"M7.9 20A9 9 0 1 0 4 16.1L2 22Z\"}],\"$undefined\"]}],\" Start New Chat\"],\"ref\":null,\"className\":\"inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [\u0026_svg]:pointer-events-none [\u0026_svg]:shrink-0 px-4 py-3 text-sm font-medium text-interactive-active border border-border-faint bg-transparent hover:text-interactive-normal hover:bg-surface-secondary active:text-text-tertiary gap-2\",\"disabled\":\"$undefined\",\"type\":\"button\"}],[\"$\",\"$L1e\",null,{\"href\":\"/leaderboard\",\"children\":[[\"$\",\"svg\",null,{\"ref\":\"$undefined\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":16,\"height\":16,\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":2,\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"lucide lucide-trophy\",\"children\":[[\"$\",\"path\",\"17hqa7\",{\"d\":\"M6 9H4.5a2.5 2.5 0 0 1 0-5H6\"}],[\"$\",\"path\",\"lmptdp\",{\"d\":\"M18 9h1.5a2.5 2.5 0 0 0 0-5H18\"}],[\"$\",\"path\",\"57wxv0\",{\"d\":\"M4 22h16\"}],[\"$\",\"path\",\"1nw9bq\",{\"d\":\"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22\"}],[\"$\",\"path\",\"1np0yb\",{\"d\":\"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22\"}],[\"$\",\"path\",\"u46fv3\",{\"d\":\"M18 2H6v7a6 6 0 0 0 12 0V2Z\"}],\"$undefined\"]}],\" View Leaderboard\"],\"ref\":null,\"className\":\"inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring ring-offset-2 focus-visible:ring-offset-surface-primary disabled:pointer-events-none disabled:opacity-50 [\u0026_svg]:pointer-events-none [\u0026_svg]:shrink-0 px-4 py-3 text-sm font-medium text-interactive-active border border-border-faint bg-transparent hover:text-interactive-normal hover:bg-surface-secondary active:text-text-tertiary gap-2\",\"disabled\":\"$undefined\",\"type\":\"button\"}]]}]\n"])</script><script>self.__next_f.push([1,"1f:I[79056,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"EvaluationStoreProvider\"]\n"])</script><script>self.__next_f.push([1,"20:Tc67f,"])</script><script>self.__next_f.push([1,"/* \n    Sin Wind Spring Generator V5.5 (Root Parent Fix)\n    - Fix: Solves \"transform in undefined\" crash when Root Bone has no parent.\n    - Feature: Stitches Frame 0 for perfect loops.\n*/\n\ntry(destroyDialog rol_SinWindSpring)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nstruct BoneInitData\n(\n    obj,\n    relativeTM,\n    boneName,\n    hasParent\n)\n\nrollout rol_SinWindSpring \"Sin + Spring 风力生成器 V5.5 Stable\" width:540\n(\n    -- === UI 布局 ===\n    group \"1. 风向控制\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:240 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:240 align:#right height:30 autoDisplay:true\n        label lbl_info \"提示: 旋转Y轴(绿轴)改变风向\" style_sunken:true align:#center\n    )\n    \n    group \"2. 姿态与形态\"\n    (\n        button btn_setPose \"★ 设定参考姿态 (Set)\" width:160 align:#left across:3 height:25 toolTip:\"将当前骨骼形状存为弹簧的目标形态\"\n        button btn_pastePose \"粘贴姿态 (Paste)\" width:160 align:#center height:25 toolTip:\"复位到参考姿态\"\n        button btn_straighten \"拉直骨骼 (Straight)\" width:160 align:#right height:25 toolTip:\"拉直骨骼链\"\n        label lbl_poseInfo \"重要: 开启循环时，请务必先摆好Pose并点击[设定参考姿态]\" style_sunken:true align:#center color:green\n    )\n    \n    group \"3. Sin风力参数 (第一根骨骼)\"\n    (\n        spinner spn_baseWind \"基础风压 (度)\" range:[0.0, 90.0, 20.0] type:#float align:#left across:2\n        spinner spn_swingAmp \"Sin摆动幅度 (度)\" range:[0.0, 30.0, 5.0] type:#float\n        \n        spinner spn_period \"摆动周期 (帧)\" range:[1, 200, 30] type:#integer align:#left across:2\n        spinner spn_turbulence \"扰动强度 (度)\" range:[0.0, 30.0, 2.0] type:#float\n        \n        spinner spn_turbFreq \"扰动频率\" range:[0.1, 20.0, 0.5] scale:0.01 type:#float align:#left across:2\n        label lbl_dummy1 \"\" \n    )\n    \n    group \"4. Spring弹簧参数 (后续骨骼)\"\n    (\n        spinner spn_springDelay \"Spring延迟\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:2 \\\n                toolTip:\"越小越硬，越大越软\"\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 \\\n                toolTip:\"X轴抗扭强度\"\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 3] type:#integer align:#left across:2 \\\n                toolTip:\"计算精度\"\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.5, 3.0, 1.5] scale:0.1 \\\n                toolTip:\"根骨骼运动幅度倍率\"\n    )\n    \n    group \"5. 角度限制\"\n    (\n        spinner spn_maxAngle \"最大角度 (度)\" range:[10.0, 180.0, 80.0] type:#float align:#left across:2\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01\n    )\n    \n    group \"6. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环 (Loop)\" checked:true align:#left across:2 toolTip:\"开启后第0帧将自动缝合，无缝衔接。\"\n        label lbl_empty \"\"\n        \n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer align:#left across:2 width:100\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:100\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:520\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:520 height:40 highlightColor:green\n\n    -- === 辅助函数 ===\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:5.0 animatable:true ui:spn_swing\n                    turbAmt type:#float default:2.0 animatable:true ui:spn_turb\n                    activation type:#float default:1.0 animatable:true ui:spn_activation\n                )\n                rollout rlt \"风力参数(可K帧)\" (\n                    group \"核心参数\" (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                        spinner spn_base \"基础风压:\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"摆动幅度:\" range:[0,30,5.0] type:#float\n                        spinner spn_turb \"扰动强度:\" range:[0,30,2.0] type:#float\n                    )\n                    group \"激活控制\" (\n                        spinner spn_activation \"激活:\" range:[0,1,1.0] type:#float scale:0.01\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_root_wind absTime baseWind swingAmp turbAmount period turbFreq =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        \n        local noisePos = [absTime * turbFreq * 0.1, 0, 0]\n        local noiseValue = noise3 noisePos\n        \n        return baseWind + swingComponent + (noiseValue * turbAmount)\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 do up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn getBoneChains roots = \n    (\n        local chains = #()\n        for r in roots do (\n            if (findItem roots r.parent) == 0 do (\n                local chain = #()\n                local curr = r\n                append chain curr\n                while curr.children.count \u003e 0 do (\n                    curr = curr.children[1] \n                    append chain curr\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n\n    -- === 姿态控制函数 (修复根骨骼无父级崩溃) ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                 if not isProperty b \"boneTM\" do CustAttributes.add b sprboneCA\n                 \n                 -- [修复] 检查父物体是否存在\n                 if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                 else\n                    b.boneTM = b.transform -- 如果没有父物体，直接存世界矩阵\n                 \n                 count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" do \n                    (\n                        try (\n                            -- [修复] 检查父物体\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then bn.transform = targetTM\n                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        ctrl.baseForce = spn_baseWind.value\n        ctrl.swingAmp = spn_swingAmp.value\n        ctrl.turbAmt = spn_turbulence.value\n        pck_ctrl.object = ctrl\n        select ctrl\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring\" on\n    (\n        clearListener()\n        if selection.count == 0 do (messageBox \"请选择骨骼根部\"; return false)\n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj do (messageBox \"请先拾取风向控制器\"; return false)\n        \n        local chains = getBoneChains (selection as array)\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local turbFreq = spn_turbFreq.value \n        local period = spn_period.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        \n        format \"初始化模拟状态 (基于帧 % )...\\n\" startF\n        \n        -- === 初始化数据 (带父物体检查) ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        -- [修复] 根骨骼无父物体时的崩溃修复\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform -- 如果无父级，认为是世界坐标\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                )\n                \n                if chain.count \u003e 1 then\n                (\n                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]\n                    append boneRelTMs lastRelTM \n                    local endWorldTM = lastRelTM * chain[chain.count].transform\n                    append simTMs endWorldTM\n                )\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    local endTM = matrix3 1\n                    endTM.pos = [bbox[2].x, 0, 0]\n                    append boneRelTMs endTM\n                    local endWorldTM = endTM * chain[1].transform\n                    append simTMs endWorldTM\n                )\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)\n                )\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n            )\n        )\n        \n        format \"开始模拟 (循环次数: % )...\\n\" loopsCount\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- [缝合逻辑] 将预热结束的状态强制写入第0帧\n            if isWritePass and chk_loops.checked do\n            (\n                format \"\u003e\u003e Loop 2: 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local turbAmount = at time t ctrlObj.turbAmt\n                local activation = at time t ctrlObj.activation\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        \n                        -- [修复] 主循环中对父物体的检查\n                        local currentPTM \n                        if chain[1].parent != undefined then\n                            currentPTM = at time currTime chain[1].parent.transform\n                        else\n                            currentPTM = matrix3 1 -- 如果没有父物体，假设世界原点\n                        \n                        for j = 1 to chain.count do\n                        (\n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos\n                            local tpos = targetBoneTM.pos\n                            \n                            -- Twist X\n                            local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                            if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                            local angX = acos(dot1)\n                            \n                            local newTM1 = copy simTMs[j]\n                            local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                            if angX \u003e 0.001 do rotate newTM1 (quat angX -vt1)\n                            newTM1.pos = tpos\n                            \n                            -- Spring Y/Z\n                            local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                            if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                            local angY1 = acos(dot2)\n                            \n                            local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                            local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))\n                            angY1 = angY1 * xAxisDelay\n                            \n                            if dot ssvt targetBoneTM.row1 \u003e 0 do angY1 = -angY1\n                            if abs angY1 \u003e 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)\n                            newTM1.pos = tpos\n                            targetBoneTM = copy newTM1\n                            \n                            -- Main Bend\n                            local tvector = normalize targetBoneTM.row1\n                            local cvector = normalize (currentPos - tpos)\n                            local vt = normalize (cross cvector tvector)\n                            \n                            local dot3 = dot cvector tvector\n                            if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                            local angle = acos(dot3)\n                            \n                            angle *= (1.0 - delay)\n                            local sangle = angle\n                            \n                            -- Root Sin Wind\n                            if j == 1 do\n                            (\n                                local windAngle = calculate_root_wind currTime baseWind swingAmp turbAmount period turbFreq\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * activation\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                angle *= scaleMotion\n                            )\n                            \n                            angle = applySoftLimit angle maxAngle softness\n                            sangle = applySoftLimit sangle maxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs angle \u003e 0.001 do rotate targetBoneTM (quat angle vt)\n                            if j == 1 and abs sangle \u003e 0.001 do rotate ttm (quat sangle vt)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- === 写入关键帧 (t+1) ===\n                            if isWritePass and sf == subs do\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try (\n                                        if classof chain[j] == CATBone then\n                                            chain[j].transform = copy targetBoneTM\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                            biped.setTransform chain[j] #rotation targetBoneTM.rotation true\n                                        else \n                                            -- [修复] 写入时的父物体检查\n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = targetBoneTM.rotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = targetBoneTM.rotation\n                                    ) catch ()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j \u003c chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        print \"生成完毕！\" \n\t\t\n    )\n)\n\ncreateDialog rol_SinWindSpring\n\n这个脚本他子采样应该启动的时候默认为1才对，根骨骼缩放为1才对，然后这个脚本可操作性比较少啊，我有另一个spring脚本，他虽然没有控制风的方向，但是他可以单独控制每根骨骼的sin摆动，还有混合的力度，相对来说是一个很不错的局部控制的方式，我在想，如果我没有激活控制的时候，是不是应该可以切换到局部控制每个骨骼的轴向的混合会更方便，所以我希望你能帮我添加结合，大家核心算法都是spring算法，只是sin有一点不同，我平常只有两个用法，要么sin开为1，直接算完第一根后，关闭sin，重新计算一次spring来达到变成自然飘动的效果，要么，直接sin的力度改成0.5，让他们混合，来达到，平滑的进入sin的效果，当然，这个问题再这边已经解决了，我这是希望可以单独控制一下，可以调整的参数更多，我希望你能帮我结合一下，下面是另一个脚本\n\n--------------------------Ver.  1.11 Ultimate    Author : Si-Chung Yuan 2017.9 + Advanced Features --------------------------------------------------------------\n\n-- 先关闭已存在的对话框\nif springMagic_rol != undefined do destroyDialog springMagic_rol\n\n-- 自定义属性定义\nvposCA = attributes vipos\n(\n\tparameters main \n\t(\n\t \tvpos type:#point3Tab tabSizeVariable:true animatable:false\n\t)\t\n)\n\nsprboneCA = attributes sprbTM\n(\n\tparameters main\n\t(\n\t\tboneTM type:#matrix3\n\t)\t\n)\n\n-- 全局变量定义\nframestart = undefined\nframeEnd = undefined\nsimbones = #()\nbone_TM = #()\npreTimebone_TM = #()\nprePos = #()\nbcnt = #()\n\nrollout springMagic_rol \"飘带魔法工具 V1.11 终极版\" width:500\n(\n\t-- 基础弹簧参数组\n\tgroup \"基础弹簧参数\"\n\t(\n\t\tspinner delaysp \"弹簧硬度\" type:#float scale:0.01 range:[0.01,1,0.3] align:#left across:3\n\t\tspinner scaleMotion \"运动缩放\" type:#float scale:0.01 range:[0,999,1]\n\t\tspinner test_G \"重力.Z\" type:#float range:[-990.0,999,0] align:#right\n\t\t\n\t\tspinner subs \"子步数\" type:#integer range:[1,30,1] align:#left across:3\n\t\tspinner upspring \"X弹簧\" type:#float scale:0.01 range:[0.1,1,0.3]\n\t\tspinner bnum \"骨骼数量\" type:#integer range:[0,1000,50] align:#right\n\t\t\n\t\tcheckBox loops \"循环计算\" align:#left\n\t)\n\t\n\t-- 多对象偏移控制\n\tgroup \"多对象控制\"\n\t(\n\t\tspinner spn_frameOffset \"动画帧偏移\" type:#integer range:[0,50,0] align:#left across:2\n\t\tspinner spn_perBoneOffset \"每对象差异帧\" type:#integer range:[0,20,2] toolTip:\"用于错开多个对象动画时间\" align:#right\n\t)\n\t\n\t-- 根部位置权重\n\tgroup \"根部位置权重\"\n\t(\n\t\tspinner test_blend_x \"X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3\n\t\tspinner test_blend_y \"Y权重\" type:#float range:[0.0,1.0,1] scale:0.01\n\t\tspinner test_blend_z \"Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#right\n\t)\n\t\n\t-- Sin扰动控制面板 (增强版)\n\tgroup \"Sin波扰动控制 (增强版)\"\n\t(\n\t\tcheckBox chk_enableSinWave \"启用Sin波\" checked:false align:#left\n\t\t\n\t\t-- X轴控制 (增强版 - 正负值强度)\n\t\tlabel lbl_x \"X轴控制 (扭转)\" align:#left\n\t\tspinner test_rota_x \"X开关\" type:#float range:[0.0,1.0,0] scale:0.01 toolTip:\"X轴开关\" align:#left across:4\n\t\tspinner test_max_rota_x \"X旋转量\" range:[-990.0,999,5] toolTip:\"X旋转量\"\n\t\tspinner spn_xPos \"X+强度\" type:#float range:[0.1,5,1] toolTip:\"正向强度比例\"\n\t\tspinner spn_xNeg \"X-强度\" type:#float range:[0.1,5,1] toolTip:\"负向强度比例\"\n\t\t\n\t\tspinner test_offsettime_x \"X时间延迟\" range:[-999,999,4] type:#integer align:#left across:3\n\t\tspinner test_max2_rota_x \"X递增量\" range:[-999,999,5] toolTip:\"X递增量\"\n\t\tspinner test_timelenght_x \"X周期长度\" range:[5,999,40] type:#integer toolTip:\"X循环长度\"\n\t\t\n\t\t-- Y轴控制 (增强版 - 正负值强度)\n\t\tlabel lbl_y \"Y轴控制 (左右摆动)\" align:#left\n\t\tspinner test_rota_y \"Y开关\" type:#float range:[0.0,1.0,0] scale:0.01 toolTip:\"Y轴开关\" align:#left across:4\n\t\tspinner test_max_rota_y \"Y旋转量\" range:[-990.0,999,5] toolTip:\"Y旋转量\"\n\t\tspinner spn_yPos \"Y+强度\" type:#float range:[0.1,5,1] toolTip:\"正向强度比例\"\n\t\tspinner spn_yNeg \"Y-强度\" type:#float range:[0.1,5,1] toolTip:\"负向强度比例\"\n\t\t\n\t\tspinner test_offsettime_y \"Y时间延迟\" range:[-999,999,4] type:#integer align:#left across:3\n\t\tspinner test_max2_rota_y \"Y递增量\" range:[-999,999,5] toolTip:\"Y递增量\"\n\t\tspinner test_timelenght_y \"Y周期长度\" range:[5,999,40] type:#integer toolTip:\"Y循环长度\"\n\t\t\n\t\t-- Z轴控制 (增强版 - 正负值强度)\n\t\tlabel lbl_z \"Z轴控制 (前后摆动)\" align:#left\n\t\tspinner test_rota_z \"Z开关\" type:#float range:[0.0,1.0,0] scale:0.01 toolTip:\"Z轴开关\" align:#left across:4\n\t\tspinner test_max_rota \"Z旋转量\" range:[-990.0,999,5] toolTip:\"Z旋转量\"\n\t\tspinner spn_zPos \"Z+强度\" type:#float range:[0.1,5,1] toolTip:\"正向强度比例\"\n\t\tspinner spn_zNeg \"Z-强度\" type:#float range:[0.1,5,1] toolTip:\"负向强度比例\"\n\t\t\n\t\tspinner test_offsettime \"Z时间延迟\" range:[-990,999,4] type:#integer align:#left across:3\n\t\tspinner test_max2_rota \"Z递增量\" range:[-999,999,5] toolTip:\"Z递增量\"\n\t\tspinner test_timelenght \"Z周期长度\" range:[5,999,40] type:#integer toolTip:\"Z循环长度\"\n\t)\n\n\t-- 骨骼姿态工具\n\tgroup \"骨骼姿态工具\"\n\t(\n\t\tbutton pasteRp \"粘贴姿态\" toolTip:\"选择首节骨骼\" align:#left across:4\n\t\tbutton setRp \"设置姿态\" toolTip:\"设置初始姿态\"\n\t\tbutton stretch \"打直骨骼\" toolTip:\"打直选择骨骼\"\n\t\tbutton btn_reset \"重置参数\" toolTip:\"重置UI数值\" align:#right\n\t)\n\t\n\t-- 关键帧范围\n\tgroup \"关键帧范围\"\n\t(\n\t\tradiobuttons a1 labels:#(\"活动范围\", \"自定义\") align:#left across:3\n\t\tspinner aframeStart \"起始帧\" type:#integer range:[-10000,100000,1]\n\t\tspinner aframeEnd \"结束帧\" type:#integer range:[0,100000,10] align:#right\n\t)\n\n\t-- 应用按钮\n\tgroup \"执行计算\"\n\t(\n\t\tbutton applybone \"烘焙动画\" toolTip:\"选择首节骨骼开始计算\" align:#left across:2\n\t\tprogressBar doit_prog \"进度\" color:red align:#right\n\t)\n\t\n\t-- 附加工具面板\n\tgroup \"附加工具\"\n\t(\n\t\tbutton btn_selectChildren \"选择所有子级\" toolTip:\"选择所有子对象\" align:#left across:6\n\t\tbutton btn_LoopStart \"首尾循环\" toolTip:\"首尾循环处理\"\n\t\tbutton btn_EulerFilter \"欧拉过滤\" toolTip:\"欧拉过滤\"\n\t\tbutton btn_TCB \"转TCB曲线\" toolTip:\"转换为TCB曲线\"\n\t\tbutton btn_Euler \"转欧拉曲线\" toolTip:\"转换为欧拉曲线\"\n\t\tbutton btn_SelectAllBones \"选择所有骨骼\" toolTip:\"选择场景中所有骨骼\" align:#right\n\t)\n\t\n\tlabel lab_aut \"作者: Si-Chung Yuan + 终极增强版\" align:#left\n\t\n\t-- 递归获取所有子对象的函数\n\tfn getAllChildren obj =\n\t(\n\t\tlocal childrenArray = #()\n\t\tfor c in obj.children do\n\t\t(\n\t\t\tappend childrenArray c\n\t\t\tjoin childrenArray (getAllChildren c)\n\t\t)\n\t\treturn childrenArray\n\t)\n\t\n\t-- 排序数组函数\n\tfn sortArrayByHeirarchy objectArray =\n\t( \n\t\tlocal sortedArray = #()\n\t\tlocal listArray = #()\n\t\tlocal parentArray = #()\n\t\tlocal childArray = #()\n\t\t\n\t\tfor obj in objectArray do\n\t\t(\n\t\t\tif (finditem objectArray obj.parent) == 0 \n\t\t\tthen append parentArray obj\n\t\t\telse append childArray obj  \n\t\t)\n\t\twhile childArray.count \u003e 0 do\n\t\t(\n\t\t\tlocal i=1\n\t\t\twhile i \u003c= childArray.count do\n\t\t\t(\n\t\t\t\tlocal parentIdx = finditem parentArray childArray[i].parent\n\t\t\t\tif parentIdx != 0 then\n\t\t\t\t(\n\t\t\t\t\tinsertItem childArray[i] parentArray (parentIdx+1) \n\t\t\t\t\tdeleteItem childArray i\n\t\t\t\t) \n\t\t\t\telse(i += 1)\n\t\t\t)\n\t\t)\n\t\t\n\t\tlocal a = 1\n\t\t\n\t\tfor l=1 to parentArray.count do\n\t\t(\n\t\t\tif (finditem parentArray (parentArray[l].children)[1]) != 0 then\n\t\t\t(\n\t\t\t\tappend listArray parentArray[l]\n\t\t\t) \n\t\t\telse\n\t\t\t(\n\t\t\t\tappend listArray parentArray[l]\n\t\t\t\tsortedArray[a] = listArray\n\t\t\t\tlistArray = #()\n\t\t\t\ta += 1\n\t\t\t)\n\t\t)\n\t\tsortedArray\n\t)\n\n\t-- 首尾循环函数\n\tfn BoneLoopStart objectArray=\n\t(\n\t\tlocal firstbonerot = #()\n\t\tlocal lastbonerot = #()\n\t\tlocal bonesub = #()\n\t\tlocal bonelistsub = #()\n\t\t\n\t\tlocal startFrame=(animationrange.start as string) as integer\n\t\tlocal endFrame=(animationrange.end as string) as integer\n\t\tlocal cycleFrame=30\n\t\tif (endFrame-startframe)\u003c30 then cycleFrame=(endFrame-startframe)\n\t\t\n\t\tfor i = 1 to objectArray.count do\n\t\t(\n\t\t\tslidertime=animationrange.start\n\t\t\tfor j = 1 to objectArray[i].count do\n\t\t\t(\n\t\t\t\tappend firstbonerot objectArray[i][j].transform.rotation\n\t\t\t)\n\t\t\tslidertime=animationrange.end\n\t\t\tfor j = 1 to objectArray[i].count do\n\t\t\t(\n\t\t\t\tappend lastbonerot objectArray[i][j].transform.rotation\n\t\t\t)\n\t\t\tfor j = 1 to objectArray[i].count do\n\t\t\t(\n\t\t\tappend bonesub (quattoeuler (firstbonerot[j]-lastbonerot[j]))\n\t\t\t)\n\t\t\tappend bonelistsub bonesub\n\t\t\tfirstbonerot = #()\n\t\t\tlastbonerot = #()\n\t\t\tbonesub = #()\n\t\t)\t\n\t\tset animate on\n\t\tfor f = 0 to cycleframe do\n\t\t(\n\t\t\tslidertime = endFrame - f;\n\t\t\tlocal per=(float)(cycleFrame-f)/cycleFrame\n\t\t\t\n\t\t\tfor a = 1 to objectArray.count do\n\t\t\t(\n\t\t\t\tfor b = 1 to objectArray[a].count do\n\t\t\t\t(\n\t\t\t\t\tlocal r = bonelistsub[a][b];\n\t\t\t\t\tif b \u003e 1 then(r=quattoeuler  (bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat))\n\t\t\t\t\tlocal rot = (eulerangles (r.x*per) (r.y*per) (r.z*per))\n\t\t\t\t\trotate objectArray[a][b] rot\n\t\t\t\t)\n\t\t\t)\n\t\t)\n\t\tset animate off\n\t\tslidertime=startframe\n\t)\n\t\n\tfn setStartEndFrame = \n\t(\n\t\tif a1.state == 1 then \n\t\t(\n\t\t\tframestart = animationRange.start-1f\n\t\t\tframeEnd = animationRange.end-1f\n\t\t) \n\t\telse \n\t\t(\n\t\t\tframestart = aframeStart.value-1f as time\n\t\t\tframeEnd = aframeEnd.value-1f as time\n\t\t)\n\t)\n\t\n\tfn reset_control_value =\n\t(\n\t\tlocal timelenght = animationRange.end.frame - animationRange.start.frame \n\t\t\n\t\tdelaysp.value = 0.3\n\t\tscaleMotion.value = 1.0\n\t\tsubs.value = 1\n\t\tupspring.value = 0.3\n\t\tbnum.value = 50\n\t\tloops.checked = false\n\t\ttest_G.value = 0.0\n\t\t\n\t\tspn_frameOffset.value = 0\n\t\tspn_perBoneOffset.value = 2\n\t\t\n\t\ttest_blend_x.value = 1.0\n\t\ttest_blend_y.value = 1.0\n\t\ttest_blend_z.value = 1.0\n\t\t\n\t\tchk_enableSinWave.checked = false\n\t\ttest_rota_x.value = 0\n\t\ttest_rota_y.value = 0\n\t\ttest_rota_z.value = 0\n\t\ttest_max_rota_x.value = 5.0\n\t\ttest_max_rota_y.value = 5.0\n\t\ttest_max_rota.value = 5.0\n\t\t\n\t\tspn_xPos.value = 1.0\n\t\tspn_xNeg.value = 1.0\n\t\tspn_yPos.value = 1.0\n\t\tspn_yNeg.value = 1.0\n\t\tspn_zPos.value = 1.0\n\t\tspn_zNeg.value = 1.0\n\t\t\n\t\ttest_offsettime_x.value = 4\n\t\ttest_offsettime_y.value = 4\n\t\ttest_offsettime.value = 4\n\t\ttest_max2_rota_x.value = 5\n\t\ttest_max2_rota_y.value = 5\n\t\ttest_max2_rota.value = 5\n\t\ttest_timelenght_x.value = timelenght\n\t\ttest_timelenght_y.value = timelenght\n\t\ttest_timelenght.value = timelenght\n\t\t\n\t\tformat \"调试: 参数已重置为默认值\\n\"\n\t)\n\n\tfn getBoneChain bone = \n\t(\n\t\tlocal bonechain = #()\n\t\tlocal bonetype = classof bone\n\t\tlocal num = 1\n\t\t\n\t\tif bone.parent == undefined do \n\t\t( \n\t\t\tmessageBox (((bone.name as string)+\"必须有父级节点!\"))\n\t\t\tcontinue\n\t\t)\n\n\t\tlocal parnode = bone.parent\n\t\t\n\t\twhile bone!=undefined do \n\t\t(\n\t\t\tbonechain[num] = bone\n\t\t\tlocal childfind = false\n\t\t\tif bone.children.count == 0 or num\u003ebnum.value then exit\n\t\t\telse \n\t\t\t(\n\t\t\t\tfor c in bone.children do\n\t\t\t\t\tif classof c == bonetype or classof c == Dummy then \n\t\t\t\t\t(\n\t\t\t\t\t\tbone = c\n\t\t\t\t\t\tnum += 1 \n\t\t\t\t\t\tchildfind = true\n\t\t\t\t\t\texit\n\t\t\t\t\t)\n\t\t\t\t\telse continue\n\t\t\t\tif childfind == false do bone = undefined\n\t\t\t)\n\t\t)\n\t\t\n\t\tappend simBones bonechain\n\t\tformat \"调试: 收集到骨骼链，包含 % 根骨骼\\n\" bonechain.count\n\n\t\tlocal pTM = parnode.transform\n\t\tlocal preTM = #()\n\t\tlocal bTM = #()\n\n\t\tfor j in 1 to bonechain.count do \n\t\t(\n\t\t\tif classof bonechain[j] == Dummy and classof bonechain[j].controller == BipSlave_Control then\n\t\t\t(\n\t\t\t\tfor i = 1 to (custAttributes.count bonechain[j]) do \n\t\t\t\t(\n\t\t\t\t\tlocal a = CustAttributes.get bonechain[j] i\n\t\t\t\t\tif isProperty a \"boneTM\" do \n\t\t\t\t\t(\n\t\t\t\t\t\tCustAttributes.delete bonechain[j] i\n\t\t\t\t\t\tlocal isDelete = true\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t)\n\t\t\telse\n\t\t\t\tif not isProperty bonechain[j] \"boneTM\" then \n\t\t\t\t(\n\t\t\t\t\tCustAttributes.add bonechain[j] sprboneCA\n\t\t\t\t\tbonechain[j].boneTM = bonechain[j].transform * inverse bonechain[j].parent.transform\n\t\t\t\t)\n\t\t\t\n\t\t\tif isProperty bonechain[j] \"boneTM\" then\n\t\t\t\tappend bTM bonechain[j].boneTM\n\t\t\telse\n\t\t\t\tappend bTM (bonechain[j].transform * inverse bonechain[j].parent.transform)\n\t\t\t\n\t\t\tappend preTM bonechain[j].transform\n\t\t)\t\n\t\t\n\t\tif bonechain.count \u003e 1 then\n\t\t\tappend prePos bonechain[2].transform.pos\n\t\telse \n\t\t(\n\t\t\tlocal bbox = nodeGetBoundingBox bonechain[1] bonechain[1].transform\n\t\t\tappend prePos (bonechain[1].transform.pos + bonechain[1].transform.row1 * bbox[2].x)\n\t\t)\n\t\t\n\t\t-- Add End\n\t\tif bnum.value \u003e= bonechain.count do \n\t\t(\n\t\t\tif bonechain.count \u003e 1 then \n\t\t\t(\n\t\t\t\tlocal ltm = copy bTM[bTM.count]\n\t\t\t\tappend bTM ltm\n\t\t\t)\n\t\t\telse \n\t\t\t(\n\t\t\t\tlocal ltm = matrix3 1\n\t\t\t\tlocal bbox = nodeGetBoundingBox bonechain[1] bonechain[1].transform\n\t\t\t\tltm.pos = [bbox[2].x, 0 ,0]\n\t\t\t\tappend bTM ltm\n\t\t\t)\n\t\t\tlocal tm = ltm * bonechain[preTM.count].transform\n\t\t\tappend preTM tm\n\t\t)\n\t\t\n\t\tif classof bonechain[bonechain.count] == Dummy and \\\n\t\t\tclassof bonechain[bonechain.count].controller == BipSlave_Control do\n\t\t\tbonechain.count = bonechain.count - 1\n\t\tif bonechain.count \u003e bnum.value do bonechain.count = bnum.value\n\n\t\tappend bcnt bTM.count\n\t\tappend preTimebone_TM preTM\n\t\tappend bone_TM bTM\n\t\t\n\t\tformat \"调试: bTM数量=% preTM数量=% 骨骼链数量=%\\n\" bTM.count preTM.count bonechain.count\n\t)\n\t\n\t-- 增强的sin旋转计算函数 (支持正负值强度)\n\tfn get_sin_rotation_enhanced F_time offset_ rota type objectIndex =\n\t(\n\t\t-- 添加对象偏移\n\t\tlocal adjustedTime = F_time + (objectIndex - 1) * spn_perBoneOffset.value + spn_frameOffset.value\n\t\t\n\t\tcase type of\n\t\t(\n\t\t\t3: -- Z轴\n\t\t\t(\n\t\t\t\tif not chk_enableSinWave.checked or test_rota_z.value == 0 do return (eulerAngles 0 0 0)\n\t\t\t\tlocal b = 1.0 / (test_timelenght.value / (2.0*pi))\n\t\t\t\tlocal d = sin (radtodeg (adjustedTime - offset_)*b)\n\t\t\t\td = radtodeg (d* (degtorad rota))\n\t\t\t\t-- 应用正负值强度\n\t\t\t\tlocal finalD = if d \u003e 0 then d * spn_zPos.value else d * spn_zNeg.value\n\t\t\t\teulerAngles 0 0 (test_rota_z.value * finalD)\n\t\t\t)\n\t\t\t2: -- Y轴\n\t\t\t(\n\t\t\t\tif not chk_enableSinWave.checked or test_rota_y.value == 0 do return (eulerAngles 0 0 0)\n\t\t\t\tlocal b = 1.0 / (test_timelenght_y.value / (2.0*pi))\n\t\t\t\tlocal d = cos (radtodeg (adjustedTime - offset_)*b)\n\t\t\t\td = radtodeg (d* (degtorad rota))\n\t\t\t\t-- 应用正负值强度\n\t\t\t\tlocal finalD = if d \u003e 0 then d * spn_yPos.value else d * spn_yNeg.value\n\t\t\t\teulerAngles 0 (test_rota_y.value * finalD) 0\n\t\t\t)\n\t\t\t1: -- X轴\n\t\t\t(\n\t\t\t\tif not chk_enableSinWave.checked or test_rota_x.value == 0 do return (eulerAngles 0 0 0)\n\t\t\t\tlocal b = 1.0 / (test_timelenght_x.value / (2.0*pi))\n\t\t\t\tlocal d = sin (radtodeg (adjustedTime - offset_)*b)\n\t\t\t\td = radtodeg (d* (degtorad rota))\n\t\t\t\t-- 应用正负值强度\n\t\t\t\tlocal finalD = if d \u003e 0 then d * spn_xPos.value else d * spn_xNeg.value\n\t\t\t\teulerAngles (test_rota_x.value * finalD) 0 0\n\t\t\t)\n\t\t)\n\t)\n\n\ton applybone pressed do with undo on \n\t(\n\t\tformat \"调试: 开始飘带魔法终极计算...\\n\"\n\t\t\n\t\t-- 权重混合\n\t\tlocal blend_z = test_blend_z.value\n\t\tlocal blend_y = test_blend_y.value\n\t\tlocal blend_x = test_blend_x.value\n\t\t\n\t\tsimbones=#()\n\t\tsetStartEndFrame()\n\n\t\t-- Clear arrays\n\t\tsimBones = #()\n\t\tbone_TM = #()\n\t\tpreTimebone_TM = #()\n\t\tprePos = #()\n\t\tbcnt = #()\n\t\t\n\t\tlocal delay = delaysp.value\n\t\tformat \"调试: 正在处理 % 个选中对象\\n\" selection.count\n\n\t\t-- 为每个选中的对象建立骨骼链\n\t\tlocal objectIndex = 0\n\t\tfor object in selection do \n\t\t(\n\t\t\tif superClassOf object != shape do \n\t\t\t(\n\t\t\t\tobjectIndex += 1\n\t\t\t\tformat \"调试: 正在处理对象 % - %\\n\" objectIndex object.name\n\t\t\t\tat time frameStart getBoneChain object\n\t\t\t)\n\t\t)\n\t\t\n\t\tformat \"调试: 总共找到 % 个骨骼链\\n\" simBones.count\n\t\t\n\t\t-- Start calculation\n\t\tlocal loopsv = if loops.checked then 2 else 1 \n\t\tlocal subframe = 1f/subs.value\n\t\t\n\t\tlocal pv = 100.0/ loopsv / (frameEnd - framestart + 1)\n\t\tdoit_prog.value = 0.0\n\t\tlocal totalVal = 0\n\t\t\n\t\tformat \"调试: 开始主计算循环, 循环次数=%, 子帧=%\\n\" loopsv subframe\n\t\t\n\t\tfor L = 1 to loopsv do \n\t\t(\n\t\t\tformat \"调试: 循环 % / %\\n\" L loopsv\n\t\t\t\n\t\t\tfor t = framestart to frameEnd do \n\t\t\t(\n\t\t\t\tif keyboard.escPressed then exit\n\t\t\t\tlocal currtTime = t\n\n\t\t\t\tfor sf in 1 to subs.value do \n\t\t\t\t(\n\t\t\t\t\tcurrtTime += subframe\n\n\t\t\t\t\tfor i in 1 to simbones.count do \n\t\t\t\t\t(\n\t\t\t\t\t\tlocal currentPTM = at time currtTime simbones[i][1].parent.transform\n\t\t\t\t\t\t\n\t\t\t\t\t\t-- 根部位置权重混合\n\t\t\t\t\t\tlocal currentPTM_up = at time framestart simbones[i][1].parent.transform\n\t\t\t\t\t\tlocal temp_z = currentPTM.pos.z * blend_z + currentPTM_up.pos.z * (1.0 - blend_z)\n\t\t\t\t\t\tlocal temp_y = currentPTM.pos.y * blend_y + currentPTM_up.pos.y * (1.0 - blend_y)\n\t\t\t\t\t\tlocal temp_x = currentPTM.pos.x * blend_x + currentPTM_up.pos.x * (1.0 - blend_x)\n\t\t\t\t\t\tcurrentPTM.pos = [temp_x,temp_y,temp_z]\n\t\t\t\t\t\t\n\t\t\t\t\t\tfor j in 1 to simbones[i].count do \n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t-- Sin旋转量递增计算 (增强版 - 支持多对象)\n\t\t\t\t\t\t\tlocal sin_rota_x = test_max_rota_x.value + (j - 1.0) * test_max2_rota_x.value\n\t\t\t\t\t\t\tlocal sin_rota_y = test_max_rota_y.value + (j - 1.0) * test_max2_rota_y.value\n\t\t\t\t\t\t\tlocal sin_rota_z = test_max_rota.value + (j - 1.0) * test_max2_rota.value\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tlocal test_rotat_x = get_sin_rotation_enhanced (t - framestart) ((j - 1)*test_offsettime_x.value) sin_rota_x 1 i\n\t\t\t\t\t\t\tlocal test_rotat_y = get_sin_rotation_enhanced (t - framestart) ((j - 1)*test_offsettime_y.value) sin_rota_y 2 i\n\t\t\t\t\t\t\tlocal test_rotat_z = get_sin_rotation_enhanced (t - framestart) ((j - 1)*test_offsettime.value) sin_rota_z 3 i\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tlocal targetboneTM = bone_TM[i][j] * currentPTM\n\t\t\t\t\t\t\tlocal currentPos = if j==1 then prePos[i] else preTimebone_TM[i][j+1].pos\n\t\t\t\t\t\t\tlocal tpos = targetboneTM.pos\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t-- Twist X calculation (springmagic_v1.11 algorithm)\n\t\t\t\t\t\t\tlocal angX = acos(dot (normalize preTimebone_TM[i][j].row1) (normalize targetboneTM.row1))\n\t\t\t\t\t\t\tlocal newTM1 = copy preTimebone_TM[i][j]\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tlocal vt1 = normalize (cross preTimebone_TM[i][j].row1 targetboneTM.row1)\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif not bit.isNAN angX do rotate newTM1 (quat angX -vt1) \n\t\t\t\t\t\t\n\t\t\t\t\t\t\tnewTM1.pos = tpos\n\n\t\t\t\t\t\t\tlocal angY1 = acos(dot (normalize newTM1[2]) (normalize targetboneTM.row2))\t\n\t\t\t\t\t\t\tlocal ssvt = cross (normalize newTM1[2]) (normalize targetboneTM.row2)\n\n\t\t\t\t\t\t\tlocal xaxisdelay = (upspring.value + ((simbones[i].count-j)/(simbones[i].count)*(1.0-upspring.value)) )\n\t\t\t\t\t\t\tangY1 = angY1 * xaxisdelay\n\t\t\t\t\t\t\tif dot ssvt targetboneTM.row1 \u003e0 do angY1 = -angY1\n\t\t\t\t\t\t\tif not bit.isNAN angY1 do rotate newTM1 (quat angY1 targetboneTM.row1) \n\t\t\t\t\t\t\tnewTM1.pos = tpos\n\t\t\t\t\t\t\ttargetboneTM = copy newTM1\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t-- Main spring calculation with gravity\n\t\t\t\t\t\t\tlocal tvector = normalize targetboneTM.row1\n\t\t\t\t\t\t\tlocal cvector = normalize (currentPos - tpos + [0, 0, -test_G.value])\n\t\t\t\t\t\t\tlocal vt = normalize (cross cvector tvector)\n\t\t\t\t\t\t\tlocal angel = acos(dot (normalize cvector) (normalize tvector))\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tangel *= (1.0-delay)\n\t\t\t\t\t\t\tlocal sangel = angel \n\t\t\t\t\t\t\tif j == 1 do angel *= scaleMotion.value\n\t\t\t\t\t\t\tlocal ttm = copy targetboneTM\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif not bit.isNAN angel do\n\t\t\t\t\t\t\t\trotate targetboneTM (quat angel vt)\n\t\t\t\t\t\t\tif j == 1 do \n\t\t\t\t\t\t\t\tif not bit.isNAN sangel do rotate ttm (quat sangel vt)\n\t\t\t\t\t\t\ttargetboneTM.pos = ttm.pos = tpos\n\n\t\t\t\t\t\t\tif L == loopsv and sf == subs.value do \n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\tanimate on at time (t + 1f)\n\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\tif classof simbones[i][j].controller == BipSlave_Control and classof simbones[i][j] != Dummy then\n\t\t\t\t\t\t\t\t\t\tbiped.setTransform simbones[i][j] #rotation targetboneTM.rotation true\n\t\t\t\t\t\t\t\t\telse if classof simbones[i][j] == CATBone then\n\t\t\t\t\t\t\t\t\t\tsimbones[i][j].transform = copy targetboneTM\n\t\t\t\t\t\t\t\t\telse \n\t\t\t\t\t\t\t\t\t\t-- Sin旋转叠加 (增强版)\n\t\t\t\t\t\t\t\t\t\tsimbones[i][j].rotation.controller.value = (quat test_rotat_x)*(quat test_rotat_y)*(quat test_rotat_z)* (targetboneTM.rotation * inverse currentPTM.rotation)\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t)\n\n\t\t\t\t\t\t\tcurrentPTM = copy targetboneTM\n\t\t\t\t\t\t\tpreTimebone_TM[i][j] = copy targetboneTM\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif j == 1 do \n\t\t\t\t\t\t\t\tprePos[i] = bone_TM[i][j+1].pos * ttm\n\n\t\t\t\t\t\t\tpreTimebone_TM[i][j+1].pos = bone_TM[i][j+1].pos * targetboneTM\t\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t\ttotalVal += pv\n\t\t\t\tif totalVal \u003e= 20.0 do \n\t\t\t\t(\n\t\t\t\t\tdoit_prog.value += totalVal\n\t\t\t\t\ttotalVal = 0.0\n\t\t\t\t)\n\t\t\t)\n\t\t)\n\t\t\n\t\tdoit_prog.value = 100.0\n\t\tformat \"调试: 飘带魔法终极计算完成!\\n\"\n\t)\n\n\t-- 附加工具函数\n\ton btn_selectChildren pressed do\n\t(\n\t\tif selection.count == 0 do\n\t\t(\n\t\t\tmessageBox \"请先选择一个或多个父对象！\"\n\t\t)\n\t\t\n\t\tlocal currentSelection = selection as array\n\t\tlocal allChildrenToSelect = #()\n\t\t\n\t\tfor obj in currentSelection do\n\t\t(\n\t\t\tjoin allChildrenToSelect (getAllChildren obj)\n\t\t)\n\t\t\n\t\tif allChildrenToSelect.count \u003e 0 then\n\t\t(\n\t\t\tselect (currentSelection + allChildrenToSelect)\n\t\t\tformat \"调试: 选择了 % 个子对象\\n\" allChildrenToSelect.count\n\t\t)\n\t\telse\n\t\t(\n\t\t\tmessageBox \"当前选择的对象没有子级。\"\n\t\t)\n\t)\n\n\ton btn_LoopStart pressed do with undo on\n\t(\n\t\tif selection.count == 0 do \n\t\t(\n\t\t\tmessageBox \"请先选择骨骼对象！\"\n\t\t)\n\t\t\n\t\tlocal aBState = animButtonState\n\t\tanimButtonState = false\n\t\tlocal sortedArr = sortArrayByHeirarchy (selection as array)\n\t\tboneLoopStart sortedArr\n\t\tanimButtonState = aBState\n\t\tformat \"调试: 首尾循环处理完成\\n\"\n\t)\n\n\ton btn_EulerFilter pressed do with undo on\n\t(\n\t\tif selection.count == 0 do \n\t\t(\n\t\t\tmessageBox \"请先选择骨骼对象！\"\n\t\t)\n\t\t\n\t\tlocal sel = (selection as array)\n\t\tlocal processedCount = 0\n\t\tfor i=1 to sel.count where(isKindOf sel[i] GeometryClass or isKindOf sel[i] Helper) do\n\t\t(\n\t\t\tif sel[i].rotation.controller != undefined then\n\t\t\t(\n\t\t\t\tsel[i].Rotation.Controller = TCB_Rotation()\n\t\t\t\tsel[i].Rotation.Controller = Euler_XYZ()\n\t\t\t\tprocessedCount += 1\n\t\t\t)\n\t\t)\n\t\tformat \"调试: 欧拉过滤应用到 % 个对象\\n\" processedCount\n\t)\n\n\ton btn_TCB pressed do with undo on\n\t(\n\t\tif selection.count == 0 do \n\t\t(\n\t\t\tmessageBox \"请先选择骨骼对象！\"\n\t\t)\n\t\t\n\t\tlocal sel = (selection as array)\n\t\tlocal processedCount = 0\n\t\tfor i=1 to sel.count where(isKindOf sel[i] GeometryClass or isKindOf sel[i] Helper) do\n\t\t(\n\t\t\tif sel[i].rotation.controller != undefined then\n\t\t\t(\n\t\t\t\tsel[i].Rotation.Controller = TCB_Rotation()\n\t\t\t\tprocessedCount += 1\n\t\t\t)\n\t\t)\n\t\tformat \"调试: TCB曲线转换应用到 % 个对象\\n\" processedCount\n\t)\n\n\ton btn_Euler pressed do with undo on\n\t(\n\t\tif selection.count == 0 do \n\t\t(\n\t\t\tmessageBox \"请先选择骨骼对象！\"\n\t\t)\n\t\t\n\t\tlocal sel = (selection as array)\n\t\tlocal processedCount = 0\n\t\tfor i=1 to sel.count where(isKindOf sel[i] GeometryClass or isKindOf sel[i] Helper) do\n\t\t(\n\t\t\tif sel[i].rotation.controller != undefined then\n\t\t\t(\n\t\t\t\tsel[i].Rotation.Controller = Euler_XYZ()\n\t\t\t\tprocessedCount += 1\n\t\t\t)\n\t\t)\n\t\tformat \"调试: 欧拉曲线转换应用到 % 个对象\\n\" processedCount\n\t)\n\n\ton btn_SelectAllBones pressed do\n\t(\n\t\tlocal allBones = for b in objects where(classOf b == BoneGeometry and b.isHidden==false) collect b\n\t\tif allBones.count \u003e 0 then\n\t\t(\n\t\t\tselect allBones\n\t\t\tformat \"调试: 选择了 % 个骨骼对象\\n\" allBones.count\n\t\t)\n\t\telse\n\t\t(\n\t\t\tmessageBox \"场景中没有找到骨骼对象\"\n\t\t)\n\t)\n\n\ton pasteRp pressed do \n\t(\n\t\tfor bone in selection do \n\t\t(\n\t\t\tlocal bonetype = classof bone\n\t\t\tif superClassOf bone == shape do continue\n\t\t\tif bone.parent == undefined do continue\n\t\t\tlocal bones=#()\n\t\t\tlocal num = 1\n\t\t\twhile bone!=undefined do \n\t\t\t(\n\t\t\t\tbones[num] = bone\n\t\t\t\tlocal childfind = false\n\t\t\t\tif bone.children.count == 0 then exit\n\t\t\t\telse \n\t\t\t\t(\n\t\t\t\t\tfor c in bone.children do\n\t\t\t\t\t\tif classof c == bonetype or classof c == Dummy then \n\t\t\t\t\t\t(\n\t\t\t\t\t\t\tbone = c\n\t\t\t\t\t\t\tnum += 1 \n\t\t\t\t\t\t\tchildfind = true\n\t\t\t\t\t\t\texit\n\t\t\t\t\t\t)\n\t\t\t\t\t\telse continue\n\t\t\t\t\tif childfind == false do bone = undefined\n\t\t\t\t)\n\t\t\t)\n\t\t\t\n\t\t\tfor b in bones do \n\t\t\t\tif isProperty b \"boneTM\" do \n\t\t\t\t(\n\t\t\t\t\tanimate on\n\t\t\t\t\t(\n\t\t\t\t\t\tif classof b == CATBone then \n\t\t\t\t\t\t(\n\t\t\t\t\t\t\tb.transform = b.boneTM * b.parent.transform\n\t\t\t\t\t\t) \n\t\t\t\t\t\telse if classof b == Biped_Object then \n\t\t\t\t\t\t\tbiped.setTransform b #rotation (b.boneTM*b.parent.transform).rotation true\n\t\t\t\t\t\telse if classof b.controller != BipSlave_Control do \n\t\t\t\t\t\t\tb.rotation.controller.value = b.boneTM.rotation\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t)\n\t\tformat \"调试: 骨骼姿态已粘贴\\n\"\n\t)\n\n\ton setRp pressed do \n\t(\n\t\tfor obj in selection do \n\t\t(\n\t\t\tlocal objtype = classof obj\n\t\t\tif superClassOf obj != GeometryClass do continue\n\t\t\tif obj.parent == undefined do continue\n\t\t\tlocal bones=#()\n\t\t\tappend bones obj\n\t\t\t\n\t\t\twhile obj != undefined do \n\t\t\t(\n\t\t\t\tif keyboard.escPressed then exit\n\t\t\t\tlocal isfind = false\n\t\t\t\tfor c in obj.children do \n\t\t\t\t\tif classof c == objtype or classof c == Dummy then \n\t\t\t\t\t(\n\t\t\t\t\t\tappend bones c\n\t\t\t\t\t\tobj = c\n\t\t\t\t\t\tisfind = true\n\t\t\t\t\t\texit\n\t\t\t\t\t)\n\t\t\t\t\telse continue\n\t\t\t\tif not isfind do obj = undefined\n\t\t\t)\n\n\t\t\tfor b in bones do\n\t\t\t\tif classof b == objtype do \n\t\t\t\t(\n\t\t\t\t\tif not isProperty b \"boneTM\" do \n\t\t\t\t\t\tCustAttributes.add b sprboneCA\n\t\t\t\t\n\t\t\t\t\tb.boneTM = b.transform*(inverse b.parent.transform)\n\t\t\t\t)\n\t\t)\n\t\tformat \"调试: 骨骼姿态已设置\\n\"\n\t)\n\t\n\ton stretch pressed do with undo on \n\t(\n\t\tfor bone in selection do \n\t\t(\n\t\t\tif bone.children.count == 0 do continue\n\t\t\tbone = bone.children[1]\n\t\t\tlocal bonetype = classof bone\n\t\t\tif superClassOf bone == shape do continue\n\t\t\tif bone.parent == undefined do continue\n\t\t\tlocal bones=#()\n\t\t\tlocal num = 1\n\t\t\twhile bone!=undefined do \n\t\t\t(\n\t\t\t\tbones[num] = bone\n\t\t\t\tlocal childfind = false\n\t\t\t\tif bone.children.count == 0 then exit\n\t\t\t\telse \n\t\t\t\t(\n\t\t\t\t\tfor c in bone.children do\n\t\t\t\t\t\tif classof c == bonetype or classof c == Dummy then \n\t\t\t\t\t\t(\n\t\t\t\t\t\t\tbone = c\n\t\t\t\t\t\t\tnum += 1 \n\t\t\t\t\t\t\tchildfind = true\n\t\t\t\t\t\t\texit\n\t\t\t\t\t\t)\n\t\t\t\t\t\telse continue\n\t\t\t\t\tif childfind == false do bone = undefined\n\t\t\t\t)\n\t\t\t)\n\t\t\tfor b in bones do \n\t\t\t(\n\t\t\t\tif bonetype == Biped_Object then \n\t\t\t\t\tbiped.setTransform b #rotation b.parent.transform.rotation true\n\t\t\t\telse \n\t\t\t\t(\n\t\t\t\t\tlocal c = copy b.parent.transform\n\t\t\t\t\tc.pos = b.transform.position\n\t\t\t\t\tb.transform = c\n\t\t\t\t)\n\t\t\t)\n\t\t)\n\t\tformat \"调试: 骨骼已打直\\n\"\n\t)\n\t\n\ton btn_reset pressed do \n\t(\n\t\treset_control_value()\n\t)\n\t\n\t-- 控制Sin Wave相关控件的启用状态\n\ton chk_enableSinWave changed state do\n\t(\n\t\tformat \"调试: Sin波启用状态: %\\n\" state\n\t)\n\t\n\ton springMagic_rol open do \n\t(\n\t\taframestart.value = animationRange.start.frame\n\t\taframeEnd.value = animationRange.end.frame\n\t\ttest_timelenght.value = animationRange.end.frame - animationRange.start.frame \n\t\ttest_timelenght_y.value = animationRange.end.frame - animationRange.start.frame\n\t\ttest_timelenght_x.value = animationRange.end.frame - animationRange.start.frame\n\t\t\n\t\tformat \"调试: 飘带魔法终极版UI已初始化\\n\"\n\t\tformat \"调试: 动画范围: % 到 %\\n\" animationRange.start.frame animationRange.end.frame\n\t)\n)\n\ncreateDialog springMagic_rol\n\nformat \"========================================\\n\"\nformat \"飘带魔法工具 V1.11 终极版 已加载!\\n\"\nformat \"功能特性:\\n\"\nformat \"- SpringMagic V1.11 核心算法\\n\"\nformat \"- 天晴 Sin波扰动系统\\n\"\nformat \"- 多对象支持与时间偏移\\n\"\nformat \"- 正负轴向强度控制\\n\"\nformat \"- 附加工具 (欧拉过滤, 循环等)\\n\"\nformat \"========================================\\n\""])</script><script>self.__next_f.push([1,"21:T973c,"])</script><script>self.__next_f.push([1,"# Sin Wind Spring Generator V6.0 终极整合版\n\n我帮你整合两个脚本的优点，创建一个终极版本。主要改进：\n\n1. **修正默认值**：子采样=1，根骨骼缩放=1\n2. **双模式控制**：全局风向控制 + 局部骨骼Sin控制\n3. **激活控制切换**：激活=1用全局风，激活=0用局部控制\n4. **混合模式**：可以设置两者之间的混合比例\n5. **保留所有附加工具**\n\n```maxscript\n/* \n    Sin Wind Spring Generator V6.0 Ultimate\n    - 整合全局风向控制 + 局部骨骼Sin控制\n    - 激活控制切换/混合模式\n    - 修正默认值：子采样=1，根骨骼缩放=1\n    - 保留所有原有功能\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V6.0 终极版\" width:580\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:260 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:260 align:#right height:30 autoDisplay:true\n        label lbl_info \"提示: 控制器的Activation参数控制全局/局部混合比例\" style_sunken:true align:#center\n    )\n    \n    group \"2. 姿态与形态\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:170 align:#left across:3 height:25 toolTip:\"将当前骨骼形状存为弹簧的目标形态\"\n        button btn_pastePose \"粘贴姿态\" width:170 align:#center height:25 toolTip:\"复位到参考姿态\"\n        button btn_straighten \"拉直骨骼\" width:170 align:#right height:25 toolTip:\"拉直骨骼链\"\n    )\n    \n    group \"3. 全局Sin风力 (Activation=1时生效)\"\n    (\n        spinner spn_baseWind \"基础风压(度)\" range:[0.0, 90.0, 20.0] type:#float align:#left across:3 width:150\n        spinner spn_swingAmp \"摆动幅度(度)\" range:[0.0, 30.0, 5.0] type:#float width:150\n        spinner spn_period \"周期(帧)\" range:[1, 200, 30] type:#integer width:150\n        \n        spinner spn_turbulence \"扰动强度\" range:[0.0, 30.0, 2.0] type:#float align:#left across:2 width:150\n        spinner spn_turbFreq \"扰动频率\" range:[0.1, 20.0, 0.5] scale:0.01 type:#float width:150\n    )\n    \n    group \"4. 局部骨骼Sin控制 (Activation=0时生效)\"\n    (\n        checkBox chk_enableLocalSin \"启用局部Sin (当Activation\u003c1时自动启用)\" checked:true align:#left\n        \n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:90 toolTip:\"0=关闭 1=全开\"\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:90 toolTip:\"基础旋转角度\"\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:90 toolTip:\"每根骨骼递增量\"\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:90 toolTip:\"时间延迟\"\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:90 toolTip:\"循环周期\"\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:90\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:90\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:90\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:90\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:90\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:90\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:90\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:90\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:90\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:90\n    )\n    \n    group \"5. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:150 \\\n                toolTip:\"越小越硬，越大越软\"\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:150 \\\n                toolTip:\"X轴抗扭强度\"\n        spinner spn_gravity \"重力.Z\" type:#float range:[-990.0,999,0] width:150\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:150 \\\n                toolTip:\"计算精度，默认1\"\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:150 \\\n                toolTip:\"根骨骼运动幅度，默认1\"\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:150 toolTip:\"最大处理骨骼数\"\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:2 width:150\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:150\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:150\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:150\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:150\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4 toolTip:\"第0帧自动缝合\"\n        label lbl_empty \"\" width:50\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:120\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:120\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:560\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:560 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:85 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:85\n        button btn_EulerFilter \"欧拉过滤\" width:85\n        button btn_TCB \"转TCB\" width:85\n        button btn_Euler \"转欧拉\" width:85\n        button btn_reset \"重置参数\" width:85 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:5.0 animatable:true ui:spn_swing\n                    turbAmt type:#float default:2.0 animatable:true ui:spn_turb\n                    activation type:#float default:1.0 animatable:true ui:spn_activation\n                )\n                rollout rlt \"风力参数(可K帧)\" (\n                    group \"核心参数\" (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                        spinner spn_base \"基础风压:\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"摆动幅度:\" range:[0,30,5.0] type:#float\n                        spinner spn_turb \"扰动强度:\" range:[0,30,2.0] type:#float\n                    )\n                    group \"模式混合 (0=局部Sin, 1=全局风向)\" (\n                        spinner spn_activation \"激活混合:\" range:[0,1,1.0] type:#float scale:0.01\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_root_wind absTime baseWind swingAmp turbAmount period turbFreq =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local noisePos = [absTime * turbFreq * 0.1, 0, 0]\n        local noiseValue = noise3 noisePos\n        return baseWind + swingComponent + (noiseValue * turbAmount)\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 do up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    -- 局部Sin旋转计算函数\n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1: -- X轴\n            (\n                if spn_localX_switch.value == 0 do return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2: -- Y轴\n            (\n                if spn_localY_switch.value == 0 do return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3: -- Z轴\n            (\n                if spn_localZ_switch.value == 0 do return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do (\n            if (findItem roots r.parent) == 0 do (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 \n            then append parentArray obj\n            else append childArray obj  \n        )\n        while childArray.count \u003e 0 do\n        (\n            local i=1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else(i += 1)\n            )\n        )\n        \n        local a = 1\n        for l=1 to parentArray.count do\n        (\n            if (finditem parentArray (parentArray[l].children)[1]) != 0 then\n                append listArray parentArray[l]\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" do CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" do \n                    (\n                        try (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then bn.transform = targetTM\n                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        ctrl.baseForce = spn_baseWind.value\n        ctrl.swingAmp = spn_swingAmp.value\n        ctrl.turbAmt = spn_turbulence.value\n        pck_ctrl.object = ctrl\n        select ctrl\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 do (messageBox \"请选择骨骼根部\"; return false)\n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj do (messageBox \"请先拾取风向控制器\"; return false)\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local turbFreq = spn_turbFreq.value \n        local period = spn_period.value\n        local gravity = spn_gravity.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        local enableLocalSin = chk_enableLocalSin.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        \n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                )\n                \n                if chain.count \u003e 1 then\n                (\n                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]\n                    append boneRelTMs lastRelTM \n                    local endWorldTM = lastRelTM * chain[chain.count].transform\n                    append simTMs endWorldTM\n                )\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    local endTM = matrix3 1\n                    endTM.pos = [bbox[2].x, 0, 0]\n                    append boneRelTMs endTM\n                    local endWorldTM = endTM * chain[1].transform\n                    append simTMs endWorldTM\n                )\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)\n                )\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- 缝合逻辑\n            if isWritePass and chk_loops.checked do\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local turbAmount = at time t ctrlObj.turbAmt\n                local activation = at time t ctrlObj.activation\n                local localBlend = 1.0 - activation  -- 局部Sin混合权重\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            -- 根部位置权重混合\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                            currentPTM = matrix3 1\n                        \n                        for j = 1 to chain.count do\n                        (\n                            -- 计算局部Sin旋转\n                            local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                            local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                            local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                            local localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos\n                            local tpos = targetBoneTM.pos\n                            \n                            -- Twist X\n                            local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                            if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                            local angX = acos(dot1)\n                            \n                            local newTM1 = copy simTMs[j]\n                            local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                            if angX \u003e 0.001 do rotate newTM1 (quat angX -vt1)\n                            newTM1.pos = tpos\n                            \n                            -- Spring Y/Z\n                            local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                            if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                            local angY1 = acos(dot2)\n                            \n                            local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                            local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))\n                            angY1 = angY1 * xAxisDelay\n                            \n                            if dot ssvt targetBoneTM.row1 \u003e 0 do angY1 = -angY1\n                            if abs angY1 \u003e 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)\n                            newTM1.pos = tpos\n                            targetBoneTM = copy newTM1\n                            \n                            -- Main Bend (加入重力)\n                            local tvector = normalize targetBoneTM.row1\n                            local cvector = normalize (currentPos - tpos + [0, 0, -gravity])\n                            local vt = normalize (cross cvector tvector)\n                            \n                            local dot3 = dot cvector tvector\n                            if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                            local angle = acos(dot3)\n                            \n                            angle *= (1.0 - delay)\n                            local sangle = angle\n                            \n                            -- Root Wind (全局模式)\n                            if j == 1 and activation \u003e 0 do\n                            (\n                                local windAngle = calculate_root_wind currTime baseWind swingAmp turbAmount period turbFreq\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * activation\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                angle *= scaleMotion\n                            )\n                            \n                            angle = applySoftLimit angle maxAngle softness\n                            sangle = applySoftLimit sangle maxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs angle \u003e 0.001 do rotate targetBoneTM (quat angle vt)\n                            if j == 1 and abs sangle \u003e 0.001 do rotate ttm (quat sangle vt)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- === 写入关键帧 ===\n                            if isWritePass and sf == subs do\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try (\n                                        -- 计算最终旋转 (混合全局和局部Sin)\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        -- 当局部Sin启用且activation\u003c1时，混合局部Sin\n                                        if enableLocalSin and localBlend \u003e 0 do\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localBlend\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        else \n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                    ) catch ()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j \u003c chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        print \"生成完毕！\" \n    )\n    \n    -- === 附加工具按钮事件 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 do (messageBox \"请先选择父对象！\"; return false)\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择骨骼！\"; return false)\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined do\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_baseWind.value = 20.0\n        spn_swingAmp.value = 5.0\n        spn_period.value = 30\n        spn_turbulence.value = 2.0\n        spn_turbFreq.value = 0.5\n        \n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_gravity.value = 0\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V6.0 终极版已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V6.0 终极版\\n\"\nformat \"========================================\\n\"\nformat \"整合功能:\\n\"\nformat \"- 全局风向控制 (带控制器方向)\\n\"\nformat \"- 局部骨骼Sin控制 (XYZ轴独立)\\n\"\nformat \"- Activation混合: 1=全局风, 0=局部Sin\\n\"\nformat \"- 重力支持\\n\"\nformat \"- 根部位置权重\\n\"\nformat \"- 默认值修正: 子采样=1, 根骨骼缩放=1\\n\"\nformat \"========================================\\n\"\n```\n\n## 主要改进说明：\n\n### 1. **修正默认值**\n- 子采样：1（原来是3）\n- 根骨骼缩放：1.0（原来是1.5）\n\n### 2. **双模式控制系统**\n- **Activation = 1**：完全使用全局风向控制器\n- **Activation = 0**：完全使用局部骨骼Sin控制\n- **Activation = 0.5**：两者混合\n\n### 3. **局部骨骼Sin控制面板**\n每个轴(X/Y/Z)都有独立控制：\n- 开关（0-1）\n- 旋转量（基础角度）\n- 递增量（每根骨骼叠加）\n- 时间延迟（波浪延迟效果）\n- 周期（循环长度）\n\n### 4. **新增功能**\n- 重力控制\n- 根部位置XYZ权重混合\n- 骨骼数量限制\n- 所有附加工具（欧拉过滤、首尾循环等）\n\n### 5. **使用方法**\n1. 创建风向控制器\n2. 设定参考姿态\n3. 调整Activation：\n   - 需要自然飘动 → Activation=1，使用全局风力\n   - 需要精细控制 → Activation=0，调整局部Sin参数\n   - 需要混合效果 → Activation=0.5"])</script><script>self.__next_f.push([1,"22:Tf12,"])</script><script>self.__next_f.push([1,"用户想要将两个脚本结合起来。让我分析一下两个脚本的特点：\n\n**第一个脚本 (Sin Wind Spring Generator V5.5)**:\n- 有风向控制器，可以控制风的方向\n- 使用全局的sin摆动参数\n- 有激活控制(activation)可以关键帧动画\n- 子采样默认为3，用户希望改为1\n- 根骨骼缩放默认为1.5，用户希望改为1\n- 缺少单独控制每根骨骼的能力\n\n**第二个脚本 (飘带魔法工具 V1.11 终极版)**:\n- 没有风向控制\n- 可以单独控制每根骨骼的X/Y/Z轴sin摆动\n- 有正负强度控制\n- 有递增量控制（每根骨骼递增）\n- 有时间延迟控制\n- 有重力控制\n- 有根部位置权重混合\n\n用户的需求：\n1. 修改默认值：子采样改为1，根骨骼缩放改为1\n2. 当激活控制关闭时，可以切换到局部控制每个骨骼的轴向混合\n3. 结合两个脚本的优点\n\n我需要创建一个综合版本，具有：\n1. 风向控制器功能（来自脚本1）\n2. 全局sin风力控制（来自脚本1）\n3. 局部骨骼sin控制（来自脚本2）\n\n\n4. 激活控制作为模式切换 - 激活=1时使用全局风控制，激活=0时使用局部骨骼控制\n5. 调整默认参数值\n\n现在开始设计这个综合脚本，创建一个能够在全局风向模式和局部骨骼控制模式之间切换的工具。\n\n脚本会定义全局属性容器来存储骨骼变换矩阵，以及一个结构体来保存初始骨骼数据。然后构建主界面，包含模式选择、参数调整和执行控制的各个功能区块。\n\n界面分为风向控制、姿态设置等多个分组，每个分组内包含相应的按钮、拾取器和信息提示。\n\n姿态控制部分提供了设定参考姿态、粘贴姿态和拉直骨骼的功能，其中设定参考姿态是在启动循环前的必要步骤。\n\n接下来是全局风力参数的配置，针对第一根骨骼设置基础风压、Sin摆动幅度、摆动周期和扰动强度等属性，还有扰动频率的调整范围。\n\n然后新增了局部骨骼Sin控制功能，允许对每根骨骼独立启用Sin控制，并为X轴（扭转）设置开关和旋转量参数。\n\n继续为Y轴（左右）配置类似的控制参数，包括开关、旋转量和递增量等设置。\n\n然后添加Z轴（前后）的控制面板，同样包含开关、旋转量和递增量的微调器。\n\n接下来是延迟和周期参数的设置。最后在第5组中配置Spring弹簧参数，包括延迟时间（范围0.01到0.99，默认0.3）和X轴弹簧强度（范围0.1到1.0，默认0.3），其中延迟值越小表示弹簧越硬，越大则越软。\n\n还需要添加子采样精度控制、根骨骼缩放倍率（范围0.5到3.0，默认1.0）以及重力Z轴参数。第6组则用于设置角度限制的最大值。\n\nfloat align:#left across:2\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环 (Loop)\" checked:true align:#left across:2 toolTip:\"开启后第0帧将自动缝合，无缝衔接。\"\n        label lbl_empty \"\"\n        \n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer align:#left across:2 width:100\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:100\n    )\n    \n    progressbar\n\n第7组处理动画播放的关键参数，包括循环模式、帧范围设置。软限制控制约束的平滑过渡，范围从0到1，步长为0.01。\n\n接下来是进度条和主要的烘焙按钮，用于生成Sin+Spring风场动画效果。下方还有一组辅助工具按钮，分别用于选择子级对象、处理首尾循环、应用欧拉过滤、转换旋转插值方式（TCB或欧拉角），以及重置所有参数到默认值。\n\n最后实现所有必要的函数逻辑，然后创建并显示对话框窗口。"])</script><script>self.__next_f.push([1,"23:Tab77,"])</script><script>self.__next_f.push([1,"你说得对！我需要把混合系统拆分成独立参数，并且大幅改进扰动系统。让我重新设计：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V6.5 Ultimate\n    - 三参数独立混合系统：全局风/局部Sin/Spring\n    - 全新多层扰动系统（多股风冲撞效果）\n    - 扰动频率/层数/速度完整控制\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V6.5\" width:600\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:270 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:270 align:#right height:30 autoDisplay:true\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:180 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:180 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:180 align:#right height:25\n    )\n    \n    group \"3. ★ 混合控制 (核心)\"\n    (\n        label lbl_mix \"三个参数独立控制，可任意组合：\" align:#left\n        spinner spn_springMix \"Spring弹簧\" range:[0.0, 1.0, 1.0] scale:0.01 align:#left across:3 width:170 \\\n                toolTip:\"弹簧物理效果强度 (通常保持1)\"\n        spinner spn_globalWindMix \"全局风向\" range:[0.0, 1.0, 1.0] scale:0.01 width:170 \\\n                toolTip:\"风向控制器驱动的Sin风力\"\n        spinner spn_localSinMix \"局部Sin\" range:[0.0, 1.0, 0.0] scale:0.01 width:170 \\\n                toolTip:\"每根骨骼独立的Sin波动\"\n        \n        label lbl_mixTip \"提示: 纯Spring=只开Spring | 自然飘动=Spring+全局风 | 精细控制=Spring+局部Sin\" align:#center style_sunken:true\n    )\n    \n    group \"4. 全局Sin风力参数\"\n    (\n        spinner spn_baseWind \"基础风压(度)\" range:[0.0, 90.0, 20.0] type:#float align:#left across:3 width:170\n        spinner spn_swingAmp \"Sin幅度(度)\" range:[0.0, 60.0, 8.0] type:#float width:170\n        spinner spn_period \"周期(帧)\" range:[1, 500, 30] type:#integer width:170\n    )\n    \n    group \"5. ★ 多层扰动系统 (多股风冲撞)\"\n    (\n        label lbl_turb \"模拟多股气流冲击效果：\" align:#left\n        spinner spn_turbStrength \"扰动强度(度)\" range:[0.0, 90.0, 15.0] type:#float align:#left across:3 width:170 \\\n                toolTip:\"扰动的总体力度，越大波动越剧烈\"\n        spinner spn_turbFreq \"扰动频率\" range:[0.1, 50.0, 3.0] scale:0.1 type:#float width:170 \\\n                toolTip:\"波峰波谷的密度，越大冲击越频繁\"\n        spinner spn_turbSpeed \"扰动速度\" range:[0.1, 20.0, 2.0] scale:0.1 type:#float width:170 \\\n                toolTip:\"扰动变化的速度\"\n        \n        spinner spn_turbLayers \"扰动层数\" range:[1, 8, 3] type:#integer align:#left across:3 width:170 \\\n                toolTip:\"叠加的噪波层数，层数越多越复杂\"\n        spinner spn_turbRoughness \"粗糙度\" range:[0.1, 5.0, 2.0] scale:0.1 type:#float width:170 \\\n                toolTip:\"高频细节的强度\"\n        spinner spn_turbSeed \"随机种子\" range:[0, 9999, 0] type:#integer width:170 \\\n                toolTip:\"不同种子产生不同扰动模式\"\n        \n        checkbox chk_turbPreview \"预览扰动曲线\" checked:false align:#left across:2\n        button btn_testTurb \"测试扰动效果\" width:150 align:#right height:20\n    )\n    \n    group \"6. 局部骨骼Sin控制\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:100\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:100\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:100\n    )\n    \n    group \"7. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:170\n        spinner spn_gravity \"重力.Z\" type:#float range:[-990.0,999,0] width:170\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:170\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:170\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:170\n    )\n    \n    group \"8. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:170\n        label lbl_empty1 \"\" width:170\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n    )\n    \n    group \"9. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:80\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:130\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:130\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:580\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:580 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:90 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:90\n        button btn_EulerFilter \"欧拉过滤\" width:90\n        button btn_TCB \"转TCB\" width:90\n        button btn_Euler \"转欧拉\" width:90\n        button btn_reset \"重置参数\" width:90 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turb\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbF\n                )\n                rollout rlt \"风力参数(可K帧)\" (\n                    group \"核心参数\" (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                        spinner spn_base \"基础风压:\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度:\" range:[0,60,8.0] type:#float\n                    )\n                    group \"扰动参数\" (\n                        spinner spn_turb \"扰动强度:\" range:[0,90,15.0] type:#float\n                        spinner spn_turbF \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    -- ★ 全新多层扰动计算函数\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 do return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            -- 每层使用不同的噪波采样位置\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            \n            -- 获取噪波值 (-1 到 1)\n            local noiseValue = noise3 noisePos\n            \n            -- 添加额外的高频细节\n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            -- 累加到总扰动\n            totalTurb += noiseValue * amplitude\n            \n            -- 下一层：频率加倍，振幅减半（分形噪波原理）\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    -- 计算带扰动的根骨骼风力\n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        -- 基础Sin波\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        \n        -- 多层扰动\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        \n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 do up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    -- 局部Sin旋转计算函数\n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1: -- X轴\n            (\n                if spn_localX_switch.value == 0 do return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2: -- Y轴\n            (\n                if spn_localY_switch.value == 0 do return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3: -- Z轴\n            (\n                if spn_localZ_switch.value == 0 do return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do (\n            if (findItem roots r.parent) == 0 do (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 \n            then append parentArray obj\n            else append childArray obj  \n        )\n        while childArray.count \u003e 0 do\n        (\n            local i=1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else(i += 1)\n            )\n        )\n        \n        local a = 1\n        for l=1 to parentArray.count do\n        (\n            if (finditem parentArray (parentArray[l].children)[1]) != 0 then\n                append listArray parentArray[l]\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" do CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" do \n                    (\n                        try (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then bn.transform = targetTM\n                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    -- 测试扰动效果\n    on btn_testTurb pressed do\n    (\n        format \"\\n========== 扰动测试 ==========\\n\"\n        format \"扰动强度: %  频率: %  速度: %  层数: %  粗糙度: %\\n\" \\\n            spn_turbStrength.value spn_turbFreq.value spn_turbSpeed.value spn_turbLayers.value spn_turbRoughness.value\n        \n        format \"\\n前50帧扰动值预览:\\n\"\n        for t = 0 to 50 by 5 do\n        (\n            local turbVal = calculate_multi_layer_turbulence t spn_turbStrength.value spn_turbFreq.value \\\n                            spn_turbSpeed.value spn_turbLayers.value spn_turbRoughness.value spn_turbSeed.value\n            local bar = \"\"\n            local barLen = (abs(turbVal) / spn_turbStrength.value * 20) as integer\n            if barLen \u003e 20 do barLen = 20\n            for i = 1 to barLen do bar += if turbVal \u003e 0 then \"+\" else \"-\"\n            format \"帧%: % (%.1f度)\\n\" (formattedPrint t format:\"02d\") bar turbVal\n        )\n        format \"================================\\n\"\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        ctrl.baseForce = spn_baseWind.value\n        ctrl.swingAmp = spn_swingAmp.value\n        ctrl.turbStrength = spn_turbStrength.value\n        ctrl.turbFreq = spn_turbFreq.value\n        pck_ctrl.object = ctrl\n        select ctrl\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 do (messageBox \"请选择骨骼根部\"; return false)\n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj do (messageBox \"请先拾取风向控制器\"; return false)\n        \n        -- 获取混合参数\n        local springMix = spn_springMix.value\n        local globalWindMix = spn_globalWindMix.value\n        local localSinMix = spn_localSinMix.value\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local period = spn_period.value\n        local gravity = spn_gravity.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        -- 扰动参数\n        local turbSpeed = spn_turbSpeed.value\n        local turbLayers = spn_turbLayers.value\n        local turbRoughness = spn_turbRoughness.value\n        local turbSeed = spn_turbSeed.value\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        \n        format \"========================================\\n\"\n        format \"混合模式: Spring=% | 全局风=% | 局部Sin=%\\n\" springMix globalWindMix localSinMix\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                )\n                \n                if chain.count \u003e 1 then\n                (\n                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]\n                    append boneRelTMs lastRelTM \n                    local endWorldTM = lastRelTM * chain[chain.count].transform\n                    append simTMs endWorldTM\n                )\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    local endTM = matrix3 1\n                    endTM.pos = [bbox[2].x, 0, 0]\n                    append boneRelTMs endTM\n                    local endWorldTM = endTM * chain[1].transform\n                    append simTMs endWorldTM\n                )\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)\n                )\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- 缝合逻辑\n            if isWritePass and chk_loops.checked do\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            -- 根部位置权重混合\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                            currentPTM = matrix3 1\n                        \n                        for j = 1 to chain.count do\n                        (\n                            -- 计算局部Sin旋转 (根据混合值)\n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 do\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos\n                            local tpos = targetBoneTM.pos\n                            \n                            -- ★ Spring计算 (根据springMix控制)\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 do\n                            (\n                                -- Twist X\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 do rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                -- Spring Y/Z\n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 do angY1 = -angY1\n                                if abs angY1 \u003e 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                -- Main Bend (加入重力)\n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - delay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- ★ Root Wind (全局模式，根据globalWindMix控制)\n                            if j == 1 and globalWindMix \u003e 0 do\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            -- 应用Spring混合\n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            springAngle = applySoftLimit springAngle maxAngle softness\n                            sangle = applySoftLimit sangle maxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 do rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 do rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- === 写入关键帧 ===\n                            if isWritePass and sf == subs do\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try (\n                                        -- 计算最终旋转\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        -- 混合局部Sin\n                                        if localSinMix \u003e 0 do\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        else \n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                    ) catch ()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j \u003c chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n    )\n    \n    -- === 附加工具按钮事件 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 do (messageBox \"请先选择父对象！\"; return false)\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择骨骼！\"; return false)\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined do\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_springMix.value = 1.0\n        spn_globalWindMix.value = 1.0\n        spn_localSinMix.value = 0.0\n        \n        spn_baseWind.value = 20.0\n        spn_swingAmp.value = 8.0\n        spn_period.value = 30\n        \n        spn_turbStrength.value = 15.0\n        spn_turbFreq.value = 3.0\n        spn_turbSpeed.value = 2.0\n        spn_turbLayers.value = 3\n        spn_turbRoughness.value = 2.0\n        spn_turbSeed.value = 0\n        \n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_gravity.value = 0\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V6.5 终极版已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V6.5\\n\"\nformat \"========================================\\n\"\nformat \"新功能:\\n\"\nformat \"1. 三参数独立混合: Spring/全局风/局部Sin\\n\"\nformat \"2. 多层扰动系统: 强度/频率/速度/层数/粗糙度\\n\"\nformat \"3. 测试扰动按钮: 可预览扰动曲线\\n\"\nformat \"========================================\\n\"\nformat \"使用示例:\\n\"\nformat \"- 纯Spring: Spring=1, 其他=0\\n\"\nformat \"- 自然飘动: Spring=1, 全局风=1\\n\"\nformat \"- 精细控制: Spring=1, 局部Sin=1\\n\"\nformat \"- 混合效果: 三个都设为0.5-1\\n\"\nformat \"========================================\\n\"\n```\n\n## 主要改进：\n\n### 1. **三参数独立混合系统**\n```\nSpring弹簧: 0-1  (物理弹簧效果)\n全局风向:   0-1  (风向控制器驱动)\n局部Sin:    0-1  (每根骨骼独立控制)\n```\n\n现在你可以：\n- **纯Spring**：Spring=1, 全局风=0, 局部Sin=0\n- **Spring+风**：Spring=1, 全局风=1, 局部Sin=0\n- **Spring+局部**：Spring=1, 全局风=0, 局部Sin=1\n- **全混合**：三个都=1\n\n### 2. **全新多层扰动系统**\n- **扰动强度(度)**：0-90度，控制总体力度\n- **扰动频率**：0.1-50，越大波峰波谷越密集\n- **扰动速度**：控制变化快慢\n- **扰动层数**：1-8层，叠加多股风的效果\n- **粗糙度**：高频细节强度\n- **随机种子**：不同种子产生不同模式\n\n### 3. **测试扰动按钮**\n可以在Listener中预览扰动曲线，帮助你调参。\n\n### 4. **推荐参数组合**\n狂风效果：\n- 扰动强度: 30-50\n- 扰动频率: 5-10\n- 扰动层数: 4-6\n\n微风效果：\n- 扰动强度: 5-10\n- 扰动频率: 1-2\n- 扰动层数: 2-3"])</script><script>self.__next_f.push([1,"24:T895,"])</script><script>self.__next_f.push([1,"用户提出了几个重要的改进建议：\n\n1. **模式混合需要拆分成三个独立参数**：\n   - 全局风向强度（可以单独为0）\n   - 局部Sin强度（可以单独为0）\n   - Spring强度（核心弹簧效果，应该始终保留或可调）\n   \n   这样用户可以：\n   - 只要Spring（全局风=0，局部Sin=0）\n   - Spring + 全局风\n   - Spring + 局部Sin\n   - Spring + 全局风 + 局部Sin混合\n   - 等等任意组合\n\n2. **扰动效果需要大幅改进**：\n   - 现在的扰动太弱，感觉不到多股风的冲击\n   - 需要更强的波峰波谷效果\n   - 需要频率控制参数\n   - 用户想要\"很多股风冲撞\"的感觉，这意味着需要：\n     - 多层噪波叠加\n     - 更高的扰动强度\n     - 频率控制（让波峰波谷更密集）\n     - 可能需要添加多个噪波层（不同频率叠加）\n\n让我重新设计这个系统：\n\n### 模式控制改为三个独立参数：\n```\n全局风向强度: 0-1 (控制风向控制器的影响)\n局部Sin强度: 0-1 (控制每根骨骼的Sin波)\nSpring强度: 0-1 (保持1就是完整弹簧效果，这个一般不需要改)\n\n\n```\n\n或者更好的方式是让Spring始终计算，全局风力和局部Sin作为叠加在其上的混合参数。\n\n### 扰动系统改进：\n需要创建一个更强大的扰动系统，包括扰动强度来控制力度、扰动频率来控制波峰波谷的密度，以及多层噪波叠加来实现用户想要的\"多股风冲撞\"效果。\n\n实现多层噪波叠加，每层都有独立的频率和振幅，通过时间和移动速度参数来驱动噪波演变，这样能产生更复杂、更自然的扰动效果。\n\n```\n\nmaxscript\n-- 改进的扰动函数\nfn calculate_turbulence absTime turbStrength turbFreq turbLayers turbSpeed =\n(\n    local totalTurb = 0\n    for layer = 1 to turbLayers do\n    (\n        local layerFreq = turbFreq * layer\n        local layerAmp = turbStrength / layer\n        local noisePos = [absTime * layerFreq * turbSpeed * 0.1, layer * 100, 0]\n        local noiseValue = noise3 noisePos\n        totalTurb += noiseValue * layerAmp\n    )\n    return totalTurb\n)\n```\n\n现在需要将这些改进整合到完整的脚本中。"])</script><script>self.__next_f.push([1,"25:Ta56d,"])</script><script>self.__next_f.push([1,"你说得对！把这些参数放到风向控制器上就可以K帧了。让我重新设计：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V6.8 Ultimate\n    - 混合控制参数可K帧\n    - 扰动参数可K帧\n    - 所有核心参数都在风向控制器上\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V6.8\" width:600\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (所有可K帧参数都在控制器上)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:270 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:270 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数\" style_sunken:true align:#center color:(color 50 200 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:180 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:180 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:180 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:100\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:100\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:100\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:170\n        spinner spn_gravity \"重力.Z\" type:#float range:[-990.0,999,0] width:170\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:170\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:170\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:170\n    )\n    \n    group \"5. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:170\n        label lbl_empty1 \"\" width:170\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n    )\n    \n    group \"6. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:80\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:130\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:130\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:580\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:580 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:90 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:90\n        button btn_EulerFilter \"欧拉过滤\" width:90\n        button btn_TCB \"转TCB\" width:90\n        button btn_Euler \"转欧拉\" width:90\n        button btn_reset \"重置参数\" width:90 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        -- ★ 完整的可K帧参数定义\n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                )\n                rollout rlt \"风力参数 (可K帧)\" width:280\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01 \\\n                                toolTip:\"弹簧物理效果 (通常保持1)\"\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01 \\\n                                toolTip:\"风向控制器驱动的Sin风力\"\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01 \\\n                                toolTip:\"每根骨骼独立的Sin波动\"\n                        label lbl_mixTip \"提示: 可K帧实现渐变过渡\" align:#left\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动 (多股风冲撞)\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float \\\n                                toolTip:\"总体力度，越大波动越剧烈\"\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float \\\n                                toolTip:\"波峰波谷密度，越大冲击越频繁\"\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float \\\n                                toolTip:\"变化快慢\"\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer \\\n                                toolTip:\"叠加层数，越多越复杂\"\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float \\\n                                toolTip:\"高频细节强度\"\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer \\\n                                toolTip:\"不同种子不同模式\"\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    -- ★ 多层扰动计算函数\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 do return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 do up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1:\n            (\n                if spn_localX_switch.value == 0 do return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2:\n            (\n                if spn_localY_switch.value == 0 do return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3:\n            (\n                if spn_localZ_switch.value == 0 do return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do (\n            if (findItem roots r.parent) == 0 do (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 \n            then append parentArray obj\n            else append childArray obj  \n        )\n        while childArray.count \u003e 0 do\n        (\n            local i=1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else(i += 1)\n            )\n        )\n        \n        local a = 1\n        for l=1 to parentArray.count do\n        (\n            if (finditem parentArray (parentArray[l].children)[1]) != 0 then\n                append listArray parentArray[l]\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" do CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" do \n                    (\n                        try (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then bn.transform = targetTM\n                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器已创建！\\n\\n选中控制器后，在右侧修改面板中可以：\\n- K帧混合控制参数\\n- K帧风力参数\\n- K帧扰动参数\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 do (messageBox \"请选择骨骼根部\"; return false)\n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj do (messageBox \"请先拾取风向控制器\"; return false)\n        \n        -- 验证控制器有必要的属性\n        if not isProperty ctrlObj \"springMix\" do \n        (\n            messageBox \"控制器缺少必要属性，请重新创建风向控制器\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local gravity = spn_gravity.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                )\n                \n                if chain.count \u003e 1 then\n                (\n                    local lastRelTM = copy boneRelTMs[boneRelTMs.count]\n                    append boneRelTMs lastRelTM \n                    local endWorldTM = lastRelTM * chain[chain.count].transform\n                    append simTMs endWorldTM\n                )\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    local endTM = matrix3 1\n                    endTM.pos = [bbox[2].x, 0, 0]\n                    append boneRelTMs endTM\n                    local endWorldTM = endTM * chain[1].transform\n                    append simTMs endWorldTM\n                )\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                (\n                    local bbox = nodeGetBoundingBox chain[1] chain[1].transform\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * bbox[2].x)\n                )\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- 缝合逻辑\n            if isWritePass and chk_loops.checked do\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                -- ★ 从控制器读取所有可K帧参数\n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                -- 混合参数 (可K帧)\n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                -- 风力参数 (可K帧)\n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                -- 扰动参数 (可K帧)\n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                            currentPTM = matrix3 1\n                        \n                        for j = 1 to chain.count do\n                        (\n                            -- 计算局部Sin旋转\n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 do\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos\n                            local tpos = targetBoneTM.pos\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 do\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 do rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((chain.count - j) / (chain.count as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 do angY1 = -angY1\n                                if abs angY1 \u003e 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - delay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind (全局模式)\n                            if j == 1 and globalWindMix \u003e 0 do\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            springAngle = applySoftLimit springAngle maxAngle softness\n                            sangle = applySoftLimit sangle maxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 do rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 do rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- 写入关键帧\n                            if isWritePass and sf == subs do\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 do\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        else \n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                    ) catch ()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j \u003c chain.count do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 do (messageBox \"请先选择父对象！\"; return false)\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择骨骼！\"; return false)\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined do\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_gravity.value = 0\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V6.8 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V6.8\\n\"\nformat \"========================================\\n\"\nformat \"★ 可K帧参数 (在风向控制器修改面板中):\\n\"\nformat \"  - 混合控制: Spring/全局风/局部Sin\\n\"\nformat \"  - 风力参数: 基础风压/Sin幅度/周期\\n\"\nformat \"  - 扰动参数: 强度/频率/速度/层数/粗糙度\\n\"\nformat \"========================================\\n\"\nformat \"使用方法:\\n\"\nformat \"1. 创建风向控制器\\n\"\nformat \"2. 选中控制器，在修改面板调整/K帧参数\\n\"\nformat \"3. 选择骨骼根部，点击生成\\n\"\nformat \"========================================\\n\"\n```\n\n## 主要改进：\n\n### 1. **所有核心参数都在风向控制器上，可K帧**\n\n选中Wind_Controller后，在修改面板中可以看到并K帧：\n\n**混合控制:**\n- Spring弹簧 (0-1)\n- 全局风向 (0-1)  \n- 局部Sin (0-1)\n\n**风力参数:**\n- 总体强度\n- 基础风压\n- Sin幅度\n- 周期\n\n**扰动参数:**\n- 扰动强度\n- 扰动频率\n- 扰动速度\n- 扰动层数\n- 粗糙度\n- 随机种子\n\n### 2. **使用方法**\n\n```\n场景A: 从无风到有风\n- 在第0帧: globalWindMix = 0\n- 在第30帧: globalWindMix = 1\n- 风会渐渐吹起来\n\n场景B: 风力渐强\n- 在第0帧: turbStrength = 5\n- 在第50帧: turbStrength = 40\n- 扰动会越来越剧烈\n\n场景C: 模式切换\n- 第0-50帧: localSinMix=0, globalWindMix=1 (全局风)\n- 第50-100帧: localSinMix=1, globalWindMix=0 (局部Sin)\n\n场景D: 纯Spring\n- springMix=1, globalWindMix=0, localSinMix=0\n```\n\n### 3. **UI简化**\n主面板不再显示混合控制和扰动参数，因为它们都在控制器上可K帧调整。"])</script><script>self.__next_f.push([1,"26:Tb961,"])</script><script>self.__next_f.push([1,"你说得对！末端骨骼因为没有子级约束，会出现过度旋转的问题。我来添加虚拟末端点和末端阻尼控制：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.0 Ultimate\n    - 虚拟末端点解决末端折叠问题\n    - 末端阻尼控制\n    - 所有核心参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.0\" width:600\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (所有可K帧参数都在控制器上)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:270 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:270 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数\" style_sunken:true align:#center color:(color 50 200 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:180 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:180 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:180 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:100\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:100\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:100\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:170\n        spinner spn_gravity \"重力.Z\" type:#float range:[-990.0,999,0] width:170\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:170\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:170\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:170\n    )\n    \n    group \"5. ★ 末端控制 (解决末端折叠)\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:170 \\\n                toolTip:\"末端骨骼的额外阻尼，越大越稳定\"\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:170 \\\n                toolTip:\"从第几根骨骼开始应用末端阻尼\"\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:170 \\\n                toolTip:\"虚拟末端点的延伸长度倍率\"\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:170\n        label lbl_empty1 \"\" width:170\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:80\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:130\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:130\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:580\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:580 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:90 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:90\n        button btn_EulerFilter \"欧拉过滤\" width:90\n        button btn_TCB \"转TCB\" width:90\n        button btn_Euler \"转欧拉\" width:90\n        button btn_reset \"重置参数\" width:90 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    -- 获取骨骼长度\n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n            return distance bone.pos bone.children[1].pos\n        else\n        (\n            -- 尝试从bounding box获取长度\n            try (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                local len = abs(bbox[2].x - bbox[1].x)\n                if len \u003e 0.1 then return len\n            ) catch()\n            \n            -- 如果有父级，用父级到自己的距离\n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            \n            return 10.0  -- 默认长度\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                )\n                rollout rlt \"风力参数 (可K帧)\" width:280\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 do return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 do up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1:\n            (\n                if spn_localX_switch.value == 0 do return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2:\n            (\n                if spn_localY_switch.value == 0 do return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3:\n            (\n                if spn_localZ_switch.value == 0 do return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    -- ★ 计算末端阻尼因子\n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        -- 从倒数第endFalloff根骨骼开始应用阻尼\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        \n        -- 线性插值阻尼\n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do (\n            if (findItem roots r.parent) == 0 do (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 \n            then append parentArray obj\n            else append childArray obj  \n        )\n        while childArray.count \u003e 0 do\n        (\n            local i=1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else(i += 1)\n            )\n        )\n        \n        local a = 1\n        for l=1 to parentArray.count do\n        (\n            if (finditem parentArray (parentArray[l].children)[1]) != 0 then\n                append listArray parentArray[l]\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" do CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" do \n                    (\n                        try (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then bn.transform = targetTM\n                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器已创建！\\n\\n选中控制器后，在右侧修改面板中可以K帧调整参数。\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 do (messageBox \"请选择骨骼根部\"; return false)\n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj do (messageBox \"请先拾取风向控制器\"; return false)\n        \n        if not isProperty ctrlObj \"springMix\" do \n        (\n            messageBox \"控制器缺少必要属性，请重新创建风向控制器\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local gravity = spn_gravity.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        -- ★ 末端控制参数\n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()  -- ★ 存储每根骨骼的长度\n        local allVirtualEndHelpers = #() -- ★ 调试用的虚拟末端helper\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        format \"末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\\n\" endDamping endFalloff virtualEndScale\n        \n        -- === 初始化数据 (改进虚拟末端) ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                \n                -- 收集骨骼数据和长度\n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    \n                    -- 计算骨骼长度\n                    local boneLen = getBoneLength b\n                    append boneLengths boneLen\n                )\n                \n                -- ★ 创建虚拟末端 (使用最后一根骨骼的长度)\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                -- 虚拟末端的相对变换 (沿X轴延伸)\n                local virtualEndRelTM = matrix3 1\n                virtualEndRelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEndRelTM\n                append boneLengths virtualLen\n                \n                -- 虚拟末端的世界变换\n                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform\n                append simTMs virtualEndWorldTM\n                \n                -- ★ 再添加一个虚拟末端的末端 (用于计算虚拟末端本身)\n                local virtualEnd2RelTM = matrix3 1\n                virtualEnd2RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd2RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM\n                append simTMs virtualEnd2WorldTM\n                \n                -- 初始位置 (用第二根骨骼或虚拟末端)\n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                \n                -- ★ 调试: 创建虚拟末端helper\n                if debugVirtualEnd do\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true \\\n                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼 + 2个虚拟末端点, 最后骨骼长度=%, 虚拟长度=%\\n\" \\\n                       cIdx chain.count lastBoneLen virtualLen\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- 缝合逻辑\n            if isWritePass and chk_loops.checked do\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                -- 从控制器读取参数\n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        \n                        -- ★ 总节点数 = 真实骨骼 + 2个虚拟末端\n                        local totalNodes = chain.count + 2\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                            currentPTM = matrix3 1\n                        \n                        -- ★ 遍历所有节点 (包括虚拟末端)\n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            -- 计算局部Sin旋转 (只对真实骨骼)\n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone do\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos\n                            local tpos = targetBoneTM.pos\n                            \n                            -- ★ 计算末端阻尼 (真实骨骼和虚拟末端都应用)\n                            local boneDamping = 0.0\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5  -- 虚拟末端额外阻尼\n                            \n                            -- 实际使用的delay (加上末端阻尼)\n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 do\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 do rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 do angY1 = -angY1\n                                if abs angY1 \u003e 0.001 do rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                -- ★ 使用有效delay (包含末端阻尼)\n                                springAngle *= (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind (全局模式，只对第一根骨骼)\n                            if j == 1 and globalWindMix \u003e 0 do\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            -- ★ 对末端应用更严格的角度限制\n                            local effectiveMaxAngle = maxAngle\n                            if isVirtualEnd do effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count do effectiveMaxAngle = maxAngle * 0.7\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 do rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 do rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- ★ 只对真实骨骼写入关键帧\n                            if isWritePass and sf == subs and isRealBone do\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 do\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        else \n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                    ) catch ()\n                                )\n                            )\n                            \n                            -- ★ 调试: 更新虚拟末端helper位置\n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 do\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count do\n                                (\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 do allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j \u003c totalNodes do simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        -- 清理调试helper\n        if not debugVirtualEnd do\n        (\n            for h in allVirtualEndHelpers do try(delete h)catch()\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 do (messageBox \"请先选择父对象！\"; return false)\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择骨骼！\"; return false)\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined do\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = TCB_Rotation()\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 do (messageBox \"请先选择对象！\"; return false)\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n            if obj.rotation.controller != undefined do obj.Rotation.Controller = Euler_XYZ()\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_gravity.value = 0\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V7.0 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V7.0\\n\"\nformat \"========================================\\n\"\nformat \"★ 新增末端控制:\\n\"\nformat \"  - 末端阻尼: 稳定末端骨骼\\n\"\nformat \"  - 末端衰减: 从第几根开始应用阻尼\\n\"\nformat \"  - 虚拟末端长度: 调整虚拟点距离\\n\"\nformat \"  - 调试显示: 可视化虚拟末端位置\\n\"\nformat \"========================================\\n\"\n```\n\n## 主要改进：\n\n### 1. **虚拟末端系统**\n- 在每条骨骼链末端添加 **2个虚拟末端点**\n- 虚拟末端沿骨骼X轴方向延伸\n- 长度基于最后一根骨骼的长度 × 倍率\n- 虚拟末端参与Spring计算但不写入关键帧\n\n### 2. **末端控制参数**\n\n| 参数 | 范围 | 说明 |\n|------|------|------|\n| 末端阻尼 | 0-1 | 越大末端越稳定，0.5为推荐值 |\n| 末端衰减 | 1-10 | 从倒数第几根骨骼开始应用阻尼 |\n| 虚拟末端长度 | 0.1-3.0 | 虚拟点距离倍率 |\n\n### 3. **阻尼计算逻辑**\n```\n- 普通骨骼: 使用基础delay\n- 接近末端的骨骼: delay + 末端阻尼 × 渐变\n- 虚拟末端: 末端阻尼 × 1.5 (额外稳定)\n```\n\n### 4. **角度限制**\n```\n- 普通骨骼: 最大角度 100%\n- 最后一根真实骨骼: 最大角度 70%\n- 虚拟末端: 最大角度 50%\n```\n\n### 5. **调试功能**\n勾选\"调试:显示虚拟末端\"后，会创建紫色Point显示虚拟末端位置，方便观察。\n\n### 推荐参数：\n- **飘带/头发**: 末端阻尼=0.5, 衰减=3\n- **很长的链条**: 末端阻尼=0.7, 衰减=5\n- **硬质物体**: 末端阻尼=0.8, 衰减=2"])</script><script>self.__next_f.push([1,"27:Tb8d0,"])</script><script>self.__next_f.push([1,"抱歉，我发现了语法错误。问题在于 `if ... do` 后面不能接 `else`，需要用 `if ... then ... else`。让我修复：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.0 Ultimate\n    - 虚拟末端点解决末端折叠问题\n    - 末端阻尼控制\n    - 所有核心参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.0\" width:600\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (所有可K帧参数都在控制器上)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:270 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:270 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数\" style_sunken:true align:#center color:(color 50 200 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:180 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:180 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:180 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:100\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:100\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:100\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:170\n        spinner spn_gravity \"重力.Z\" type:#float range:[-990.0,999,0] width:170\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:170\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:170\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:170\n    )\n    \n    group \"5. ★ 末端控制 (解决末端折叠)\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:170 \\\n                toolTip:\"末端骨骼的额外阻尼，越大越稳定\"\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:170 \\\n                toolTip:\"从第几根骨骼开始应用末端阻尼\"\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:170 \\\n                toolTip:\"虚拟末端点的延伸长度倍率\"\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:170\n        label lbl_empty1 \"\" width:170\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:80\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:130\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:130\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:580\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:580 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:90 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:90\n        button btn_EulerFilter \"欧拉过滤\" width:90\n        button btn_TCB \"转TCB\" width:90\n        button btn_Euler \"转欧拉\" width:90\n        button btn_reset \"重置参数\" width:90 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    -- 获取骨骼长度\n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n        (\n            return distance bone.pos bone.children[1].pos\n        )\n        else\n        (\n            -- 尝试从bounding box获取长度\n            local len = 0.0\n            try \n            (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) \n            catch()\n            \n            if len \u003e 0.1 then return len\n            \n            -- 如果有父级，用父级到自己的距离\n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            \n            return 10.0  -- 默认长度\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                )\n                rollout rlt \"风力参数 (可K帧)\" width:280\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then \n            return angle\n        \n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1:\n            (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2:\n            (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3:\n            (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    -- ★ 计算末端阻尼因子\n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        \n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else\n                (\n                    i += 1\n                )\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if (finditem parentArray (parentArray[l].children)[1]) != 0 then\n            (\n                append listArray parentArray[l]\n            )\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do \n            (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try \n                        (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then \n                                bn.transform = targetTM\n                            else if classof bn == Biped_Object then \n                                biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) \n                        catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try \n                    (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then \n                        (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) \n                    catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器已创建！\\n\\n选中控制器后，在右侧修改面板中可以K帧调整参数。\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then \n        (\n            messageBox \"请选择骨骼根部\"\n            return false\n        )\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then \n        (\n            messageBox \"请先拾取风向控制器\"\n            return false\n        )\n        \n        if not isProperty ctrlObj \"springMix\" then \n        (\n            messageBox \"控制器缺少必要属性，请重新创建风向控制器\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local gravity = spn_gravity.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        -- ★ 末端控制参数\n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        format \"末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\\n\" endDamping endFalloff virtualEndScale\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    \n                    local boneLen = getBoneLength b\n                    append boneLengths boneLen\n                )\n                \n                -- ★ 虚拟末端\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                local virtualEndRelTM = matrix3 1\n                virtualEndRelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEndRelTM\n                append boneLengths virtualLen\n                \n                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform\n                append simTMs virtualEndWorldTM\n                \n                local virtualEnd2RelTM = matrix3 1\n                virtualEnd2RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd2RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM\n                append simTMs virtualEnd2WorldTM\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true \\\n                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼 + 2个虚拟末端点\\n\" cIdx chain.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            if isWritePass and chk_loops.checked then\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try \n                            (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                (\n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                                )\n                            ) \n                            catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        \n                        local totalNodes = chain.count + 2\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                        (\n                            currentPTM = matrix3 1\n                        )\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            local currentPos = if j == 1 then prePos else simTMs[j+1].pos\n                            local tpos = targetBoneTM.pos\n                            \n                            -- ★ 计算末端阻尼\n                            local boneDamping = 0.0\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5\n                            \n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            -- ★ 末端角度限制 (修复语法)\n                            local effectiveMaxAngle = maxAngle\n                            if isVirtualEnd then\n                                effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count then\n                                effectiveMaxAngle = maxAngle * 0.7\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- ★ 只对真实骨骼写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try \n                                    (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 then\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                        (\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        )\n                                        else \n                                        (\n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                        )\n                                    ) \n                                    catch ()\n                                )\n                            )\n                            \n                            -- ★ 调试helper\n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count then\n                                (\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j \u003c totalNodes then simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then\n        (\n            for h in allVirtualEndHelpers do \n            (\n                try(delete h)catch()\n            )\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择父对象！\"\n            return false\n        )\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择骨骼！\"\n            return false\n        )\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = TCB_Rotation()\n        )\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = Euler_XYZ()\n        )\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_gravity.value = 0\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V7.0 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V7.0\\n\"\nformat \"========================================\\n\"\nformat \"★ 末端控制功能:\\n\"\nformat \"  - 末端阻尼: 稳定末端骨骼\\n\"\nformat \"  - 末端衰减: 从第几根开始应用阻尼\\n\"\nformat \"  - 虚拟末端长度: 调整虚拟点距离\\n\"\nformat \"========================================\\n\"\n```\n\n## 修复的语法错误：\n\n1. **`if ... do` 改为 `if ... then`**：MaxScript中 `if` 后面需要用 `then`（带返回值/多行）或 `do`（单行无返回值），但 `else` 只能跟在 `then` 后面\n\n2. **多处语法统一**：\n   - `if condition do action` → 无else的单行\n   - `if condition then action else action` → 有else的情况\n   - `if condition then (block) else (block)` → 多行块\n\n3. **主要修改位置**：\n   ```maxscript\n   -- 原来错误的写法:\n   if isVirtualEnd do effectiveMaxAngle = maxAngle * 0.5\n   else if j == chain.count do effectiveMaxAngle = maxAngle * 0.7\n   \n   -- 修复后:\n   if isVirtualEnd then\n       effectiveMaxAngle = maxAngle * 0.5\n   else if j == chain.count then\n       effectiveMaxAngle = maxAngle * 0.7\n   ```\n\n现在脚本应该可以正常运行了。"])</script><script>self.__next_f.push([1,"28:T817,"])</script><script>self.__next_f.push([1,"用户报告了一个语法错误，位于第869行附近，错误是\"语法错误: 位于 else，需要 \u003c因子\u003e\"。\n\n这通常是因为在MaxScript中，`if` 语句的语法问题。让我检查代码中可能出现问题的地方。\n\n在MaxScript中，如果使用单行if语句，语法是：\n```\nif condition then value1 else value2\n```\n\n但如果是多行，需要用括号：\n```\nif condition then\n(\n    ...\n)\nelse\n(\n    ...\n)\n```\n\n让我检查代码中的问题。错误提示在第869行附近。\n\n看代码，可能的问题是在 `getBoneLength` 函数中：\n\n```maxscript\nfn getBoneLength bone =\n(\n    if bone.children.count \u003e 0 then\n        return distance bone.pos bone.children[1].pos\n    else\n    (\n        -- 尝试从bounding box获取长度\n        try (\n            local bbox = nodeGetBoundingBox bone bone.transform\n            local len = abs(bbox[2].x - bbox[1].x)\n            if len \u003e 0.1 then return len\n        ) catch()\n        \n        -- 如果有父级，用父级到自己的距离\n        if bone.parent != undefined then\n        (\n            local parentDist = distance bone.pos bone.parent.pos\n            if parentDist \u003e 0.1 then return parentDist\n        )\n        \n        return 10.0  -- 默认长度\n    )\n)\n```\n\n问题可能在于 `if len \u003e 0.1 then return len` 后面没有 else，但这个应该是可以的...\n\n\n还有另一个可能的问题：在某些地方使用了 `if ... do` 而不是 `if ... then`，比如 `if cIdx \u003c= allVirtualEndHelpers.count do` 这样的语法在MaxScript中应该改为 `if ... then` 或者用其他正确的控制流语句。\n\n特别是在处理 `effectiveMaxAngle` 的赋值时，`if isVirtualEnd do effectiveMaxAngle = maxAngle * 0.5` 这种写法是错误的，因为 `if ... do` 后面不能接 `else`。应该改成标准的 `if ... then ... else if ... then` 的形式来正确处理这些条件分支。\n\n或者用 `case` 语句会更清晰，根据是否是虚拟端点、是否是链的最后一个关节来分别设置为 `maxAngle * 0.5`、`maxAngle * 0.7` 或默认的 `maxAngle`。"])</script><script>self.__next_f.push([1,"29:T1f3a,"])</script><script>self.__next_f.push([1,"========================================\n初始化模拟状态 (基于帧 0)...\n末端控制: 阻尼=0.5 衰减起始=3 虚拟末端长度倍率=1.0\n链 1: 7 根骨骼 + 2个虚拟末端点\n开始模拟 (循环次数: 2, 链数: 1)...\n-- j loop; 文件名: ; 位置: 32650; line: 824 中发生错误\n--  帧:\n--   localSinRotX: undefined\n--   vt1: undefined\n--   newTM1: undefined\n--   tvector: undefined\n--   isRealBone: false\n--   springVT: undefined\n--   localSinQuat: (quat 0 0 0 1)\n--   ssvt: undefined\n--   currentPos: undefined\n--   dot1: undefined\n--   dot2: undefined\n--   finalRotation: undefined\n--   dot3: undefined\n--   effectiveMaxAngle: undefined\n--   sangle: undefined\n--   windAngle: undefined\n--   j: 9\n--   isVirtualEnd: true\n--   windRotMat: undefined\n--   cvector: undefined\n--   ttm: undefined\n--   targetboneTM: (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.8041,-0.0387631,16.8059])\n--   effectiveDelay: undefined\n--   angX: undefined\n--   finalTM: undefined\n--   localSinRotY: undefined\n--   tpos: undefined\n--   boneDamping: undefined\n--   angY1: undefined\n--   localSinRotZ: undefined\n--   springAngle: undefined\n--   xaxisdelay: undefined\n--   tempTM: undefined\n--   在  cidx loop; 文件名: ; 位置: 41132; 行: 966 中调用\n--  帧:\n--   temp_x: undefined\n--   targetRelTMs: #((matrix3 [0.592197,0.000221683,-0.805793] [0.805793,1.06989e-006,0.592197] [0.000132142,-1,-0.000177997] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.998517,-0.054437,-0.000290907] [0.0544369,0.998517,7.97361e-005] [0.000286135,-9.5454e-005,1] [11.2772,3.8147e-006,0]), (matrix3 [0.975443,-0.220251,8.961e-005] [0.220251,0.975443,-1.90787e-005] [-8.32073e-005,3.83469e-005,1] [11.5231,-7.62939e-006,0]), (matrix3 [0.97496,-0.222379,0.00016429] [0.222379,0.97496,-0.0001807] [-0.000119993,0.00021271,1] [11.6788,7.62939e-006,2.49594e-007]), (matrix3 [0.999925,0.012298,7.33372e-005] [-0.012298,0.999925,5.5463e-005] [-7.26496e-005,-5.63606e-005,1] [8.42004,0,3.50177e-007]), (matrix3 [0.9954,-0.0958044,2.5727e-005] [0.0958044,0.9954,-0.000153374] [-1.09147e-005,0.000155134,1] [8.99675,-0.000106812,3.67872e-007]), (matrix3 [1,-0.000351239,0.00033469] [0.000351131,1,0.000302826] [-0.000334797,-0.000302708,1] [7.61336,6.86646e-005,3.72762e-007]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]))\n--   currentPTM_start: undefined\n--   simTMs: #((matrix3 [0.557944,0.307106,-0.770963] [0.821015,-0.0688555,0.566739] [0.120964,-0.949181,-0.290557] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.54738,-0.100305,-0.830852] [0.831498,-0.0472777,0.553513] [-0.0948011,-0.993833,0.0575248] [26.8333,3.46329,69.9073]), (matrix3 [0.356759,-0.155269,-0.921203] [0.928409,-0.0506648,0.36809] [-0.103825,-0.986572,0.126078] [33.1408,2.30746,60.3333]), (matrix3 [0.151673,-0.0789285,-0.985274] [0.986071,-0.0567579,0.156342] [-0.068262,-0.995263,0.0692205] [37.3073,0.494113,49.5748]), (matrix3 [0.155363,-0.0219836,-0.987613] [0.987154,-0.0342777,0.156054] [-0.0372837,-0.999171,0.0163757] [38.5844,-0.170469,41.2787]), (matrix3 [0.0558305,0.0116808,-0.998372] [0.998272,-0.0190027,0.0556026] [-0.0183223,-0.999751,-0.0127216] [39.982,-0.368246,32.3934]), (matrix3 [0.0505352,0.0293371,-0.998292] [0.998697,-0.00862972,0.0503021] [-0.00713926,-0.999532,-0.0297349] [40.4072,-0.279317,24.7924]), (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.6093,-0.161969,20.7993]), (matrix3 [0.0489683,-0.000222649,-0.998801] [0.9988,0.000147182,0.0489683] [0.000136102,-1,0.00022959] [40.8041,-0.0387631,16.8059]))\n--   totalNodes: 9\n--   temp_z: undefined\n--   prePos: [27.2196,0.00249658,69.5145]\n--   currentPTM: (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.6093,-0.161969,20.7993])\n--   temp_y: undefined\n--   chain: #($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007)\n--   cidx: 1\n--   boneLengths: #(11.2772, 11.5231, 11.6788, 8.42004, 8.99675, 7.61336, 4.0, 4.0, 4.0)\n--   在  sf loop; 文件名: ; 位置: 41155; 行: 967 中调用\n--  帧:\n--   sf: 1\n--   在  t loop; 文件名: ; 位置: 41174; 行: 968 中调用\n--  帧:\n--   currTime: 1.0\n--   turbSpeed: 2.0\n--   windTM: (matrix3 [1,0,0] [0,1,0] [0,0,1] [0,0,0])\n--   globalStr: 1.0\n--   swingAmp: 8.0\n--   turbSeed: 0\n--   t: 0\n--   windDir: [0,-1,0]\n--   springMix: 1.0\n--   localSinMix: 0.0\n--   turbStrength: 15.0\n--   turbLayers: 3\n--   turbRoughness: 2.0\n--   baseWind: 20.0\n--   period: 30.0\n--   turbFreq: 3.0\n--   globalWindMix: 1.0\n--   在  l loop; 文件名: ; 位置: 41189; 行: 969 中调用\n--  帧:\n--   l: 1\n--   isWritePass: false\n--   在  btn_Bake.pressed(); 文件名: ; 位置: 41200; 行: 970 中调用\n--  帧:\n--   startF: 0\n--   delay: 0.3\n--   blend_x: 1.0\n--   debugVirtualEnd: false\n--   allPreTimeBoneTM: #(#((matrix3 [0.557944,0.307106,-0.770963] [0.821015,-0.0688555,0.566739] [0.120964,-0.949181,-0.290557] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.54738,-0.100305,-0.830852] [0.831498,-0.0472777,0.553513] [-0.0948011,-0.993833,0.0575248] [26.8333,3.46329,69.9073]), (matrix3 [0.356759,-0.155269,-0.921203] [0.928409,-0.0506648,0.36809] [-0.103825,-0.986572,0.126078] [33.1408,2.30746,60.3333]), (matrix3 [0.151673,-0.0789285,-0.985274] [0.986071,-0.0567579,0.156342] [-0.068262,-0.995263,0.0692205] [37.3073,0.494113,49.5748]), (matrix3 [0.155363,-0.0219836,-0.987613] [0.987154,-0.0342777,0.156054] [-0.0372837,-0.999171,0.0163757] [38.5844,-0.170469,41.2787]), (matrix3 [0.0558305,0.0116808,-0.998372] [0.998272,-0.0190027,0.0556026] [-0.0183223,-0.999751,-0.0127216] [39.982,-0.368246,32.3934]), (matrix3 [0.0505352,0.0293371,-0.998292] [0.998697,-0.00862972,0.0503021] [-0.00713926,-0.999532,-0.0297349] [40.4072,-0.279317,24.7924]), (matrix3 [0.0486959,0.0308015,-0.998339] [0.998812,-0.00312664,0.0486225] [-0.0016238,-0.999521,-0.0309172] [40.6093,-0.161969,20.7993]), (matrix3 [0.0489683,-0.000222649,-0.998801] [0.9988,0.000147182,0.0489683] [0.000136102,-1,0.00022959] [40.8041,-0.0387631,16.8059])))\n--   allPrePos: #([26.8333,3.46329,69.9073])\n--   allChains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))\n--   allBoneLengths: #(#(11.2772, 11.5231, 11.6788, 8.42004, 8.99675, 7.61336, 4.0, 4.0, 4.0))\n--   maxAngle: 80.0\n--   allVirtualEndHelpers: #()\n--   gravity: 0.0\n--   blend_y: 1.0\n--   endDamping: 0.5\n--   virtualEndScale: 1.0\n--   softness: 0.3\n--   ctrlObj: $Wind_Controller196\n--   chains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))\n--   xSpring: 0.3\n--   subframe: 1.0\n--   totalFrames: 202\n--   scaleMotion: 1.0\n--   blend_z: 1.0\n--   frameCounter: 1\n--   subs: 1\n--   loopsCount: 2\n--   endF: 100\n--   endFalloff: 3\n--   allBoneTM: #(#((matrix3 [0.592197,0.000221683,-0.805793] [0.805793,1.06989e-006,0.592197] [0.000132142,-1,-0.000177997] [20.5413,-3.43578e-006,78.6015]), (matrix3 [0.998517,-0.054437,-0.000290907] [0.0544369,0.998517,7.97361e-005] [0.000286135,-9.5454e-005,1] [11.2772,3.8147e-006,0]), (matrix3 [0.975443,-0.220251,8.961e-005] [0.220251,0.975443,-1.90787e-005] [-8.32073e-005,3.83469e-005,1] [11.5231,-7.62939e-006,0]), (matrix3 [0.97496,-0.222379,0.00016429] [0.222379,0.97496,-0.0001807] [-0.000119993,0.00021271,1] [11.6788,7.62939e-006,2.49594e-007]), (matrix3 [0.999925,0.012298,7.33372e-005] [-0.012298,0.999925,5.5463e-005] [-7.26496e-005,-5.63606e-005,1] [8.42004,0,3.50177e-007]), (matrix3 [0.9954,-0.0958044,2.5727e-005] [0.0958044,0.9954,-0.000153374] [-1.09147e-005,0.000155134,1] [8.99675,-0.000106812,3.67872e-007]), (matrix3 [1,-0.000351239,0.00033469] [0.000351131,1,0.000302826] [-0.000334797,-0.000302708,1] [7.61336,6.86646e-005,3.72762e-007]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0])))\n\u003e\u003e MAXScript 卷展栏处理程序 异常:\n-- 未知属性:“pos”位于 undefined \u003c\u003c"])</script><script>self.__next_f.push([1,"2a:Tbc21,"])</script><script>self.__next_f.push([1,"问题在于当 j = 9（最后一个虚拟末端）时，`simTMs[j+1].pos` 超出了数组范围。让我修复这个边界检查问题：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.0 Ultimate (Fixed)\n    - 修复虚拟末端数组越界问题\n    - 虚拟末端点解决末端折叠问题\n    - 所有核心参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.0\" width:600\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (所有可K帧参数都在控制器上)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:270 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:270 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动参数\" style_sunken:true align:#center color:(color 50 200 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:180 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:180 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:180 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:100\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:100\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:100\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:100\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:100\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:100\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:100\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:100\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:100\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:170\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:170\n        spinner spn_gravity \"重力.Z\" type:#float range:[-990.0,999,0] width:170\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:170\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:170\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:170\n    )\n    \n    group \"5. ★ 末端控制 (解决末端折叠)\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:170 \\\n                toolTip:\"末端骨骼的额外阻尼，越大越稳定\"\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:170 \\\n                toolTip:\"从第几根骨骼开始应用末端阻尼\"\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:170 \\\n                toolTip:\"虚拟末端点的延伸长度倍率\"\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:170\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:170\n        label lbl_empty1 \"\" width:170\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:170\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:170\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:80\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:130\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:130\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:580\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:580 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:90 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:90\n        button btn_EulerFilter \"欧拉过滤\" width:90\n        button btn_TCB \"转TCB\" width:90\n        button btn_Euler \"转欧拉\" width:90\n        button btn_reset \"重置参数\" width:90 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n        (\n            return distance bone.pos bone.children[1].pos\n        )\n        else\n        (\n            local len = 0.0\n            try \n            (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) \n            catch()\n            \n            if len \u003e 0.1 then return len\n            \n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            \n            return 10.0\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                )\n                rollout rlt \"风力参数 (可K帧)\" width:280\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then \n            return angle\n        \n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1:\n            (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2:\n            (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3:\n            (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        \n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else\n                (\n                    i += 1\n                )\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if parentArray[l].children.count \u003e 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then\n            (\n                append listArray parentArray[l]\n            )\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do \n            (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try \n                        (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then \n                                bn.transform = targetTM\n                            else if classof bn == Biped_Object then \n                                biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) \n                        catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try \n                    (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then \n                        (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) \n                    catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器已创建！\\n\\n选中控制器后，在右侧修改面板中可以K帧调整参数。\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then \n        (\n            messageBox \"请选择骨骼根部\"\n            return false\n        )\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then \n        (\n            messageBox \"请先拾取风向控制器\"\n            return false\n        )\n        \n        if not isProperty ctrlObj \"springMix\" then \n        (\n            messageBox \"控制器缺少必要属性，请重新创建风向控制器\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local gravity = spn_gravity.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        format \"末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\\n\" endDamping endFalloff virtualEndScale\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    \n                    local boneLen = getBoneLength b\n                    append boneLengths boneLen\n                )\n                \n                -- ★ 虚拟末端1\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                local virtualEndRelTM = matrix3 1\n                virtualEndRelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEndRelTM\n                append boneLengths virtualLen\n                \n                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform\n                append simTMs virtualEndWorldTM\n                \n                -- ★ 虚拟末端2\n                local virtualEnd2RelTM = matrix3 1\n                virtualEnd2RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd2RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM\n                append simTMs virtualEnd2WorldTM\n                \n                -- ★ 虚拟末端3 (用于最后一个虚拟点的计算)\n                local virtualEnd3RelTM = matrix3 1\n                virtualEnd3RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd3RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM\n                append simTMs virtualEnd3WorldTM\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true \\\n                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼 + 3个虚拟末端点, simTMs数量=%\\n\" cIdx chain.count simTMs.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            if isWritePass and chk_loops.checked then\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try \n                            (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                (\n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                                )\n                            ) \n                            catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        \n                        -- ★ 总节点数 = 真实骨骼 + 3个虚拟末端 (但只处理到倒数第二个)\n                        local totalNodes = simTMs.count - 1  -- 不处理最后一个，它只用来提供位置\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                        (\n                            currentPTM = matrix3 1\n                        )\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            \n                            -- ★ 修复: 安全获取currentPos\n                            local currentPos\n                            if j == 1 then\n                                currentPos = prePos\n                            else if j + 1 \u003c= simTMs.count then\n                                currentPos = simTMs[j+1].pos\n                            else\n                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n                            \n                            local tpos = targetBoneTM.pos\n                            \n                            -- 计算末端阻尼\n                            local boneDamping = 0.0\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5\n                            \n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos + [0, 0, -gravity])\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            -- 末端角度限制\n                            local effectiveMaxAngle = maxAngle\n                            if isVirtualEnd then\n                                effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count then\n                                effectiveMaxAngle = maxAngle * 0.7\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- 只对真实骨骼写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try \n                                    (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 then\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                        (\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        )\n                                        else \n                                        (\n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                        )\n                                    ) \n                                    catch ()\n                                )\n                            )\n                            \n                            -- 调试helper\n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count then\n                                (\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            \n                            -- ★ 修复: 安全更新下一个位置\n                            if j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then\n                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then\n        (\n            for h in allVirtualEndHelpers do \n            (\n                try(delete h)catch()\n            )\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择父对象！\"\n            return false\n        )\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择骨骼！\"\n            return false\n        )\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = TCB_Rotation()\n        )\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = Euler_XYZ()\n        )\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_gravity.value = 0\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V7.0 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V7.0 (Fixed)\\n\"\nformat \"========================================\\n\"\n```\n\n## 修复的问题：\n\n### 1. **数组越界修复**\n原来的问题是当 `j = 9`（最后一个虚拟末端）时，`simTMs[j+1].pos` 访问了不存在的第10个元素。\n\n**修复方案：**\n```maxscript\n-- ★ 修复: 安全获取currentPos\nlocal currentPos\nif j == 1 then\n    currentPos = prePos\nelse if j + 1 \u003c= simTMs.count then\n    currentPos = simTMs[j+1].pos\nelse\n    -- 最后一个节点，用当前节点沿X轴延伸估算位置\n    currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n```\n\n### 2. **增加一个虚拟末端点**\n现在添加了3个虚拟末端点（原来是2个），这样最后一个处理的节点总是有下一个位置可用。\n\n### 3. **处理范围修正**\n```maxscript\n-- 只处理到倒数第二个，最后一个只提供位置\nlocal totalNodes = simTMs.count - 1\n```\n\n### 4. **安全更新下一个位置**\n```maxscript\nif j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then\n    simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n```\n\n现在脚本应该可以正常运行了！"])</script><script>self.__next_f.push([1,"2b:Td348,"])</script><script>self.__next_f.push([1,"好的，我来添加惯性系统和更完善的重力控制：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.2 Ultimate\n    - 新增惯性系统（质量感）\n    - 完善重力控制（XYZ三轴 + 可K帧）\n    - 虚拟末端点解决末端折叠\n    - 所有核心参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.2\" width:620\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (所有可K帧参数都在控制器上)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:280 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:280 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 选中控制器后，在修改面板可K帧调整: 混合/风力/扰动/重力参数\" style_sunken:true align:#center color:(color 50 200 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:190 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:190 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:190 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:105\n        spinner spn_localX_rot \"旋转量\" range:[-90,90,5] width:105\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:105\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:105\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:105\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:5 width:105\n        spinner spn_localY_rot \"旋转量\" range:[-90,90,5] width:105\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:105\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:105\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:105\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:5 width:105\n        spinner spn_localZ_rot \"旋转量\" range:[-90,90,8] width:105\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:105\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:105\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:105\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:180\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:180\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:180\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:180\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:180\n        label lbl_empty0 \"\" width:180\n    )\n    \n    group \"5. ★ 惯性系统 (质量感)\"\n    (\n        spinner spn_inertia \"惯性强度\" range:[0.0, 0.99, 0.3] scale:0.01 align:#left across:3 width:180 \\\n                toolTip:\"越大惯性越强，运动停止后会有延续\"\n        spinner spn_inertiaDamping \"惯性衰减\" range:[0.8, 0.99, 0.95] scale:0.01 width:180 \\\n                toolTip:\"惯性的衰减速度，越小衰减越快\"\n        spinner spn_massDistribution \"质量分布\" range:[0.0, 2.0, 1.0] scale:0.1 width:180 \\\n                toolTip:\"0=均匀, 1=末端更重, 2=末端非常重\"\n        \n        label lbl_inertiaTip \"提示: 惯性让骨骼停止时有'晃动余韵'的质量感\" align:#center style_sunken:true\n    )\n    \n    group \"6. ★ 末端控制 (解决末端折叠)\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:180\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:180\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:180\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"7. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:180\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:180\n        label lbl_empty1 \"\" width:180\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:180\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:180\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:180\n    )\n    \n    group \"8. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:100\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:140\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:140\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:600\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:600 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:95 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:95\n        button btn_EulerFilter \"欧拉过滤\" width:95\n        button btn_TCB \"转TCB\" width:95\n        button btn_Euler \"转欧拉\" width:95\n        button btn_reset \"重置参数\" width:95 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n        (\n            return distance bone.pos bone.children[1].pos\n        )\n        else\n        (\n            local len = 0.0\n            try \n            (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) \n            catch()\n            \n            if len \u003e 0.1 then return len\n            \n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            \n            return 10.0\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParams\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                    \n                    -- ★ 重力参数 (XYZ可K帧)\n                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX\n                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY\n                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ\n                )\n                rollout rlt \"风力参数 (可K帧)\" width:280\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                    group \"★ 重力 (XYZ可K帧)\"\n                    (\n                        spinner spn_gravX \"重力 X:\" range:[-500,500,0] type:#float \\\n                                toolTip:\"X轴方向的力 (可K帧实现变化)\"\n                        spinner spn_gravY \"重力 Y:\" range:[-500,500,0] type:#float \\\n                                toolTip:\"Y轴方向的力\"\n                        spinner spn_gravZ \"重力 Z:\" range:[-500,500,0] type:#float \\\n                                toolTip:\"Z轴方向的力 (负值=向下)\"\n                        label lbl_gravTip \"提示: 负Z=向下, 正Y=向前\" align:#left\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then \n            return angle\n        \n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1:\n            (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2:\n            (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3:\n            (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        \n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    -- ★ 计算骨骼质量因子 (用于惯性)\n    fn calculateMassFactor boneIndex totalBones massDistribution =\n    (\n        if massDistribution == 0 then return 1.0\n        \n        local progress = boneIndex as float / totalBones as float\n        return 1.0 + (progress * massDistribution)\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else\n                (\n                    i += 1\n                )\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if parentArray[l].children.count \u003e 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then\n            (\n                append listArray parentArray[l]\n            )\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do \n            (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try \n                        (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then \n                                bn.transform = targetTM\n                            else if classof bn == Biped_Object then \n                                biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) \n                        catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try \n                    (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then \n                        (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) \n                    catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器已创建！\\n\\n选中控制器后，在右侧修改面板中可以K帧调整：\\n- 混合/风力/扰动参数\\n- 重力 XYZ (可K帧)\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then \n        (\n            messageBox \"请选择骨骼根部\"\n            return false\n        )\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then \n        (\n            messageBox \"请先拾取风向控制器\"\n            return false\n        )\n        \n        if not isProperty ctrlObj \"springMix\" then \n        (\n            messageBox \"控制器缺少必要属性，请重新创建风向控制器\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        -- ★ 惯性参数\n        local inertiaStrength = spn_inertia.value\n        local inertiaDamping = spn_inertiaDamping.value\n        local massDistribution = spn_massDistribution.value\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        \n        -- ★ 惯性速度存储\n        local allVelocities = #()\n        local allPrevPositions = #()\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        format \"末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\\n\" endDamping endFalloff virtualEndScale\n        format \"惯性系统: 强度=% 衰减=% 质量分布=%\\n\" inertiaStrength inertiaDamping massDistribution\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                local velocities = #()\n                local prevPositions = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    \n                    local boneLen = getBoneLength b\n                    append boneLengths boneLen\n                    \n                    -- ★ 初始化速度和前一帧位置\n                    append velocities [0,0,0]\n                    append prevPositions b.transform.pos\n                )\n                \n                -- ★ 虚拟末端1\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                local virtualEndRelTM = matrix3 1\n                virtualEndRelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEndRelTM\n                append boneLengths virtualLen\n                \n                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform\n                append simTMs virtualEndWorldTM\n                append velocities [0,0,0]\n                append prevPositions virtualEndWorldTM.pos\n                \n                -- ★ 虚拟末端2\n                local virtualEnd2RelTM = matrix3 1\n                virtualEnd2RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd2RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM\n                append simTMs virtualEnd2WorldTM\n                append velocities [0,0,0]\n                append prevPositions virtualEnd2WorldTM.pos\n                \n                -- ★ 虚拟末端3\n                local virtualEnd3RelTM = matrix3 1\n                virtualEnd3RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd3RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM\n                append simTMs virtualEnd3WorldTM\n                append velocities [0,0,0]\n                append prevPositions virtualEnd3WorldTM.pos\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                append allVelocities velocities\n                append allPrevPositions prevPositions\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true \\\n                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼 + 3个虚拟末端点\\n\" cIdx chain.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            if isWritePass and chk_loops.checked then\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try \n                            (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                (\n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                                )\n                            ) \n                            catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                -- ★ 从控制器读取重力 (可K帧)\n                local gravityX = at time t ctrlObj.gravityX\n                local gravityY = at time t ctrlObj.gravityY\n                local gravityZ = at time t ctrlObj.gravityZ\n                local gravityVec = [gravityX, gravityY, gravityZ]\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        local velocities = allVelocities[cIdx]\n                        local prevPositions = allPrevPositions[cIdx]\n                        \n                        local totalNodes = simTMs.count - 1\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                        (\n                            currentPTM = matrix3 1\n                        )\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            \n                            -- 安全获取currentPos\n                            local currentPos\n                            if j == 1 then\n                                currentPos = prePos\n                            else if j + 1 \u003c= simTMs.count then\n                                currentPos = simTMs[j+1].pos\n                            else\n                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n                            \n                            local tpos = targetBoneTM.pos\n                            \n                            -- 计算末端阻尼\n                            local boneDamping = 0.0\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5\n                            \n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            -- ★ 计算质量因子\n                            local massFactor = calculateMassFactor j totalNodes massDistribution\n                            \n                            -- ★ 应用惯性 (将速度加到当前位置)\n                            if inertiaStrength \u003e 0 then\n                            (\n                                local inertiaPos = velocities[j] * inertiaStrength * massFactor\n                                currentPos = currentPos + inertiaPos\n                            )\n                            \n                            -- ★ 添加重力到currentPos\n                            currentPos = currentPos + gravityVec * massFactor * 0.01\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos)\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            -- 末端角度限制\n                            local effectiveMaxAngle = maxAngle\n                            if isVirtualEnd then\n                                effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count then\n                                effectiveMaxAngle = maxAngle * 0.7\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- ★ 计算并存储速度 (用于下一帧的惯性)\n                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]\n                            local newVelocity = newPos - prevPositions[j]\n                            velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)\n                            prevPositions[j] = newPos\n                            \n                            -- 只对真实骨骼写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try \n                                    (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 then\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                        (\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        )\n                                        else \n                                        (\n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                        )\n                                    ) \n                                    catch ()\n                                )\n                            )\n                            \n                            -- 调试helper\n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count then\n                                (\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            \n                            if j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then\n                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                        \n                        -- ★ 更新速度数组引用\n                        allVelocities[cIdx] = velocities\n                        allPrevPositions[cIdx] = prevPositions\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then\n        (\n            for h in allVirtualEndHelpers do \n            (\n                try(delete h)catch()\n            )\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择父对象！\"\n            return false\n        )\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择骨骼！\"\n            return false\n        )\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = TCB_Rotation()\n        )\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = Euler_XYZ()\n        )\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_inertia.value = 0.3\n        spn_inertiaDamping.value = 0.95\n        spn_massDistribution.value = 1.0\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V7.2 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V7.2\\n\"\nformat \"========================================\\n\"\nformat \"★ 新增功能:\\n\"\nformat \"  - 惯性系统: 质量感/余韵晃动\\n\"\nformat \"  - 重力XYZ: 可K帧控制方向和强度\\n\"\nformat \"========================================\\n\"\nformat \"惯性参数说明:\\n\"\nformat \"  - 惯性强度: 0=无惯性, 0.5=中等, 0.9=很强\\n\"\nformat \"  - 惯性衰减: 越大衰减越慢\\n\"\nformat \"  - 质量分布: 0=均匀, 1=末端重, 2=末端很重\\n\"\nformat \"========================================\\n\"\nformat \"重力参数说明 (在控制器上可K帧):\\n\"\nformat \"  - 重力Z: 负值=向下, 推荐-50到-200\\n\"\nformat \"  - 重力Y: 正值=向前\\n\"\nformat \"  - 重力X: 正值=向右\\n\"\nformat \"========================================\\n\"\n```\n\n## 新增功能说明：\n\n### 1. **惯性系统 (质量感)**\n\n| 参数 | 范围 | 说明 |\n|------|------|------|\n| 惯性强度 | 0-0.99 | 越大惯性越强，运动停止后会有延续晃动 |\n| 惯性衰减 | 0.8-0.99 | 越大衰减越慢，余韵越长 |\n| 质量分布 | 0-2 | 0=均匀分布, 1=末端更重, 2=末端非常重 |\n\n**效果说明：**\n- 惯性=0：骨骼停止时立即静止\n- 惯性=0.3：停止后有轻微晃动\n- 惯性=0.6：停止后有明显余韵\n- 惯性=0.9：停止后长时间晃动（像果冻）\n\n**质量分布效果：**\n- 0：所有骨骼惯性相同\n- 1：末端骨骼惯性更大（像甩鞭子）\n- 2：末端骨骼惯性非常大（像重物挂在末端）\n\n### 2. **重力控制 (XYZ可K帧)**\n\n在风向控制器上新增三个可K帧的重力参数：\n\n| 参数 | 建议值 | 说明 |\n|------|--------|------|\n| 重力 X | -500~500 | 左右方向的力 |\n| 重力 Y | -500~500 | 前后方向的力 |\n| 重力 Z | -500~500 | 上下方向的力 (负值=向下) |\n\n**使用场景：**\n```\n场景1: 自然下垂\n  重力Z = -100\n\n场景2: 风从后方吹来\n  重力Y = 50, 重力Z = -50\n\n场景3: K帧实现重力变化\n  第0帧: 重力Z = 0 (无重力)\n  第30帧: 重力Z = -200 (突然下坠)\n```\n\n### 推荐参数组合\n\n**飘带/丝带:**\n```\n惯性强度: 0.4\n惯性衰减: 0.93\n质量分布: 1.0\n重力Z: -30\n```\n\n**长发:**\n```\n惯性强度: 0.3\n惯性衰减: 0.95\n质量分布: 0.5\n重力Z: -80\n```\n\n**厚重布料:**\n```\n惯性强度: 0.5\n惯性衰减: 0.90\n质量分布: 1.5\n重力Z: -150\n```\n\n**弹性绳索:**\n```\n惯性强度: 0.7\n惯性衰减: 0.97\n质量分布: 2.0\n重力Z: -50\n```"])</script><script>self.__next_f.push([1,"2c:T1339,"])</script><script>self.__next_f.push([1,"惯性系统我也希望可以K帧呢，然后我们的局部骨骼sin，我下午分正负轴向呢，比如-y和y的强度也可以单独设置一下\n========================================\n初始化模拟状态 (基于帧 0)...\n末端控制: 阻尼=0.5 衰减起始=3 虚拟末端长度倍率=1.0\n惯性系统: 强度=0.3 衰减=0.95 质量分布=1.0\n链 1: 7 根骨骼 + 3个虚拟末端点\n开始模拟 (循环次数: 2, 链数: 1)...\n-- t loop; 文件名: ; 位置: 33183; line: 843 中发生错误\n--  帧:\n--   swingAmp: 8.0\n--   springMix: 1.0\n--   turbLayers: 3\n--   gravityY: undefined\n--   windDir: [0,-1,0]\n--   period: 30.0\n--   gravityZ: undefined\n--   globalWindMix: 0.0\n--   turbRoughness: 2.0\n--   t: 0\n--   localSinMix: 0.0\n--   turbStrength: 15.0\n--   turbSeed: 2\n--   gravityVec: undefined\n--   currTime: 0.0\n--   windTM: (matrix3 [1,0,0] [0,1,0] [0,0,1] [0,0,0])\n--   turbFreq: 3.0\n--   gravityX: undefined\n--   globalStr: 1.0\n--   baseWind: 20.0\n--   turbSpeed: 2.0\n--   在  l loop; 文件名: ; 位置: 46421; 行: 1073 中调用\n--  帧:\n--   isWritePass: false\n--   l: 1\n--   在  btn_Bake.pressed(); 文件名: ; 位置: 46432; 行: 1074 中调用\n--  帧:\n--   inertiaStrength: 0.3\n--   allChains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))\n--   ctrlObj: $Wind_Controller\n--   subs: 1\n--   allBoneLengths: #(#(20.3258, 26.581, 15.8307, 22.8501, 22.7351, 16.6523, 4.0, 4.0, 4.0, 4.0))\n--   allVirtualEndHelpers: #()\n--   delay: 0.3\n--   massDistribution: 1.0\n--   chains: #(#($Bone001, $Bone002, $Bone003, $Bone004, $Bone005, $Bone006, $Bone007))\n--   xSpring: 0.3\n--   subframe: 1.0\n--   softness: 0.3\n--   scaleMotion: 1.0\n--   totalFrames: 202\n--   blend_x: 1.0\n--   frameCounter: 1\n--   blend_y: 1.0\n--   blend_z: 1.0\n--   inertiaDamping: 0.95\n--   loopsCount: 2\n--   virtualEndScale: 1.0\n--   debugVirtualEnd: false\n--   allVelocities: #(#([0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0], [0,0,0]))\n--   endF: 100\n--   allBoneTM: #(#((matrix3 [0.744569,0,-0.667545] [0.667545,-1.62921e-007,0.744569] [0,-1,-1.21306e-007] [-31.5721,-5.08113e-006,116.243]), (matrix3 [0.957454,-0.288585,0] [0.288585,0.957454,0] [0,0,1] [20.3258,0.000289917,0]), (matrix3 [0.92174,-0.387808,0] [0.387808,0.92174,0] [0,0,1] [26.581,3.8147e-006,8.10998e-007]), (matrix3 [0.999407,-0.0344413,0] [0.0344413,0.999407,0] [0,0,1] [15.8307,2.86102e-006,1.05333e-006]), (matrix3 [0.962204,-0.272332,-1.55791e-007] [0.272332,0.962204,0] [1.39403e-007,0,1] [22.8501,-9.53674e-007,1.58213e-006]), (matrix3 [0.897357,-0.441305,0] [0.441305,0.897357,1.80916e-007] [0,-1.67414e-007,1] [22.735,-1.43051e-006,1.99225e-006]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [16.6523,-3.8147e-006,1.71636e-006]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0]), (matrix3 [1,0,0] [0,1,0] [0,0,1] [4,0,0])))\n--   startF: 0\n--   maxAngle: 80.0\n--   endDamping: 0.5\n--   allPreTimeBoneTM: #(#((matrix3 [0.744569,0,-0.667545] [0.667545,-1.62921e-007,0.744569] [0,-1,-1.21306e-007] [-31.5721,-5.08113e-006,116.243]), (matrix3 [0.520247,0,-0.854016] [0.854016,-1.55989e-007,0.520247] [0,-1,-1.21306e-007] [-16.4379,-5.09381e-006,102.674]), (matrix3 [0.148339,1.33044e-007,-0.988937] [0.988937,-1.25548e-007,0.148339] [0,-1,-1.50196e-007] [-2.60924,-4.65507e-006,79.9739]), (matrix3 [0.114191,1.37289e-007,-0.993459] [0.993459,-1.21918e-007,0.114191] [0,-1,-1.50313e-007] [-0.260921,-3.60222e-006,64.3183]), (matrix3 [-0.160675,3.21093e-007,-0.987007] [0.987007,0,-0.160675] [-1.68528e-007,-1,-2.97885e-007] [2.34835,-2.04728e-006,41.6177]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-1.30462,3.26053e-006,19.1781]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-10.9589,7.40414e-006,5.60989]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-13.2779,8.81174e-006,2.35073]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-15.5969,1.02193e-005,-0.908438]), (matrix3 [-0.579755,3.519e-007,-0.814791] [0.814791,-1.45531e-007,-0.579755] [-3.22594e-007,-1,-2.02353e-007] [-17.9159,1.16269e-005,-4.1676])))\n--   endFalloff: 3\n--   allPrePos: #([-16.4379,-5.09381e-006,102.674])\n--   allPrevPositions: #(#([-31.5721,-5.08113e-006,116.243], [-16.4379,-5.09381e-006,102.674], [-2.60924,-4.65507e-006,79.9739], [-0.260921,-3.60222e-006,64.3183], [2.34835,-2.04728e-006,41.6177], [-1.30462,3.26053e-006,19.1781], [-10.9589,7.40414e-006,5.60989], [-13.2779,8.81174e-006,2.35073], [-15.5969,1.02193e-005,-0.908438], [-17.9159,1.16269e-005,-4.1676]))\n\u003e\u003e MAXScript 卷展栏处理程序 异常:\n-- 未知属性:“gravityX”位于 $点辅助对象:Wind_Controller @ [0.000000,0.000000,0.000000] \u003c\u003c"])</script><script>self.__next_f.push([1,"2d:Td501,"])</script><script>self.__next_f.push([1,"好的，我来修复这个问题并添加你要求的功能：\n\n1. 修复旧控制器兼容性问题\n2. 惯性参数放到控制器上（可K帧）\n3. 局部Sin添加正负轴向强度\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.5 Ultimate\n    - 惯性系统可K帧\n    - 局部Sin正负轴向强度控制\n    - 重力XYZ可K帧\n    - 修复旧控制器兼容性\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.5\" width:650\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:300 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:300 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 必须使用V7.5版本的控制器，旧版请重新创建\" style_sunken:true align:#center color:(color 255 150 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:200 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:200 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:200 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localX_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localX_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75 toolTip:\"正向旋转强度倍率\"\n        spinner spn_localX_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75 toolTip:\"负向旋转强度倍率\"\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localY_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localY_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75 toolTip:\"正向旋转强度倍率\"\n        spinner spn_localY_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75 toolTip:\"负向旋转强度倍率\"\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75\n        spinner spn_localZ_rot \"旋转\" range:[-90,90,8] width:75\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:75\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localZ_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75 toolTip:\"正向旋转强度倍率\"\n        spinner spn_localZ_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75 toolTip:\"负向旋转强度倍率\"\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:190\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:190\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:190\n        label lbl_empty0 \"\" width:190\n    )\n    \n    group \"5. ★ 末端控制 (解决末端折叠)\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:190\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:190\n        label lbl_empty1 \"\" width:190\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:120\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:150\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:150\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:630\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:630 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:100 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:100\n        button btn_EulerFilter \"欧拉过滤\" width:100\n        button btn_TCB \"转TCB\" width:100\n        button btn_Euler \"转欧拉\" width:100\n        button btn_reset \"重置参数\" width:100 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n        (\n            return distance bone.pos bone.children[1].pos\n        )\n        else\n        (\n            local len = 0.0\n            try \n            (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) \n            catch()\n            \n            if len \u003e 0.1 then return len\n            \n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            \n            return 10.0\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller_V75\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParamsV75\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                    \n                    -- 重力参数\n                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX\n                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY\n                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ\n                    \n                    -- ★ 惯性参数 (可K帧)\n                    inertiaStrength type:#float default:0.3 animatable:true ui:spn_inertia\n                    inertiaDamping type:#float default:0.95 animatable:true ui:spn_inertiaDamp\n                    massDistribution type:#float default:1.0 animatable:true ui:spn_massDist\n                )\n                rollout rlt \"风力参数 V7.5 (可K帧)\" width:300\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                    group \"★ 重力 (XYZ可K帧)\"\n                    (\n                        spinner spn_gravX \"重力 X:\" range:[-500,500,0] type:#float\n                        spinner spn_gravY \"重力 Y:\" range:[-500,500,0] type:#float\n                        spinner spn_gravZ \"重力 Z:\" range:[-500,500,0] type:#float\n                    )\n                    group \"★ 惯性系统 (可K帧)\"\n                    (\n                        spinner spn_inertia \"惯性强度:\" range:[0,0.99,0.3] type:#float scale:0.01 \\\n                                toolTip:\"越大余韵越长\"\n                        spinner spn_inertiaDamp \"惯性衰减:\" range:[0.8,0.99,0.95] type:#float scale:0.01 \\\n                                toolTip:\"越大衰减越慢\"\n                        spinner spn_massDist \"质量分布:\" range:[0,2,1.0] type:#float scale:0.1 \\\n                                toolTip:\"0=均匀, 1=末端重, 2=末端很重\"\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then \n            return angle\n        \n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    -- ★ 改进的局部Sin旋转（支持正负轴向强度）\n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1: -- X轴\n            (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                -- ★ 应用正负轴向强度\n                if d \u003e 0 then\n                    d = d * spn_localX_posStr.value\n                else\n                    d = d * spn_localX_negStr.value\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2: -- Y轴\n            (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                -- ★ 应用正负轴向强度\n                if d \u003e 0 then\n                    d = d * spn_localY_posStr.value\n                else\n                    d = d * spn_localY_negStr.value\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3: -- Z轴\n            (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                -- ★ 应用正负轴向强度\n                if d \u003e 0 then\n                    d = d * spn_localZ_posStr.value\n                else\n                    d = d * spn_localZ_negStr.value\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        \n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn calculateMassFactor boneIndex totalBones massDistribution =\n    (\n        if massDistribution == 0 then return 1.0\n        \n        local progress = boneIndex as float / totalBones as float\n        return 1.0 + (progress * massDistribution)\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else\n                (\n                    i += 1\n                )\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if parentArray[l].children.count \u003e 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then\n            (\n                append listArray parentArray[l]\n            )\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do \n            (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try \n                        (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then \n                                bn.transform = targetTM\n                            else if classof bn == Biped_Object then \n                                biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) \n                        catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try \n                    (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then \n                        (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) \n                    catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器V7.5已创建！\\n\\n选中控制器后，在修改面板可K帧调整：\\n- 混合/风力/扰动参数\\n- 重力 XYZ\\n- 惯性系统\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then \n        (\n            messageBox \"请选择骨骼根部\"\n            return false\n        )\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then \n        (\n            messageBox \"请先拾取风向控制器\"\n            return false\n        )\n        \n        -- ★ 检查是否是V7.5版本的控制器\n        if not isProperty ctrlObj \"inertiaStrength\" then \n        (\n            messageBox \"控制器版本过旧，缺少惯性/重力属性！\\n\\n请点击[创建风向控制器]按钮重新创建V7.5版本的控制器。\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        local allVelocities = #()\n        local allPrevPositions = #()\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        format \"末端控制: 阻尼=% 衰减起始=% 虚拟末端长度倍率=%\\n\" endDamping endFalloff virtualEndScale\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                local velocities = #()\n                local prevPositions = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    \n                    local boneLen = getBoneLength b\n                    append boneLengths boneLen\n                    \n                    append velocities [0,0,0]\n                    append prevPositions b.transform.pos\n                )\n                \n                -- 虚拟末端1\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                local virtualEndRelTM = matrix3 1\n                virtualEndRelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEndRelTM\n                append boneLengths virtualLen\n                \n                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform\n                append simTMs virtualEndWorldTM\n                append velocities [0,0,0]\n                append prevPositions virtualEndWorldTM.pos\n                \n                -- 虚拟末端2\n                local virtualEnd2RelTM = matrix3 1\n                virtualEnd2RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd2RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM\n                append simTMs virtualEnd2WorldTM\n                append velocities [0,0,0]\n                append prevPositions virtualEnd2WorldTM.pos\n                \n                -- 虚拟末端3\n                local virtualEnd3RelTM = matrix3 1\n                virtualEnd3RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd3RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM\n                append simTMs virtualEnd3WorldTM\n                append velocities [0,0,0]\n                append prevPositions virtualEnd3WorldTM.pos\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                append allVelocities velocities\n                append allPrevPositions prevPositions\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true \\\n                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼 + 3个虚拟末端点\\n\" cIdx chain.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            if isWritePass and chk_loops.checked then\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try \n                            (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                (\n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                                )\n                            ) \n                            catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                -- ★ 从控制器读取重力和惯性 (可K帧)\n                local gravityX = at time t ctrlObj.gravityX\n                local gravityY = at time t ctrlObj.gravityY\n                local gravityZ = at time t ctrlObj.gravityZ\n                local gravityVec = [gravityX, gravityY, gravityZ]\n                \n                local inertiaStrength = at time t ctrlObj.inertiaStrength\n                local inertiaDamping = at time t ctrlObj.inertiaDamping\n                local massDistribution = at time t ctrlObj.massDistribution\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        local velocities = allVelocities[cIdx]\n                        local prevPositions = allPrevPositions[cIdx]\n                        \n                        local totalNodes = simTMs.count - 1\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                        (\n                            currentPTM = matrix3 1\n                        )\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            \n                            local currentPos\n                            if j == 1 then\n                                currentPos = prePos\n                            else if j + 1 \u003c= simTMs.count then\n                                currentPos = simTMs[j+1].pos\n                            else\n                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n                            \n                            local tpos = targetBoneTM.pos\n                            \n                            local boneDamping = 0.0\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5\n                            \n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            local massFactor = calculateMassFactor j totalNodes massDistribution\n                            \n                            -- ★ 应用惯性\n                            if inertiaStrength \u003e 0 then\n                            (\n                                local inertiaPos = velocities[j] * inertiaStrength * massFactor\n                                currentPos = currentPos + inertiaPos\n                            )\n                            \n                            -- ★ 应用重力\n                            currentPos = currentPos + gravityVec * massFactor * 0.01\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos)\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            local effectiveMaxAngle = maxAngle\n                            if isVirtualEnd then\n                                effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count then\n                                effectiveMaxAngle = maxAngle * 0.7\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- ★ 计算速度用于惯性\n                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]\n                            local newVelocity = newPos - prevPositions[j]\n                            velocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)\n                            prevPositions[j] = newPos\n                            \n                            -- 写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try \n                                    (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 then\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                        (\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        )\n                                        else \n                                        (\n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                        )\n                                    ) \n                                    catch ()\n                                )\n                            )\n                            \n                            -- 调试helper\n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count then\n                                (\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            \n                            if j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then\n                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                        \n                        allVelocities[cIdx] = velocities\n                        allPrevPositions[cIdx] = prevPositions\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then\n        (\n            for h in allVirtualEndHelpers do \n            (\n                try(delete h)catch()\n            )\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择父对象！\"\n            return false\n        )\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择骨骼！\"\n            return false\n        )\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = TCB_Rotation()\n        )\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = Euler_XYZ()\n        )\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        spn_localX_posStr.value = 1.0\n        spn_localX_negStr.value = 1.0\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        spn_localY_posStr.value = 1.0\n        spn_localY_negStr.value = 1.0\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        spn_localZ_posStr.value = 1.0\n        spn_localZ_negStr.value = 1.0\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V7.5 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V7.5\\n\"\nformat \"========================================\\n\"\nformat \"★ V7.5 新功能:\\n\"\nformat \"  - 惯性系统可K帧 (在控制器上)\\n\"\nformat \"  - 局部Sin正负轴向强度控制\\n\"\nformat \"  - 必须使用V7.5版本控制器\\n\"\nformat \"========================================\\n\"\nformat \"★ 控制器可K帧参数:\\n\"\nformat \"  - 混合: Spring/全局风/局部Sin\\n\"\nformat \"  - Sin风力: 基础风压/幅度/周期\\n\"\nformat \"  - 扰动: 强度/频率/速度/层数\\n\"\nformat \"  - 重力: X/Y/Z\\n\"\nformat \"  - 惯性: 强度/衰减/质量分布\\n\"\nformat \"========================================\\n\"\nformat \"★ 局部Sin正负强度用法:\\n\"\nformat \"  +强度=1, -强度=2: 负向幅度更大\\n\"\nformat \"  +强度=2, -强度=0.5: 正向幅度更大\\n\"\nformat \"========================================\\n\"\n```\n\n## V7.5 更新内容：\n\n### 1. **惯性系统可K帧**\n现在惯性参数都在控制器上，可以K帧：\n- 惯性强度 (0-0.99)\n- 惯性衰减 (0.8-0.99)\n- 质量分布 (0-2)\n\n**使用场景：**\n```\n第0帧: 惯性强度=0 (静止状态)\n第30帧: 惯性强度=0.5 (开始有余韵)\n第60帧: 惯性强度=0.9 (果冻效果)\n```\n\n### 2. **局部Sin正负轴向强度**\n每个轴都有 `+强度` 和 `-强度` 参数：\n\n| 参数 | 说明 |\n|------|------|\n| +强度 | 正向旋转的倍率 |\n| -强度 | 负向旋转的倍率 |\n\n**使用示例：**\n```\n场景1: 只向一边摆动\n  +强度=1.0, -强度=0.2 → 正向大，负向小\n\n场景2: 负向摆动更大\n  +强度=0.5, -强度=1.5 → 负向更大\n\n场景3: 不对称波形\n  +强度=2.0, -强度=1.0 → 正向幅度翻倍\n```\n\n### 3. **版本检查**\n脚本会检查控制器版本，如果使用旧版控制器会提示重新创建。\n\n### 4. **控制器命名**\n新版控制器名称为 `Wind_Controller_V75`，方便区分。"])</script><script>self.__next_f.push([1,"2e:Te9ec,"])</script><script>self.__next_f.push([1,"你说得对，我来重新设计一个更完善的惯性系统，添加频率和振幅控制：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.8 Ultimate\n    - 完善惯性系统：频率/振幅/衰减全可控\n    - 惯性衰减解锁全范围\n    - 局部Sin正负轴向强度\n    - 所有核心参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.8\" width:650\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:300 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:300 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 必须使用V7.8版本的控制器，旧版请重新创建\" style_sunken:true align:#center color:(color 255 150 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:200 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:200 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:200 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localX_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localX_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localX_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localY_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localY_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localY_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75\n        spinner spn_localZ_rot \"旋转\" range:[-90,90,8] width:75\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:75\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localZ_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localZ_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:190\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:190\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:190\n        label lbl_empty0 \"\" width:190\n    )\n    \n    group \"5. ★ 末端控制 (解决末端折叠)\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:190\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:190\n        label lbl_empty1 \"\" width:190\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:120\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:150\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:150\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:630\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:630 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:100 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:100\n        button btn_EulerFilter \"欧拉过滤\" width:100\n        button btn_TCB \"转TCB\" width:100\n        button btn_Euler \"转欧拉\" width:100\n        button btn_reset \"重置参数\" width:100 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n        (\n            return distance bone.pos bone.children[1].pos\n        )\n        else\n        (\n            local len = 0.0\n            try \n            (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) \n            catch()\n            \n            if len \u003e 0.1 then return len\n            \n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            \n            return 10.0\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller_V78\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParamsV78\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                    \n                    -- 重力参数\n                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX\n                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY\n                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ\n                    \n                    -- ★ 完善惯性系统 (全可K帧)\n                    inertiaStrength type:#float default:0.5 animatable:true ui:spn_inertia\n                    inertiaFrequency type:#float default:2.0 animatable:true ui:spn_inertiaFreq\n                    inertiaAmplitude type:#float default:1.0 animatable:true ui:spn_inertiaAmp\n                    inertiaDamping type:#float default:0.5 animatable:true ui:spn_inertiaDamp\n                    inertiaStiffness type:#float default:0.5 animatable:true ui:spn_inertiaStiff\n                    massDistribution type:#float default:1.0 animatable:true ui:spn_massDist\n                )\n                rollout rlt \"风力参数 V7.8 (可K帧)\" width:320\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                    group \"★ 重力 (XYZ可K帧)\"\n                    (\n                        spinner spn_gravX \"重力 X:\" range:[-500,500,0] type:#float\n                        spinner spn_gravY \"重力 Y:\" range:[-500,500,0] type:#float\n                        spinner spn_gravZ \"重力 Z:\" range:[-500,500,0] type:#float\n                    )\n                    group \"★ 惯性系统 (完整控制)\"\n                    (\n                        spinner spn_inertia \"惯性强度:\" range:[0,2,0.5] type:#float scale:0.01 \\\n                                toolTip:\"总体惯性大小，0=无惯性\"\n                        spinner spn_inertiaFreq \"晃动频率:\" range:[0.1,20,2.0] type:#float scale:0.1 \\\n                                toolTip:\"停止后晃动的快慢，越大晃动越快\"\n                        spinner spn_inertiaAmp \"晃动振幅:\" range:[0,5,1.0] type:#float scale:0.1 \\\n                                toolTip:\"停止后晃动的幅度，越大幅度越大\"\n                        spinner spn_inertiaDamp \"衰减速度:\" range:[0,1,0.5] type:#float scale:0.01 \\\n                                toolTip:\"晃动消失的速度，0=不衰减，1=立即消失\"\n                        spinner spn_inertiaStiff \"弹簧刚度:\" range:[0,1,0.5] type:#float scale:0.01 \\\n                                toolTip:\"回弹的硬度，越大回弹越快越硬\"\n                        spinner spn_massDist \"质量分布:\" range:[0,3,1.0] type:#float scale:0.1 \\\n                                toolTip:\"0=均匀, 1=末端重, 2+=末端很重\"\n                        label lbl_inertiaTip1 \"频率高+衰减慢=抖动\" align:#left\n                        label lbl_inertiaTip2 \"频率低+振幅大=晃荡\" align:#left\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then \n            return angle\n        \n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            \n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            \n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        \n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        \n        case axisType of\n        (\n            1:\n            (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then\n                    d = d * spn_localX_posStr.value\n                else\n                    d = d * spn_localX_negStr.value\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2:\n            (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then\n                    d = d * spn_localY_posStr.value\n                else\n                    d = d * spn_localY_negStr.value\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3:\n            (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then\n                    d = d * spn_localZ_posStr.value\n                else\n                    d = d * spn_localZ_negStr.value\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        \n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn calculateMassFactor boneIndex totalBones massDistribution =\n    (\n        if massDistribution == 0 then return 1.0\n        local progress = boneIndex as float / totalBones as float\n        return 1.0 + (progress * massDistribution)\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else\n                (\n                    i += 1\n                )\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if parentArray[l].children.count \u003e 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then\n            (\n                append listArray parentArray[l]\n            )\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do\n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do\n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do\n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            \n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    local rot = (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                    rotate objectArray[a][b] rot\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do \n            (\n                curr = curr.children[1]\n                append bones curr\n            )\n            \n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then\n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else\n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try \n                        (\n                            local targetTM \n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform\n                            else\n                                targetTM = bn.boneTM\n                                \n                            if classof bn == CATBone then \n                                bn.transform = targetTM\n                            else if classof bn == Biped_Object then \n                                biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then\n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else\n                                bn.rotation = targetTM.rotation\n                        ) \n                        catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                \n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try \n                    (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then \n                        (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) \n                    catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器V7.8已创建！\\n\\n惯性系统参数说明：\\n- 惯性强度: 总体惯性大小\\n- 晃动频率: 余韵晃动快慢\\n- 晃动振幅: 余韵晃动幅度\\n- 衰减速度: 晃动消失速度\\n- 弹簧刚度: 回弹硬度\\n- 质量分布: 末端重量\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then \n        (\n            messageBox \"请选择骨骼根部\"\n            return false\n        )\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then \n        (\n            messageBox \"请先拾取风向控制器\"\n            return false\n        )\n        \n        -- 检查V7.8版本\n        if not isProperty ctrlObj \"inertiaFrequency\" then \n        (\n            messageBox \"控制器版本过旧！\\n\\n请点击[创建风向控制器]按钮重新创建V7.8版本的控制器。\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        \n        -- ★ 惯性系统数据结构\n        local allVelocities = #()      -- 速度\n        local allAccelerations = #()   -- 加速度\n        local allPrevPositions = #()   -- 前一帧位置\n        local allOscillationPhase = #() -- 振荡相位\n        local allOscillationEnergy = #() -- 振荡能量\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        format \"末端控制: 阻尼=% 衰减起始=% 虚拟末端长度=%\\n\" endDamping endFalloff virtualEndScale\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                local velocities = #()\n                local accelerations = #()\n                local prevPositions = #()\n                local oscPhases = #()\n                local oscEnergies = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    \n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    \n                    local boneLen = getBoneLength b\n                    append boneLengths boneLen\n                    \n                    -- ★ 惯性数据初始化\n                    append velocities [0,0,0]\n                    append accelerations [0,0,0]\n                    append prevPositions b.transform.pos\n                    append oscPhases 0.0\n                    append oscEnergies 0.0\n                )\n                \n                -- 虚拟末端1\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                local virtualEndRelTM = matrix3 1\n                virtualEndRelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEndRelTM\n                append boneLengths virtualLen\n                \n                local virtualEndWorldTM = virtualEndRelTM * lastBone.transform\n                append simTMs virtualEndWorldTM\n                append velocities [0,0,0]\n                append accelerations [0,0,0]\n                append prevPositions virtualEndWorldTM.pos\n                append oscPhases 0.0\n                append oscEnergies 0.0\n                \n                -- 虚拟末端2\n                local virtualEnd2RelTM = matrix3 1\n                virtualEnd2RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd2RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd2WorldTM = virtualEnd2RelTM * virtualEndWorldTM\n                append simTMs virtualEnd2WorldTM\n                append velocities [0,0,0]\n                append accelerations [0,0,0]\n                append prevPositions virtualEnd2WorldTM.pos\n                append oscPhases 0.0\n                append oscEnergies 0.0\n                \n                -- 虚拟末端3\n                local virtualEnd3RelTM = matrix3 1\n                virtualEnd3RelTM.pos = [virtualLen, 0, 0]\n                append boneRelTMs virtualEnd3RelTM\n                append boneLengths virtualLen\n                \n                local virtualEnd3WorldTM = virtualEnd3RelTM * virtualEnd2WorldTM\n                append simTMs virtualEnd3WorldTM\n                append velocities [0,0,0]\n                append accelerations [0,0,0]\n                append prevPositions virtualEnd3WorldTM.pos\n                append oscPhases 0.0\n                append oscEnergies 0.0\n                \n                if chain.count \u003e 1 then\n                    append allPrePos chain[2].transform.pos\n                else\n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                append allVelocities velocities\n                append allAccelerations accelerations\n                append allPrevPositions prevPositions\n                append allOscillationPhase oscPhases\n                append allOscillationEnergy oscEnergies\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true \\\n                                         wirecolor:(color 255 0 255) pos:virtualEndWorldTM.pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼 + 3个虚拟末端点\\n\" cIdx chain.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %, 链数: %)...\\n\" loopsCount allChains.count\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            if isWritePass and chk_loops.checked then\n            (\n                format \"\u003e\u003e 正在缝合首尾，修正第 % 帧...\\n\" startF\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        \n                        for j = 1 to chain.count do\n                        (\n                            try \n                            (\n                                if classof chain[j] == CATBone then\n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then\n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else \n                                (\n                                    if chain[j].parent != undefined then\n                                        chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                    else\n                                        chain[j].rotation.controller.value = simTMs[j].rotation\n                                )\n                            ) \n                            catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                \n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                local gravityX = at time t ctrlObj.gravityX\n                local gravityY = at time t ctrlObj.gravityY\n                local gravityZ = at time t ctrlObj.gravityZ\n                local gravityVec = [gravityX, gravityY, gravityZ]\n                \n                -- ★ 惯性参数 (全可K帧)\n                local inertiaStrength = at time t ctrlObj.inertiaStrength\n                local inertiaFrequency = at time t ctrlObj.inertiaFrequency\n                local inertiaAmplitude = at time t ctrlObj.inertiaAmplitude\n                local inertiaDamping = at time t ctrlObj.inertiaDamping\n                local inertiaStiffness = at time t ctrlObj.inertiaStiffness\n                local massDistribution = at time t ctrlObj.massDistribution\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        local velocities = allVelocities[cIdx]\n                        local accelerations = allAccelerations[cIdx]\n                        local prevPositions = allPrevPositions[cIdx]\n                        local oscPhases = allOscillationPhase[cIdx]\n                        local oscEnergies = allOscillationEnergy[cIdx]\n                        \n                        local totalNodes = simTMs.count - 1\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            local temp_x = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local temp_y = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local temp_z = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [temp_x, temp_y, temp_z]\n                        )\n                        else\n                        (\n                            currentPTM = matrix3 1\n                        )\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local localSinRotX = get_local_sin_rotation (t - startF) j 1\n                                local localSinRotY = get_local_sin_rotation (t - startF) j 2\n                                local localSinRotZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat localSinRotX) * (quat localSinRotY) * (quat localSinRotZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            \n                            local currentPos\n                            if j == 1 then\n                                currentPos = prePos\n                            else if j + 1 \u003c= simTMs.count then\n                                currentPos = simTMs[j+1].pos\n                            else\n                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n                            \n                            local tpos = targetBoneTM.pos\n                            \n                            local boneDamping = 0.0\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5\n                            \n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            local massFactor = calculateMassFactor j totalNodes massDistribution\n                            \n                            -- ★ 完善的惯性系统计算\n                            if inertiaStrength \u003e 0 then\n                            (\n                                -- 计算当前速度\n                                local currentVelocity = currentPos - prevPositions[j]\n                                local velocityMagnitude = length currentVelocity\n                                \n                                -- 计算加速度变化 (用于检测减速)\n                                local newAcceleration = currentVelocity - velocities[j]\n                                local deceleration = length (newAcceleration - accelerations[j])\n                                \n                                -- 当检测到减速时，增加振荡能量\n                                local decelerationThreshold = 0.1\n                                if deceleration \u003e decelerationThreshold then\n                                (\n                                    oscEnergies[j] = oscEnergies[j] + (deceleration * inertiaAmplitude * massFactor)\n                                )\n                                \n                                -- 振荡相位累加\n                                oscPhases[j] = oscPhases[j] + (inertiaFrequency * 0.1)\n                                \n                                -- 计算振荡偏移 (阻尼弹簧振动)\n                                local oscillation = sin(oscPhases[j] * 360.0) * oscEnergies[j]\n                                \n                                -- 应用弹簧刚度影响振荡频率\n                                local stiffnessOsc = cos(oscPhases[j] * 360.0 * (1.0 + inertiaStiffness)) * oscEnergies[j] * inertiaStiffness * 0.5\n                                \n                                -- 振荡衰减\n                                oscEnergies[j] = oscEnergies[j] * (1.0 - inertiaDamping * 0.1)\n                                if oscEnergies[j] \u003c 0.001 then oscEnergies[j] = 0.0\n                                \n                                -- 应用惯性到位置\n                                local inertiaOffset = velocities[j] * inertiaStrength * massFactor\n                                \n                                -- 应用振荡 (沿速度方向垂直振动)\n                                local oscDirection = if velocityMagnitude \u003e 0.01 then \n                                    normalize (cross velocities[j] [0,0,1])\n                                else \n                                    [0,1,0]\n                                \n                                if length oscDirection \u003c 0.01 then oscDirection = [1,0,0]\n                                \n                                local oscOffset = oscDirection * (oscillation + stiffnessOsc) * inertiaStrength\n                                \n                                currentPos = currentPos + inertiaOffset + oscOffset\n                                \n                                -- 更新速度和加速度\n                                velocities[j] = velocities[j] * (1.0 - inertiaDamping * 0.05) + currentVelocity * inertiaDamping * 0.05\n                                accelerations[j] = newAcceleration\n                            )\n                            \n                            -- 应用重力\n                            currentPos = currentPos + gravityVec * massFactor * 0.01\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1 else if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1 else if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos)\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1 else if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3)\n                                \n                                springAngle *= (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period \\\n                                                  turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            local effectiveMaxAngle = maxAngle\n                            if isVirtualEnd then\n                                effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count then\n                                effectiveMaxAngle = maxAngle * 0.7\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- ★ 更新前一帧位置\n                            local newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]\n                            prevPositions[j] = newPos\n                            \n                            -- 写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try \n                                    (\n                                        local finalRotation = targetBoneTM.rotation\n                                        \n                                        if localSinMix \u003e 0 then\n                                        (\n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        )\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then\n                                        (\n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        )\n                                        else \n                                        (\n                                            if chain[j].parent != undefined then\n                                                chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                            else\n                                                chain[j].rotation.controller.value = finalRotation\n                                        )\n                                    ) \n                                    catch ()\n                                )\n                            )\n                            \n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count then\n                                (\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                                )\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            \n                            if j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then\n                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                        \n                        -- ★ 更新惯性数据\n                        allVelocities[cIdx] = velocities\n                        allAccelerations[cIdx] = accelerations\n                        allPrevPositions[cIdx] = prevPositions\n                        allOscillationPhase[cIdx] = oscPhases\n                        allOscillationEnergy[cIdx] = oscEnergies\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then\n        (\n            for h in allVirtualEndHelpers do \n            (\n                try(delete h)catch()\n            )\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择父对象！\"\n            return false\n        )\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n        format \"选择了 % 个子对象\\n\" allChildren.count\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择骨骼！\"\n            return false\n        )\n        local aBState = animButtonState\n        animButtonState = false\n        local sortedArr = sortArrayByHeirarchy (selection as array)\n        BoneLoopStart sortedArr\n        animButtonState = aBState\n        format \"首尾循环处理完成\\n\"\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        local sel = selection as array\n        for obj in sel where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n        format \"欧拉过滤完成\\n\"\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = TCB_Rotation()\n        )\n        format \"TCB曲线转换完成\\n\"\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择对象！\"\n            return false\n        )\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then \n                obj.Rotation.Controller = Euler_XYZ()\n        )\n        format \"欧拉曲线转换完成\\n\"\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        spn_localX_posStr.value = 1.0\n        spn_localX_negStr.value = 1.0\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        spn_localY_posStr.value = 1.0\n        spn_localY_negStr.value = 1.0\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        spn_localZ_posStr.value = 1.0\n        spn_localZ_negStr.value = 1.0\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1.0\n        spn_blend_y.value = 1.0\n        spn_blend_z.value = 1.0\n        \n        format \"参数已重置\\n\"\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local totalFrames = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = totalFrames\n        spn_localY_period.value = totalFrames\n        spn_localZ_period.value = totalFrames\n        format \"Sin+Spring V7.8 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring 风力生成器 V7.8\\n\"\nformat \"========================================\\n\"\nformat \"★ 惯性系统完整参数:\\n\"\nformat \"  惯性强度 (0-2): 总体惯性大小\\n\"\nformat \"  晃动频率 (0.1-20): 余韵晃动快慢\\n\"\nformat \"  晃动振幅 (0-5): 余韵晃动幅度\\n\"\nformat \"  衰减速度 (0-1): 晃动消失速度\\n\"\nformat \"  弹簧刚度 (0-1): 回弹硬度\\n\"\nformat \"  质量分布 (0-3): 末端重量\\n\"\nformat \"========================================\\n\"\nformat \"★ 惯性效果组合示例:\\n\"\nformat \"  抖动效果: 频率=10, 振幅=0.5, 衰减=0.3\\n\"\nformat \"  晃荡效果: 频率=1, 振幅=2, 衰减=0.1\\n\"\nformat \"  果冻效果: 频率=3, 振幅=1.5, 刚度=0.8\\n\"\nformat \"  重物感: 频率=0.5, 振幅=1, 质量分布=2\\n\"\nformat \"========================================\\n\"\n```\n\n## V7.8 惯性系统完整参数说明：\n\n### 惯性系统参数（全部可K帧）\n\n| 参数 | 范围 | 说明 |\n|------|------|------|\n| 惯性强度 | 0-2 | 总体惯性大小，0=无惯性 |\n| 晃动频率 | 0.1-20 | 余韵晃动的快慢，越大越快 |\n| 晃动振幅 | 0-5 | 余韵晃动的幅度，越大幅度越大 |\n| 衰减速度 | 0-1 | 晃动消失的速度，0=不衰减，1=立即消失 |\n| 弹簧刚度 | 0-1 | 回弹的硬度，越大回弹越硬越快 |\n| 质量分布 | 0-3 | 0=均匀，1=末端重，2+=末端很重 |\n\n### 效果组合示例\n\n**快速抖动（像触电）：**\n```\n频率=10-15, 振幅=0.3-0.5, 衰减=0.3-0.5\n```\n\n**缓慢晃荡（像钟摆）：**\n```\n频率=0.5-2, 振幅=1.5-2.5, 衰减=0.05-0.15\n```\n\n**果冻质感：**\n```\n频率=3-5, 振幅=1-1.5, 刚度=0.7-0.9, 衰减=0.2\n```\n\n**重物下坠感：**\n```\n频率=0.3-0.8, 振幅=0.8-1.2, 质量分布=2-3\n```\n\n**弹性回弹：**\n```\n频率=4-6, 振幅=1, 刚度=0.8-1, 衰减=0.4\n```\n\n### K帧使用场景\n\n```\n场景: 角色突然停下\n第0帧: 惯性强度=0.5, 衰减=0.1 (正常晃动)\n第30帧: 惯性强度=1.5, 振幅=2 (撞击后大幅晃动)\n第60帧: 惯性强度=0.3, 衰减=0.5 (逐渐平静)\n\n场景: 从柔软变硬\n第0帧: 刚度=0.2, 频率=1 (柔软)\n第50帧: 刚度=0.9, 频率=8 (变硬抖动)\n```"])</script><script>self.__next_f.push([1,"2f:Td09e,"])</script><script>self.__next_f.push([1,"你说得对，我把惯性逻辑搞复杂后反而破坏了原有的效果。让我重新设计一个更直观有效的惯性系统：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.9 Ultimate\n    - 修复惯性系统：基础惯性 + 阻尼振荡\n    - 更直观的参数控制\n    - 所有参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.9\" width:650\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:300 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:300 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 必须使用V7.9版本的控制器\" style_sunken:true align:#center color:(color 255 150 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:200 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:200 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:200 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localX_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localX_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localX_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localY_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localY_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localY_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75\n        spinner spn_localZ_rot \"旋转\" range:[-90,90,8] width:75\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:75\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localZ_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localZ_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:190\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:190\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:190\n        label lbl_empty0 \"\" width:190\n    )\n    \n    group \"5. ★ 末端控制\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:190\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:190\n        label lbl_empty1 \"\" width:190\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:120\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:150\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:150\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:630\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:630 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:100 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:100\n        button btn_EulerFilter \"欧拉过滤\" width:100\n        button btn_TCB \"转TCB\" width:100\n        button btn_Euler \"转欧拉\" width:100\n        button btn_reset \"重置参数\" width:100 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n            return distance bone.pos bone.children[1].pos\n        else\n        (\n            local len = 0.0\n            try (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) catch()\n            \n            if len \u003e 0.1 then return len\n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            return 10.0\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller_V79\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParamsV79\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                    \n                    -- 重力参数\n                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX\n                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY\n                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ\n                    \n                    -- ★ 惯性系统 (简化但有效)\n                    inertiaEnable type:#float default:1.0 animatable:true ui:spn_inertiaEnable\n                    inertiaMomentum type:#float default:0.85 animatable:true ui:spn_momentum\n                    inertiaOscFreq type:#float default:3.0 animatable:true ui:spn_oscFreq\n                    inertiaOscAmp type:#float default:0.5 animatable:true ui:spn_oscAmp\n                    inertiaOscDecay type:#float default:0.92 animatable:true ui:spn_oscDecay\n                    inertiaMass type:#float default:1.0 animatable:true ui:spn_mass\n                )\n                rollout rlt \"风力参数 V7.9 (可K帧)\" width:320\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                    group \"★ 重力 (XYZ可K帧)\"\n                    (\n                        spinner spn_gravX \"重力 X:\" range:[-500,500,0] type:#float\n                        spinner spn_gravY \"重力 Y:\" range:[-500,500,0] type:#float\n                        spinner spn_gravZ \"重力 Z:\" range:[-500,500,0] type:#float\n                    )\n                    group \"★ 惯性系统 (余韵晃动)\"\n                    (\n                        spinner spn_inertiaEnable \"惯性开关:\" range:[0,1,1.0] type:#float scale:0.01 \\\n                                toolTip:\"0=关闭, 1=开启\"\n                        spinner spn_momentum \"动量保持:\" range:[0.5,0.99,0.85] type:#float scale:0.01 \\\n                                toolTip:\"速度保持程度，越大惯性越强\"\n                        spinner spn_oscFreq \"振荡频率:\" range:[0.5,15,3.0] type:#float scale:0.1 \\\n                                toolTip:\"停止后晃动的快慢\"\n                        spinner spn_oscAmp \"振荡振幅:\" range:[0,3,0.5] type:#float scale:0.1 \\\n                                toolTip:\"停止后晃动的幅度\"\n                        spinner spn_oscDecay \"振荡衰减:\" range:[0.5,0.99,0.92] type:#float scale:0.01 \\\n                                toolTip:\"晃动能量保持，越大晃动越久\"\n                        spinner spn_mass \"质量分布:\" range:[0,3,1.0] type:#float scale:0.1 \\\n                                toolTip:\"0=均匀, 1+=末端更重\"\n                        label lbl_tip1 \"动量0.9+振荡0.5=自然余韵\" align:#left\n                        label lbl_tip2 \"振荡频率高=快速抖动\" align:#left\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        case axisType of\n        (\n            1: (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then d = d * spn_localX_posStr.value else d = d * spn_localX_negStr.value\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2: (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then d = d * spn_localY_posStr.value else d = d * spn_localY_negStr.value\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3: (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then d = d * spn_localZ_posStr.value else d = d * spn_localZ_negStr.value\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn calculateMassFactor boneIndex totalBones massDistribution =\n    (\n        if massDistribution == 0 then return 1.0\n        local progress = boneIndex as float / totalBones as float\n        return 1.0 + (progress * massDistribution)\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else i += 1\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if parentArray[l].children.count \u003e 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then\n                append listArray parentArray[l]\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do append firstbonerot objectArray[i][j].transform.rotation\n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do append lastbonerot objectArray[i][j].transform.rotation\n            for j = 1 to objectArray[i].count do append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            append bonelistsub bonesub\n            firstbonerot = #(); lastbonerot = #(); bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    rotate objectArray[a][b] (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then b.boneTM = b.transform * (inverse b.parent.transform)\n                else b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try (\n                            local targetTM = if bn.parent != undefined then bn.boneTM * bn.parent.transform else bn.boneTM\n                            if classof bn == CATBone then bn.transform = targetTM\n                            else if classof bn == Biped_Object then biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else bn.rotation = targetTM.rotation\n                        ) catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do (curr = curr.children[1]; append bones curr)\n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try (\n                        if classof bn == Biped_Object and bn.parent != undefined then biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then (local newTM = copy bn.parent.transform; newTM.pos = bn.transform.pos; bn.transform = newTM)\n                    ) catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器V7.9已创建！\\n\\n惯性系统说明：\\n- 动量保持: 速度延续程度 (0.85-0.95推荐)\\n- 振荡频率: 晃动快慢 (1-5正常, 8+抖动)\\n- 振荡振幅: 晃动幅度\\n- 振荡衰减: 晃动持续时间\\n- 质量分布: 末端权重\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then (messageBox \"请选择骨骼根部\"; return false)\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then (messageBox \"请先拾取风向控制器\"; return false)\n        if not isProperty ctrlObj \"inertiaMomentum\" then (messageBox \"请重新创建V7.9版本控制器\"; return false)\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        \n        -- ★ 惯性系统数据\n        local allVelocities = #()       -- 速度向量\n        local allPrevPositions = #()    -- 前一帧位置\n        local allOscPhases = #()        -- 振荡相位\n        local allOscEnergies = #()      -- 振荡能量\n        local allPrevVelocities = #()   -- 前一帧速度 (用于检测速度变化)\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                local velocities = #()\n                local prevPositions = #()\n                local oscPhases = #()\n                local oscEnergies = #()\n                local prevVelocities = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM = if isProperty b \"boneTM\" then b.boneTM \n                                  else (if b.parent != undefined then b.transform * inverse b.parent.transform else b.transform)\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    append boneLengths (getBoneLength b)\n                    append velocities [0,0,0]\n                    append prevPositions b.transform.pos\n                    append oscPhases (random 0.0 360.0) -- 随机初始相位避免同步\n                    append oscEnergies 0.0\n                    append prevVelocities [0,0,0]\n                )\n                \n                -- 虚拟末端\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                for v = 1 to 3 do\n                (\n                    local vTM = matrix3 1\n                    vTM.pos = [virtualLen, 0, 0]\n                    append boneRelTMs vTM\n                    append boneLengths virtualLen\n                    \n                    local parentTM = if v == 1 then lastBone.transform else simTMs[simTMs.count]\n                    local vWorldTM = vTM * parentTM\n                    append simTMs vWorldTM\n                    append velocities [0,0,0]\n                    append prevPositions vWorldTM.pos\n                    append oscPhases (random 0.0 360.0)\n                    append oscEnergies 0.0\n                    append prevVelocities [0,0,0]\n                )\n                \n                if chain.count \u003e 1 then append allPrePos chain[2].transform.pos\n                else append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                append allVelocities velocities\n                append allPrevPositions prevPositions\n                append allOscPhases oscPhases\n                append allOscEnergies oscEnergies\n                append allPrevVelocities prevVelocities\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true wirecolor:(color 255 0 255) pos:simTMs[chain.count + 1].pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼\\n\" cIdx chain.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %)...\\n\" loopsCount\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- 循环缝合\n            if isWritePass and chk_loops.checked then\n            (\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        for j = 1 to chain.count do\n                        (\n                            try (\n                                if classof chain[j] == CATBone then chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else if chain[j].parent != undefined then chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                else chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                -- 读取控制器参数\n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                local gravityVec = [at time t ctrlObj.gravityX, at time t ctrlObj.gravityY, at time t ctrlObj.gravityZ]\n                \n                -- ★ 惯性参数\n                local inertiaEnable = at time t ctrlObj.inertiaEnable\n                local momentum = at time t ctrlObj.inertiaMomentum\n                local oscFreq = at time t ctrlObj.inertiaOscFreq\n                local oscAmp = at time t ctrlObj.inertiaOscAmp\n                local oscDecay = at time t ctrlObj.inertiaOscDecay\n                local massParam = at time t ctrlObj.inertiaMass\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        local velocities = allVelocities[cIdx]\n                        local prevPositions = allPrevPositions[cIdx]\n                        local oscPhases = allOscPhases[cIdx]\n                        local oscEnergies = allOscEnergies[cIdx]\n                        local prevVelocities = allPrevVelocities[cIdx]\n                        \n                        local totalNodes = simTMs.count - 1\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            currentPTM.pos = [\n                                currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x),\n                                currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y),\n                                currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            ]\n                        )\n                        else currentPTM = matrix3 1\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            -- 局部Sin\n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local lsX = get_local_sin_rotation (t - startF) j 1\n                                local lsY = get_local_sin_rotation (t - startF) j 2\n                                local lsZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat lsX) * (quat lsY) * (quat lsZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            \n                            local currentPos\n                            if j == 1 then currentPos = prePos\n                            else if j + 1 \u003c= simTMs.count then currentPos = simTMs[j+1].pos\n                            else currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n                            \n                            local tpos = targetBoneTM.pos\n                            \n                            -- 末端阻尼\n                            local boneDamping = if isRealBone then calculateEndDamping j chain.count endDamping endFalloff else endDamping * 1.5\n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            -- 质量因子\n                            local massFactor = calculateMassFactor j totalNodes massParam\n                            \n                            -- ★ 惯性系统计算\n                            if inertiaEnable \u003e 0 then\n                            (\n                                -- 1. 计算当前帧的速度\n                                local currentVelocity = currentPos - prevPositions[j]\n                                local velocityMag = length currentVelocity\n                                \n                                -- 2. 检测速度变化（减速/方向变化）→ 给振荡充能\n                                local prevVelMag = length prevVelocities[j]\n                                local velocityChange = length (currentVelocity - prevVelocities[j])\n                                \n                                -- 当速度变化时（减速或改变方向），振荡能量增加\n                                if velocityChange \u003e 0.01 then\n                                (\n                                    local energyInput = velocityChange * oscAmp * massFactor * inertiaEnable\n                                    oscEnergies[j] = oscEnergies[j] + energyInput\n                                )\n                                \n                                -- 3. 更新振荡相位\n                                oscPhases[j] = oscPhases[j] + oscFreq * 10.0\n                                if oscPhases[j] \u003e 360000 then oscPhases[j] = mod oscPhases[j] 360.0\n                                \n                                -- 4. 计算振荡偏移\n                                local oscValue = sin(oscPhases[j]) * oscEnergies[j]\n                                \n                                -- 振荡方向：垂直于当前速度方向\n                                local oscDir = [0,0,0]\n                                if velocityMag \u003e 0.001 then\n                                (\n                                    oscDir = normalize (cross (normalize currentVelocity) [0,0,1])\n                                    if length oscDir \u003c 0.001 then oscDir = normalize (cross (normalize currentVelocity) [0,1,0])\n                                )\n                                else if length velocities[j] \u003e 0.001 then\n                                (\n                                    oscDir = normalize (cross (normalize velocities[j]) [0,0,1])\n                                    if length oscDir \u003c 0.001 then oscDir = normalize (cross (normalize velocities[j]) [0,1,0])\n                                )\n                                else\n                                    oscDir = [1,0,0]\n                                \n                                local oscillationOffset = oscDir * oscValue * inertiaEnable\n                                \n                                -- 5. 振荡能量衰减\n                                oscEnergies[j] = oscEnergies[j] * oscDecay\n                                if oscEnergies[j] \u003c 0.0001 then oscEnergies[j] = 0.0\n                                \n                                -- 6. 动量累积 (速度延续)\n                                velocities[j] = velocities[j] * momentum + currentVelocity * (1.0 - momentum)\n                                \n                                -- 7. 应用惯性偏移\n                                local inertiaOffset = velocities[j] * inertiaEnable * massFactor\n                                \n                                -- 8. 最终位置\n                                currentPos = currentPos + inertiaOffset + oscillationOffset\n                                \n                                -- 9. 更新前一帧速度\n                                prevVelocities[j] = currentVelocity\n                            )\n                            \n                            -- 应用重力\n                            currentPos = currentPos + gravityVec * massFactor * 0.01\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                dot1 = amax -1.0 (amin 1.0 dot1)\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                dot2 = amax -1.0 (amin 1.0 dot2)\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos)\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                dot3 = amax -1.0 (amin 1.0 dot3)\n                                springAngle = acos(dot3) * (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            local effectiveMaxAngle = maxAngle * (if isVirtualEnd then 0.5 else if j == chain.count then 0.7 else 1.0)\n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- 更新位置记录\n                            prevPositions[j] = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]\n                            \n                            -- 写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try (\n                                        local finalRotation = targetBoneTM.rotation\n                                        if localSinMix \u003e 0 then finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        \n                                        if classof chain[j] == CATBone then (local finalTM = copy targetBoneTM; finalTM.rotation = finalRotation; chain[j].transform = finalTM)\n                                        else if classof chain[j].controller == BipSlave_Control then biped.setTransform chain[j] #rotation finalRotation true\n                                        else if chain[j].parent != undefined then chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                        else chain[j].rotation.controller.value = finalRotation\n                                    ) catch ()\n                                )\n                            )\n                            \n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 and cIdx \u003c= allVirtualEndHelpers.count then\n                                try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                        \n                        -- 更新惯性数据\n                        allVelocities[cIdx] = velocities\n                        allPrevPositions[cIdx] = prevPositions\n                        allOscPhases[cIdx] = oscPhases\n                        allOscEnergies[cIdx] = oscEnergies\n                        allPrevVelocities[cIdx] = prevVelocities\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then for h in allVirtualEndHelpers do try(delete h)catch()\n    )\n    \n    -- === 附加工具 ===\n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then (messageBox \"请先选择父对象！\"; return false)\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then (messageBox \"请先选择骨骼！\"; return false)\n        animButtonState = false\n        BoneLoopStart (sortArrayByHeirarchy (selection as array))\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) and obj.rotation.controller != undefined do\n        (obj.Rotation.Controller = TCB_Rotation(); obj.Rotation.Controller = Euler_XYZ())\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) and obj.rotation.controller != undefined do\n            obj.Rotation.Controller = TCB_Rotation()\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) and obj.rotation.controller != undefined do\n            obj.Rotation.Controller = Euler_XYZ()\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0; spn_localX_rot.value = 5; spn_localX_inc.value = 2; spn_localX_delay.value = 4; spn_localX_period.value = 40; spn_localX_posStr.value = 1; spn_localX_negStr.value = 1\n        spn_localY_switch.value = 0; spn_localY_rot.value = 5; spn_localY_inc.value = 2; spn_localY_delay.value = 4; spn_localY_period.value = 40; spn_localY_posStr.value = 1; spn_localY_negStr.value = 1\n        spn_localZ_switch.value = 1; spn_localZ_rot.value = 8; spn_localZ_inc.value = 3; spn_localZ_delay.value = 4; spn_localZ_period.value = 40; spn_localZ_posStr.value = 1; spn_localZ_negStr.value = 1\n        spn_springDelay.value = 0.3; spn_xSpring.value = 0.3; spn_subs.value = 1; spn_scaleMotion.value = 1.0; spn_boneCount.value = 50\n        spn_endDamping.value = 0.5; spn_endFalloff.value = 3; spn_virtualEndScale.value = 1.0\n        spn_maxAngle.value = 80.0; spn_softness.value = 0.3; spn_blend_x.value = 1; spn_blend_y.value = 1; spn_blend_z.value = 1\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local tf = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = tf; spn_localY_period.value = tf; spn_localZ_period.value = tf\n        format \"Sin+Spring V7.9 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring V7.9 惯性系统说明:\\n\"\nformat \"========================================\\n\"\nformat \"动量保持 (0.5-0.99):\\n\"\nformat \"  越高=速度越持久=惯性越强\\n\"\nformat \"  0.85=正常, 0.95=很强惯性\\n\"\nformat \"----------------------------------------\\n\"\nformat \"振荡频率 (0.5-15):\\n\"\nformat \"  越高=晃动越快\\n\"\nformat \"  1-3=缓慢晃荡, 8+=快速抖动\\n\"\nformat \"----------------------------------------\\n\"\nformat \"振荡振幅 (0-3):\\n\"\nformat \"  晃动的幅度大小\\n\"\nformat \"----------------------------------------\\n\"\nformat \"振荡衰减 (0.5-0.99):\\n\"\nformat \"  越高=晃动持续越久\\n\"\nformat \"  0.8=快速停止, 0.95=长时间晃动\\n\"\nformat \"========================================\\n\"\nformat \"推荐组合:\\n\"\nformat \"自然余韵: 动量0.88, 频率2, 振幅0.5, 衰减0.9\\n\"\nformat \"果冻感: 动量0.92, 频率4, 振幅0.8, 衰减0.93\\n\"\nformat \"快速抖动: 动量0.8, 频率10, 振幅0.3, 衰减0.85\\n\"\nformat \"重物晃荡: 动量0.9, 频率1, 振幅1.2, 衰减0.95\\n\"\nformat \"========================================\\n\"\n```\n\n## V7.9 惯性系统修复说明：\n\n### 问题分析\nV7.8中惯性失效的原因：\n1. 速度更新公式系数过小 (`inertiaDamping * 0.05`)\n2. 振荡能量只在特定条件下累积\n3. 逻辑过于复杂导致参数相互抵消\n\n### V7.9 修复的核心逻辑\n\n```\n1. 速度延续（动量）\n   velocity = velocity * momentum + currentVelocity * (1 - momentum)\n   → momentum=0.9 意味着90%保留之前速度\n\n2. 振荡能量累积\n   当检测到速度变化时 → 给振荡充能\n   oscEnergies += velocityChange * amplitude\n\n3. 振荡计算\n   oscillation = sin(phase) * energy\n   → 产生来回晃动效果\n\n4. 应用到位置\n   finalPos = currentPos + inertiaOffset + oscillationOffset\n```\n\n### 参数说明\n\n| 参数 | 范围 | 说明 |\n|------|------|------|\n| 惯性开关 | 0-1 | 总开关 |\n| 动量保持 | 0.5-0.99 | 速度延续程度，**越高惯性越强** |\n| 振荡频率 | 0.5-15 | 晃动快慢 |\n| 振荡振幅 | 0-3 | 晃动幅度 |\n| 振荡衰减 | 0.5-0.99 | 晃动持续时间，**越高晃动越久** |\n| 质量分布 | 0-3 | 末端权重 |\n\n### 推荐参数组合\n\n**自然余韵（头发/飘带）：**\n```\n动量=0.88, 频率=2, 振幅=0.5, 衰减=0.9\n```\n\n**果冻质感：**\n```\n动量=0.92, 频率=4, 振幅=0.8, 衰减=0.93\n```\n\n**快速抖动（触电/惊吓）：**\n```\n动量=0.8, 频率=10, 振幅=0.3, 衰减=0.85\n```\n\n**重物晃荡（厚重布料）：**\n```\n动量=0.9, 频率=1, 振幅=1.2, 衰减=0.95, 质量=2\n```"])</script><script>self.__next_f.push([1,"30:Ta90,"])</script><script>self.__next_f.push([1,"用户说惯性系统改进后完全没有惯性感觉了，骨骼直接停止。让我分析一下问题所在：\n\n1. 在V7.8中，我重新设计了惯性系统，使用了振荡能量(oscEnergies)和振荡相位(oscPhases)来模拟阻尼振动\n\n2. 问题可能在于：\n   - 振荡能量的累积逻辑有问题\n   - 检测减速的阈值设置不合理\n   - 衰减速度太快\n   - 惯性偏移量计算不正确\n\n让我回顾一下原来V7.2版本的惯性逻辑：\n```\n-- 应用惯性 (将速度加到当前位置)\nif inertiaStrength \u003e 0 then\n(\n    local inertiaPos = velocities[j] * inertiaStrength * massFactor\n    currentPos = currentPos + inertiaPos\n)\n\n-- 计算并存储速度 (用于下一帧的惯性)\nlocal newPos = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]\nlocal newVelocity = newPos - prevPositions[j]\nvelocities[j] = velocities[j] * inertiaDamping + newVelocity * (1.0 - inertiaDamping)\nprevPositions[j] = newPos\n```\n\n这个逻辑是正确的 - 速度会被累积并应用到位置上。\n\n在V7.8中，我把逻辑改复杂了，但可能引入了bug：\n\n\n当检测到减速时才累积振荡能量，然后将速度偏移和振荡偏移都加到位置上。但这里的问题是，如果减速检测的阈值设置得太高，或者振荡能量的衰减太快，就会导致惯性效果完全消失。看起来速度可能根本没有被正确地保留和应用到下一帧。\n\n新速度的计算方式是用旧速度乘以一个衰减因子，再加上当前速度乘以一个很小的系数。这个系数 `inertiaDamping * 0.05` 太小了，意味着新速度几乎完全由旧速度决定，当前速度的影响微乎其微。这样的话，速度更新就失去了意义。\n\n振荡能量的增加只在检测到减速时触发，但减速检测的逻辑可能有问题。更根本的问题是速度更新公式本身就不对——应该是 `velocities[j] * (1 - damping) + newVelocity * damping` 这样的形式。\n\n我需要重新构建一个更清晰的惯性系统。首先是基础惯性，通过速度累积和应用来实现。然后加入振荡效果，在运动停止后产生周期性的晃动。整个系统需要几个可控的参数：惯性强度控制速度保持程度，晃动频率控制振荡的快慢，晃动振幅控制振荡的大小，衰减速度控制振荡消失的速度，还有刚度参数控制回弹的硬度。\n\n核心的计算逻辑是先通过速度累积实现基础惯性，然后计算惯性偏移，最后加入振荡计算。\n\n振荡部分需要在检测到速度变化时给振荡能量充能，通过相位推进计算正弦波形，并让能量逐步衰减，最终的位置就是原位置加上惯性偏移和振荡偏移。"])</script><script>self.__next_f.push([1,"31:Tdc4a,"])</script><script>self.__next_f.push([1,"抱歉，MaxScript中多行数组语法有问题。让我修复这个语法错误：\n\n```maxscript\n/* \n    Sin Wind Spring Generator V7.9 Ultimate\n    - 修复惯性系统：基础惯性 + 阻尼振荡\n    - 更直观的参数控制\n    - 所有参数可K帧\n*/\n\ntry(destroyDialog rol_SinWindSpringUltimate)catch()\n\nglobal sprboneCA = attributes sprbTM\n(\n    parameters main\n    (\n        boneTM type:#matrix3\n    )   \n)\n\nrollout rol_SinWindSpringUltimate \"Sin + Spring 风力生成器 V7.9\" width:650\n(\n    -- === UI 布局 ===\n    \n    group \"1. 风向控制器 (混合/风力/扰动/重力/惯性 都可K帧)\"\n    (\n        button btn_createWindCtrl \"1. 创建风向控制器\" width:300 align:#left across:2 height:30\n        pickbutton pck_ctrl \"2. 拾取控制器\" width:300 align:#right height:30 autoDisplay:true\n        label lbl_ctrlInfo \"★ 必须使用V7.9版本的控制器\" style_sunken:true align:#center color:(color 255 150 50)\n    )\n    \n    group \"2. 姿态控制\"\n    (\n        button btn_setPose \"★ 设定参考姿态\" width:200 align:#left across:3 height:25\n        button btn_pastePose \"粘贴姿态\" width:200 align:#center height:25\n        button btn_straighten \"拉直骨骼\" width:200 align:#right height:25\n    )\n    \n    group \"3. 局部骨骼Sin控制 (当localSinMix\u003e0时生效)\"\n    (\n        label lbl_localX \"X轴(扭转):\" align:#left\n        spinner spn_localX_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localX_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localX_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localX_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localX_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localX_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localX_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n        \n        label lbl_localY \"Y轴(左右):\" align:#left\n        spinner spn_localY_switch \"开关\" type:#float range:[0,1,0] scale:0.01 align:#left across:7 width:75\n        spinner spn_localY_rot \"旋转\" range:[-90,90,5] width:75\n        spinner spn_localY_inc \"递增\" range:[-90,90,2] width:75\n        spinner spn_localY_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localY_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localY_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localY_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n        \n        label lbl_localZ \"Z轴(前后):\" align:#left\n        spinner spn_localZ_switch \"开关\" type:#float range:[0,1,1] scale:0.01 align:#left across:7 width:75\n        spinner spn_localZ_rot \"旋转\" range:[-90,90,8] width:75\n        spinner spn_localZ_inc \"递增\" range:[-90,90,3] width:75\n        spinner spn_localZ_delay \"延迟\" range:[-999,999,4] type:#integer width:75\n        spinner spn_localZ_period \"周期\" range:[5,999,40] type:#integer width:75\n        spinner spn_localZ_posStr \"+强度\" range:[0.1,5,1] scale:0.1 width:75\n        spinner spn_localZ_negStr \"-强度\" range:[0.1,5,1] scale:0.1 width:75\n    )\n    \n    group \"4. Spring弹簧参数\"\n    (\n        spinner spn_springDelay \"弹簧硬度\" range:[0.01, 0.99, 0.3] scale:0.01 align:#left across:3 width:190\n        spinner spn_xSpring \"X轴弹簧\" range:[0.1, 1.0, 0.3] scale:0.01 width:190\n        spinner spn_scaleMotion \"根骨骼缩放\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        spinner spn_subs \"子采样\" range:[1, 10, 1] type:#integer align:#left across:3 width:190\n        spinner spn_boneCount \"骨骼数量\" range:[1, 1000, 50] type:#integer width:190\n        label lbl_empty0 \"\" width:190\n    )\n    \n    group \"5. ★ 末端控制\"\n    (\n        spinner spn_endDamping \"末端阻尼\" range:[0.0, 1.0, 0.5] scale:0.01 align:#left across:3 width:190\n        spinner spn_endFalloff \"末端衰减\" range:[1, 10, 3] type:#integer width:190\n        spinner spn_virtualEndScale \"虚拟末端长度\" range:[0.1, 3.0, 1.0] scale:0.1 width:190\n        \n        checkbox chk_debugVirtualEnd \"调试: 显示虚拟末端\" checked:false align:#left\n    )\n    \n    group \"6. 角度限制 \u0026 根部权重\"\n    (\n        spinner spn_maxAngle \"最大角度\" range:[10.0, 180.0, 80.0] type:#float align:#left across:3 width:190\n        spinner spn_softness \"软限制\" range:[0.0, 1.0, 0.3] scale:0.01 width:190\n        label lbl_empty1 \"\" width:190\n        \n        spinner spn_blend_x \"根部X权重\" type:#float range:[0.0,1.0,1] scale:0.01 align:#left across:3 width:190\n        spinner spn_blend_y \"根部Y权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n        spinner spn_blend_z \"根部Z权重\" type:#float range:[0.0,1.0,1] scale:0.01 width:190\n    )\n    \n    group \"7. 动画设置\"\n    (\n        checkbox chk_loops \"无缝循环\" checked:true align:#left across:4\n        label lbl_empty2 \"\" width:120\n        spinner spn_start \"起始帧\" range:[-99999,99999,0] type:#integer width:150\n        spinner spn_end \"结束帧\" range:[-99999,99999,100] type:#integer width:150\n    )\n    \n    progressbar pb_progress \"进度\" color:red height:20 width:630\n    button btn_bake \"生成 Sin+Spring 风场动画\" width:630 height:40 highlightColor:green\n\n    group \"附加工具\"\n    (\n        button btn_selectChildren \"选择子级\" width:100 align:#left across:6\n        button btn_LoopStart \"首尾循环\" width:100\n        button btn_EulerFilter \"欧拉过滤\" width:100\n        button btn_TCB \"转TCB\" width:100\n        button btn_Euler \"转欧拉\" width:100\n        button btn_reset \"重置参数\" width:100 align:#right\n    )\n\n    -- === 辅助函数 ===\n    \n    fn getBoneLength bone =\n    (\n        if bone.children.count \u003e 0 then\n            return distance bone.pos bone.children[1].pos\n        else\n        (\n            local len = 0.0\n            try (\n                local bbox = nodeGetBoundingBox bone bone.transform\n                len = abs(bbox[2].x - bbox[1].x)\n            ) catch()\n            \n            if len \u003e 0.1 then return len\n            if bone.parent != undefined then\n            (\n                local parentDist = distance bone.pos bone.parent.pos\n                if parentDist \u003e 0.1 then return parentDist\n            )\n            return 10.0\n        )\n    )\n    \n    fn createWindController =\n    (\n        local ctrl = Point name:\"Wind_Controller_V79\" size:30 cross:true axistripod:true \\\n                          centermarker:false wirecolor:(color 255 200 0) pos:[0,0,0]\n        \n        local arrow = Cone radius1:5 radius2:0 height:40 heightsegs:1 capsegs:1 sides:8\n        arrow.name = \"Wind_Arrow\"\n        arrow.wirecolor = yellow\n        arrow.parent = ctrl\n        arrow.pos = [0,30,0]\n        rotate arrow (eulerAngles -90 0 0)\n        \n        custAttributes.add ctrl (\n            attributes \"WindParamsV79\" (\n                parameters main rollout:rlt (\n                    -- 混合控制\n                    springMix type:#float default:1.0 animatable:true ui:spn_springMix\n                    globalWindMix type:#float default:1.0 animatable:true ui:spn_globalWindMix\n                    localSinMix type:#float default:0.0 animatable:true ui:spn_localSinMix\n                    \n                    -- 全局强度\n                    strength type:#float default:1.0 animatable:true ui:spn_str\n                    \n                    -- Sin风力参数\n                    baseForce type:#float default:20.0 animatable:true ui:spn_base\n                    swingAmp type:#float default:8.0 animatable:true ui:spn_swing\n                    period type:#float default:30.0 animatable:true ui:spn_period\n                    \n                    -- 扰动参数\n                    turbStrength type:#float default:15.0 animatable:true ui:spn_turbStr\n                    turbFreq type:#float default:3.0 animatable:true ui:spn_turbFreq\n                    turbSpeed type:#float default:2.0 animatable:true ui:spn_turbSpeed\n                    turbLayers type:#integer default:3 animatable:true ui:spn_turbLayers\n                    turbRoughness type:#float default:2.0 animatable:true ui:spn_turbRough\n                    turbSeed type:#integer default:0 animatable:false ui:spn_turbSeed\n                    \n                    -- 重力参数\n                    gravityX type:#float default:0.0 animatable:true ui:spn_gravX\n                    gravityY type:#float default:0.0 animatable:true ui:spn_gravY\n                    gravityZ type:#float default:0.0 animatable:true ui:spn_gravZ\n                    \n                    -- ★ 惯性系统 (简化但有效)\n                    inertiaEnable type:#float default:1.0 animatable:true ui:spn_inertiaEnable\n                    inertiaMomentum type:#float default:0.85 animatable:true ui:spn_momentum\n                    inertiaOscFreq type:#float default:3.0 animatable:true ui:spn_oscFreq\n                    inertiaOscAmp type:#float default:0.5 animatable:true ui:spn_oscAmp\n                    inertiaOscDecay type:#float default:0.92 animatable:true ui:spn_oscDecay\n                    inertiaMass type:#float default:1.0 animatable:true ui:spn_mass\n                )\n                rollout rlt \"风力参数 V7.9 (可K帧)\" width:320\n                (\n                    group \"★ 混合控制\"\n                    (\n                        spinner spn_springMix \"Spring弹簧:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_globalWindMix \"全局风向:\" range:[0,1,1.0] type:#float scale:0.01\n                        spinner spn_localSinMix \"局部Sin:\" range:[0,1,0.0] type:#float scale:0.01\n                    )\n                    group \"全局强度\"\n                    (\n                        spinner spn_str \"总体强度:\" range:[0,10,1.0] type:#float\n                    )\n                    group \"Sin风力参数\"\n                    (\n                        spinner spn_base \"基础风压(度):\" range:[0,90,20.0] type:#float\n                        spinner spn_swing \"Sin幅度(度):\" range:[0,60,8.0] type:#float\n                        spinner spn_period \"周期(帧):\" range:[1,500,30.0] type:#float\n                    )\n                    group \"★ 多层扰动\"\n                    (\n                        spinner spn_turbStr \"扰动强度(度):\" range:[0,90,15.0] type:#float\n                        spinner spn_turbFreq \"扰动频率:\" range:[0.1,50,3.0] type:#float\n                        spinner spn_turbSpeed \"扰动速度:\" range:[0.1,20,2.0] type:#float\n                        spinner spn_turbLayers \"扰动层数:\" range:[1,8,3] type:#integer\n                        spinner spn_turbRough \"粗糙度:\" range:[0.1,5,2.0] type:#float\n                        spinner spn_turbSeed \"随机种子:\" range:[0,9999,0] type:#integer\n                    )\n                    group \"★ 重力 (XYZ可K帧)\"\n                    (\n                        spinner spn_gravX \"重力 X:\" range:[-500,500,0] type:#float\n                        spinner spn_gravY \"重力 Y:\" range:[-500,500,0] type:#float\n                        spinner spn_gravZ \"重力 Z:\" range:[-500,500,0] type:#float\n                    )\n                    group \"★ 惯性系统 (余韵晃动)\"\n                    (\n                        spinner spn_inertiaEnable \"惯性开关:\" range:[0,1,1.0] type:#float scale:0.01 \\\n                                toolTip:\"0=关闭, 1=开启\"\n                        spinner spn_momentum \"动量保持:\" range:[0.5,0.99,0.85] type:#float scale:0.01 \\\n                                toolTip:\"速度保持程度，越大惯性越强\"\n                        spinner spn_oscFreq \"振荡频率:\" range:[0.5,15,3.0] type:#float scale:0.1 \\\n                                toolTip:\"停止后晃动的快慢\"\n                        spinner spn_oscAmp \"振荡振幅:\" range:[0,3,0.5] type:#float scale:0.1 \\\n                                toolTip:\"停止后晃动的幅度\"\n                        spinner spn_oscDecay \"振荡衰减:\" range:[0.5,0.99,0.92] type:#float scale:0.01 \\\n                                toolTip:\"晃动能量保持，越大晃动越久\"\n                        spinner spn_mass \"质量分布:\" range:[0,3,1.0] type:#float scale:0.1 \\\n                                toolTip:\"0=均匀, 1+=末端更重\"\n                        label lbl_tip1 \"动量0.9+振荡0.5=自然余韵\" align:#left\n                        label lbl_tip2 \"振荡频率高=快速抖动\" align:#left\n                    )\n                )\n            )\n        )\n        return ctrl\n    )\n\n    fn applySoftLimit angle maxAngle softness =\n    (\n        if abs(angle) \u003c= maxAngle then return angle\n        local excess = abs(angle) - maxAngle\n        local sign = if angle \u003e 0 then 1 else -1\n        local softExcess = excess * (1.0 - softness)\n        return sign * (maxAngle + softExcess)\n    )\n\n    fn calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        if turbStrength == 0 then return 0.0\n        \n        local totalTurb = 0.0\n        local amplitude = turbStrength\n        local frequency = turbFreq\n        \n        for layer = 1 to turbLayers do\n        (\n            local timeOffset = absTime * frequency * turbSpeed * 0.05\n            local noisePos = [timeOffset, seed + layer * 137.5, layer * 73.3]\n            local noiseValue = noise3 noisePos\n            local detailPos = [timeOffset * roughness, seed + layer * 200, layer * 50]\n            local detailNoise = noise3 detailPos\n            noiseValue = noiseValue * 0.7 + detailNoise * 0.3\n            totalTurb += noiseValue * amplitude\n            amplitude *= 0.6\n            frequency *= 1.8\n        )\n        return totalTurb\n    )\n    \n    fn calculate_root_wind_with_turbulence absTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers roughness seed =\n    (\n        local timePhase = (absTime / period) * 360.0\n        local sinValue = sin(timePhase)\n        local swingComponent = sinValue * swingAmp\n        local turbulence = calculate_multi_layer_turbulence absTime turbStrength turbFreq turbSpeed turbLayers roughness seed\n        return baseWind + swingComponent + turbulence\n    )\n    \n    fn angleToRotationMatrix angle windDir =\n    (\n        local up = [0,0,1]\n        if (abs (dot windDir up)) \u003e 0.99 then up = [0,1,0]\n        local perpAxis1 = normalize (cross windDir up)\n        local perpAxis2 = normalize (cross windDir perpAxis1)\n        local rot1 = quat (angle * 0.7) perpAxis1\n        local rot2 = quat (angle * 0.3) perpAxis2\n        return (rot1 * rot2) as matrix3\n    )\n    \n    fn get_local_sin_rotation frameTime boneIndex axisType =\n    (\n        local result = eulerAngles 0 0 0\n        case axisType of\n        (\n            1: (\n                if spn_localX_switch.value == 0 then return result\n                local rotAmount = spn_localX_rot.value + (boneIndex - 1) * spn_localX_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localX_delay.value\n                local b = 1.0 / (spn_localX_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then d = d * spn_localX_posStr.value else d = d * spn_localX_negStr.value\n                result = eulerAngles (spn_localX_switch.value * d) 0 0\n            )\n            2: (\n                if spn_localY_switch.value == 0 then return result\n                local rotAmount = spn_localY_rot.value + (boneIndex - 1) * spn_localY_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localY_delay.value\n                local b = 1.0 / (spn_localY_period.value / (2.0 * pi))\n                local d = cos(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then d = d * spn_localY_posStr.value else d = d * spn_localY_negStr.value\n                result = eulerAngles 0 (spn_localY_switch.value * d) 0\n            )\n            3: (\n                if spn_localZ_switch.value == 0 then return result\n                local rotAmount = spn_localZ_rot.value + (boneIndex - 1) * spn_localZ_inc.value\n                local timeOffset = (boneIndex - 1) * spn_localZ_delay.value\n                local b = 1.0 / (spn_localZ_period.value / (2.0 * pi))\n                local d = sin(radtodeg((frameTime - timeOffset) * b))\n                d = radtodeg(d * (degtorad rotAmount))\n                if d \u003e 0 then d = d * spn_localZ_posStr.value else d = d * spn_localZ_negStr.value\n                result = eulerAngles 0 0 (spn_localZ_switch.value * d)\n            )\n        )\n        return result\n    )\n    \n    fn calculateEndDamping boneIndex totalBones endDamping endFalloff =\n    (\n        local startDampingAt = totalBones - endFalloff + 1\n        if boneIndex \u003c startDampingAt then return 0.0\n        local progress = (boneIndex - startDampingAt + 1) as float / endFalloff as float\n        return endDamping * progress\n    )\n    \n    fn calculateMassFactor boneIndex totalBones massDistribution =\n    (\n        if massDistribution == 0 then return 1.0\n        local progress = boneIndex as float / totalBones as float\n        return 1.0 + (progress * massDistribution)\n    )\n    \n    fn getBoneChains roots maxBones = \n    (\n        local chains = #()\n        for r in roots do \n        (\n            if (findItem roots r.parent) == 0 then\n            (\n                local chain = #()\n                local curr = r\n                local count = 0\n                append chain curr\n                while curr.children.count \u003e 0 and count \u003c maxBones do \n                (\n                    curr = curr.children[1] \n                    append chain curr\n                    count += 1\n                )\n                append chains chain\n            )\n        )\n        return chains\n    )\n    \n    fn getAllChildren obj =\n    (\n        local childrenArray = #()\n        for c in obj.children do\n        (\n            append childrenArray c\n            join childrenArray (getAllChildren c)\n        )\n        return childrenArray\n    )\n    \n    fn sortArrayByHeirarchy objectArray =\n    ( \n        local sortedArray = #()\n        local listArray = #()\n        local parentArray = #()\n        local childArray = #()\n        \n        for obj in objectArray do\n        (\n            if (finditem objectArray obj.parent) == 0 then\n                append parentArray obj\n            else \n                append childArray obj  \n        )\n        \n        while childArray.count \u003e 0 do\n        (\n            local i = 1\n            while i \u003c= childArray.count do\n            (\n                local parentIdx = finditem parentArray childArray[i].parent\n                if parentIdx != 0 then\n                (\n                    insertItem childArray[i] parentArray (parentIdx+1) \n                    deleteItem childArray i\n                ) \n                else \n                (\n                    i += 1\n                )\n            )\n        )\n        \n        local a = 1\n        for l = 1 to parentArray.count do\n        (\n            if parentArray[l].children.count \u003e 0 and (finditem parentArray (parentArray[l].children)[1]) != 0 then\n                append listArray parentArray[l]\n            else\n            (\n                append listArray parentArray[l]\n                sortedArray[a] = listArray\n                listArray = #()\n                a += 1\n            )\n        )\n        sortedArray\n    )\n\n    fn BoneLoopStart objectArray =\n    (\n        local firstbonerot = #()\n        local lastbonerot = #()\n        local bonesub = #()\n        local bonelistsub = #()\n        \n        local startFrame = (animationrange.start as string) as integer\n        local endFrame = (animationrange.end as string) as integer\n        local cycleFrame = 30\n        if (endFrame - startframe) \u003c 30 then cycleFrame = (endFrame - startframe)\n        \n        for i = 1 to objectArray.count do\n        (\n            slidertime = animationrange.start\n            for j = 1 to objectArray[i].count do \n                append firstbonerot objectArray[i][j].transform.rotation\n            \n            slidertime = animationrange.end\n            for j = 1 to objectArray[i].count do \n                append lastbonerot objectArray[i][j].transform.rotation\n            \n            for j = 1 to objectArray[i].count do \n                append bonesub (quattoeuler (firstbonerot[j] - lastbonerot[j]))\n            \n            append bonelistsub bonesub\n            firstbonerot = #()\n            lastbonerot = #()\n            bonesub = #()\n        )\n        \n        set animate on\n        for f = 0 to cycleframe do\n        (\n            slidertime = endFrame - f\n            local per = (float)(cycleFrame - f) / cycleFrame\n            for a = 1 to objectArray.count do\n            (\n                for b = 1 to objectArray[a].count do\n                (\n                    local r = bonelistsub[a][b]\n                    if b \u003e 1 then r = quattoeuler(bonelistsub[a][b] as quat - bonelistsub[a][b-1] as quat)\n                    rotate objectArray[a][b] (eulerangles (r.x * per) (r.y * per) (r.z * per))\n                )\n            )\n        )\n        set animate off\n        slidertime = startframe\n    )\n\n    -- === 姿态控制 ===\n    \n    on btn_setPose pressed do with undo \"Set Spring Pose\" on\n    (\n        local count = 0\n        for obj in selection do\n        (\n            local curr = obj\n            local bones = #(curr)\n            while curr.children.count \u003e 0 do \n            (\n                curr = curr.children[1]\n                append bones curr\n            )\n            for b in bones do\n            (\n                if not isProperty b \"boneTM\" then CustAttributes.add b sprboneCA\n                if b.parent != undefined then \n                    b.boneTM = b.transform * (inverse b.parent.transform)\n                else \n                    b.boneTM = b.transform\n                count += 1\n            )\n        )\n        messageBox (\"已为 \" + count as string + \" 根骨骼设定参考姿态。\") title:\"姿态已设定\"\n    )\n    \n    on btn_pastePose pressed do with undo \"Paste Spring Pose\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                for bn in bones do \n                (\n                    if isProperty bn \"boneTM\" then \n                    (\n                        try \n                        (\n                            local targetTM\n                            if bn.parent != undefined then\n                                targetTM = bn.boneTM * bn.parent.transform \n                            else\n                                targetTM = bn.boneTM\n                            \n                            if classof bn == CATBone then \n                                bn.transform = targetTM\n                            else if classof bn == Biped_Object then \n                                biped.setTransform bn #rotation targetTM.rotation true\n                            else if bn.parent != undefined then \n                                bn.rotation.controller.value = targetTM.rotation * inverse bn.parent.transform.rotation\n                            else \n                                bn.rotation = targetTM.rotation\n                        ) \n                        catch()\n                    )\n                )\n            )\n        )\n        resumeEditing()\n    )\n    \n    on btn_straighten pressed do with undo \"Straighten Bones\" on\n    (\n        suspendEditing()\n        animate on\n        (\n            for b in selection do\n            (\n                local bones = #(b)\n                local curr = b\n                while curr.children.count \u003e 0 do \n                (\n                    curr = curr.children[1]\n                    append bones curr\n                )\n                for i = 1 to bones.count do\n                (\n                    local bn = bones[i]\n                    try \n                    (\n                        if classof bn == Biped_Object and bn.parent != undefined then \n                            biped.setTransform bn #rotation bn.parent.transform.rotation true\n                        else if bn.parent != undefined then \n                        (\n                            local newTM = copy bn.parent.transform\n                            newTM.pos = bn.transform.pos\n                            bn.transform = newTM\n                        )\n                    ) \n                    catch()\n                )\n            )\n        )\n        resumeEditing()\n    )\n\n    -- === 核心烘焙逻辑 ===\n\n    on btn_createWindCtrl pressed do\n    (\n        local ctrl = createWindController()\n        pck_ctrl.object = ctrl\n        select ctrl\n        messageBox \"风向控制器V7.9已创建！\\n\\n惯性系统说明：\\n- 动量保持: 速度延续程度 (0.85-0.95推荐)\\n- 振荡频率: 晃动快慢 (1-5正常, 8+抖动)\\n- 振荡振幅: 晃动幅度\\n- 振荡衰减: 晃动持续时间\\n- 质量分布: 末端权重\" title:\"提示\"\n    )\n\n    on btn_bake pressed do with undo \"Bake Sin+Spring Ultimate\" on\n    (\n        clearListener()\n        if selection.count == 0 then \n        (\n            messageBox \"请选择骨骼根部\"\n            return false\n        )\n        \n        local ctrlObj = pck_ctrl.object\n        if not isValidNode ctrlObj then \n        (\n            messageBox \"请先拾取风向控制器\"\n            return false\n        )\n        \n        if not isProperty ctrlObj \"inertiaMomentum\" then \n        (\n            messageBox \"请重新创建V7.9版本控制器\"\n            return false\n        )\n        \n        local chains = getBoneChains (selection as array) spn_boneCount.value\n        local startF = spn_start.value\n        local endF = spn_end.value\n        local maxAngle = spn_maxAngle.value\n        local softness = spn_softness.value\n        local delay = spn_springDelay.value\n        local xSpring = spn_xSpring.value\n        local subs = spn_subs.value\n        local subframe = 1.0 / subs\n        local scaleMotion = spn_scaleMotion.value\n        local blend_x = spn_blend_x.value\n        local blend_y = spn_blend_y.value\n        local blend_z = spn_blend_z.value\n        local loopsCount = if chk_loops.checked then 2 else 1\n        \n        local endDamping = spn_endDamping.value\n        local endFalloff = spn_endFalloff.value\n        local virtualEndScale = spn_virtualEndScale.value\n        local debugVirtualEnd = chk_debugVirtualEnd.checked\n        \n        local allBoneTM = #()       \n        local allPreTimeBoneTM = #() \n        local allPrePos = #()       \n        local allChains = #()\n        local allBoneLengths = #()\n        local allVirtualEndHelpers = #()\n        \n        -- ★ 惯性系统数据\n        local allVelocities = #()\n        local allPrevPositions = #()\n        local allOscPhases = #()\n        local allOscEnergies = #()\n        local allPrevVelocities = #()\n        \n        format \"========================================\\n\"\n        format \"初始化模拟状态 (基于帧 %)...\\n\" startF\n        \n        -- === 初始化数据 ===\n        at time startF\n        (\n            for cIdx = 1 to chains.count do\n            (\n                local chain = chains[cIdx]\n                local boneRelTMs = #()\n                local simTMs = #()\n                local boneLengths = #()\n                local velocities = #()\n                local prevPositions = #()\n                local oscPhases = #()\n                local oscEnergies = #()\n                local prevVelocities = #()\n                \n                for i = 1 to chain.count do\n                (\n                    local b = chain[i]\n                    local relTM\n                    if isProperty b \"boneTM\" then\n                        relTM = b.boneTM \n                    else\n                    (\n                        if b.parent != undefined then\n                            relTM = b.transform * inverse b.parent.transform\n                        else\n                            relTM = b.transform\n                    )\n                    \n                    append boneRelTMs relTM\n                    append simTMs (copy b.transform)\n                    append boneLengths (getBoneLength b)\n                    append velocities [0,0,0]\n                    append prevPositions b.transform.pos\n                    append oscPhases (random 0.0 360.0)\n                    append oscEnergies 0.0\n                    append prevVelocities [0,0,0]\n                )\n                \n                -- 虚拟末端\n                local lastBone = chain[chain.count]\n                local lastBoneLen = boneLengths[boneLengths.count]\n                local virtualLen = lastBoneLen * virtualEndScale\n                \n                for v = 1 to 3 do\n                (\n                    local vTM = matrix3 1\n                    vTM.pos = [virtualLen, 0, 0]\n                    append boneRelTMs vTM\n                    append boneLengths virtualLen\n                    \n                    local parentTM\n                    if v == 1 then \n                        parentTM = lastBone.transform \n                    else \n                        parentTM = simTMs[simTMs.count]\n                    \n                    local vWorldTM = vTM * parentTM\n                    append simTMs vWorldTM\n                    append velocities [0,0,0]\n                    append prevPositions vWorldTM.pos\n                    append oscPhases (random 0.0 360.0)\n                    append oscEnergies 0.0\n                    append prevVelocities [0,0,0]\n                )\n                \n                if chain.count \u003e 1 then \n                    append allPrePos chain[2].transform.pos\n                else \n                    append allPrePos (chain[1].transform.pos + chain[1].transform.row1 * lastBoneLen)\n                \n                append allBoneTM boneRelTMs\n                append allPreTimeBoneTM simTMs\n                append allChains chain\n                append allBoneLengths boneLengths\n                append allVelocities velocities\n                append allPrevPositions prevPositions\n                append allOscPhases oscPhases\n                append allOscEnergies oscEnergies\n                append allPrevVelocities prevVelocities\n                \n                if debugVirtualEnd then\n                (\n                    local helper = Point name:(\"VirtualEnd_\" + cIdx as string) size:5 cross:true wirecolor:(color 255 0 255) pos:simTMs[chain.count + 1].pos\n                    append allVirtualEndHelpers helper\n                )\n                \n                format \"链 %: % 根骨骼\\n\" cIdx chain.count\n            )\n        )\n        \n        format \"开始模拟 (循环次数: %)...\\n\" loopsCount\n        \n        local totalFrames = (endF - startF + 1) * loopsCount\n        local frameCounter = 0\n        pb_progress.value = 0\n        \n        suspendEditing()\n        \n        -- === 主循环 ===\n        for L = 1 to loopsCount do\n        (\n            local isWritePass = (L == loopsCount) \n            \n            -- 循环缝合\n            if isWritePass and chk_loops.checked then\n            (\n                animate on at time startF\n                (\n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        for j = 1 to chain.count do\n                        (\n                            try \n                            (\n                                if classof chain[j] == CATBone then \n                                    chain[j].transform = simTMs[j]\n                                else if classof chain[j].controller == BipSlave_Control then \n                                    biped.setTransform chain[j] #rotation simTMs[j].rotation true\n                                else if chain[j].parent != undefined then \n                                    chain[j].rotation.controller.value = simTMs[j].rotation * inverse chain[j].parent.transform.rotation\n                                else \n                                    chain[j].rotation.controller.value = simTMs[j].rotation\n                            ) \n                            catch ()\n                        )\n                    )\n                )\n            )\n            \n            for t = startF to endF do\n            (\n                if keyboard.escPressed then exit\n                frameCounter += 1\n                pb_progress.value = (100.0 * frameCounter / totalFrames)\n                \n                local currTime = t as float\n                \n                -- 读取控制器参数\n                local windTM = at time t ctrlObj.transform\n                local windDir = normalize (-windTM.row2)\n                \n                local springMix = at time t ctrlObj.springMix\n                local globalWindMix = at time t ctrlObj.globalWindMix\n                local localSinMix = at time t ctrlObj.localSinMix\n                local globalStr = at time t ctrlObj.strength\n                local baseWind = at time t ctrlObj.baseForce\n                local swingAmp = at time t ctrlObj.swingAmp\n                local period = at time t ctrlObj.period\n                \n                local turbStrength = at time t ctrlObj.turbStrength\n                local turbFreq = at time t ctrlObj.turbFreq\n                local turbSpeed = at time t ctrlObj.turbSpeed\n                local turbLayers = at time t ctrlObj.turbLayers\n                local turbRoughness = at time t ctrlObj.turbRoughness\n                local turbSeed = ctrlObj.turbSeed\n                \n                local gravityX = at time t ctrlObj.gravityX\n                local gravityY = at time t ctrlObj.gravityY\n                local gravityZ = at time t ctrlObj.gravityZ\n                local gravityVec = [gravityX, gravityY, gravityZ]\n                \n                -- ★ 惯性参数\n                local inertiaEnable = at time t ctrlObj.inertiaEnable\n                local momentum = at time t ctrlObj.inertiaMomentum\n                local oscFreq = at time t ctrlObj.inertiaOscFreq\n                local oscAmp = at time t ctrlObj.inertiaOscAmp\n                local oscDecay = at time t ctrlObj.inertiaOscDecay\n                local massParam = at time t ctrlObj.inertiaMass\n                \n                for sf = 1 to subs do\n                (\n                    currTime += subframe\n                    \n                    for cIdx = 1 to allChains.count do\n                    (\n                        local chain = allChains[cIdx]\n                        local targetRelTMs = allBoneTM[cIdx]\n                        local simTMs = allPreTimeBoneTM[cIdx] \n                        local prePos = allPrePos[cIdx]\n                        local boneLengths = allBoneLengths[cIdx]\n                        local velocities = allVelocities[cIdx]\n                        local prevPositions = allPrevPositions[cIdx]\n                        local oscPhases = allOscPhases[cIdx]\n                        local oscEnergies = allOscEnergies[cIdx]\n                        local prevVelocities = allPrevVelocities[cIdx]\n                        \n                        local totalNodes = simTMs.count - 1\n                        \n                        local currentPTM \n                        if chain[1].parent != undefined then\n                        (\n                            currentPTM = at time currTime chain[1].parent.transform\n                            local currentPTM_start = at time startF chain[1].parent.transform\n                            \n                            -- ★ 修复：分开计算每个分量\n                            local newPosX = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\n                            local newPosY = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\n                            local newPosZ = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n                            currentPTM.pos = [newPosX, newPosY, newPosZ]\n                        )\n                        else\n                        (\n                            currentPTM = matrix3 1\n                        )\n                        \n                        for j = 1 to totalNodes do\n                        (\n                            local isVirtualEnd = (j \u003e chain.count)\n                            local isRealBone = (j \u003c= chain.count)\n                            \n                            -- 局部Sin\n                            local localSinQuat = quat 0 0 0 1\n                            if localSinMix \u003e 0 and isRealBone then\n                            (\n                                local lsX = get_local_sin_rotation (t - startF) j 1\n                                local lsY = get_local_sin_rotation (t - startF) j 2\n                                local lsZ = get_local_sin_rotation (t - startF) j 3\n                                localSinQuat = (quat lsX) * (quat lsY) * (quat lsZ)\n                            )\n                            \n                            local targetBoneTM = targetRelTMs[j] * currentPTM\n                            \n                            local currentPos\n                            if j == 1 then \n                                currentPos = prePos\n                            else if j + 1 \u003c= simTMs.count then \n                                currentPos = simTMs[j+1].pos\n                            else \n                                currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\n                            \n                            local tpos = targetBoneTM.pos\n                            \n                            -- 末端阻尼\n                            local boneDamping\n                            if isRealBone then\n                                boneDamping = calculateEndDamping j chain.count endDamping endFalloff\n                            else\n                                boneDamping = endDamping * 1.5\n                            \n                            local effectiveDelay = delay + boneDamping * (1.0 - delay)\n                            \n                            -- 质量因子\n                            local massFactor = calculateMassFactor j totalNodes massParam\n                            \n                            -- ★ 惯性系统计算\n                            if inertiaEnable \u003e 0 then\n                            (\n                                -- 1. 计算当前帧的速度\n                                local currentVelocity = currentPos - prevPositions[j]\n                                local velocityMag = length currentVelocity\n                                \n                                -- 2. 检测速度变化（减速/方向变化）→ 给振荡充能\n                                local velocityChange = length (currentVelocity - prevVelocities[j])\n                                \n                                -- 当速度变化时（减速或改变方向），振荡能量增加\n                                if velocityChange \u003e 0.01 then\n                                (\n                                    local energyInput = velocityChange * oscAmp * massFactor * inertiaEnable\n                                    oscEnergies[j] = oscEnergies[j] + energyInput\n                                )\n                                \n                                -- 3. 更新振荡相位\n                                oscPhases[j] = oscPhases[j] + oscFreq * 10.0\n                                if oscPhases[j] \u003e 360000 then oscPhases[j] = mod oscPhases[j] 360.0\n                                \n                                -- 4. 计算振荡偏移\n                                local oscValue = sin(oscPhases[j]) * oscEnergies[j]\n                                \n                                -- 振荡方向：垂直于当前速度方向\n                                local oscDir = [0,0,0]\n                                if velocityMag \u003e 0.001 then\n                                (\n                                    oscDir = normalize (cross (normalize currentVelocity) [0,0,1])\n                                    if length oscDir \u003c 0.001 then oscDir = normalize (cross (normalize currentVelocity) [0,1,0])\n                                )\n                                else if length velocities[j] \u003e 0.001 then\n                                (\n                                    oscDir = normalize (cross (normalize velocities[j]) [0,0,1])\n                                    if length oscDir \u003c 0.001 then oscDir = normalize (cross (normalize velocities[j]) [0,1,0])\n                                )\n                                else\n                                (\n                                    oscDir = [1,0,0]\n                                )\n                                \n                                local oscillationOffset = oscDir * oscValue * inertiaEnable\n                                \n                                -- 5. 振荡能量衰减\n                                oscEnergies[j] = oscEnergies[j] * oscDecay\n                                if oscEnergies[j] \u003c 0.0001 then oscEnergies[j] = 0.0\n                                \n                                -- 6. 动量累积 (速度延续)\n                                velocities[j] = velocities[j] * momentum + currentVelocity * (1.0 - momentum)\n                                \n                                -- 7. 应用惯性偏移\n                                local inertiaOffset = velocities[j] * inertiaEnable * massFactor\n                                \n                                -- 8. 最终位置\n                                currentPos = currentPos + inertiaOffset + oscillationOffset\n                                \n                                -- 9. 更新前一帧速度\n                                prevVelocities[j] = currentVelocity\n                            )\n                            \n                            -- 应用重力\n                            currentPos = currentPos + gravityVec * massFactor * 0.01\n                            \n                            -- Spring计算\n                            local springAngle = 0.0\n                            local springVT = [0,0,1]\n                            \n                            if springMix \u003e 0 then\n                            (\n                                local dot1 = dot (normalize simTMs[j].row1) (normalize targetBoneTM.row1)\n                                if dot1 \u003e 1 then dot1 = 1\n                                if dot1 \u003c -1 then dot1 = -1\n                                local angX = acos(dot1)\n                                \n                                local newTM1 = copy simTMs[j]\n                                local vt1 = normalize (cross simTMs[j].row1 targetBoneTM.row1)\n                                if angX \u003e 0.001 then rotate newTM1 (quat angX -vt1)\n                                newTM1.pos = tpos\n                                \n                                local dot2 = dot (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                if dot2 \u003e 1 then dot2 = 1\n                                if dot2 \u003c -1 then dot2 = -1\n                                local angY1 = acos(dot2)\n                                \n                                local ssvt = cross (normalize newTM1[2]) (normalize targetBoneTM.row2)\n                                local xAxisDelay = xSpring + ((totalNodes - j) / (totalNodes as float) * (1.0 - xSpring))\n                                angY1 = angY1 * xAxisDelay\n                                \n                                if dot ssvt targetBoneTM.row1 \u003e 0 then angY1 = -angY1\n                                if abs angY1 \u003e 0.001 then rotate newTM1 (quat angY1 targetBoneTM.row1)\n                                newTM1.pos = tpos\n                                targetBoneTM = copy newTM1\n                                \n                                local tvector = normalize targetBoneTM.row1\n                                local cvector = normalize (currentPos - tpos)\n                                springVT = normalize (cross cvector tvector)\n                                \n                                local dot3 = dot cvector tvector\n                                if dot3 \u003e 1 then dot3 = 1\n                                if dot3 \u003c -1 then dot3 = -1\n                                springAngle = acos(dot3) * (1.0 - effectiveDelay)\n                            )\n                            \n                            local sangle = springAngle\n                            \n                            -- Root Wind\n                            if j == 1 and globalWindMix \u003e 0 then\n                            (\n                                local windAngle = calculate_root_wind_with_turbulence currTime baseWind swingAmp period turbStrength turbFreq turbSpeed turbLayers turbRoughness (turbSeed + cIdx)\n                                windAngle = applySoftLimit windAngle maxAngle softness\n                                windAngle *= globalStr * globalWindMix\n                                \n                                local windRotMat = angleToRotationMatrix windAngle windDir\n                                local tempTM = copy targetBoneTM\n                                tempTM.pos = [0,0,0]\n                                tempTM = tempTM * windRotMat\n                                tempTM.pos = tpos\n                                targetBoneTM = tempTM\n                                \n                                springAngle *= scaleMotion\n                            )\n                            \n                            springAngle *= springMix\n                            sangle *= springMix\n                            \n                            local effectiveMaxAngle\n                            if isVirtualEnd then\n                                effectiveMaxAngle = maxAngle * 0.5\n                            else if j == chain.count then\n                                effectiveMaxAngle = maxAngle * 0.7\n                            else\n                                effectiveMaxAngle = maxAngle\n                            \n                            springAngle = applySoftLimit springAngle effectiveMaxAngle softness\n                            sangle = applySoftLimit sangle effectiveMaxAngle softness\n                            \n                            local ttm = copy targetBoneTM\n                            \n                            if abs springAngle \u003e 0.001 then rotate targetBoneTM (quat springAngle springVT)\n                            if j == 1 and abs sangle \u003e 0.001 then rotate ttm (quat sangle springVT)\n                            \n                            targetBoneTM.pos = tpos\n                            ttm.pos = tpos\n                            \n                            -- 更新位置记录\n                            prevPositions[j] = targetBoneTM.pos + targetBoneTM.row1 * boneLengths[j]\n                            \n                            -- 写入关键帧\n                            if isWritePass and sf == subs and isRealBone then\n                            (\n                                animate on at time (t + 1f)\n                                (\n                                    try \n                                    (\n                                        local finalRotation = targetBoneTM.rotation\n                                        if localSinMix \u003e 0 then \n                                            finalRotation = slerp targetBoneTM.rotation (targetBoneTM.rotation * localSinQuat) localSinMix\n                                        \n                                        if classof chain[j] == CATBone then\n                                        (\n                                            local finalTM = copy targetBoneTM\n                                            finalTM.rotation = finalRotation\n                                            chain[j].transform = finalTM\n                                        )\n                                        else if classof chain[j].controller == BipSlave_Control then \n                                            biped.setTransform chain[j] #rotation finalRotation true\n                                        else if chain[j].parent != undefined then \n                                            chain[j].rotation.controller.value = finalRotation * inverse currentPTM.rotation\n                                        else \n                                            chain[j].rotation.controller.value = finalRotation\n                                    ) \n                                    catch ()\n                                )\n                            )\n                            \n                            if debugVirtualEnd and isWritePass and sf == subs and j == chain.count + 1 then\n                            (\n                                if cIdx \u003c= allVirtualEndHelpers.count then\n                                    try (allVirtualEndHelpers[cIdx].pos = targetBoneTM.pos) catch()\n                            )\n                            \n                            currentPTM = copy targetBoneTM\n                            simTMs[j] = copy targetBoneTM\n                            \n                            if j == 1 then allPrePos[cIdx] = targetRelTMs[j+1].pos * ttm\n                            if j + 1 \u003c= simTMs.count and j + 1 \u003c= targetRelTMs.count then \n                                simTMs[j+1].pos = targetRelTMs[j+1].pos * targetBoneTM\n                        )\n                        \n                        -- 更新惯性数据\n                        allVelocities[cIdx] = velocities\n                        allPrevPositions[cIdx] = prevPositions\n                        allOscPhases[cIdx] = oscPhases\n                        allOscEnergies[cIdx] = oscEnergies\n                        allPrevVelocities[cIdx] = prevVelocities\n                    )\n                )\n            )\n        )\n        \n        resumeEditing()\n        pb_progress.value = 100\n        format \"========================================\\n\"\n        format \"生成完毕！\\n\"\n        \n        if not debugVirtualEnd then\n        (\n            for h in allVirtualEndHelpers do \n                try(delete h)catch()\n        )\n    )\n    \n    -- === 附加工具 ===\n    \n    on btn_selectChildren pressed do\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择父对象！\"\n            return false\n        )\n        local currentSel = selection as array\n        local allChildren = #()\n        for obj in currentSel do join allChildren (getAllChildren obj)\n        if allChildren.count \u003e 0 then select (currentSel + allChildren)\n    )\n    \n    on btn_LoopStart pressed do with undo on\n    (\n        if selection.count == 0 then \n        (\n            messageBox \"请先选择骨骼！\"\n            return false\n        )\n        animButtonState = false\n        BoneLoopStart (sortArrayByHeirarchy (selection as array))\n    )\n    \n    on btn_EulerFilter pressed do with undo on\n    (\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n            (\n                obj.Rotation.Controller = TCB_Rotation()\n                obj.Rotation.Controller = Euler_XYZ()\n            )\n        )\n    )\n    \n    on btn_TCB pressed do with undo on\n    (\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n                obj.Rotation.Controller = TCB_Rotation()\n        )\n    )\n    \n    on btn_Euler pressed do with undo on\n    (\n        for obj in selection where (isKindOf obj GeometryClass or isKindOf obj Helper) do\n        (\n            if obj.rotation.controller != undefined then\n                obj.Rotation.Controller = Euler_XYZ()\n        )\n    )\n    \n    on btn_reset pressed do\n    (\n        spn_localX_switch.value = 0\n        spn_localX_rot.value = 5\n        spn_localX_inc.value = 2\n        spn_localX_delay.value = 4\n        spn_localX_period.value = 40\n        spn_localX_posStr.value = 1\n        spn_localX_negStr.value = 1\n        \n        spn_localY_switch.value = 0\n        spn_localY_rot.value = 5\n        spn_localY_inc.value = 2\n        spn_localY_delay.value = 4\n        spn_localY_period.value = 40\n        spn_localY_posStr.value = 1\n        spn_localY_negStr.value = 1\n        \n        spn_localZ_switch.value = 1\n        spn_localZ_rot.value = 8\n        spn_localZ_inc.value = 3\n        spn_localZ_delay.value = 4\n        spn_localZ_period.value = 40\n        spn_localZ_posStr.value = 1\n        spn_localZ_negStr.value = 1\n        \n        spn_springDelay.value = 0.3\n        spn_xSpring.value = 0.3\n        spn_subs.value = 1\n        spn_scaleMotion.value = 1.0\n        spn_boneCount.value = 50\n        \n        spn_endDamping.value = 0.5\n        spn_endFalloff.value = 3\n        spn_virtualEndScale.value = 1.0\n        \n        spn_maxAngle.value = 80.0\n        spn_softness.value = 0.3\n        spn_blend_x.value = 1\n        spn_blend_y.value = 1\n        spn_blend_z.value = 1\n    )\n    \n    on rol_SinWindSpringUltimate open do\n    (\n        spn_start.value = animationRange.start.frame\n        spn_end.value = animationRange.end.frame\n        local tf = animationRange.end.frame - animationRange.start.frame\n        spn_localX_period.value = tf\n        spn_localY_period.value = tf\n        spn_localZ_period.value = tf\n        format \"Sin+Spring V7.9 已加载\\n\"\n    )\n)\n\ncreateDialog rol_SinWindSpringUltimate\n\nformat \"========================================\\n\"\nformat \"Sin+Spring V7.9 惯性系统说明:\\n\"\nformat \"========================================\\n\"\nformat \"动量保持 (0.5-0.99):\\n\"\nformat \"  越高=速度越持久=惯性越强\\n\"\nformat \"  0.85=正常, 0.95=很强惯性\\n\"\nformat \"----------------------------------------\\n\"\nformat \"振荡频率 (0.5-15):\\n\"\nformat \"  越高=晃动越快\\n\"\nformat \"  1-3=缓慢晃荡, 8+=快速抖动\\n\"\nformat \"----------------------------------------\\n\"\nformat \"振荡振幅 (0-3):\\n\"\nformat \"  晃动的幅度大小\\n\"\nformat \"----------------------------------------\\n\"\nformat \"振荡衰减 (0.5-0.99):\\n\"\nformat \"  越高=晃动持续越久\\n\"\nformat \"  0.8=快速停止, 0.95=长时间晃动\\n\"\nformat \"========================================\\n\"\nformat \"推荐组合:\\n\"\nformat \"自然余韵: 动量0.88, 频率2, 振幅0.5, 衰减0.9\\n\"\nformat \"果冻感: 动量0.92, 频率4, 振幅0.8, 衰减0.93\\n\"\nformat \"快速抖动: 动量0.8, 频率10, 振幅0.3, 衰减0.85\\n\"\nformat \"重物晃荡: 动量0.9, 频率1, 振幅1.2, 衰减0.95\\n\"\nformat \"========================================\\n\"\n```\n\n修复的语法错误是这一行：\n\n```maxscript\n-- 错误写法 (多行数组):\ncurrentPTM.pos = [\n    currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x),\n    currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y),\n    currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\n]\n\n-- 正确写法 (分开计算):\nlocal newPosX = currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x)\nlocal newPosY = currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y)\nlocal newPosZ = currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\ncurrentPTM.pos = [newPosX, newPosY, newPosZ]\n```\n\nMaxScript不支持在方括号内直接换行，必须分开计算或者写在一行。现在脚本应该可以正常运行了。"])</script><script>self.__next_f.push([1,"5:[\"$\",\"$L1f\",null,{\"initialState\":{\"id\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"userId\":\"019bb20d-d385-7729-93cc-4fd65a481c5b\",\"title\":\"/* \\n    Sin Wind Spring Generator V5.5 (Root Parent Fix)\\n    - Fix: Solves \\\"transform in undefined\\\" \",\"mode\":\"direct\",\"visibility\":\"public\",\"lastMessageIds\":[\"019bb2a4-42ac-73f3-bcaf-221566318215\"],\"deletedAt\":null,\"deletionPendingProcessing\":false,\"createdAt\":\"2026-01-12 12:13:12.936+00\",\"updatedAt\":\"2026-01-12 14:37:51.452928+00\",\"messages\":[{\"id\":\"019bb21f-59e0-7a49-8588-e91c3c585f00\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[],\"content\":\"$20\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T12:13:13.299998+00:00\",\"updatedAt\":\"2026-01-12T12:13:13.299998+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.5,\"botScoreType\":\"recaptcha_v2\",\"recaptchaDidFail\":false,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"16\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"55857d332a91e6e42db2ad7e3b31aa450c740f35693ab76dd304def24d3670a6\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb21f-59e0-79b7-9931-4b42a0743735\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb21f-59e0-7a49-8588-e91c3c585f00\"],\"content\":\"$21\",\"reasoning\":\"$22\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T12:13:13.314757+00:00\",\"updatedAt\":\"2026-01-12T12:17:13.185998+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":1248,\"timeToStreamCompleteMs\":239817,\"timeToFirstContentTokenMs\":54251,\"timeToFirstReasoningTokenMs\":1254}},{\"id\":\"019bb234-d7cf-7260-b595-38d72555a6fd\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb21f-59e0-79b7-9931-4b42a0743735\"],\"content\":\"我看了一下你这个模式混合啊，0=局部sin，1=全局风动，没有把spring算在里面啊，如果我只单纯想要spring怎么办呢，所以我需要把这些混合数字，都拆分成三个参数才对，而且这个扰动强度啊，并不理想，我希望的是，可以很多很多股风冲撞到我的骨骼链的感觉，波峰波谷在我打高这个数值的时候是接踵而至的，现在力度非常小，而且没有频率控制参数\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T12:36:09.154541+00:00\",\"updatedAt\":\"2026-01-12T12:36:09.154541+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.699999988079071,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.699999988079071,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"24\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"4513e026bbde5d781d93d7bac574016af1992c4cdb668049bc21229c9e3daf55\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb234-d7cf-7219-8b90-9f26bac712e0\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb234-d7cf-7260-b595-38d72555a6fd\"],\"content\":\"$23\",\"reasoning\":\"$24\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T12:36:09.159843+00:00\",\"updatedAt\":\"2026-01-12T12:40:09.769872+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":1813,\"timeToStreamCompleteMs\":240591,\"timeToFirstContentTokenMs\":20702,\"timeToFirstReasoningTokenMs\":1816}},{\"id\":\"019bb23d-5f0c-7261-99b0-0f2b45a20b37\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb234-d7cf-7219-8b90-9f26bac712e0\"],\"content\":\"混合控制的三个参数可以写在风向控制面板上面，我希望可以K帧，包括扰动面板也希望可以K帧\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T12:45:28.078901+00:00\",\"updatedAt\":\"2026-01-12T12:45:28.078901+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"8\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"55857d332a91e6e42db2ad7e3b31aa450c740f35693ab76dd304def24d3670a6\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb23d-5f0c-7de2-a81c-b2be00538010\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb23d-5f0c-7261-99b0-0f2b45a20b37\"],\"content\":\"$25\",\"reasoning\":\"用户希望：\\n1. 混合控制的三个参数（Spring弹簧、全局风向、局部Sin）可以K帧\\n2. 扰动面板的参数也可以K帧\\n\\n这意味着我需要把这些参数都添加到风向控制器的自定义属性中，这样就可以在控制器上直接K帧了。\\n\\n让我重新设计风向控制器的自定义属性，包含：\\n1. 核心参数：\\n   - strength (总体强度)\\n   - baseForce (基础风压)\\n   - swingAmp (Sin幅度)\\n\\n2. 混合控制：\\n   - springMix (Spring混合)\\n   - globalWindMix (全局风混合)\\n   - localSinMix (局部Sin混合)\\n\\n3. 扰动参数：\\n   - turbStrength (扰动强度)\\n   - turbFreq (扰动频率)\\n   - turbSpeed (扰动速度)\\n   - turbLayers (扰动层数) - 这个可能不需要K帧，因为是整数\\n   - turbRoughness (粗糙度)\\n\\n我需要更新createWindController函数，在自定义属性中添加这些参数。\\n\\n同时在主循环中，需要从控制器读取这些K帧参数而不是从UI读取。\\n\\n让我重写这个脚本。\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T12:45:28.088946+00:00\",\"updatedAt\":\"2026-01-12T12:49:03.671248+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":1897,\"timeToStreamCompleteMs\":215552,\"timeToFirstContentTokenMs\":10010,\"timeToFirstReasoningTokenMs\":2652}},{\"id\":\"019bb248-208d-73f6-af05-65069cc3a192\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb23d-5f0c-7de2-a81c-b2be00538010\"],\"content\":\"这个算法，末端他似乎会出现前所未有的旋转增幅曲线，和前一节完全不同，他会出现不同程度的旋转折叠，你能帮助我虚拟一个假的末端，解决这个问题吗\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T12:57:12.945651+00:00\",\"updatedAt\":\"2026-01-12T12:57:12.945651+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"5\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"4513e026bbde5d781d93d7bac574016af1992c4cdb668049bc21229c9e3daf55\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb248-208d-76f3-9382-5e138a7e8884\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb248-208d-73f6-af05-65069cc3a192\"],\"content\":\"$26\",\"reasoning\":\"用户反映骨骼链末端出现异常的旋转增幅，导致折叠问题。这是Spring算法中常见的问题 - 末端骨骼没有子级来约束，所以会出现过度旋转。\\n\\n解决方案是创建一个\\\"虚拟末端点\\\"(Virtual End Point)，让末端骨骼有一个假的子级来计算，这样可以稳定末端的行为。\\n\\n具体实现思路：\\n1. 在骨骼链末端添加一个虚拟点（不是真实的骨骼对象，只是一个计算用的位置/矩阵）\\n2. 这个虚拟点继承末端骨骼的变换特性\\n3. 在Spring计算时，用这个虚拟点来约束末端骨骼的旋转\\n\\n我需要修改以下部分：\\n1. 初始化时，为每条链添加虚拟末端数据\\n2. 在主循环中，处理虚拟末端的位置更新\\n3. 确保末端骨骼的计算考虑到虚拟末端\\n\\n让我重新审视代码中关于末端处理的逻辑：\\n\\n当前代码在初始化时已经有添加末端的逻辑：\\n```maxscript\\nif chain.count \u003e 1 then\\n(\\n    local lastRelTM = copy boneRelTMs[boneRelTMs.count]\\n    append boneRelTMs lastRelTM \\n    local endWorldTM = lastRelTM * chain[chain.count].transform\\n    append simTMs endWorldTM\\n\\n\\n)\\n```\\n\\n但问题可能在于虚拟末端的相对变换设置不当，或者在Spring计算过程中没有正确处理。虚拟末端应该沿着最后一根骨骼的X轴方向延伸，长度与该骨骼相近，这样才能有效约束末端的旋转行为。\\n\\n我需要添加虚拟末端长度的参数，改进其初始化逻辑，并在主循环中让它参与Spring计算但不写入关键帧。同时可能需要加入末端阻尼参数来控制其运动特性。\\n\\n首先定义一个函数来获取骨骼长度，通过检查子骨骼距离或使用包围盒作为备选方案。然后为链的最后一根骨骼创建虚拟末端，设置其相对变换矩阵使其沿X轴延伸指定长度。\\n\\n在初始化时，将虚拟末端的世界变换矩阵添加到模拟数据中。\\n\\n在主循环里，虚拟末端需要参与Spring力计算，但不应该写入关键帧。为了增强末端的稳定性，可以引入一个末端阻尼参数来控制其运动的衰减程度。\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T12:57:12.953943+00:00\",\"updatedAt\":\"2026-01-12T13:01:32.159648+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":2023,\"timeToStreamCompleteMs\":259150,\"timeToFirstContentTokenMs\":25913,\"timeToFirstReasoningTokenMs\":2026}},{\"id\":\"019bb24e-0f41-7f6b-9598-08a975937e9b\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb248-208d-76f3-9382-5e138a7e8884\"],\"content\":\"-- 匿名 codeblock; 文件名: ; 位置: 37119; line: 869 中发生错误\\n-- 语法错误: 位于 else，需要 \u003c因子\u003e\\n--  所在行:                             else i\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T13:03:42.209721+00:00\",\"updatedAt\":\"2026-01-12T13:03:42.209721+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.5,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.5,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"6\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"4513e026bbde5d781d93d7bac574016af1992c4cdb668049bc21229c9e3daf55\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb24e-0f42-7b5b-89cf-3be9031430b6\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb24e-0f41-7f6b-9598-08a975937e9b\"],\"content\":\"$27\",\"reasoning\":\"$28\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T13:03:42.215841+00:00\",\"updatedAt\":\"2026-01-12T13:07:43.470276+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":2281,\"timeToStreamCompleteMs\":241214,\"timeToFirstContentTokenMs\":19681,\"timeToFirstReasoningTokenMs\":2330}},{\"id\":\"019bb26b-f0cf-7162-a08f-c754461775f5\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb24e-0f42-7b5b-89cf-3be9031430b6\"],\"content\":\"$29\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T13:36:20.445971+00:00\",\"updatedAt\":\"2026-01-12T13:36:20.445971+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"14\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"55857d332a91e6e42db2ad7e3b31aa450c740f35693ab76dd304def24d3670a6\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb26b-f0d0-7504-bc46-f3fba7772fc9\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb26b-f0cf-7162-a08f-c754461775f5\"],\"content\":\"$2a\",\"reasoning\":\"问题在于当 j = 9 时（第二个虚拟末端点），尝试访问 `simTMs[j+1].pos` 但 j+1 = 10 超出了数组范围。\\n\\n看错误信息：\\n- j: 9\\n- totalNodes: 9\\n- simTMs 只有 9 个元素\\n\\n当 j = 9 时，`currentPos = simTMs[j+1].pos` 会尝试访问 `simTMs[10]`，这是不存在的。\\n\\n我需要修复这个边界检查问题。当 j 是最后一个节点时，不应该尝试访问 j+1。\\n\\n让我检查代码逻辑：\\n\\n```maxscript\\nlocal currentPos = if j == 1 then prePos else simTMs[j+1].pos\\n```\\n\\n这里的问题是：\\n- 当 j = 1 时，使用 prePos\\n- 当 j \u003e 1 时，使用 simTMs[j+1].pos\\n\\n但当 j = totalNodes (9) 时，j+1 = 10 超出范围了。\\n\\n实际上，对于最后一个虚拟节点，我们不需要它的\\\"下一个\\\"位置，因为它本身就是用来约束倒数第二个节点的。\\n\\n修复方案：\\n1. 对于最后一个节点（j == totalNodes），使用一个估算的位置，或者直接跳过计算\\n2. 或者在初始化时多加一个虚拟点用于计算\\n\\n让我选择方案1，当 j == totalNodes 时，使用当前节点沿X轴延伸的位置：\\n\\n\\n```maxscript\\nlocal currentPos\\nif j == 1 then\\n    currentPos = prePos\\nelse if j \u003c totalNodes then\\n    currentPos = simTMs[j+1].pos\\nelse\\n    currentPos = simTMs[j].pos + simTMs[j].row1 * boneLengths[j]\\n```\\n\\n同时需要检查其他访问 simTMs[j+1] 的地方，确保也加上边界检查，比如在更新位置时也要确保 j \u003c totalNodes。\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T13:36:20.449981+00:00\",\"updatedAt\":\"2026-01-12T13:40:31.64163+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":9743,\"timeToStreamCompleteMs\":251154,\"timeToFirstContentTokenMs\":22713,\"timeToFirstReasoningTokenMs\":9754}},{\"id\":\"019bb282-0710-7e5a-883f-a8750292d99d\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb26b-f0d0-7504-bc46-f3fba7772fc9\"],\"content\":\"可以再添加一个惯性的参数吗，我希望通过这个开关他停下来的时候，不要完全静止，有一点质量的感觉，而且我需要一个重力的调节\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T14:00:28.305412+00:00\",\"updatedAt\":\"2026-01-12T14:00:28.305412+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"7\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"55857d332a91e6e42db2ad7e3b31aa450c740f35693ab76dd304def24d3670a6\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb282-0711-7f9c-b3c8-b9bb95c085ab\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb282-0710-7e5a-883f-a8750292d99d\"],\"content\":\"$2b\",\"reasoning\":\"用户想要添加两个功能：\\n1. 惯性参数 - 让骨骼在停止时不会立即静止，而是有一定的延续运动（类似质量/动量的效果）\\n2. 重力调节 - 实际上已经有重力参数了（spn_gravity），但用户可能想要更完善的重力控制\\n\\n让我来实现：\\n\\n1. **惯性系统**：\\n   - 需要存储前一帧的速度/角速度\\n   - 当运动减速时，惯性会让骨骼继续运动一段时间\\n   - 可以用velocity damping的方式实现\\n   - 存储每个节点的前一帧位置，计算速度，然后在下一帧应用一部分这个速度\\n\\n2. **重力控制**：\\n   - 已有Z轴重力\\n   - 可以添加XYZ三轴独立重力控制\\n   - 或者添加重力方向控制\\n\\n让我设计惯性系统：\\n- `inertia` 参数：0-1，控制惯性强度\\n- 需要存储 `allPrevVelocity` 数组来记录每个节点的速度\\n- 每帧计算当前位置与上一帧位置的差值作为速度\\n- 将速度乘以惯性系数加到当前位置上\\n\\n重力可以改成三轴控制，或者添加到控制器上让它可以K帧。\\n\\n让我实现这个：\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T14:00:28.312338+00:00\",\"updatedAt\":\"2026-01-12T14:05:03.138212+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":5734,\"timeToStreamCompleteMs\":274789,\"timeToFirstContentTokenMs\":16834,\"timeToFirstReasoningTokenMs\":5752}},{\"id\":\"019bb287-9a60-7972-936d-8944af84db81\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb282-0711-7f9c-b3c8-b9bb95c085ab\"],\"content\":\"$2c\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T14:06:33.199163+00:00\",\"updatedAt\":\"2026-01-12T14:06:33.199163+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"7\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"55857d332a91e6e42db2ad7e3b31aa450c740f35693ab76dd304def24d3670a6\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb287-9a60-7ea9-b32d-10e70b693fef\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb287-9a60-7972-936d-8944af84db81\"],\"content\":\"$2d\",\"reasoning\":\"用户遇到了两个问题：\\n1. 控制器缺少gravityX/Y/Z属性（因为他们使用的是旧版控制器）\\n2. 用户希望：\\n   - 惯性系统参数也可以K帧\\n   - 局部骨骼Sin可以设置正负轴向的强度（比如+Y和-Y可以有不同强度）\\n\\n我需要：\\n1. 修复控制器属性检查逻辑\\n2. 把惯性参数也放到控制器上（可K帧）\\n3. 为局部Sin添加正负轴向强度控制\\n\\n让我重新编写脚本。\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T14:06:33.210925+00:00\",\"updatedAt\":\"2026-01-12T14:11:03.003341+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":2948,\"timeToStreamCompleteMs\":269750,\"timeToFirstContentTokenMs\":7765,\"timeToFirstReasoningTokenMs\":2950}},{\"id\":\"019bb28f-301e-7218-8348-93e02bc07777\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb287-9a60-7ea9-b32d-10e70b693fef\"],\"content\":\"惯性的衰减被锁死在0.8了，不能更方便的调节了，解锁，然后是这个惯性系统太简陋了，我没办法准确控制他停下来的晃动频率，我有时候希望他晃动的快一些，或者慢一些，或者幅度大一些\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T14:14:51.6479+00:00\",\"updatedAt\":\"2026-01-12T14:14:51.6479+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"7\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"55857d332a91e6e42db2ad7e3b31aa450c740f35693ab76dd304def24d3670a6\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb28f-301f-7abb-95dd-a7a615f16238\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb28f-301e-7218-8348-93e02bc07777\"],\"content\":\"$2e\",\"reasoning\":\"用户提出了两个问题：\\n\\n1. 惯性衰减被锁死在0.8-0.99范围，需要解锁更大范围\\n2. 惯性系统太简陋，需要更精细的控制：\\n   - 晃动频率控制\\n   - 晃动幅度控制\\n   - 停止时的余韵效果\\n\\n我需要重新设计惯性系统，让它更像一个真正的弹簧振动系统。物理上，一个阻尼弹簧系统的行为由以下参数控制：\\n- 弹簧刚度 (stiffness) - 控制振动频率\\n- 阻尼比 (damping ratio) - 控制衰减速度\\n- 质量 (mass) - 影响频率和惯性\\n\\n对于停止时的晃动，我需要实现类似\\\"二次振动\\\"的效果：\\n- 惯性振幅：停止后晃动的初始幅度\\n- 惯性频率：晃动的快慢\\n- 惯性衰减：晃动消失的速度\\n\\n让我重新设计惯性系统：\\n\\n1. **惯性强度** (0-1): 基础惯性大小\\n2. **惯性频率** (0.1-10): 余韵晃动的频率，越大晃动越快\\n3. **惯性衰减** (0-1): 完全解锁范围，0=不衰减，1=立即消失\\n4. **惯性振幅** (0-5): 余韵晃动的幅度倍率\\n\\n\\n5. **质量分布** (0-2): 末端质量分布\\n\\n实现上，我需要存储每个骨骼的速度向量，当运动减速时触发振荡行为。振荡采用sin波形，参数可调，并随时间衰减。最后更新控制器属性定义、惯性计算逻辑和UI面板参数。\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T14:14:51.653994+00:00\",\"updatedAt\":\"2026-01-12T14:19:48.230844+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":3410,\"timeToStreamCompleteMs\":296541,\"timeToFirstContentTokenMs\":15050,\"timeToFirstReasoningTokenMs\":3416}},{\"id\":\"019bb29f-3676-7cc7-af87-a74852530bad\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb28f-301f-7abb-95dd-a7a615f16238\"],\"content\":\"怎么这个惯性系统更改后，却完全没有了惯性的感觉，他直接就停止了，这里面肯定有问题\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T14:32:20.441741+00:00\",\"updatedAt\":\"2026-01-12T14:32:20.441741+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.699999988079071,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.699999988079071,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"5\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"4513e026bbde5d781d93d7bac574016af1992c4cdb668049bc21229c9e3daf55\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb29f-3677-759e-b5e3-5df2450c1d4b\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb29f-3676-7cc7-af87-a74852530bad\"],\"content\":\"$2f\",\"reasoning\":\"$30\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T14:32:20.445861+00:00\",\"updatedAt\":\"2026-01-12T14:37:15.188231+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":6231,\"timeToStreamCompleteMs\":294703,\"timeToFirstContentTokenMs\":29645,\"timeToFirstReasoningTokenMs\":6238}},{\"id\":\"019bb2a4-42ab-790c-ba5e-5eb381af1550\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"user\",\"parentMessageIds\":[\"019bb29f-3677-759e-b5e3-5df2450c1d4b\"],\"content\":\"\u003cAttributeDef:sprbTM\u003e\\n-- 匿名 codeblock; 文件名: ; 位置: 34124; line: 778 中发生错误\\n-- 语法错误: 位于 eol，需要 ,\\n--  所在行:                                 currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\",\"experimental_attachments\":[],\"modelId\":null,\"createdAt\":\"2026-01-12T14:37:51.419749+00:00\",\"updatedAt\":\"2026-01-12T14:37:51.419749+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"botScore\":0.6000000238418579,\"botScoreType\":\"recaptcha_v3\",\"recaptchaDidFail\":false,\"recaptchaV3Score\":0.6000000238418579,\"cloudflareMetadata\":{\"ja4\":\"t13d1517h2_8daaf6152771_b6f405a00624\",\"botScore\":\"5\",\"clientAsn\":\"46844\",\"clientCountry\":\"US\",\"hashedClientIp\":\"4513e026bbde5d781d93d7bac574016af1992c4cdb668049bc21229c9e3daf55\",\"ja4_ips_rank_1h\":\"5\",\"ja4_uas_rank_1h\":\"10\",\"ja4_reqs_rank_1h\":\"5\",\"ja4_h2h3_ratio_1h\":\"0.95037305355072\",\"ja4_paths_rank_1h\":\"6\",\"ja4_cache_ratio_1h\":\"0.25499990582466\",\"ja4_ips_quantile_1h\":\"0.99999403953552\",\"ja4_browser_ratio_1h\":\"0.92225974798203\",\"ja4_reqs_quantile_1h\":\"0.99999403953552\",\"ja4_heuristic_ratio_1h\":\"0.001506510307081\"}}},{\"id\":\"019bb2a4-42ac-73f3-bcaf-221566318215\",\"evaluationSessionId\":\"019bb20e-3a6d-7296-b16e-aab6357c7b8c\",\"evaluationId\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"role\":\"assistant\",\"parentMessageIds\":[\"019bb2a4-42ab-790c-ba5e-5eb381af1550\"],\"content\":\"$31\",\"reasoning\":\"The user is getting a syntax error. The issue is with the array syntax on this line:\\n\\n```maxscript\\ncurrentPTM.pos = [\\n    currentPTM.pos.x * blend_x + currentPTM_start.pos.x * (1.0 - blend_x),\\n    currentPTM.pos.y * blend_y + currentPTM_start.pos.y * (1.0 - blend_y),\\n    currentPTM.pos.z * blend_z + currentPTM_start.pos.z * (1.0 - blend_z)\\n]\\n```\\n\\nIn MaxScript, when you have a multi-line array definition, you need to be careful about line continuation. The issue is that MaxScript doesn't automatically continue lines within brackets like some other languages. I need to either:\\n\\n1. Put it all on one line\\n2. Use the backslash `\\\\` for line continuation\\n3. Use different syntax\\n\\nLet me fix this by putting it on one line or using proper syntax.\",\"experimental_attachments\":[],\"modelId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"createdAt\":\"2026-01-12T14:37:51.443923+00:00\",\"updatedAt\":\"2026-01-12T14:42:26.539313+00:00\",\"participantPosition\":\"a\",\"status\":\"success\",\"failureReason\":null,\"metadata\":{\"timeToFirstTokenMs\":4181,\"timeToStreamCompleteMs\":275043,\"timeToFirstContentTokenMs\":9214,\"timeToFirstReasoningTokenMs\":4190}}],\"maskedEvaluations\":[{\"id\":\"019bb21f-e368-79c3-b39b-6173b5a3501b\",\"modality\":\"chat\",\"arenaId\":\"4c249f58-2f34-4859-bbdb-4233a8313340\"}],\"pairwiseFeedbacks\":[],\"pointwiseFeedbacks\":[]},\"children\":\"$L32\"}]\n"])</script><script>self.__next_f.push([1,"33:I[66701,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"ModelStoreProvider\"]\n"])</script><script>self.__next_f.push([1,"32:[\"$\",\"$L33\",null,{\"initialModels\":[{\"id\":\"0199f059-3877-7cfe-bc80-e01b1a4a83de\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"gemini-2.5-flash\",\"name\":\"gemini-2.5-flash\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-opus-4-5-20251101-thinking-32k\",\"name\":\"claude-opus-4-5-20251101-thinking-32k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019adcc2-c05e-7b1a-a950-92b1ca78087b\",\"publicName\":\"evo-logic\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b4231-1994-75a1-8567-8cba308fba55\",\"organization\":\"minimax\",\"provider\":\"minimaxAnthropic\",\"publicName\":\"minimax-m2.1-preview\",\"name\":\"minimax-m2.1-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019adbec-8396-71cc-87d5-b47f8431a6a6\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-opus-4-5-20251101\",\"name\":\"claude-opus-4-5-20251101-vertex\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019adb32-bb7a-77eb-882f-b8e3aaa2b2fd\",\"organization\":\"deepseek\",\"provider\":\"deepseekToolCalling\",\"publicName\":\"deepseek-v3.2-thinking\",\"name\":\"deepseek-v3.2-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019ade1a-a918-79dd-9ef9-ba22f97c977d\",\"publicName\":\"micro-mango\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b5826-abdd-7d67-9951-f00982b5eeee\",\"organization\":\"xiaomi\",\"provider\":\"xiaomiV1\",\"publicName\":\"mimo-v2-flash (thinking)\",\"name\":\"mimo-v2-flash-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019b5da6-19e7-7dcd-8387-e6bac5d6145e\",\"publicName\":\"anonymous-1218\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"14e9311c-94d2-40c2-8c54-273947e208b0\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-4.1-2025-04-14\",\"name\":\"gpt-4.1-2025-04-14\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"69f5d38a-45f5-4d3a-9320-b866a4035ed9\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"mistral-small-3.1-24b-instruct-2503\",\"name\":\"mistral-small-3.1-24b-instruct-2503\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"42015285-534d-4e6b-9a9a-9061c2f73e1c\",\"publicName\":\"x1-1-preview-0915\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"4ddb69f5-391a-4f78-af92-7d7328c18ab1\",\"organization\":\"ibm\",\"provider\":\"ibm\",\"publicName\":\"ibm-granite-h-small\",\"name\":\"ibm-granite-h-small\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199e3d1-a308-77b9-a650-41453e8ef2fb\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-vl-8b-thinking\",\"name\":\"qwen3-vl-8b-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199e3d1-a713-7de2-a5dd-a1583cad9532\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-vl-8b-instruct\",\"name\":\"qwen3-vl-8b-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a184d-efba-7743-979a-324e949aa1c4\",\"publicName\":\"ernie-exp-251024\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b95b7-f811-7c25-b0a9-ec35a1a7bf62\",\"publicName\":\"beluga-0104-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"27b9f8c6-3ee1-464a-9479-a8b3c2a48fd4\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"mistral-medium-2505\",\"name\":\"mistral-medium-2505\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b5da7-c6eb-73f2-b228-0c1e8e1c77ce\",\"publicName\":\"anonymous-1221\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"6a3a1e04-050e-4cb4-9052-b9ac4bec0c38\",\"organization\":\"tencent\",\"provider\":\"tencent\",\"publicName\":\"hunyuan-vision-1.5-thinking\",\"name\":\"hunyuan-vision-1.5-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0f785ba1-efcb-472d-961e-69f7b251c7e3\",\"organization\":\"cohere\",\"provider\":\"cohere\",\"publicName\":\"command-a-03-2025\",\"name\":\"command-a-03-2025\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"2f5253e4-75be-473c-bcfc-baeb3df0f8ad\",\"organization\":\"deepseek\",\"provider\":\"fireworks\",\"publicName\":\"deepseek-v3-0324\",\"name\":\"deepseek-v3-0324\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"7699c8d4-0742-42f9-a117-d10e84688dab\",\"organization\":\"xai\",\"provider\":\"xaiPublic\",\"publicName\":\"grok-3-mini-beta\",\"name\":\"grok-3-mini-beta\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"b88e983b-9459-473d-8bf1-753932f1679a\",\"organization\":\"moonshot\",\"provider\":\"moonshot\",\"publicName\":\"kimi-k2-0905-preview\",\"name\":\"kimi-k2-0905-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b476c-187e-7845-bc10-d223fb62c860\",\"organization\":\"zai\",\"provider\":\"zaiBigModel\",\"publicName\":\"glm-4.7\",\"name\":\"zebra-text\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b7117-2a76-73d8-8f0f-b32c53c062f3\",\"publicName\":\"lmarena-text-gg\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ae300-83b7-7717-a1e0-31accd1ff6fa\",\"organization\":\"amazon\",\"provider\":\"amazonBedrock\",\"publicName\":\"nova-2-lite\",\"name\":\"global.amazon.nova-2-lite-v1:0\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b95b8-1bc9-7804-8357-f5b4e038c0d1\",\"publicName\":\"beluga-0105-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"b4a681ed-df4e-476f-89c6-a992a5783e60\",\"publicName\":\"EB45-turbo-vl-0906\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"39b185cb-aba9-4232-99ea-074883a5ccd4\",\"publicName\":\"stephen-v2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"dcbd7897-5a37-4a34-93f1-76a24c7bb028\",\"organization\":\"meta\",\"provider\":\"fireworks\",\"publicName\":\"llama-3.3-70b-instruct\",\"name\":\"llama-3.3-70b-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"9a066f6a-7205-4325-8d0b-d81cc4b049c0\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-30b-a3b\",\"name\":\"qwen3-30b-a3b\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"b5ad3ab7-fc56-4ecd-8921-bd56b55c1159\",\"organization\":\"meta\",\"provider\":\"fireworks\",\"publicName\":\"llama-4-maverick-17b-128e-instruct\",\"name\":\"llama-4-maverick-17b-128e-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"ac44dd10-0666-451c-b824-386ccfea7bcc\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-sonnet-4-20250514\",\"name\":\"claude-sonnet-4-20250514\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"04ec9a17-c597-49df-acf0-963da275c246\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemini-2.5-flash-lite-preview-06-17-thinking\",\"name\":\"gemini-2.5-flash-lite-preview-06-17-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b95b8-4004-7ab3-b879-127332df84fb\",\"publicName\":\"beluga-0105-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"87e8d160-049e-4b4e-adc4-7f2511348539\",\"organization\":\"minimax\",\"provider\":\"minimax\",\"publicName\":\"minimax-m1\",\"name\":\"minimax-m1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ac2ef-27e1-769f-8258-d131f79e28ef\",\"organization\":\"allenai\",\"provider\":\"openrouter\",\"publicName\":\"olmo-3-32b-think\",\"name\":\"olmo-3-32b-think\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019acb94-2eca-79a2-bc6c-585bf303df54\",\"publicName\":\"dark-dragon\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"8d1f38a1-51a6-4030-ae4b-e19fb503e4fa\",\"publicName\":\"x1-turbo-0906\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019acca2-d16d-7f5c-8441-e1ad98ba9625\",\"organization\":\"amazon\",\"provider\":\"amazon\",\"publicName\":\"amazon-nova-experimental-chat-11-10\",\"name\":\"beluga-1125-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019acbac-df7c-73dc-9716-ebe040daaa4e\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"mistral-large-3\",\"name\":\"jaguar\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019adb32-b716-7591-9a2f-c6882973e340\",\"organization\":\"deepseek\",\"provider\":\"deepseek\",\"publicName\":\"deepseek-v3.2\",\"name\":\"deepseek-v3.2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019ae5e0-1ba6-701e-a482-a4b8bb23fe36\",\"publicName\":\"frame-flow\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019aa41a-01bf-726c-913c-8a65b8f4c879\",\"organization\":\"xai\",\"provider\":\"xaiPublic\",\"publicName\":\"grok-4-1-fast-non-reasoning\",\"name\":\"grok-4-1-fast-non-reasoning\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b9784-470e-75b9-b2fb-f005d78972e1\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-max-preview\",\"name\":\"qwen3-max-preview-v2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b9b64-ddd3-722e-893a-6d6f59c04d9d\",\"publicName\":\"january26-chatbot1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"896a3848-ae03-4651-963b-7d8f54b61ae8\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemma-3n-e4b-it\",\"name\":\"gemma-3n-e4b-it\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"bbad1d17-6aa5-4321-949c-d11fb6289241\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"mistral-small-2506\",\"name\":\"mistral-small-2506\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b9af7-d8f5-78a8-9e71-52484e18bc95\",\"publicName\":\"qwen3-max-2025-10-20\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"d079ef40-3b20-4c58-ab5e-243738dbada5\",\"organization\":\"zai\",\"provider\":\"zai\",\"publicName\":\"glm-4.5\",\"name\":\"glm-4.5\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b9b65-0912-7931-aabe-64f78d288eb0\",\"publicName\":\"january26-chatbot2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b75aa-c6f3-76ce-89ab-afa4cef96921\",\"publicName\":\"beluga-1229-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"b9edb8e9-4e98-49e7-8aaf-ae67e9797a11\",\"organization\":\"xai\",\"provider\":\"openrouter\",\"publicName\":\"grok-4-0709\",\"name\":\"grok-4-0709\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b0ad8-856e-74fc-871c-86ccbb2b1d35\",\"organization\":\"google\",\"provider\":\"googleWithThoughtSignatures\",\"publicName\":\"gemini-3-flash\",\"name\":\"fiercefalcon\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019b75ab-62ea-7d87-81f7-826e5a824a39\",\"publicName\":\"beluga-1230-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a4ca9-720d-75f5-9012-883ce8ff61df\",\"organization\":\"baidu\",\"provider\":\"baiduyiyan\",\"publicName\":\"ernie-5.0-preview-1103\",\"name\":\"bridge-mind\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"51a47cc6-5ef9-4ac7-a59c-4009230d7564\",\"publicName\":\"gemini-2.5-pro-grounding-exp\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019aec73-6e86-784c-885a-7fe129025f95\",\"publicName\":\"beluga-1128-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019af0b1-5c1d-7c24-8260-621ed4b32b96\",\"publicName\":\"phantom-1203-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019af1f8-aa23-7188-8a73-e717ae24a7d8\",\"publicName\":\"phantom-mm-1125-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b0442-ff8e-72ac-99c0-9fc71eaf6db2\",\"publicName\":\"integrated-info\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"7a55108b-b997-4cff-a72f-5aa83beee918\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemini-2.0-flash-001\",\"name\":\"gemini-2.0-flash-001\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b0582-32cb-7f4b-9402-1f833c3b2a9e\",\"publicName\":\"beluga-1203-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b2a43-6750-7119-808e-09c32d66af6a\",\"publicName\":\"master-node\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"a14546b5-d78d-4cf6-bb61-ab5b8510a9d6\",\"organization\":\"amazon\",\"provider\":\"amazonBedrock\",\"publicName\":\"amazon.nova-pro-v1:0\",\"name\":\"amazon.nova-pro-v1:0\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"7a3626fc-4e64-4c9e-821f-b449a4b43b6a\",\"organization\":\"moonshot\",\"provider\":\"moonshot\",\"publicName\":\"kimi-k2-0711-preview\",\"name\":\"kimi-k2-0711-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019aebfd-af0e-7f0c-8f0d-96c588e4cd3b\",\"organization\":\"prime-intellect\",\"provider\":\"openrouter\",\"publicName\":\"intellect-3\",\"name\":\"intellect-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b0aa7-334a-78e8-b2a8-885f31f4fc0c\",\"organization\":\"nvidia\",\"provider\":\"nvidia\",\"publicName\":\"nvidia-nemotron-3-nano-30b-a3b-bf16\",\"name\":\"december-chatbot\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b9b19-bda6-7563-b383-de35fa4ed1db\",\"publicName\":\"raptor-0107\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b2eea-8cab-7525-9e70-2be764ff8ef6\",\"publicName\":\"cogilux\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199c1d5-51b8-7ead-a0a8-3f59234682fa\",\"publicName\":\"gpt-5-high-no-system-prompt\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ba0c1-d519-718c-b125-e6297f581232\",\"organization\":\"allenai\",\"provider\":\"openrouter\",\"publicName\":\"olmo-3.1-32b-instruct\",\"name\":\"olmo-3.1-32b-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ba559-2883-7a05-b012-bf6c2d38fa86\",\"organization\":\"allenai\",\"provider\":\"openrouter\",\"publicName\":\"olmo-3.1-32b-think\",\"name\":\"olmo-3.1-32b-think-v2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"af033cbd-ec6c-42cc-9afa-e227fc12efe8\",\"organization\":\"Alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-coder-480b-a35b-instruct\",\"name\":\"qwen3-coder-480b-a35b-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"7bfb254a-5d32-4ce2-b6dc-2c7faf1d5fe8\",\"organization\":\"zai\",\"provider\":\"zai\",\"publicName\":\"glm-4.5-air\",\"name\":\"glm-4.5-air\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"638fb8b8-1037-4ee5-bfba-333392575a5d\",\"publicName\":\"EB45-vision\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"27035fb8-a25b-4ec9-8410-34be18328afd\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"mistral-medium-2508\",\"name\":\"mistral-medium-2508\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ba592-47db-724b-aa7b-001c8896c079\",\"publicName\":\"beluga-0106-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b0e9a-c833-7e18-8a31-31c5a2415284\",\"publicName\":\"fire-bird\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b33cd-0c2b-7b75-8238-0396e5928c38\",\"publicName\":\"beluga-1211-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b5265-8405-799e-87af-199dc9f4ad4a\",\"organization\":\"google\",\"provider\":\"googleVertexGlobalWithThoughtSignatures\",\"publicName\":\"gemini-3-flash (thinking-minimal)\",\"name\":\"gemini-3-flash-thinking-minimal-fixed-20251224\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"c15b93ed-e87b-467f-8f9f-d830fd7aa54d\",\"publicName\":\"lmarena-internal-test-only\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"f1a5a6ab-e1b1-4247-88ac-49395291c1e3\",\"publicName\":\"not-a-new-model\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b352d-36a8-7dd3-bbec-2bc78852d6c0\",\"organization\":\"xiaomi\",\"provider\":\"xiaomiV1\",\"publicName\":\"mimo-v2-flash\",\"name\":\"mimo-v2-flash\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"e9dd5a96-c066-48b0-869f-eb762030b5ed\",\"publicName\":\"EB45-turbo\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019bae2b-af92-775f-9a6e-91e7000c61be\",\"organization\":\"amazon\",\"provider\":\"amazon\",\"publicName\":\"amazon-nova-experimental-chat-12-10\",\"name\":\"amazon-nova-experimental-chat-12-10\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"be98fcfd-345c-4ae1-9a82-a19123ebf1d2\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-3-7-sonnet-20250219-thinking-32k\",\"name\":\"claude-3-7-sonnet-20250219-thinking-32k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"9dab0475-a0cc-4524-84a2-3fd25aa8c768\",\"organization\":\"zai\",\"provider\":\"zai\",\"publicName\":\"glm-4.5v\",\"name\":\"glm-4.5v\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199f437-08bd-7907-81e7-098e2eab750a\",\"publicName\":\"raptor-vision-1015\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b151a-7c3b-72a2-8811-0bf9317c2ef5\",\"organization\":\"zai\",\"provider\":\"zai\",\"publicName\":\"glm-4.6v\",\"name\":\"glm-4.6v\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b80de-be75-7165-9b85-438eb7d021ff\",\"publicName\":\"kiwi-do\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019aa97e-7b68-7c21-add9-b17edc20ff02\",\"publicName\":\"anonymous-1111\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"ee116d12-64d6-48a8-88e5-b2d06325cdd2\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-opus-4-20250514\",\"name\":\"claude-opus-4-20250514\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a7ebf-0f3f-7518-8899-fca13e32d9dc\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.1\",\"name\":\"gpt-5.1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019b1448-ff14-7c98-a1ac-726fece799ec\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.2\",\"name\":\"gpt-5.2-no-system-prompt-text\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b1449-0313-7911-b836-419e2ed79b2e\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.2-high\",\"name\":\"gpt-5.2-high-no-system-prompt-text\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b1536-49c0-73b2-8d45-403b8571568d\",\"organization\":\"zai\",\"provider\":\"zai\",\"publicName\":\"glm-4.6v-flash\",\"name\":\"glm-4.6v-flash\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"9af435c8-1f53-4b78-a400-c1f5e9fe09b0\",\"publicName\":\"leepwal\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a33c6-e248-7091-94c0-af68f29390b8\",\"publicName\":\"blackhawk\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"ee7cb86e-8601-4585-b1d0-7c7380f8f6f4\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-235b-a22b-instruct-2507\",\"name\":\"qwen3-235b-a22b-instruct-2507\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b47da-49b9-7295-906c-ce44ccd30d74\",\"publicName\":\"gemini-3-flash\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"4b11c78c-08c8-461c-938e-5fc97d56a40d\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5-chat\",\"name\":\"gpt-5-chat\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199f060-b306-7e1f-aeae-0ebb4e3f1122\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"gemini-2.5-pro\",\"name\":\"gemini-2.5-pro\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"ba8c2392-4c47-42af-bfee-c6c057615a91\",\"organization\":\"tencent\",\"provider\":\"tencent\",\"publicName\":\"hunyuan-t1-20250711\",\"name\":\"hunyuan-t1-20250711\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"98ad8b8b-12cd-46cd-98de-99edde7e03eb\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-max-2025-09-23\",\"name\":\"qwen3-max-2025-09-23\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b1644-8045-7af4-a02a-1bb21cd26344\",\"organization\":\"baidu\",\"provider\":\"baiduyiyan\",\"publicName\":\"ernie-5.0-preview-1220\",\"name\":\"jet-force\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b47e2-c37d-7431-a5a7-05d0469d8b1a\",\"publicName\":\"beluga-1203-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b3dec-d7ed-77c2-be29-3e7341c8e26d\",\"publicName\":\"neo-nucleus\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b3dec-db60-769d-ac34-55eaf8ef1ebb\",\"publicName\":\"jakiro\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"6ee9f901-17b5-4fbe-9cc2-13c16497c23b\",\"organization\":\"openai\",\"provider\":\"fireworks\",\"publicName\":\"gpt-oss-120b\",\"name\":\"gpt-oss-120b\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b3dec-df21-7106-bcbb-11ee9c52dd41\",\"publicName\":\"december-chatbot3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"ac31e980-8bf1-4637-adba-cf9ffa8b6343\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-max-2025-09-26\",\"name\":\"qwen3-max-2025-09-26\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"351fe482-eb6c-4536-857b-909e16c0bf52\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-next-80b-a3b-instruct\",\"name\":\"qwen3-next-80b-a3b-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b4c70-d1b1-7690-9773-148d5f6636f9\",\"publicName\":\"omg-wow\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b4da9-b7d5-7869-b1fa-c6d3dd7d48aa\",\"publicName\":\"beluga-1223-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"b0ea1407-2f92-4515-b9cc-b22a6d6c14f2\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-sonnet-4-5-20250929-thinking-32k\",\"name\":\"claude-sonnet-4-5-20250929-thinking-32k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019b47ea-4256-7afd-85e6-8c0c8ea24a26\",\"publicName\":\"proto-think\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b00de-7b51-7d3e-8d27-01b44b156c5d\",\"organization\":\"baidu\",\"provider\":\"baiduyiyan\",\"publicName\":\"ernie-5.0-preview-1203\",\"name\":\"holo-scope\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b4dab-09d6-7a22-9105-4e22c493717a\",\"publicName\":\"beluga-1223-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a9e80-e469-722e-8f9a-585860a5859d\",\"publicName\":\"raptor-1119\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"ec3beb4b-7229-4232-bab9-670ee52dd711\",\"organization\":\"openai\",\"provider\":\"fireworks\",\"publicName\":\"gpt-oss-20b\",\"name\":\"gpt-oss-20b\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"f23d6df4-4395-4404-897f-bdedc909e783\",\"publicName\":\"raptor\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"75555628-8c14-402a-8d6e-43c19cb40116\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemini-2.5-flash-lite-preview-09-2025-no-thinking\",\"name\":\"gemini-2.5-flash-lite-preview-09-2025-no-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"149619f1-f1d5-45fd-a53e-7d790f156f20\",\"organization\":\"xai\",\"provider\":\"xaiPublic\",\"publicName\":\"grok-3-mini-high\",\"name\":\"grok-3-mini-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"fc700d46-c4c1-4fec-88b5-f086876ae0bb\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemini-2.5-flash-preview-09-2025\",\"name\":\"gemini-2.5-flash-preview-09-2025\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"19b3730a-0369-49ba-ad9c-09e7337937f0\",\"organization\":\"xai\",\"provider\":\"xaiPublic\",\"publicName\":\"grok-4-fast-reasoning\",\"name\":\"grok-4-fast-reasoning\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019a6617-4f6a-77ab-af79-097f7aa7c86d\",\"publicName\":\"winter-wind\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019aa41a-0a13-714a-beb1-be4a918a4b56\",\"organization\":\"xai\",\"provider\":\"xaiPublic\",\"publicName\":\"grok-4-1-fast-reasoning\",\"name\":\"grok-4-1-fast-reasoning\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"6fcbe051-f521-4dc7-8986-c429eb6191bf\",\"organization\":\"meituan\",\"provider\":\"meituan\",\"publicName\":\"longcat-flash-chat\",\"name\":\"longcat-flash-chat\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"16b8e53a-cc7b-4608-a29a-20d4dac77cf2\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-235b-a22b-thinking-2507\",\"name\":\"qwen3-235b-a22b-thinking-2507\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"716aa8ca-d729-427f-93ab-9579e4a13e98\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-vl-235b-a22b-instruct\",\"name\":\"qwen3-vl-235b-a22b-instruct\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"6a5437a7-c786-467b-b701-17b0bc8c8231\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-4.1-mini-2025-04-14\",\"name\":\"gpt-4.1-mini-2025-04-14\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"1a400d9a-f61c-4bc2-89b4-a9b7e77dff12\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-235b-a22b-no-thinking\",\"name\":\"qwen3-235b-a22b-no-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"03c511f5-0d35-4751-aae6-24f918b0d49e\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-vl-235b-a22b-thinking\",\"name\":\"qwen3-vl-235b-a22b-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"ee3588cd-1fe1-484a-bcc9-f92065b8380c\",\"organization\":\"xiaomi\",\"provider\":\"xiaomi\",\"publicName\":\"MiMo-7B\",\"name\":\"MiMo-7B\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"c680645e-efac-4a81-b0af-da16902b2541\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"o3-mini\",\"name\":\"o3-mini\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"96ae95fd-b70d-49c3-91cc-b58c7da1090b\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-opus-4-1-20250805\",\"name\":\"claude-opus-4-1-20250805\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"0199c9dc-e157-7458-bd49-5942363be215\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-omni-flash\",\"name\":\"qwen3-omni-flash\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a27e0-e7d8-7b0b-877c-a2106c6eb87d\",\"organization\":\"minimax\",\"provider\":\"minimax\",\"publicName\":\"minimax-m2\",\"name\":\"minimax-m2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019a3aeb-371d-7474-a1b7-b8f4207a9a2c\",\"publicName\":\"qwen3-max-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b4dad-72d7-7a13-a08c-b7c318c74dae\",\"publicName\":\"beluga-1223-4\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b4dac-3cf6-7547-99b5-01e7ae52fe26\",\"publicName\":\"beluga-1223-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"e3c9ea42-5f42-496b-bc80-c7e8ee5653cc\",\"publicName\":\"stephen-vision-csfix\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"f1a2eb6f-fc30-4806-9e00-1efd0d73cbc4\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-opus-4-1-20250805-thinking-16k\",\"name\":\"claude-opus-4-1-20250805-thinking-16k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"f44e280a-7914-43ca-a25d-ecfcc5d48d09\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-3-5-sonnet-20241022\",\"name\":\"claude-3-5-sonnet-20241022\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ab9ad-d128-7858-8745-6da5936ccb5e\",\"publicName\":\"raptor-1124\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"71f96ca9-4cf8-4be7-bac2-2231613930a6\",\"organization\":\"ant-group\",\"provider\":\"antgroup\",\"publicName\":\"ling-flash-2.0\",\"name\":\"ling-flash-2.0\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019ab9ad-caac-78f4-8007-bf0e082771d0\",\"publicName\":\"raptor-1123\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b287d-9ffc-7ce4-95be-d93929cdd94f\",\"publicName\":\"step-3-mini-2511\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0304b4de-e544-48d4-8490-ad9123bc26e3\",\"publicName\":\"monster\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"c5a11495-081a-4dc6-8d9a-64a4fd6f7bbc\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-3-7-sonnet-20250219\",\"name\":\"claude-3-7-sonnet-20250219\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199c1e0-3720-742d-91c8-787788b0a19b\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"chatgpt-4o-latest-20250326\",\"name\":\"chatgpt-4o-latest-20250326\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"885976d3-d178-48f5-a3f4-6e13e0718872\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwq-32b\",\"name\":\"qwq-32b\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019b8452-a312-7023-b83e-77092113a520\",\"publicName\":\"anonymous-1222\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199eb70-db25-73ea-b944-f18fe0c3c0cd\",\"publicName\":\"ernie-exp-vl-251016\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199e8e9-01ed-73e0-96ba-cf43b286bf10\",\"organization\":\"anthropic\",\"provider\":\"anthropic\",\"publicName\":\"claude-haiku-4-5-20251001\",\"name\":\"claude-haiku-4-5-20251001\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"f6fbf06c-532c-4c8a-89c7-f3ddcfb34bd1\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-3-5-haiku-20241022\",\"name\":\"claude-3-5-haiku-20241022\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"6fe1ec40-3219-4c33-b3e7-0e65658b4194\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen-vl-max-2025-08-13\",\"name\":\"qwen-vl-max-2025-08-13\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"a8d1d310-e485-4c50-8f27-4bff18292a99\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-30b-a3b-instruct-2507\",\"name\":\"qwen3-30b-a3b-instruct-2507\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"1ea13a81-93a7-4804-bcdd-693cd72e302d\",\"organization\":\"stepfun\",\"provider\":\"stepfun\",\"publicName\":\"step-3\",\"name\":\"step-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199edd2-88be-76b8-9aaa-5fc6b9c53503\",\"publicName\":\"ling-1t\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"d8444b25-e302-4d3b-8561-7ded087ee03c\",\"publicName\":\"monterey\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a2d13-28a5-7205-908c-0a58de904617\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-sonnet-4-5-20250929\",\"name\":\"claude-sonnet-4-5-20250929\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"2595a594-fa54-4299-97cd-2d7380d21c80\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-235b-a22b\",\"name\":\"qwen3-235b-a22b\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a3e64-eae6-7178-a9ae-2894c25ada46\",\"publicName\":\"sunshine-ai\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"4653dded-a46b-442a-a8fe-9bb9730e2453\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-sonnet-4-20250514-thinking-32k\",\"name\":\"claude-sonnet-4-20250514-thinking-32k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"11ad4114-c868-4fed-b6e7-d535dc9c62f8\",\"organization\":\"ant-group\",\"provider\":\"antgroup\",\"publicName\":\"ring-flash-2.0\",\"name\":\"ring-flash-2.0\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"3b5e9593-3dc0-4492-a3da-19784c4bde75\",\"organization\":\"anthropic\",\"provider\":\"googleVertexAnthropic\",\"publicName\":\"claude-opus-4-20250514-thinking-16k\",\"name\":\"claude-opus-4-20250514-thinking-16k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"f595e6f1-6175-4880-a9eb-377e390819e4\",\"organization\":\"zai\",\"provider\":\"zai\",\"publicName\":\"glm-4.6\",\"name\":\"glm-4.6\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019a5658-ba6f-7185-b79d-51516ef94314\",\"publicName\":\"gauss\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a98f7-afcd-779f-8dcb-856cc3b3f078\",\"organization\":\"google\",\"provider\":\"googleVertexGlobal\",\"publicName\":\"gemini-3-pro\",\"name\":\"gemini-3-pro\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019a17b5-5e1e-7df6-9e1a-6c4338f8b6ff\",\"organization\":\"minimax\",\"provider\":\"minimax\",\"publicName\":\"minimax-m2-preview\",\"name\":\"minimax-m2-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019a7b93-af36-7f06-bb46-2b6b0548fc93\",\"publicName\":\"whisperfall\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a9389-a4d8-748d-9939-b4640198302e\",\"organization\":\"xai\",\"provider\":\"xaiResearch\",\"publicName\":\"grok-4.1\",\"name\":\"grok-4.1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a842c-7e62-725a-8a2a-f76f5ec786dd\",\"publicName\":\"neon\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"789e245f-eafe-4c72-b563-d135e93988fc\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemma-3-27b-it\",\"name\":\"gemma-3-27b-it\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a6f77-e20d-7c1d-a7cd-8bd926e7395d\",\"organization\":\"inception-ai\",\"provider\":\"openrouter\",\"publicName\":\"mercury\",\"name\":\"mercury\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"983bc566-b783-4d28-b24c-3c8b08eb1086\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5-high\",\"name\":\"gpt-5-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a6c82-2ead-7475-8612-55dabba11c31\",\"publicName\":\"viper\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a19ad-97fe-72fb-89ad-d02355152e55\",\"organization\":\"baidu\",\"provider\":\"baiduyiyan\",\"publicName\":\"ernie-5.0-preview-1120\",\"name\":\"ernie-5.0-preview-1120\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"0199de70-e6ad-7276-9020-a7502bed99ad\",\"publicName\":\"flying-octopus\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a19ad-8f50-7282-8cb9-5e49b9052aff\",\"publicName\":\"ernie-exp-251023\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a26b4-2a20-7864-b1f7-d471ec1f4e3f\",\"publicName\":\"ernie-exp-251027\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"48fe3167-5680-4903-9ab5-2f0b9dc05815\",\"publicName\":\"nightride-on\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a19ad-a47e-7828-aa1f-5c7f2c4f65fe\",\"publicName\":\"ring-1t\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a1dce-b0d7-75cc-8742-997a0639f061\",\"publicName\":\"ernie-exp-251025\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"71023e9b-7361-498a-b6db-f2d2a83883fd\",\"organization\":\"xai\",\"provider\":\"xaiResearch\",\"publicName\":\"grok-4-fast-chat\",\"name\":\"grok-4-fast\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a26b4-2540-7a7d-96bf-b6b377e8d1ec\",\"publicName\":\"ernie-exp-251026\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"c822ec98-38e9-4e43-a434-982eb534824f\",\"publicName\":\"nightride-on-v2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"cb0f1e24-e8e9-4745-aabc-b926ffde7475\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"o3-2025-04-16\",\"name\":\"o3-2025-04-16\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a26b4-2f39-7a0e-818d-254d0f37a85a\",\"publicName\":\"raptor-llm-1024\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a5658-b301-7c8e-acb2-707cad8d6177\",\"publicName\":\"newton\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a4ca3-54ee-7c78-9cbf-19584ddfb7be\",\"publicName\":\"aegis-core\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a8548-a2b1-70ce-b1be-eba096d41f58\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.1-high\",\"name\":\"gpt-5.1-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"6337f479-2fc8-4311-a76b-8c957765cd68\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"magistral-medium-2506\",\"name\":\"magistral-medium-2506\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a7011-49dd-7e6e-94e1-ced43eac205c\",\"publicName\":\"raptor-vision-1107\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"f1102bbf-34ca-468f-a9fc-14bcf63f315b\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"o4-mini-2025-04-16\",\"name\":\"o4-mini-2025-04-16\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a6617-53aa-7d9f-940d-94afc98aab1f\",\"publicName\":\"rain-drop\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a9389-a9d3-77a8-afbb-4fe4dd3d8630\",\"organization\":\"xai\",\"provider\":\"xaiResearch\",\"publicName\":\"grok-4.1-thinking\",\"name\":\"grok-4.1-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"5fd3caa8-fe4c-41a5-a22c-0025b58f4b42\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5-mini-high\",\"name\":\"gpt-5-mini-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"2dc249b3-98da-44b4-8d1e-6666346a8012\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5-nano-high\",\"name\":\"gpt-5-nano-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"6c98ce8c-41d1-42cd-b2e3-292c6519add5\",\"publicName\":\"redwood\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"19ad5f04-38c6-48ae-b826-f7d5bbfd79f7\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5-high-new-system-prompt\",\"name\":\"gpt-5-high-new-system-prompt\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"73cf8705-98c8-4b75-8d04-e3746e1c1565\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen3-next-80b-a3b-thinking\",\"name\":\"qwen3-next-80b-a3b-thinking\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"1c0259b5-dff7-48ce-bca1-b6957675463b\",\"organization\":\"xiaomi\",\"provider\":\"xiaomiVision\",\"publicName\":\"MiMo-VL-7B-RL-2508\",\"name\":\"MiMo-VL-7B-RL-2508\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019aa3fb-ec59-7b49-af33-57d0981509e0\",\"publicName\":\"ling-1t-1031\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019a59bc-8bb8-7933-92eb-fe143770c211\",\"organization\":\"moonshot\",\"provider\":\"moonshot\",\"publicName\":\"kimi-k2-thinking-turbo\",\"name\":\"kimi-k2-thinking-turbo\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true,\"web\":true}},\"rankByModality\":{\"chat\":9007199254740991,\"webdev\":9007199254740991}},{\"id\":\"019b0bd7-efa8-7024-a3be-a2ee84cf4b66\",\"publicName\":\"raptor-1.8-1208\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019afca4-2085-78ee-847a-e221cdb50501\",\"publicName\":\"raptor-llm-1205\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"text\":true}},\"rankByModality\":{\"chat\":9007199254740991}},{\"id\":\"019abd9a-f6ff-7081-8bdb-ff0a352dc601\",\"publicName\":\"robin\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a9b1b-4c52-7245-83de-4cdaaf9e0f2b\",\"organization\":\"kwai\",\"provider\":\"kwai\",\"publicName\":\"KAT-Coder-Pro-V1\",\"name\":\"KAT-Coder-Pro-V1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019ac30c-70ce-72af-b6e9-cfbc52d46c19\",\"publicName\":\"robin-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019b303a-ad72-75fc-87d8-9728e0015acd\",\"organization\":\"zai\",\"provider\":\"zaiBigModel\",\"publicName\":\"glm-4.7\",\"name\":\"zebra\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019aeb38-cc3b-7421-a472-0bfaaeace035\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5.1-codex-max\",\"name\":\"gpt-5.1-codex-max\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019b0fe1-5dfd-7c0e-88a7-489650364da5\",\"publicName\":\"lambda-1201-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a84e2-e1b7-718b-8b8d-589079121b9b\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5.1-codex\",\"name\":\"gpt-5.1-codex\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a84e2-e6bd-7123-a5f6-626d1766d4f2\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5.1-codex-mini\",\"name\":\"gpt-5.1-codex-mini\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019b144b-678a-7d13-a17e-973d4953ac35\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.2-high\",\"name\":\"gpt-5.2-high-code\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019b144b-5ffb-7192-be63-79533ef5d854\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.2\",\"name\":\"gpt-5.2-code\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a0ec1-e54d-7354-be40-62fb6f0e5d43\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5-medium\",\"name\":\"gpt-5-medium\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a95f0-02c7-7f62-a820-c809f767a222\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"gpt-5.1-medium\",\"name\":\"gpt-5.1-medium\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a6a30-cd7d-7431-8c4a-7be88deebf43\",\"organization\":\"mistral\",\"provider\":\"mistral\",\"publicName\":\"devstral-medium-2507\",\"name\":\"devstral-medium-2507\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a9afe-d7c8-7c5d-ad57-d34170bcebae\",\"publicName\":\"f1031_wda\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"019a5d6b-1dd1-77ff-81df-108d460d6481\",\"organization\":\"xai\",\"provider\":\"xaiPublic\",\"publicName\":\"grok-code-fast-1\",\"name\":\"grok-code-fast-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"web\":true}},\"rankByModality\":{\"webdev\":9007199254740991}},{\"id\":\"7766a45c-1b6b-4fb8-9823-2557291e1ddd\",\"organization\":\"tencent\",\"provider\":\"tencent\",\"publicName\":\"hunyuan-image-3.0\",\"name\":\"hunyuan-image-3.0\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019aafce-f609-727d-a998-0fa521fcb1d5\",\"publicName\":\"tangerine\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019adb32-afa4-749e-9992-39653b52fe13\",\"organization\":\"shengshu\",\"provider\":\"shengshu\",\"publicName\":\"vidu-q2-image\",\"name\":\"viduq2-image\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"1b407d5c-1806-477c-90a5-e5c5a114f3bc\",\"organization\":\"microsoft-ai\",\"provider\":\"maiImage\",\"publicName\":\"mai-image-1\",\"name\":\"mai-image-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"f44fd4f8-af30-480f-8ce2-80b2bdfea55e\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"imagen-4.0-fast-generate-001\",\"name\":\"imagen-4.0-fast-generate-001\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"b88d5814-1d20-49cc-9eb6-e362f5851661\",\"organization\":\"Recraft\",\"provider\":\"fal\",\"publicName\":\"recraft-v3\",\"name\":\"recraft-v3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"51ad1d79-61e2-414c-99e3-faeb64bb6b1b\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"imagen-3.0-generate-002\",\"name\":\"imagen-3.0-generate-002\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019ae2a3-304d-773b-b333-daa050124a92\",\"publicName\":\"gemini-3-pro-image-preview-4k (nano-banana-pro)\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"e7c9fa2d-6f5d-40eb-8305-0980b11c7cab\",\"organization\":\"luma-ai\",\"provider\":\"fal\",\"publicName\":\"photon\",\"name\":\"photon\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b4782-79d7-721c-a56c-6bb09bc3a437\",\"publicName\":\"z-image\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b753e-1192-7bf3-a056-f4f62ac16704\",\"organization\":\"bfl\",\"provider\":\"bfl\",\"publicName\":\"flux-2-flex\",\"name\":\"flux-2-flex-20251231\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019ae6da-6438-7077-9d2d-b311a35645f8\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"imagen-4.0-ultra-generate-001\",\"name\":\"imagen-4.0-ultra-generate-001\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019abc10-e78d-7932-b725-7f1563ed8a12\",\"organization\":\"google\",\"provider\":\"google-genai\",\"publicName\":\"gemini-3-pro-image-preview-2k (nano-banana-pro)\",\"name\":\"gemini-3-pro-image-preview-2k\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019ae6da-6788-761a-8253-e0bb2bf2e3a9\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"imagen-4.0-generate-001\",\"name\":\"imagen-4.0-generate-001\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"69f90b32-01dc-43e1-8c48-bf494f8f4f38\",\"publicName\":\"gpt-image-1-high-fidelity\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"9fe82ee1-c84f-417f-b0e7-cab4ae4cf3f3\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen-image-prompt-extend\",\"name\":\"qwen-image-prompt-extend\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b478d-74ae-7d19-9a8f-6cfde89ab4ca\",\"organization\":\"bfl\",\"provider\":\"bfl\",\"publicName\":\"flux-2-dev\",\"name\":\"flux-2-dev-20251222\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"0633b1ef-289f-49d4-a834-3d475a25e46b\",\"publicName\":\"flux-1-kontext-max\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b478d-71ee-7658-867a-bce80c8e77a3\",\"organization\":\"bfl\",\"provider\":\"bfl\",\"publicName\":\"flux-2-max\",\"name\":\"flux-2-max-20251222\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b7541-5e4b-7ff7-a34b-b0255b6ca9aa\",\"organization\":\"bfl\",\"provider\":\"bfl\",\"publicName\":\"flux-2-pro\",\"name\":\"flux-2-pro-20251231\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"995cf221-af30-466d-a809-8e0985f83649\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen-image-edit\",\"name\":\"qwen-image-edit\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b00fe-89e8-7fda-9f6c-36d16813fb48\",\"publicName\":\"hazel-gen-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"e2969ebb-6450-4bc4-87c9-bbdcf95840da\",\"publicName\":\"seededit-3.0\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"73378be5-cdba-49e7-b3d0-027949871aa6\",\"organization\":\"Ideogram\",\"provider\":\"fal\",\"publicName\":\"ideogram-v3-quality\",\"name\":\"ideogram-v3-quality\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"a9a26426-5377-4efa-bef9-de71e29ad943\",\"organization\":\"tencent\",\"provider\":\"fal\",\"publicName\":\"hunyuan-image-2.1\",\"name\":\"hunyuan-image-2.1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b00ff-a0f5-71e9-b43c-d02661323dfc\",\"publicName\":\"hazel-gen-4\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b8194-58e4-7975-ad6b-d966909a0eb8\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen-image-2512\",\"name\":\"qwen-image-2512\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019a5050-2875-78ed-ae3a-d9a51a438685\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"wan2.5-t2i-preview\",\"name\":\"wan2.5-t2i-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"32bff2df-00e6-409b-ad3f-bfbad87cc49f\",\"publicName\":\"hidream-e1.1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b169a-09c6-79ea-9400-1566d793ade1\",\"organization\":\"reve\",\"provider\":\"reve\",\"publicName\":\"reve-v1.1\",\"name\":\"epsilon\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b2eac-06ad-7e71-a9ac-67a6765f2619\",\"organization\":\"openai\",\"provider\":\"customOpenai\",\"publicName\":\"chatgpt-image-latest (20251216)\",\"name\":\"chatgpt-image-latest-20251216\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b3943-7503-776f-9632-c3c5da0c39b7\",\"organization\":\"bytedance\",\"provider\":\"byteplus\",\"publicName\":\"seedream-4.5\",\"name\":\"autumn-byteplus\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"0199e980-d247-7dd3-9ca1-77092f126f05\",\"publicName\":\"hunyuan-image-3.0-fal\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"0199c238-f8ee-7f7d-afc1-7e28fcfd21cf\",\"organization\":\"openai\",\"provider\":\"customOpenai\",\"publicName\":\"gpt-image-1-mini\",\"name\":\"gpt-image-1-mini\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"bb97bc68-131c-4ea4-a59e-03a6252de0d2\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"dall-e-3\",\"name\":\"dall-e-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b8194-804a-775d-86d4-c8ded9ba3e9f\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"qwen-image-edit-2511\",\"name\":\"qwen-image-edit-2511\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b207a-d836-7742-a312-b2b247b2366e\",\"organization\":\"reve\",\"provider\":\"fal\",\"publicName\":\"reve-v1.1-fast\",\"name\":\"epsilon-fast\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"6e855f13-55d7-4127-8656-9168a9f4dcc0\",\"organization\":\"openai\",\"provider\":\"customOpenai\",\"publicName\":\"gpt-image-1\",\"name\":\"gpt-image-1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"69bbf7d4-9f44-447e-a868-abc4f7a31810\",\"organization\":\"google\",\"provider\":\"google\",\"publicName\":\"gemini-2.0-flash-preview-image-generation\",\"name\":\"gemini-2.0-flash-preview-image-generation\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"0199ef2a-583f-7088-b704-b75fd169401d\",\"organization\":\"google\",\"provider\":\"google-genai\",\"publicName\":\"gemini-2.5-flash-image-preview (nano-banana)\",\"name\":\"gemini-2.5-flash-image-preview (nano-banana)\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"d8771262-8248-4372-90d5-eb41910db034\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedream-3\",\"name\":\"seedream-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"32974d8d-333c-4d2e-abf3-f258c0ac1310\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedream-4-high-res-fal\",\"name\":\"seedream-4-high-res-fal\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019b2893-2508-7686-a63d-4861997565d2\",\"organization\":\"openai\",\"provider\":\"customOpenai\",\"publicName\":\"gpt-image-1.5\",\"name\":\"gpt-image-1.5\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019a5050-1695-7b5d-b045-ba01ff08ec28\",\"publicName\":\"wan2.5-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"28a8f330-3554-448c-9f32-2c0a08ec6477\",\"organization\":\"bfl\",\"provider\":\"bfl\",\"publicName\":\"flux-1-kontext-pro\",\"name\":\"flux-1-kontext-pro\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019aeb62-c6ea-788e-88f9-19b1b48325b5\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"wan2.5-i2i-preview\",\"name\":\"wan2.5-i2i-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"eb90ae46-a73a-4f27-be8b-40f090592c9a\",\"organization\":\"bfl\",\"provider\":\"bfl\",\"publicName\":\"flux-1-kontext-dev\",\"name\":\"flux-1-kontext-dev\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":false}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"5a3b3520-c87d-481f-953c-1364687b6e8f\",\"organization\":\"leonardo-ai\",\"provider\":\"leonardo-ai\",\"publicName\":\"lucid-origin\",\"name\":\"lucid-origin\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019aa208-5c19-7162-ae3b-0a9ddbb1e16a\",\"organization\":\"google\",\"provider\":\"google-genai\",\"publicName\":\"gemini-3-pro-image-preview (nano-banana-pro)\",\"name\":\"gemini-3-pro-image-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false,\"multipleImages\":true}},\"outputCapabilities\":{\"image\":{\"aspectRatios\":[\"1:1\"]}}},\"rankByModality\":{\"image\":9007199254740991}},{\"id\":\"019abdb7-6957-71c1-96a2-bfa79e8a094f\",\"organization\":\"google\",\"provider\":\"googleVertexGlobalSearch\",\"publicName\":\"gemini-3-pro-grounding\",\"name\":\"gemini-3-pro-grounding\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"24145149-86c9-4690-b7c9-79c7db216e5c\",\"organization\":\"perplexity\",\"provider\":\"perplexity\",\"publicName\":\"ppl-sonar-reasoning-pro-high\",\"name\":\"ppl-sonar-reasoning-pro-high\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"fbe08e9a-3805-4f9f-a085-7bc38e4b51d1\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"o3-search\",\"name\":\"o3-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"019b2f68-97ae-75b1-9e2f-456470bd5332\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5.1-search-sp\",\"name\":\"gpt-5.1-search-new-system-prompt-20251217\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"25bcb878-749e-49f4-ac05-de84d964bcee\",\"organization\":\"anthropic\",\"provider\":\"anthropicSearch\",\"publicName\":\"claude-opus-4-search\",\"name\":\"claude-opus-4-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"019af19c-0658-7566-9c60-112ae5bdb8db\",\"organization\":\"xai\",\"provider\":\"xaiResponsesSearch\",\"publicName\":\"grok-4-1-fast-search\",\"name\":\"grok-4-1-fast-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"019abdb7-50a5-7c05-9308-4491d069578b\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5.1-search\",\"name\":\"gpt-5.1-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"019b094b-ff6f-728b-8517-a735d43ab2ac\",\"publicName\":\"stellarblade\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"d942b564-191c-41c5-ae22-400a930a2cfe\",\"organization\":\"anthropic\",\"provider\":\"anthropicSearch\",\"publicName\":\"claude-opus-4-1-search\",\"name\":\"claude-opus-4-1-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"b222be23-bd55-4b20-930b-a30cc84d3afd\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"gemini-2.5-pro-grounding\",\"name\":\"gemini-2.5-pro-grounding\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"019b1448-f74a-72de-b25d-8666618f8c5a\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5.2-search\",\"name\":\"gpt-5.2-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"0862885e-ef53-4d0d-b9c4-4c8f68f453ce\",\"organization\":\"diffbot\",\"provider\":\"diffbot\",\"publicName\":\"diffbot-small-xl\",\"name\":\"diffbot-small-xl\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"9217ac2d-91bc-4391-aa07-b8f9e2cf11f2\",\"organization\":\"xai\",\"provider\":\"xaiResearchSearch\",\"publicName\":\"grok-4-fast-search\",\"name\":\"grok-4-fast-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"86d767b0-2574-4e47-a256-a22bcace9f56\",\"organization\":\"xai\",\"provider\":\"xaiSearch\",\"publicName\":\"grok-4-search\",\"name\":\"grok-4-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"d14d9b23-1e46-4659-b157-a3804ba7e2ef\",\"organization\":\"openai\",\"provider\":\"openaiResponses\",\"publicName\":\"gpt-5-search\",\"name\":\"gpt-5-search\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"search\":true}},\"rankByModality\":{\"search\":9007199254740991}},{\"id\":\"043a03a9-a792-4045-9f6d-4bcd747dac43\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"sora-2\",\"name\":\"sora-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019b70d2-e820-7dd8-97da-f78134489b1a\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedance-v1.5-pro\",\"name\":\"seedance-v1.5-pro-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"01f39601-03ed-4d66-8afb-5039c90b27ea\",\"organization\":\"openai\",\"provider\":\"openai\",\"publicName\":\"sora-2-pro\",\"name\":\"sora-2-pro\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019b70d5-d1b4-70e3-804f-8afeb937dba5\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedance-v1.5-pro\",\"name\":\"seedance-v1.5-pro-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019a74c8-5bf5-7f37-b0c4-4d597ea6f831\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"wan2.5-t2v-preview\",\"name\":\"wan2.5-t2v-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":false},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019b28b8-5801-708c-9a7c-e77999d624d6\",\"organization\":\"tencent\",\"provider\":\"tencent\",\"publicName\":\"hunyuan-video-1.5\",\"name\":\"hunyuan-video-1.5-t2v-20251209\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"fec7074d-a3a0-4f83-a487-82700fcec84d\",\"organization\":\"luma-ai\",\"provider\":\"luma\",\"publicName\":\"ray-3\",\"name\":\"ray-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019b28b8-671b-7d8c-9d32-0cd757a60a6c\",\"organization\":\"tencent\",\"provider\":\"tencent\",\"publicName\":\"hunyuan-video-1.5\",\"name\":\"hunyuan-video-1.5-i2v-20251209\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019aebd1-e566-7009-9190-f6178cd6f9ac\",\"organization\":\"kling\",\"provider\":\"fal\",\"publicName\":\"kling-2.6-pro\",\"name\":\"kling-2.6-pro-image-to-video-fal\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019aebd1-edc0-71c9-906d-82656c3d8927\",\"organization\":\"kling\",\"provider\":\"fal\",\"publicName\":\"kling-2.6-pro\",\"name\":\"kling-2.6-pro-text-to-video-fal\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"55069e04-a634-4d98-8765-95113b945f5e\",\"organization\":\"minimax\",\"provider\":\"fal\",\"publicName\":\"hailuo-02-pro\",\"name\":\"hailuo-02-pro-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"e652c45e-8699-4392-94f0-7834e7464137\",\"organization\":\"minimax\",\"provider\":\"fal\",\"publicName\":\"hailuo-02-standard\",\"name\":\"hailuo-02-standard-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"1b677c7e-49dd-4045-9ce0-d1aedcb9bbbc\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-3-fast\",\"name\":\"veo-3-fast\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"08d8dcc6-2ab5-45ae-9bf1-353480f1f7ee\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-2\",\"name\":\"veo-2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"80caa6ac-05cd-4403-88e1-ef0164c8b1a8\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-3\",\"name\":\"veo-3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"58060613-41dc-478b-97a0-6d9c4f0c722a\",\"organization\":\"minimax\",\"provider\":\"fal\",\"publicName\":\"hailuo-02-fast\",\"name\":\"hailuo-02-fast\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019a36dd-5d6c-7f15-8598-4755f4c34e28\",\"organization\":\"minimax\",\"provider\":\"minimax\",\"publicName\":\"hailuo-2.3-fast\",\"name\":\"hailuo-2.3-fast\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"217158f9-793e-4ffe-a197-6de9448432fc\",\"organization\":\"luma-ai\",\"provider\":\"fal\",\"publicName\":\"ray2\",\"name\":\"ray2\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"527e3f88-c13f-404c-92b4-0dcf7eeb61e6\",\"organization\":\"minimax\",\"provider\":\"fal\",\"publicName\":\"hailuo-02-pro\",\"name\":\"hailuo-02-pro-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"a071b843-0fc2-4fcf-b644-023509635452\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-3-audio\",\"name\":\"veo-3-audio\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"bf03b5bb-8b4e-4a36-a893-0b2809f1daec\",\"organization\":\"minimax\",\"provider\":\"fal\",\"publicName\":\"hailuo-02-standard\",\"name\":\"hailuo-02-standard-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"e705b65f-82cd-40cb-9630-d9e6ca92d06f\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedance-v1-pro\",\"name\":\"seedance-v1-pro-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"4c8dde6e-1b2c-45b9-91c3-413b2ceafffb\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedance-v1-lite\",\"name\":\"seedance-v1-lite-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"9bbbca46-b6c2-4919-83a8-87ef1c559c4e\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-3-fast-audio\",\"name\":\"veo-3-fast-audio\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"d63b03fb-8bc8-4ed8-9a50-6ccb683ac2b1\",\"organization\":\"kling\",\"provider\":\"fal\",\"publicName\":\"kling-v2.1-master\",\"name\":\"kling-v2.1-master-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"86de5aea-fc0c-4c36-b65a-7afc443a32d2\",\"organization\":\"pika\",\"provider\":\"fal\",\"publicName\":\"pika-v2.2\",\"name\":\"pika-v2.2-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"4ddc4e52-2867-49b6-a603-5aab24a566ca\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedance-v1-pro\",\"name\":\"seedance-v1-pro-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"c3d0e5c8-f4b3-417a-8cb8-2ccf757d3869\",\"organization\":\"openai\",\"provider\":\"azureOpenAI\",\"publicName\":\"sora\",\"name\":\"sora\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"ea96cfc8-953a-4c3c-a229-1107c55b7479\",\"organization\":\"kling\",\"provider\":\"fal\",\"publicName\":\"kling-v2.1-standard\",\"name\":\"kling-v2.1-standard\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"f9b9f030-9ebc-4765-bf76-c64a82a72dfd\",\"organization\":\"pika\",\"provider\":\"fal\",\"publicName\":\"pika-v2.2\",\"name\":\"pika-v2.2-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"13ce11ba-def2-4c80-a70b-b0b2c14d293e\",\"organization\":\"bytedance\",\"provider\":\"fal\",\"publicName\":\"seedance-v1-lite\",\"name\":\"seedance-v1-lite-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"0754baa1-ab91-42d0-ba74-522aa8e5b8e2\",\"organization\":\"runway\",\"provider\":\"replicate\",\"publicName\":\"runway-gen4-turbo\",\"name\":\"runway-gen4-turbo\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"efdb7e05-2091-4e88-af9e-4ea6168d2f85\",\"organization\":\"kling\",\"provider\":\"fal\",\"publicName\":\"kling-v2.1-master\",\"name\":\"kling-v2.1-master-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"f4809219-14a8-47fe-9705-8685085513e7\",\"organization\":\"genmo\",\"provider\":\"fal\",\"publicName\":\"mochi-v1\",\"name\":\"mochi-v1\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"3a91bb37-39fb-471c-8aa2-a89b98d280d0\",\"organization\":\"alibaba\",\"provider\":\"fal\",\"publicName\":\"wan-v2.2-a14b\",\"name\":\"wan-v2.2-a14b-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"264e6e2f-b66a-4e27-a859-8145ff32d6f6\",\"organization\":\"alibaba\",\"provider\":\"fal\",\"publicName\":\"wan-v2.2-a14b\",\"name\":\"wan-v2.2-a14b-text-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"4cd188c8-4671-45a0-8433-dd89ce4e16a5\",\"organization\":\"kling\",\"provider\":\"kling\",\"publicName\":\"kling-2.5-turbo-1080p\",\"name\":\"kling-2.5-turbo-1080p\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019a3c95-c431-79fe-9298-09cce3f449f3\",\"organization\":\"alibaba\",\"provider\":\"alibaba\",\"publicName\":\"wan2.5-i2v-preview\",\"name\":\"wan2.5-i2v-preview\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"0199eacf-0d64-736a-8309-07cc254b849d\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-3.1-audio\",\"name\":\"veo-3.1-audio\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"0199eacf-1119-7e20-a53e-86b740c32f03\",\"organization\":\"google\",\"provider\":\"googleVertex\",\"publicName\":\"veo-3.1-fast-audio\",\"name\":\"veo-3.1-fast-audio\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019a1e21-7cb0-7778-9dd0-02ed4fb3563f\",\"organization\":\"minimax\",\"provider\":\"minimax\",\"publicName\":\"hailuo-2.3\",\"name\":\"hailuo-2.3\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":false}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019a997a-88a7-7e5c-9214-ed2a946eb739\",\"organization\":\"kandinsky\",\"provider\":\"kandinsky\",\"publicName\":\"kandinsky-5.0-t2v-lite\",\"name\":\"kandinsky-5.0-t2v-lite\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"019a997a-92dd-7588-ac3c-bdca7e81af37\",\"organization\":\"kandinsky\",\"provider\":\"kandinsky\",\"publicName\":\"kandinsky-5.0-t2v-pro\",\"name\":\"kandinsky-5.0-t2v-pro\",\"capabilities\":{\"inputCapabilities\":{\"text\":true},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}},{\"id\":\"5b3383a9-6bca-4f71-8210-78895c9d84d5\",\"organization\":\"luma-ai\",\"provider\":\"fal\",\"publicName\":\"ray2\",\"name\":\"ray2-image-to-video\",\"capabilities\":{\"inputCapabilities\":{\"text\":true,\"image\":{\"requiresUpload\":true}},\"outputCapabilities\":{\"video\":true}},\"rankByModality\":{\"video\":9007199254740991}}],\"initialModelAId\":\"019ab8b2-9bcf-79b5-9fb5-149a7c67b7c0\",\"initialModelBId\":null,\"children\":[\"$L34\",\"$L35\"]}]\n"])</script><script>self.__next_f.push([1,"36:I[86508,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"DismissableHeaderBanner\"]\n"])</script><script>self.__next_f.push([1,"37:I[47124,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"ArenaSidebarProvider\"]\n"])</script><script>self.__next_f.push([1,"38:I[87696,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"EvaluationSessionNotificationStoreProvider\"]\n"])</script><script>self.__next_f.push([1,"39:I[99484,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"ArenaSidebar\"]\n"])</script><script>self.__next_f.push([1,"3a:I[24600,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"SidebarInset\"]\n"])</script><script>self.__next_f.push([1,"3b:I[25257,[\"52307\",\"static/chunks/04e11c28-ea9d8ee041e7d2ff.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"41574\",\"static/chunks/8aacbce6-88a34b8eeaee694a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"59379\",\"static/chunks/f79f5b6c-35f1a745a9c4cb2f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96732\",\"static/chunks/96732-d9441f5dc98a99a9.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60085\",\"static/chunks/60085-670df980123fc75b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"60294\",\"static/chunks/60294-0b8504d1daa65488.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"79181\",\"static/chunks/79181-1242f2d124392839.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"11497\",\"static/chunks/11497-6ceeff1e9c85d138.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"91589\",\"static/chunks/91589-2a7b5f72e82cce6f.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"82214\",\"static/chunks/82214-8f84d964761bc4af.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"1060\",\"static/chunks/1060-d7e8cb52da646351.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"92027\",\"static/chunks/92027-3dd9233645836478.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5915\",\"static/chunks/5915-7cadfb8426f9b95a.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"96624\",\"static/chunks/96624-f993d60e989ef23d.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"20186\",\"static/chunks/20186-93af0fc699237fbf.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"95090\",\"static/chunks/95090-270d0f209a7eeb0b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46192\",\"static/chunks/46192-170273cb5db9a009.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"26254\",\"static/chunks/26254-ee93dcaf2b2ee6fe.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"21368\",\"static/chunks/21368-ac2a239ad05c5330.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"81069\",\"static/chunks/81069-d7eeb2c84c581251.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"49405\",\"static/chunks/49405-adfd94a6a9c3437c.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"28178\",\"static/chunks/28178-efe28f5ec012d57b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"7988\",\"static/chunks/7988-28b4de0512ac72e1.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"46855\",\"static/chunks/46855-96bf129bdf9f9797.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"69138\",\"static/chunks/69138-4af705ad2a7847c4.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"55186\",\"static/chunks/55186-7f702a4ef02ccbcc.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"90399\",\"static/chunks/90399-ef06b81ca99f5332.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"25626\",\"static/chunks/25626-33122f1179407249.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"30296\",\"static/chunks/30296-1d9ae1f465e18785.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\",\"5058\",\"static/chunks/app/%5Blocale%5D/(app)/(with-sidebar)/layout-cda7a0147393eb8b.js?dpl=dpl_3VsckoiMHNYE9AzMGgvS6zwtEcEN\"],\"LoginModal\"]\n"])</script><script>self.__next_f.push([1,"34:[\"$\",\"$L36\",null,{}]\n35:[\"$\",\"$L37\",null,{\"isInitiallyOpen\":false,\"isInitialRouteLeaderboard\":false,\"children\":[\"$\",\"$L38\",null,{\"children\":[[\"$\",\"$L39\",null,{}],[\"$\",\"$L3a\",null,{\"className\":\"flex h-svh flex-col\",\"children\":[[\"$\",\"main\",null,{\"id\":\"root-portal-target\",\"className\":\"h-full\",\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"$L3b\",null,{}]]}]]}]}]\n"])</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bcd6d5dd8b1b256',t:'MTc2ODIyOTAxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><iframe height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/saved_resource(1).html"></iframe><script defer="" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;rayId&quot;:&quot;9bcd6d5dd8b1b256&quot;,&quot;version&quot;:&quot;2025.9.1&quot;,&quot;serverTiming&quot;:{&quot;name&quot;:{&quot;cfExtPri&quot;:true,&quot;cfEdge&quot;:true,&quot;cfOrigin&quot;:true,&quot;cfL4&quot;:true,&quot;cfSpeedBrain&quot;:true,&quot;cfCacheStatus&quot;:true}},&quot;token&quot;:&quot;f67b768e7322450d970b8bcf2c449e7b&quot;,&quot;b&quot;:1}" crossorigin="anonymous"></script>
<div id="kiss-translator-box" class="notranslate"><template shadowrootmode="open"><div class="kiss-translator-box_wrapper notranslate"></div><style data-emotion="kiss-translator-box-global" data-s=""></style></template></div><div id="kiss-translator-fab" class="notranslate"><template shadowrootmode="open"><style data-emotion="kiss-translator-fab" data-s=""></style><div class="kiss-translator-fab_wrapper notranslate"><div style="opacity: 0.2; position: fixed; left: -20px; top: 450.5px; z-index: 2147483647; display: block;"><div style="touch-action: none;"><button class="MuiButtonBase-root MuiFab-root MuiFab-circular MuiFab-sizeSmall MuiFab-primary MuiFab-root MuiFab-circular MuiFab-sizeSmall MuiFab-primary kiss-translator-fab-1mkalbv" tabindex="0" type="button"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium kiss-translator-fab-1in44b7" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="TranslateIcon"><path d="m12.87 15.07-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg><span class="MuiTouchRipple-root kiss-translator-fab-w0pj6f"></span></button></div><div></div></div></div><style data-emotion="kiss-translator-fab-global" data-s=""></style></template></div><textarea tabindex="-1" aria-hidden="true" style="min-height: 0px !important; max-height: none !important; height: 0px !important; visibility: hidden !important; overflow: hidden !important; position: absolute !important; z-index: -1000 !important; top: 0px !important; right: 0px !important; display: block !important; border-width: 0px; box-sizing: border-box; font-family: Inter, &quot;Inter Fallback&quot;, ui-sans-serif, system-ui, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Noto Color Emoji&quot;; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; line-height: 24px; padding: 12px; tab-size: 4; text-indent: 0px; text-rendering: auto; text-transform: none; width: 1630px; word-break: normal; word-spacing: 0px; scrollbar-gutter: auto;"></textarea><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/js" data-nscript="afterInteractive"></script><script id="google-analytics" data-nscript="afterInteractive">
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                
                gtag('config', 'G-L5C4D55WJJ', {
                    page_path: window.location.pathname,
                });
                </script><script src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/enterprise.js.下载" data-nscript="afterInteractive"></script><next-route-announcer style="position: absolute;"><template shadowrootmode="open"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></template></next-route-announcer><div><div class="grecaptcha-badge" data-style="bottomright" style="width: 256px; height: 60px; display: block; transition: right 0.3s; position: fixed; bottom: 14px; right: -186px; box-shadow: gray 0px 0px 5px; border-radius: 2px; overflow: hidden;"><div class="grecaptcha-logo"><iframe title="reCAPTCHA" width="256" height="60" role="presentation" name="a-f1ihnz4s3l9z" frameborder="0" scrolling="no" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation allow-modals allow-popups-to-escape-sandbox allow-storage-access-by-user-activation" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/anchor.html"></iframe></div><div class="grecaptcha-error"></div><textarea id="g-recaptcha-response-100000" name="g-recaptcha-response" class="g-recaptcha-response" style="width: 250px; height: 40px; border: 1px solid rgb(193, 193, 193); margin: 10px 25px; padding: 0px; resize: none; display: none;"></textarea></div><iframe style="display: none;" src="./LMArena _ Benchmark &amp; Compare the Best AI Models_files/saved_resource(2).html"></iframe></div></body></html>