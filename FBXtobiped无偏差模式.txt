--文件名 : Sox Fbx to Biped 完整版
--支持武器、Xtra、Ponytail等附加骨骼，支持模板保存/加载
--作者：改进版 v2.8 - 使用 User Defined Properties 存储（修正版）

global SoxFbxToBipedFull

try (destroydialog SoxFbxToBipedFull) catch()

-- ============ 全局变量 ============
global Fbx_allbone = #()
global Fbx_bip = #()
global Fbx_bip_name = #()
global New_bip = #()
global New_bip_name = #()
global Bip_root = undefined
global New_bip_root = undefined
global New_bone = #()
global New_bone_name = #()
global Fbx_bone = #()
global Fbx_bone_name = #()
global SceneDataHelper = undefined
global SceneDataHelperName = "SoxFbxToBipedData_v28"

-- 骨骼配对结构
struct BonePair (
	fbxBone,
	newBone,
	fbxBoneName,
	newBoneName
)
global bone_pairs = #()

-- ============ 全局辅助函数 ============

fn getAllChildrenRecursive node result:#() = (
	if node == undefined do return result
	if node.children.count > 0 do (
		for child in node.children do (
			append result child
			getAllChildrenRecursive child result:result
		)
	)
	return result
)

fn isBipedBone boneName = (
	local result = false
	if matchPattern boneName pattern:"*bip*" do result = true
	if matchPattern boneName pattern:"*Nub*" do result = false
	if matchPattern boneName pattern:"*Footsteps*" do result = false
	if matchPattern boneName pattern:"*Twist*" do result = false
	return result
)

fn isAttachmentBone boneName = (
	local result = false
	if matchPattern boneName pattern:"*Twist*" do return false
	if not matchPattern boneName pattern:"*bip*" do result = true
	if matchPattern boneName pattern:"*Xtra*" do result = true
	if matchPattern boneName pattern:"*Ponytail*" do result = true
	if matchPattern boneName pattern:"*马尾辫*" do result = true
	return result
)

fn normalizeBoneName str = (
	if str == undefined or str == "" do return ""
	
	local result = ""
	local upperStr = toUpper str
	
	local prefixesToRemove = #(
		"BIP001", "BIP002", "BIP003", "BIP008", "BIP01", "BIP02", "BIP03",
		"MIXAMORIG", "MIXAMO", "ROOT", "ARMATURE"
	)
	
	for prefix in prefixesToRemove do (
		if matchPattern upperStr pattern:(prefix + "*") do (
			upperStr = substring upperStr (prefix.count + 1) -1
			exit
		)
	)
	
	for i = 1 to upperStr.count do (
		local char = upperStr[i]
		if (char >= "A" and char <= "Z") or (char >= "0" and char <= "9") do (
			result += char
		)
	)
	
	while result.count > 0 and result[1] >= "0" and result[1] <= "9" do (
		result = substring result 2 -1
	)
	
	while result.count > 0 and result[result.count] >= "0" and result[result.count] <= "9" do (
		result = substring result 1 (result.count - 1)
	)
	
	return result
)

fn extractBoneKeywords str = (
	local normalized = normalizeBoneName str
	local keywords = #()
	
	local knownKeywords = #(
		"PELVIS", "SPINE", "NECK", "HEAD",
		"CLAVICLE", "SHOULDER", "UPPERARM", "FOREARM", "HAND",
		"THUMB", "INDEX", "MIDDLE", "RING", "PINKY",
		"FINGER", "DIGIT",
		"THIGH", "CALF", "FOOT", "TOE",
		"HIP", "KNEE", "ANKLE",
		"HORSELINK", "LINK",
		"TAIL", "PONYTAIL", "PROP",
		"LEFT", "RIGHT", "L", "R"
	)
	
	for keyword in knownKeywords do (
		if findString normalized keyword != undefined do (
			appendIfUnique keywords keyword
		)
	)
	
	return keywords
)

fn calculateNameSimilarity name1 name2 = (
	local norm1 = normalizeBoneName name1
	local norm2 = normalizeBoneName name2
	
	if norm1 == norm2 do return 100
	if norm1 == "" or norm2 == "" do return 0
	
	local keywords1 = extractBoneKeywords name1
	local keywords2 = extractBoneKeywords name2
	
	if keywords1.count > 0 and keywords2.count > 0 do (
		local matchCount = 0
		for kw in keywords1 do (
			if findItem keywords2 kw != 0 do matchCount += 1
		)
		
		local totalKeywords = amax #(keywords1.count, keywords2.count)
		if totalKeywords > 0 do (
			local keywordScore = (matchCount as float / totalKeywords as float) * 100
			if keywordScore >= 80 do return keywordScore
		)
	)
	
	if findString norm1 norm2 != undefined do return 70
	if findString norm2 norm1 != undefined do return 70
	
	local len1 = norm1.count
	local len2 = norm2.count
	
	if len1 == 0 do return 0
	if len2 == 0 do return 0
	
	local maxLen = amin #(len1, len2, 10)
	local matchChars = 0
	
	for i = 1 to maxLen do (
		if norm1[i] == norm2[i] do matchChars += 1
	)
	
	local similarity = (matchChars as float / maxLen as float) * 100
	return similarity
)

fn findBestMatch fbxBone newBoneList matchedIndices = (
	local bestScore = 0
	local bestIndex = 0
	
	for i = 1 to newBoneList.count do (
		if findItem matchedIndices i == 0 do (
			local score = calculateNameSimilarity fbxBone.name newBoneList[i].name
			if score > bestScore do (
				bestScore = score
				bestIndex = i
			)
		)
	)
	
	if bestScore >= 60 then
		return #(bestIndex, bestScore)
	else
		return #(0, 0)
)

fn findFbxBoneByName boneName = (
	for bone in Fbx_bip do (
		if bone.name == boneName do return bone
	)
	return undefined
)

fn findNewBoneByName boneName = (
	for bone in New_bip do (
		if bone.name == boneName do return bone
	)
	return undefined
)

fn getNextBipedNumber = (
	local maxNum = 0
	for obj in objects do (
		if matchPattern obj.name pattern:"Bip*" do (
			local numStr = substring obj.name 4 3
			try (
				local num = numStr as integer
				if num > maxNum do maxNum = num
			) catch()
		)
	)
	return maxNum + 1
)

-- ============ 场景数据管理函数（使用 User Defined Properties） ============

fn findSceneDataHelper = (
	local helper = getNodeByName SceneDataHelperName
	if helper != undefined and isValidNode helper then (
		-- 验证是否有数据
		local ver = getUserProp helper "Version"
		if ver != undefined then (
			SceneDataHelper = helper
			return helper
		)
	)
	return undefined
)

fn createSceneDataHelper = (
	-- 删除旧的
	try (
		local oldHelper = findSceneDataHelper()
		if oldHelper != undefined do delete oldHelper
	) catch()
	
	-- 创建新的Point对象
	SceneDataHelper = Point size:10 centermarker:true axistripod:true cross:false box:false \
		name:SceneDataHelperName wirecolor:(color 255 0 255) pos:[0,0,0]
	
	SceneDataHelper.isHidden = true
	
	format "创建场景数据对象: %\n" SceneDataHelper.name
	
	return SceneDataHelper
)

fn saveDataToSceneHelper = (
	if bone_pairs.count == 0 do (
		messageBox "没有配对数据可保存！" title:"提示"
		return false
	)
	
	try (
		local helper = createSceneDataHelper()
		if helper == undefined do throw "无法创建数据对象"
		
		-- 保存版本和基本信息
		setUserProp helper "Version" "2.8"
		setUserProp helper "SaveDate" (localTime as string)
		setUserProp helper "FbxRoot" (if Bip_root != undefined then Bip_root.name else "")
		setUserProp helper "NewRoot" (if New_bip_root != undefined then New_bip_root.name else "")
		
		-- 提取 biped 编号
		if New_bip_root != undefined then (
			local rootName = New_bip_root.name
			if rootName.count >= 6 then (
				local numStr = substring rootName 4 3
				try (
					setUserProp helper "BipedNumber" (numStr as integer)
				) catch (
					setUserProp helper "BipedNumber" 1
				)
			)
		)
		
		-- 保存 Biped 配对数量和数据
		setUserProp helper "BipedMappingCount" bone_pairs.count
		
		for i = 1 to bone_pairs.count do (
			local fbxName = if bone_pairs[i].fbxBone != undefined then bone_pairs[i].fbxBone.name else ""
			local newName = if bone_pairs[i].newBone != undefined then bone_pairs[i].newBone.name else ""
			
			setUserProp helper ("BipedPair_" + i as string + "_Fbx") fbxName
			setUserProp helper ("BipedPair_" + i as string + "_New") newName
		)
		
		-- 保存附加骨骼数据
		setUserProp helper "AttachmentCount" Fbx_bone.count
		
		for i = 1 to Fbx_bone.count do (
			setUserProp helper ("Attachment_" + i as string + "_Fbx") Fbx_bone_name[i]
			setUserProp helper ("Attachment_" + i as string + "_New") New_bone_name[i]
		)
		
		format "数据已保存到 User Defined Properties:\n"
		format "  FBX根: %\n" (getUserProp helper "FbxRoot")
		format "  新根: %\n" (getUserProp helper "NewRoot")
		format "  Biped配对数: %\n" (getUserProp helper "BipedMappingCount")
		format "  附加骨骼: %\n" (getUserProp helper "AttachmentCount")
		
		return true
		
	) catch (
		format "保存失败: %\n" (getCurrentException())
		return false
	)
)

fn loadDataFromSceneHelper = (
	local helper = findSceneDataHelper()
	if helper == undefined do (
		return false
	)
	
	try (
		format "从场景加载数据...\n"
		
		-- 读取基本信息
		local fbxRootName = getUserProp helper "FbxRoot"
		local newRootName = getUserProp helper "NewRoot"
		local bipedMappingCount = getUserProp helper "BipedMappingCount"
		local attachmentCount = getUserProp helper "AttachmentCount"
		
		format "  版本: %\n" (getUserProp helper "Version")
		format "  保存日期: %\n" (getUserProp helper "SaveDate")
		format "  FBX根: %\n" fbxRootName
		format "  新根: %\n" newRootName
		format "  配对数: %\n" bipedMappingCount
		format "  附加骨骼: %\n" attachmentCount
		
		-- 读取根骨骼
		if fbxRootName != undefined and fbxRootName != "" do (
			Bip_root = getNodeByName fbxRootName
			if Bip_root != undefined then (
				Fbx_allbone = getAllChildrenRecursive Bip_root
				Fbx_bip = #()
				Fbx_bip_name = #()
				for bone in Fbx_allbone do (
					if isBipedBone bone.name do (
						append Fbx_bip bone
						append Fbx_bip_name bone.name
					)
				)
				format "  找到FBX骨骼: %\n" Fbx_bip.count
			)
			else (
				format "  警告: 未找到FBX根骨骼 '%'\n" fbxRootName
			)
		)
		
		if newRootName != undefined and newRootName != "" do (
			New_bip_root = getNodeByName newRootName
			if New_bip_root != undefined then (
				local allBones = getAllChildrenRecursive New_bip_root
				New_bip = #()
				New_bip_name = #()
				for bone in allBones do (
					if not matchPattern bone.name pattern:"*Nub*" do (
						if isBipedBone bone.name do (
							append New_bip bone
							append New_bip_name bone.name
						)
					)
				)
				format "  找到新Biped骨骼: %\n" New_bip.count
			)
			else (
				format "  警告: 未找到新Biped根骨骼 '%'\n" newRootName
			)
		)
		
		-- 读取 Biped 配对关系
		bone_pairs = #()
		if bipedMappingCount != undefined do (
			for i = 1 to bipedMappingCount do (
				local fbxName = getUserProp helper ("BipedPair_" + i as string + "_Fbx")
				local newName = getUserProp helper ("BipedPair_" + i as string + "_New")
				
				if fbxName == undefined do fbxName = ""
				if newName == undefined do newName = ""
				
				local fbxBone = if fbxName != "" then (getNodeByName fbxName) else undefined
				local newBone = if newName != "" then (getNodeByName newName) else undefined
				
				append bone_pairs (BonePair \
					fbxBone:fbxBone \
					newBone:newBone \
					fbxBoneName:fbxName \
					newBoneName:newName)
			)
		)
		format "  加载配对关系: %\n" bone_pairs.count
		
		-- 读取附加骨骼
		New_bone = #()
		New_bone_name = #()
		Fbx_bone = #()
		Fbx_bone_name = #()
		
		if attachmentCount != undefined do (
			for i = 1 to attachmentCount do (
				local fbxName = getUserProp helper ("Attachment_" + i as string + "_Fbx")
				local newName = getUserProp helper ("Attachment_" + i as string + "_New")
				
				if fbxName != undefined and newName != undefined do (
					local fbxBone = getNodeByName fbxName
					local newBone = getNodeByName newName
					
					if fbxBone != undefined and newBone != undefined do (
						append Fbx_bone fbxBone
						append Fbx_bone_name fbxName
						append New_bone newBone
						append New_bone_name newName
					)
				)
			)
		)
		format "  加载附加骨骼: %\n" New_bone.count
		
		return true
		
	) catch (
		format "加载失败: %\n" (getCurrentException())
		return false
	)
)

-- ============ Rollout 定义 ============

rollout SoxFbxToBipedFull "Fbx转Biped完整版 v2.8" width:650 height:850
(
	-- .NET 控件
	dotNetControl dgvBipedMapping "System.Windows.Forms.DataGridView" pos:[10,10] width:630 height:250
	dotNetControl dgvBoneMapping "System.Windows.Forms.DataGridView" pos:[10,270] width:630 height:250
	
	group "快速操作" (
		button btnQuickConvert "一键Fbx转Bip" width:300 height:45 toolTip:"自动分析、创建和匹配" across:2
		button btnAnalyzeSkeleton "分析骨架" width:300 height:45
		
		checkbox chkReplaceName "替换名称" checked:true across:3
		checkbox chkReplaceSkin "替换蒙皮" checked:true
		checkbox chkImportAnim "导入动画" checked:false
	)
	
	group "模板管理" (
		button btnSaveTemplate "保存模板" width:150 toolTip:"保存当前配对关系为模板" across:4
		button btnLoadTemplate "加载模板" width:150 toolTip:"从模板文件加载配对关系"
		button btnSetFbxBone "设置FBX骨骼" width:150 toolTip:"手动设置选中项的FBX骨骼"
		button btnSetNewBone "设置新骨骼" width:150 toolTip:"手动设置选中项的新Biped骨骼"
	)
	
	group "数据管理" (
		button btnSaveToScene "保存到场景" width:200 height:30 toolTip:"将映射关系保存到场景对象" across:2
		button btnClearSceneData "清除场景数据" width:200 height:30 toolTip:"删除场景中的映射数据对象"
		label lblDataStatus "场景数据：无" align:#left
	)
	
	group "手动操作" (
		button btnManualMatch "手动匹配" width:150 across:4
		button btnFigureSync "体型同步" width:150
		button btnAnimSync "动画同步" width:150
		button btnReset "重置" width:150
	)
	
	spinner spnBoneSize "附加骨骼大小:" range:[0.1,10,1] type:#float fieldWidth:60
	
	progressBar pbProgress width:630 height:20
	label lblStatus "状态：就绪" align:#left
	label lblInfo "" align:#left height:40
	
	-- ============ Rollout 局部函数 ============
	
	fn refreshLists = (
		dgvBipedMapping.Rows.Clear()
		
		for i = 1 to bone_pairs.count do (
			local idx = dgvBipedMapping.Rows.Add()
			local row = dgvBipedMapping.Rows.Item[idx]
			
			local fbxName = if bone_pairs[i].fbxBone != undefined then bone_pairs[i].fbxBone.name else "( 未设置 )"
			local newName = if bone_pairs[i].newBone != undefined then bone_pairs[i].newBone.name else "( 未设置 )"
			
			row.Cells.Item[0].Value = fbxName
			row.Cells.Item[1].Value = newName
			
			if bone_pairs[i].fbxBone != undefined and bone_pairs[i].newBone != undefined then (
				row.Cells.Item[2].Value = "✓"
				row.DefaultCellStyle.BackColor = (dotNetClass "System.Drawing.Color").LightGreen
			) else (
				row.Cells.Item[2].Value = "✗"
				row.DefaultCellStyle.BackColor = (dotNetClass "System.Drawing.Color").LightYellow
			)
		)
		
		dgvBoneMapping.Rows.Clear()
		for i = 1 to New_bone.count do (
			local idx = dgvBoneMapping.Rows.Add()
			local row = dgvBoneMapping.Rows.Item[idx]
			
			row.Cells.Item[0].Value = Fbx_bone_name[i]
			row.Cells.Item[1].Value = New_bone_name[i]
			
			local boneType = "Bone"
			if matchPattern Fbx_bone_name[i] pattern:"*Xtra*" do boneType = "Xtra"
			if matchPattern Fbx_bone_name[i] pattern:"*Prop*" do boneType = "武器"
			if matchPattern Fbx_bone_name[i] pattern:"*Ponytail*" do boneType = "马尾辫"
			if matchPattern Fbx_bone_name[i] pattern:"*Dummy*" do boneType = "Dummy"
			
			row.Cells.Item[2].Value = boneType
			row.DefaultCellStyle.BackColor = (dotNetClass "System.Drawing.Color").LightCyan
		)
	)
	
	fn saveDataToScene = (
		if saveDataToSceneHelper() then (
			lblDataStatus.text = "场景数据：已保存（" + bone_pairs.count as string + "对）"
			lblStatus.text = "状态：映射关系已保存到场景"
			messageBox ("映射关系已保存到场景！\n\n对象名称：" + SceneDataHelperName + "\nBiped配对：" + bone_pairs.count as string + "\n附加骨骼：" + New_bone.count as string + "\n\n提示：数据保存在对象的 User Defined Properties 中") title:"成功"
			return true
		)
		else (
			messageBox "保存失败！请查看监听器窗口" title:"错误"
			return false
		)
	)
	
	fn loadDataFromScene = (
		if loadDataFromSceneHelper() then (
			refreshLists()  -- 现在 refreshLists 在同一个 rollout 中定义
			lblDataStatus.text = "场景数据：已加载（" + bone_pairs.count as string + "对）"
			lblStatus.text = "状态：已从场景加载映射关系"
			
			local info = "已加载映射关系！\n\n"
			info += "Biped配对数量：" + bone_pairs.count as string + "\n"
			info += "附加骨骼：" + New_bone.count as string
			
			messageBox info title:"加载成功"
			return true
		)
		else (
			lblDataStatus.text = "场景数据：无"
			return false
		)
	)
	
	fn clearSceneData = (
		local helper = findSceneDataHelper()
		if helper != undefined do (
			try (
				delete helper
				SceneDataHelper = undefined
				lblDataStatus.text = "场景数据：无"
				lblStatus.text = "状态：场景数据已清除"
				messageBox "场景数据已清除！" title:"完成"
			) catch (
				messageBox "清除失败！" title:"错误"
			)
		)
		if helper == undefined do (
			messageBox "场景中没有找到数据对象！" title:"提示"
		)
	)
	
	fn createBonePairs = (
		bone_pairs = #()
		
		if Fbx_bip.count == 0 or New_bip.count == 0 do (
			messageBox "骨骼数据不完整！" title:"错误"
			return false
		)
		
		local matchedIndices = #()
		local matchDetails = stringStream ""
		
		format "\n========== 骨骼匹配报告 ==========\n" to:matchDetails
		
		for i = 1 to Fbx_bip.count do (
			local fbxBone = Fbx_bip[i]
			local matchResult = findBestMatch fbxBone New_bip matchedIndices
			local bestIndex = matchResult[1]
			local bestScore = matchResult[2]
			
			if bestIndex > 0 then (
				append bone_pairs (BonePair \
					fbxBone:fbxBone \
					newBone:New_bip[bestIndex] \
					fbxBoneName:fbxBone.name \
					newBoneName:New_bip[bestIndex].name)
				append matchedIndices bestIndex
				
				format "✓ [%] % <-> % (相似度: %)\n" i fbxBone.name New_bip[bestIndex].name bestScore to:matchDetails
			)
			else (
				append bone_pairs (BonePair \
					fbxBone:fbxBone \
					newBone:undefined \
					fbxBoneName:fbxBone.name \
					newBoneName:"")
				
				format "✗ [%] % - 未找到匹配\n" i fbxBone.name to:matchDetails
			)
		)
		
		for i = 1 to New_bip.count do (
			if findItem matchedIndices i == 0 do (
				format "  [未使用] %\n" New_bip[i].name to:matchDetails
			)
		)
		
		format "================================\n" to:matchDetails
		format "总计: FBX骨骼 %, 成功匹配 %\n" Fbx_bip.count (Fbx_bip.count - (for p in bone_pairs where p.newBone == undefined collect p).count) to:matchDetails
		
		print (matchDetails as string)
		
		format "成功配对 % 个骨骼\n" bone_pairs.count
		return true
	)
	
	fn saveTemplate = (
		if bone_pairs.count == 0 do (
			messageBox "没有配对数据可保存！" title:"错误"
			return false
		)
		
		local filename = getSaveFileName caption:"保存Biped配对模板" \
			types:"Biped模板文件(*.bpt)|*.bpt|所有文件(*.*)|*.*"
		
		if filename == undefined do return false
		
		try (
			local f = createFile filename
			if f == undefined do throw "无法创建文件"
			
			format "# Sox Fbx to Biped Template File\n" to:f
			format "# Version: 2.8\n" to:f
			format "# Date: %\n\n" (localTime) to:f
			
			if Bip_root != undefined then
				format "FbxRoot=%\n" Bip_root.name to:f
			else
				format "FbxRoot=\n" to:f
			
			if New_bip_root != undefined then
				format "NewRoot=%\n\n" New_bip_root.name to:f
			else
				format "NewRoot=\n\n" to:f
			
			format "# Bone Pairs Count: %\n" bone_pairs.count to:f
			for pair in bone_pairs do (
				local fbxName = if pair.fbxBone != undefined then pair.fbxBone.name else ""
				local newName = if pair.newBone != undefined then pair.newBone.name else ""
				format "[PAIR]\n" to:f
				format "FbxBone=%\n" fbxName to:f
				format "NewBone=%\n" newName to:f
			)
			
			close f
			
			lblStatus.text = "状态：模板已保存 - " + (filenameFromPath filename)
			messageBox ("模板已保存！\n文件：" + filename) title:"成功"
			return true
			
		) catch (
			messageBox ("保存失败：" + getCurrentException()) title:"错误"
			return false
		)
	)
	
	fn loadTemplate = (
		if Fbx_bip.count == 0 or New_bip.count == 0 do (
			messageBox "请先分析FBX骨架并创建新Biped！" title:"错误"
			return false
		)
		
		local filename = getOpenFileName caption:"加载Biped配对模板" \
			types:"Biped模板文件(*.bpt)|*.bpt|所有文件(*.*)|*.*"
		
		if filename == undefined do return false
		
		try (
			local f = openFile filename mode:"r"
			if f == undefined do throw "无法打开文件"
			
			bone_pairs = #()
			local currentFbxBone = ""
			local currentNewBone = ""
			local inPair = false
			
			while not eof f do (
				local line = readLine f
				line = trimLeft (trimRight line)
				
				if line.count == 0 or line[1] == "#" do continue
				
				local eqPos = findString line "="
				if eqPos != undefined do (
					local key = substring line 1 (eqPos - 1)
					local value = substring line (eqPos + 1) -1
					
					case key of (
						"[PAIR]": (
							inPair = true
							currentFbxBone = ""
							currentNewBone = ""
						)
						"FbxBone": (
							currentFbxBone = value
						)
						"NewBone": (
							currentNewBone = value
							
							if inPair do (
								local fbxBone = findFbxBoneByName currentFbxBone
								local newBone = findNewBoneByName currentNewBone
								
								if fbxBone != undefined or newBone != undefined do (
									append bone_pairs (BonePair \
										fbxBone:fbxBone \
										newBone:newBone \
										fbxBoneName:currentFbxBone \
										newBoneName:currentNewBone)
								)
								
								inPair = false
							)
						)
					)
				)
			)
			
			close f
			
			lblStatus.text = "状态：模板已加载 - " + (filenameFromPath filename)
			messageBox ("模板已加载！\n成功配对：" + bone_pairs.count as string + " 个骨骼") title:"成功"
			
			refreshLists()
			return true
			
		) catch (
			messageBox ("加载失败：" + getCurrentException()) title:"错误"
			return false
		)
	)
	
	fn analyzeFbxSkeleton = (
		lblStatus.text = "状态：正在分析FBX骨架..."
		
		Bip_root = undefined
		for obj in objects do (
			if matchPattern obj.name pattern:"*Bip*Pelvis*" or \
			   matchPattern obj.name pattern:"*pelvis*" or \
			   matchPattern obj.name pattern:"*Hips*" do (
				Bip_root = obj.parent
				exit
			)
		)
		
		if Bip_root == undefined do (
			messageBox "未找到FBX骨架！\n请确保场景中有Biped骨骼。" title:"错误"
			return false
		)
		
		Fbx_allbone = getAllChildrenRecursive Bip_root
		
		Fbx_bip = #()
		Fbx_bip_name = #()
		for bone in Fbx_allbone do (
			if isBipedBone bone.name do (
				append Fbx_bip bone
				append Fbx_bip_name bone.name
			)
		)
		
		local spineCount = 0
		local neckCount = 0
		local leftFingers = 0
		local rightFingers = 0
		local leftToes = 0
		local rightToes = 0
		local hasArms = false
		local legLinks = 3
		local tailCount = 0
		local propCount = 0
		
		for boneName in Fbx_bip_name do (
			if matchPattern boneName pattern:"*Spine*" do spineCount += 1
			if matchPattern boneName pattern:"*Neck*" do neckCount += 1
			if matchPattern boneName pattern:"*bip*L*Finger*" do leftFingers += 1
			if matchPattern boneName pattern:"*bip*R*Finger*" do rightFingers += 1
			if matchPattern boneName pattern:"*L*Toe*" do leftToes += 1
			if matchPattern boneName pattern:"*R*Toe*" do rightToes += 1
			if matchPattern boneName pattern:"*Clavicle*" do hasArms = true
			if matchPattern boneName pattern:"*HorseLink*" do legLinks = 4
			if matchPattern boneName pattern:"*Tail*" do tailCount += 1
			if matchPattern boneName pattern:"*prop*" do propCount += 1
		)
		
		local fingerCount = 0
		local fingerLinks = 0
		local toeCount = 0
		local toeLinks = 0
		
		if leftFingers > 0 do (
			for bone in Fbx_bip do (
				if matchPattern bone.name pattern:"*L*Hand*" do (
					for child in bone.children do (
						if matchPattern child.name pattern:"*bip*L*Finger*" do (
							fingerCount += 1
						)
					)
					exit
				)
			)
			if fingerCount > 0 do fingerLinks = leftFingers / fingerCount
		)
		
		if leftToes > 0 then (
			for bone in Fbx_bip do (
				if matchPattern bone.name pattern:"*L*Foot*" do (
					for child in bone.children do (
						if matchPattern child.name pattern:"*bip*L*Toe*" do (
							toeCount += 1
						)
					)
					exit
				)
			)
			if toeCount > 0 do toeLinks = leftToes / toeCount
		)
		else (
			toeCount = 1
			toeLinks = 1
		)
		
		local attachmentCount = 0
		for bone in Fbx_allbone do (
			if isAttachmentBone bone.name do (
				attachmentCount += 1
			)
		)
		
		local info = "FBX骨架分析：\n"
		info += "Biped骨骼：" + Fbx_bip.count as string
		info += " | 附加骨骼（武器/Xtra等）：" + attachmentCount as string + "\n"
		info += "脊椎：" + spineCount as string + " | 脖子：" + neckCount as string
		info += " | 手指：" + fingerCount as string + "x" + fingerLinks as string
		info += " | 脚趾：" + toeCount as string + "x" + toeLinks as string
		
		lblInfo.text = info
		lblStatus.text = "状态：分析完成"
		
		return #(spineCount, neckCount, hasArms, fingerCount, fingerLinks, toeCount, toeLinks, legLinks, tailCount, propCount)
	)
	
	fn autoCreateBiped params = (
		lblStatus.text = "状态：正在创建Biped..."
		
		local spineCount = params[1]
		local neckCount = params[2]
		local hasArms = params[3]
		local fingerCount = params[4]
		local fingerLinks = params[5]
		local toeCount = params[6]
		local toeLinks = params[7]
		local legLinks = params[8]
		local tailCount = params[9]
		local propCount = params[10]
		
		local pelvisPos = undefined
		local headPos = undefined
		for bone in Fbx_bip do (
			if matchPattern bone.name pattern:"*Pelvis*" do pelvisPos = bone.pos
			if matchPattern bone.name pattern:"*Head*" do headPos = bone.pos
		)
		
		local bipHeight = 100
		if pelvisPos != undefined and headPos != undefined do (
			bipHeight = distance pelvisPos headPos
		)
		
		if fingerCount == 0 do fingerLinks = 1
		
		local bipNum = getNextBipedNumber()
		local bipPrefix = "Bip" + (formattedPrint bipNum format:"03d")
		
		format "创建新 Biped: %\n" bipPrefix
		
		local newBip = biped.createNew (bipHeight * 3) -90 [0,0,0] \
			arms:hasArms \
			necklinks:neckCount \
			spineLinks:spineCount \
			legLinks:legLinks \
			fingers:fingerCount \
			fingerLinks:fingerLinks \
			toes:toeCount \
			toeLinks:toeLinks \
			tailLinks:tailCount
		
		if fingerCount == 0 do fingerLinks = 0
		
		local bipCtrl = newBip.controller
		bipCtrl.figureMode = true
		bipCtrl.bodyType = 3
		
		if propCount >= 1 do bipCtrl.prop1Exists = true
		if propCount >= 2 do bipCtrl.prop2Exists = true
		if propCount >= 3 do bipCtrl.prop3Exists = true
		
		bipCtrl.rootName = bipPrefix
		
		New_bip_root = newBip
		
		local allBones = getAllChildrenRecursive newBip
		New_bip = #()
		New_bip_name = #()
		for bone in allBones do (
			if not matchPattern bone.name pattern:"*Nub*" do (
				if isBipedBone bone.name do (
					append New_bip bone
					append New_bip_name bone.name
				)
			)
		)
		
		lblStatus.text = "状态：Biped创建完成（" + bipPrefix + "）"
		return newBip
	)
	
	fn createAttachmentBones = (
		lblStatus.text = "状态：正在创建附加骨骼..."
		
		New_bone = #()
		New_bone_name = #()
		Fbx_bone = #()
		Fbx_bone_name = #()
		
		local children_array = #()
		for bone in Fbx_bip do (
			if bone.children.count > 0 do (
				for child in bone.children do (
					append children_array child
				)
			)
		)
		
		local bone_root_array = #()
		for child in children_array do (
			if isAttachmentBone child.name do (
				append bone_root_array child
			)
		)
		
		if bone_root_array.count == 0 do (
			lblStatus.text = "状态：无附加骨骼"
			return()
		)
		
		local boneSize = spnBoneSize.value
		
		for rootBone in bone_root_array do (
			local boneParent = rootBone.parent
			local newParent = undefined
			
			for pair in bone_pairs do (
				if pair.fbxBone == boneParent do (
					newParent = pair.newBone
					exit
				)
			)
			
			if newParent == undefined do (
				format "警告：未找到父骨骼 % 的匹配\n" boneParent.name
				continue
			)
			
			local boneChain = getAllChildrenRecursive rootBone
			insertItem rootBone boneChain 1
			
			local bonePositions = #()
			for bone in boneChain do (
				append bonePositions bone.transform.pos
			)
			
			local relation_parent = #()
			local relation_children = #()
			
			for i = 1 to boneChain.count do (
				local fbxBone = boneChain[i]
				local newBone = undefined
				
				if matchPattern fbxBone.name pattern:"*Dummy*" then (
					if i < boneChain.count then (
						local dist = distance bonePositions[i] bonePositions[i+1]
						if dist > 0.001 then
							newBone = Dummy boxsize:[dist, dist, dist] / 2
						else
							newBone = Dummy boxsize:[boneSize, boneSize, boneSize] * 3
					)
					else
						newBone = Dummy boxsize:[boneSize, boneSize, boneSize] * 3
					
					newBone.transform = fbxBone.transform
					
					append relation_parent newBone
					append relation_children fbxBone.children
				)
				else (
					if i < boneChain.count then (
						if distance bonePositions[i] bonePositions[i+1] > 0.001 then (
							newBone = BoneSys.createBone bonePositions[i] bonePositions[i+1] [0,0,1]
							newBone.width = distance bonePositions[i] bonePositions[i+1] / 4
							newBone.height = distance bonePositions[i] bonePositions[i+1] / 4
						)
						else (
							newBone = BoneSys.createBone bonePositions[i] (bonePositions[i] * 1.1) [0,0,1]
							newBone.width = boneSize
							newBone.height = boneSize
							newBone.length = boneSize * 4
						)
						
						newBone.transform = fbxBone.transform
						newBone.wirecolor = color 176 26 26
						newBone.boneEnable = false
						newBone.frontfin = true
						newBone.frontfinsize = boneSize / 2
						
						append relation_parent newBone
						append relation_children fbxBone.children
					)
					else (
						newBone = BoneSys.createBone bonePositions[i] (bonePositions[i] * 1.1) [0,0,1]
						newBone.transform = fbxBone.transform
						
						if i > 1 and fbxBone.parent != undefined then (
							if distance fbxBone.transform.pos fbxBone.parent.transform.pos > 0.001 then (
								newBone.width = distance fbxBone.transform.pos fbxBone.parent.transform.pos / 4
								newBone.height = distance fbxBone.transform.pos fbxBone.parent.transform.pos / 4
								newBone.length = (newBone.width + newBone.height) / 2
							)
							else (
								newBone.width = boneSize
								newBone.height = boneSize
								newBone.length = boneSize * 4
							)
						)
						else (
							newBone.width = boneSize
							newBone.height = boneSize
							newBone.length = boneSize * 4
						)
						
						newBone.taper = 90
						newBone.wirecolor = color 176 26 26
						newBone.boneEnable = false
						newBone.frontfin = true
						newBone.frontfinsize = boneSize / 2
					)
				)
				
				newBone.name = "F" + fbxBone.name
				
				append New_bone newBone
				append New_bone_name newBone.name
				append Fbx_bone fbxBone
				append Fbx_bone_name fbxBone.name
			)
			
			New_bone[New_bone.count - boneChain.count + 1].parent = newParent
			
			for i = 1 to relation_parent.count do (
				for ii = 1 to relation_children[i].count do (
					local childIdx = findItem boneChain relation_children[i][ii]
					if childIdx > 0 do (
						local newBoneIdx = New_bone.count - boneChain.count + childIdx
						New_bone[newBoneIdx].parent = relation_parent[i]
					)
				)
			)
		)
		
		for i = 1 to New_bone.count do (
			setInheritanceFlags New_bone[i] #{1,2,3,4,5,6,7,8,9}
		)
		
		for i = 1 to New_bone.count do (
			local savedParent = New_bone[i].parent
			New_bone[i].parent = undefined
			New_bone[i].transform.controller = link_constraint()
			New_bone[i].transform.controller.addTarget Fbx_bone[i] 0
			if savedParent != undefined do (
				New_bone[i].parent = savedParent
			)
		)
		
		lblStatus.text = "状态：附加骨骼创建完成（" + New_bone.count as string + "个），已添加约束"
	)
	
	fn syncFigureMode = (
		if bone_pairs.count == 0 do (
			messageBox "请先执行自动匹配或加载模板！" title:"错误"
			return false
		)
		
		lblStatus.text = "状态：正在同步体型..."
		pbProgress.value = 0
		
		undo "体型同步" on (
			New_bip_root.controller.figureMode = true
			
			local totalBones = bone_pairs.count
			
			at time 0 (
				try (
					biped.setTransform New_bip_root #pos Bip_root.transform.position false
					biped.setTransform New_bip_root #rotation Bip_root.transform.rotation false
				) catch (
					format "根骨骼同步失败\n"
				)
			)
			
			for i = 1 to totalBones do (
				at time 0 (
					try (
						if bone_pairs[i].fbxBone != undefined and bone_pairs[i].newBone != undefined do (
							local fbxBone = bone_pairs[i].fbxBone
							local newBone = bone_pairs[i].newBone
							
							biped.setTransform newBone #pos fbxBone.transform.position false
							biped.setTransform newBone #rotation fbxBone.transform.rotation false
							
							if fbxBone.children.count > 0 do (
								local childBone = undefined
								for child in fbxBone.children do (
									if not matchPattern child.name pattern:"*Twist*" do (
										childBone = child
										exit
									)
								)
								
								if childBone != undefined do (
									local dist = distance fbxBone.transform.position childBone.transform.position
									if dist > 0.001 do (
										local originalScale = biped.getTransform newBone #scale
										biped.setTransform newBone #scale [dist, originalScale.y, originalScale.z] false
									)
								)
							)
						)
					) catch (
						format "骨骼 % 同步失败\n" bone_pairs[i].newBoneName
					)
				)
				
				pbProgress.value = (i as float / totalBones as float) * 100
			)
		)
		
		pbProgress.value = 0
		lblStatus.text = "状态：体型同步完成"
		
		messageBox "体型同步完成！\n提示：Figure模式仍然开启，可以手动调整细节" title:"完成"
		return true
	)
	
	fn syncAnimation = (
		if bone_pairs.count == 0 do (
			messageBox "请先执行自动匹配或加载模板！" title:"错误"
			return false
		)
		
		lblStatus.text = "状态：正在同步动画..."
		clearListener()
		
		format "\n========== 开始动画同步 ==========\n"
		
		local startFrame = animationRange.start as integer / TicksPerFrame
		local endFrame = animationRange.end as integer / TicksPerFrame
		
		if Bip_root != undefined do (
			local posCtrl = Bip_root.pos.controller
			local rotCtrl = Bip_root.rotation.controller
			
			if posCtrl != undefined and posCtrl.keys.count > 0 do (
				startFrame = (posCtrl.keys[1].time / TicksPerFrame) as integer
				endFrame = (posCtrl.keys[posCtrl.keys.count].time / TicksPerFrame) as integer
			)
			
			if rotCtrl != undefined and rotCtrl.keys.count > 0 do (
				startFrame = amin #(startFrame, (rotCtrl.keys[1].time / TicksPerFrame) as integer)
				endFrame = amax #(endFrame, (rotCtrl.keys[rotCtrl.keys.count].time / TicksPerFrame) as integer)
			)
		)
		
		animationRange = interval startFrame endFrame
		format "动画范围: % - % 帧\n" startFrame endFrame
		
		undo "动画同步" on (
			New_bip_root.controller.figureMode = false
			
			clearSelection()
			disableSceneRedraw()
			
			format "清除现有关键帧...\n"
			deselectKeys New_bip_root.controller startFrame endFrame
			selectKeys New_bip_root.controller startFrame endFrame
			try biped.deleteKeys New_bip_root.controller #selection catch()
			
			for p = 1 to bone_pairs.count do (
				if bone_pairs[p].newBone != undefined do (
					deselectKeys bone_pairs[p].newBone.controller startFrame endFrame
					selectKeys bone_pairs[p].newBone.controller startFrame endFrame
					try biped.deleteKeys bone_pairs[p].newBone.controller #selection catch()
				)
			)
			
			format "同步根骨骼动画...\n"
			for i = startFrame to endFrame do (
				at time (i as time) (
					try (
						biped.setTransform New_bip_root #pos Bip_root.transform.position true
						biped.setTransform New_bip_root #rotation Bip_root.transform.rotation true
					) catch()
				)
			)
			
			format "同步子骨骼动画...\n"
			local totalBones = bone_pairs.count
			local lastPercent = 0
			
			for p = 1 to totalBones do (
				if bone_pairs[p].fbxBone != undefined and bone_pairs[p].newBone != undefined do (
					for i = startFrame to endFrame do (
						at time (i as time) (
							try (
								biped.setTransform bone_pairs[p].newBone #pos bone_pairs[p].fbxBone.transform.position true
								biped.setTransform bone_pairs[p].newBone #rotation bone_pairs[p].fbxBone.transform.rotation true
							) catch()
						)
					)
				)
				
				local currentPercent = ((p as float) / (totalBones as float)) * 100
				if (currentPercent - lastPercent) >= 10 or p == totalBones do (
				format "进度: %，处理骨骼 % / %\n" (currentPercent as integer) p totalBones
				lblStatus.text = "状态：动画同步中... " + (currentPercent as integer) as string + "%"
				lastPercent = currentPercent
)
			)
			
			enableSceneRedraw()
		)
		
		lblStatus.text = "状态：动画同步完成"
		format "========== 动画同步完成 ==========\n\n"
		
		messageBox "动画同步完成！\n附加骨骼通过Link Constraint自动跟随\n详细信息请查看监听器窗口" title:"完成"
		return true
	)
	
	fn initDataGrids = (
		dgvBipedMapping.AllowUserToAddRows = false
		dgvBipedMapping.AutoSizeColumnsMode = dgvBipedMapping.AutoSizeColumnsMode.Fill
		dgvBipedMapping.SelectionMode = dgvBipedMapping.SelectionMode.FullRowSelect
		dgvBipedMapping.ReadOnly = true
		dgvBipedMapping.BackgroundColor = (dotNetClass "System.Drawing.Color").White
		
		dgvBipedMapping.ColumnCount = 3
		dgvBipedMapping.Columns.Item[0].Name = "FBX Biped"
		dgvBipedMapping.Columns.Item[1].Name = "新Biped"
		dgvBipedMapping.Columns.Item[2].Name = "状态"
		dgvBipedMapping.Columns.Item[2].Width = 80
		
		local headerStyle = dgvBipedMapping.ColumnHeadersDefaultCellStyle
		headerStyle.BackColor = (dotNetClass "System.Drawing.Color").DarkGreen
		headerStyle.ForeColor = (dotNetClass "System.Drawing.Color").White
		headerStyle.Font = dotNetObject "System.Drawing.Font" "微软雅黑" 10 ((dotNetClass "System.Drawing.FontStyle").Bold)
		
		dgvBipedMapping.RowTemplate.Height = 22
		
		dgvBoneMapping.AllowUserToAddRows = false
		dgvBoneMapping.AutoSizeColumnsMode = dgvBoneMapping.AutoSizeColumnsMode.Fill
		dgvBoneMapping.SelectionMode = dgvBoneMapping.SelectionMode.FullRowSelect
		dgvBoneMapping.ReadOnly = true
		dgvBoneMapping.BackgroundColor = (dotNetClass "System.Drawing.Color").White
		
		dgvBoneMapping.ColumnCount = 3
		dgvBoneMapping.Columns.Item[0].Name = "FBX附加骨骼"
		dgvBoneMapping.Columns.Item[1].Name = "新Bone"
		dgvBoneMapping.Columns.Item[2].Name = "类型"
		dgvBoneMapping.Columns.Item[2].Width = 100
		
		headerStyle = dgvBoneMapping.ColumnHeadersDefaultCellStyle
		headerStyle.BackColor = (dotNetClass "System.Drawing.Color").DarkOrange
		headerStyle.ForeColor = (dotNetClass "System.Drawing.Color").White
		headerStyle.Font = dotNetObject "System.Drawing.Font" "微软雅黑" 10 ((dotNetClass "System.Drawing.FontStyle").Bold)
		
		dgvBoneMapping.RowTemplate.Height = 22
	)
	
	-- ============ 事件处理 ============
	
	on SoxFbxToBipedFull open do (
		initDataGrids()
		
		if loadDataFromScene() then (
			format "已自动加载场景中的映射数据\n"
		)
		else (
			lblDataStatus.text = "场景数据：无"
		)
	)
	
	on btnQuickConvert pressed do (
		local params = analyzeFbxSkeleton()
		if params == false do return()
		
		local newBip = autoCreateBiped params
		if newBip == undefined do return()
		
		if not createBonePairs() do (
			messageBox "骨骼匹配失败！" title:"错误"
			return()
		)
		
		createAttachmentBones()
		refreshLists()
		saveDataToScene()
		
		if queryBox "是否立即同步体型？" do (
			syncFigureMode()
		)
	)
	
	on btnAnalyzeSkeleton pressed do (
		analyzeFbxSkeleton()
	)
	
	on btnManualMatch pressed do (
		local params = analyzeFbxSkeleton()
		if params != false do (
			local newBip = autoCreateBiped params
			if newBip != undefined do (
				if createBonePairs() do (
					createAttachmentBones()
					refreshLists()
					saveDataToScene()
				)
			)
		)
	)
	
	on btnSaveTemplate pressed do (
		saveTemplate()
	)
	
	on btnLoadTemplate pressed do (
		loadTemplate()
	)
	
	on btnSaveToScene pressed do (
		saveDataToScene()
	)
	
	on btnClearSceneData pressed do (
		if queryBox "确定要清除场景数据吗？" do (
			clearSceneData()
		)
	)
	
	on btnSetFbxBone pressed do (
		if dgvBipedMapping.SelectedRows.Count == 0 do (
			messageBox "请先在列表中选择一行！" title:"提示"
			return()
		)
		
		if selection.count == 0 do (
			messageBox "请先在场景中选择一个FBX骨骼！" title:"提示"
			return()
		)
		
		local rowIndex = dgvBipedMapping.SelectedRows.Item[0].Index + 1
		
		if rowIndex > 0 and rowIndex <= bone_pairs.count do (
			bone_pairs[rowIndex].fbxBone = selection[1]
			bone_pairs[rowIndex].fbxBoneName = selection[1].name
			refreshLists()
			lblStatus.text = "状态：已设置FBX骨骼 - " + selection[1].name
		)
	)
	
	on btnSetNewBone pressed do (
		if dgvBipedMapping.SelectedRows.Count == 0 do (
			messageBox "请先在列表中选择一行！" title:"提示"
			return()
		)
		
		if selection.count == 0 do (
			messageBox "请先在场景中选择一个新Biped骨骼！" title:"提示"
			return()
		)
		
		local rowIndex = dgvBipedMapping.SelectedRows.Item[0].Index + 1
		
		if rowIndex > 0 and rowIndex <= bone_pairs.count do (
			bone_pairs[rowIndex].newBone = selection[1]
			bone_pairs[rowIndex].newBoneName = selection[1].name
			refreshLists()
			lblStatus.text = "状态：已设置新骨骼 - " + selection[1].name
		)
	)
	
	on btnFigureSync pressed do (
		syncFigureMode()
	)
	
	on btnAnimSync pressed do (
		syncAnimation()
	)
	
	on btnReset pressed do (
		if queryBox "确定要重置吗？这将清空当前所有配对数据（不影响场景保存的数据）" do (
			Fbx_bip = #()
			New_bip = #()
			New_bone = #()
			Fbx_bone = #()
			bone_pairs = #()
			dgvBipedMapping.Rows.Clear()
			dgvBoneMapping.Rows.Clear()
			lblInfo.text = ""
			lblStatus.text = "状态：已重置"
		)
	)
)

createDialog SoxFbxToBipedFull
这个脚本，在创建好BIPED后，不是出了提示框让手动微调对齐的状态吗，可是，我调整后，他还是会按照他创建好的情况进行动画拷贝啊，能不能说有一个按钮，叫记录偏移，拷贝的时候，就拷贝修正过的数据给他呢，这个偏移要存在用户定义属性里面，方便下次开场景继续用